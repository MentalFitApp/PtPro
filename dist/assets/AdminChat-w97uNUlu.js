import{r as n,q as X,d as x,f as l,x as v,y as U,F as N,o as A,j as s,E as _,G as $,h as D,i as k,H as G,k as w}from"./index-anlJ2MEK.js";import{S as H}from"./search-Bdosj-RF.js";import{m as J}from"./proxy-QSBDSPTy.js";import{S as W}from"./send-C48asdir.js";import{M as Z}from"./message-square-BIN7rgw0.js";const T=()=>s.jsx("div",{className:"flex justify-center items-center h-full p-4",children:s.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-rose-500"})}),ae=()=>{const[f,F]=n.useState([]),[i,y]=n.useState(null),[S,C]=n.useState([]),[d,z]=n.useState(""),[L,I]=n.useState(!0),[O,p]=n.useState(!1),[u,R]=n.useState(""),[M,g]=n.useState([]),[b,j]=n.useState(!1),E=n.useRef(null),m=X().currentUser,o=["QwWST9OVOlTOi5oheyCqfpXLOLg2","AeZKjJYu5zMZ4mvffaGiqCBb0cF2","3j0AXIRa4XdHq1ywCl4UBxJNsku2","l0RI8TzFjbNVoAdmcxNQkP9mWb12"];n.useEffect(()=>{if(!m)return;const e=x(l,"chats"),a=v(e,N("participants","array-contains-any",o),U("lastUpdate","desc")),r=A(a,t=>{F(t.docs.map(c=>({id:c.id,...c.data()}))),I(!1)},t=>{console.error("Errore nel caricare le chat:",t),I(!1)});return()=>r()},[m]),n.useEffect(()=>{if(!i){C([]);return}p(!0);const e=x(l,"chats",i,"messages"),a=v(e,U("createdAt")),r=A(a,t=>{C(t.docs.map(c=>({id:c.id,...c.data()}))),p(!1)},t=>{console.error("Errore nel caricare i messaggi:",t),p(!1)});return()=>r()},[i]),n.useEffect(()=>{var e;(e=E.current)==null||e.scrollIntoView({behavior:"smooth"})},[S]),n.useEffect(()=>{const e=async()=>{if(u.trim().length<2){g([]),j(!1);return}j(!0);const r=x(l,"clients"),t=u.toLowerCase(),c=v(r,N("name_lowercase",">=",t),N("name_lowercase","<=",t+"ï£¿"),_(10));try{const h=await $(c);g(h.docs.map(q=>({id:q.id,...q.data()})))}catch(h){console.error("Errore nella ricerca (indice Firestore mancante?):",h)}j(!1)},a=setTimeout(()=>{e()},300);return()=>clearTimeout(a)},[u]);const Q=async e=>{if(!m)return;const a=o[0],r=[e.id,a].sort().join("_"),t=D(l,"chats",r);f.find(h=>h.id===r)||await k(t,{participants:[e.id,a],participantNames:{[e.id]:e.name,[a]:"Coach"},lastMessage:"Conversazione iniziata",lastUpdate:w()},{merge:!0}),y(r),R(""),g([])},B=async e=>{if(e.preventDefault(),d.trim()===""||!i||!m)return;const a=x(l,"chats",i,"messages");await G(a,{text:d,createdAt:w(),senderId:m.uid}),await k(D(l,"chats",i),{lastMessage:d,lastUpdate:w()},{merge:!0}),z("")},V=()=>{var r;if(!i)return"Chat";const e=f.find(t=>t.id===i);if(!e)return"Chat";const a=e.participants.find(t=>!o.includes(t));return((r=e.participantNames)==null?void 0:r[a])||"Cliente"};return s.jsxs("div",{className:"flex h-[calc(100vh-120px)] bg-zinc-950/60 backdrop-blur-xl rounded-2xl gradient-border overflow-hidden",children:[s.jsxs("div",{className:"w-1/3 border-r border-white/10 flex flex-col",children:[s.jsx("div",{className:"p-4 border-b border-white/10",children:s.jsxs("div",{className:"relative",children:[s.jsx(H,{className:"absolute top-1/2 left-3 -translate-y-1/2 text-slate-400",size:18}),s.jsx("input",{type:"text",placeholder:"Cerca o avvia una chat...",value:u,onChange:e=>R(e.target.value),className:"w-full bg-zinc-900/70 p-2 pl-10 rounded-lg border border-white/10 outline-none focus:ring-2 focus:ring-rose-500 text-slate-200"})]})}),u.length>1?s.jsxs("div",{className:"flex-1 overflow-y-auto",children:[b&&s.jsx("p",{className:"p-4 text-slate-400 text-sm",children:"Ricerca in corso..."}),!b&&M.length===0&&s.jsx("p",{className:"p-4 text-slate-400 text-sm",children:"Nessun cliente trovato."}),!b&&M.map(e=>s.jsxs("div",{onClick:()=>Q(e),className:"p-4 cursor-pointer hover:bg-white/5 transition-colors",children:[s.jsx("p",{className:"font-semibold text-slate-100",children:e.name}),s.jsx("p",{className:"text-sm text-slate-400",children:e.email})]},e.id))]}):s.jsx(s.Fragment,{children:L?s.jsx(T,{}):s.jsx("div",{className:"flex-1 overflow-y-auto",children:f.map(e=>{const a=e.participants.find(t=>!o.includes(t)),r=e.participantNames?e.participantNames[a]:"Cliente";return s.jsxs("div",{onClick:()=>y(e.id),className:`p-4 cursor-pointer border-l-4 transition-colors ${i===e.id?"bg-rose-600/20 border-rose-500":"border-transparent hover:bg-white/5"}`,children:[s.jsx("p",{className:"font-semibold text-slate-100",children:r||"Cliente"}),s.jsx("p",{className:"text-sm text-slate-400 truncate",children:e.lastMessage})]},e.id)})})})]}),s.jsx("div",{className:"w-2/3 flex flex-col bg-zinc-900/50",children:i?s.jsxs(s.Fragment,{children:[s.jsx("div",{className:"p-4 border-b border-white/10",children:s.jsx("h3",{className:"font-bold text-lg text-slate-50",children:V()})}),s.jsxs("div",{className:"flex-1 overflow-y-auto p-6 space-y-4",children:[O?s.jsx(T,{}):S.map(e=>s.jsx("div",{className:`flex ${o.includes(e.senderId)?"justify-end":"justify-start"}`,children:s.jsx(J.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},className:`max-w-md p-3 rounded-2xl text-slate-100 ${o.includes(e.senderId)?"bg-rose-600 rounded-br-none":"bg-zinc-800 rounded-bl-none"}`,children:s.jsx("p",{className:"break-words",children:e.text})})},e.id)),s.jsx("div",{ref:E})]}),s.jsx("div",{className:"p-4 border-t border-white/10",children:s.jsxs("form",{onSubmit:B,className:"flex items-center gap-4",children:[s.jsx("input",{type:"text",value:d,onChange:e=>z(e.target.value),placeholder:"Scrivi una risposta...",className:"flex-1 p-3 bg-zinc-800 border border-white/10 rounded-full outline-none focus:ring-2 focus:ring-rose-500 text-white"}),s.jsx("button",{type:"submit",className:"p-3 bg-rose-600 hover:bg-rose-700 text-white rounded-full transition-colors disabled:opacity-50",disabled:!d.trim(),children:s.jsx(W,{size:20})})]})})]}):s.jsxs("div",{className:"flex flex-col justify-center items-center h-full text-slate-500",children:[s.jsx(Z,{size:48}),s.jsx("p",{className:"mt-4",children:"Seleziona una conversazione o cercane una nuova."})]})})]})};export{ae as default};
