rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {
    
    // ==================== FUNZIONI DI SUPPORTO ====================
    
    function isPlatformCEO() {
      return request.auth != null &&
             exists(/databases/$(database)/documents/platform_admins/superadmins) &&
             request.auth.uid in firestore.get(/databases/$(database)/documents/platform_admins/superadmins).data.uids;
    }

    function isTenantSuperAdmin(tenantId) {
      return request.auth != null &&
             exists(/databases/$(database)/documents/tenants/$(tenantId)/roles/superadmins) &&
             request.auth.uid in firestore.get(/databases/$(database)/documents/tenants/$(tenantId)/roles/superadmins).data.uids;
    }

    function isTenantAdmin(tenantId) {
      return isTenantSuperAdmin(tenantId) ||
             (request.auth != null &&
              exists(/databases/$(database)/documents/tenants/$(tenantId)/roles/admins) &&
              request.auth.uid in firestore.get(/databases/$(database)/documents/tenants/$(tenantId)/roles/admins).data.uids);
    }

    function isTenantCoach(tenantId) {
      return isTenantAdmin(tenantId) ||
             (request.auth != null &&
              exists(/databases/$(database)/documents/tenants/$(tenantId)/roles/coaches) &&
              request.auth.uid in firestore.get(/databases/$(database)/documents/tenants/$(tenantId)/roles/coaches).data.uids);
    }
    
    // ==================== TENANT-BASED STORAGE ====================
    
    // Video di benvenuto tenant (max 1GB)
    match /tenant_videos/{tenantId}/{fileName} {
      allow read: if request.auth != null;
      allow write: if (isTenantAdmin(tenantId) || isTenantCoach(tenantId)) &&
                     request.resource.size < 1073741824 && // 1GB
                     request.resource.contentType.matches('video/.*');
      allow delete: if isTenantAdmin(tenantId) || isTenantCoach(tenantId);
    }
    
    // Foto profilo tenant
    match /tenants/{tenantId}/profile_photos/{fileName} {
      allow read: if request.auth != null;
      allow write: if request.auth != null &&
                     request.resource.size < 5 * 1024 * 1024 &&
                     request.resource.contentType.matches('image/.*');
    }
    
    // Anamnesi photos tenant
    match /tenants/{tenantId}/clients/{userId}/anamnesi_photos/{allPaths=**} {
      allow read: if request.auth != null && (
        request.auth.uid == userId ||
        isTenantAdmin(tenantId) ||
        isTenantCoach(tenantId)
      );
      allow write: if request.auth != null && request.auth.uid == userId &&
                     request.resource.size < 5 * 1024 * 1024 &&
                     request.resource.contentType.matches('image/.*');
    }
    
    // Check photos tenant
    match /tenants/{tenantId}/clients/{userId}/checks/{allPaths=**} {
      allow read: if request.auth != null && (
        request.auth.uid == userId ||
        isTenantAdmin(tenantId) ||
        isTenantCoach(tenantId)
      );
      allow write: if request.auth != null && request.auth.uid == userId &&
                     request.resource.size < 5 * 1024 * 1024 &&
                     request.resource.contentType.matches('image/.*');
    }
    
    // Landing page assets tenant
    match /tenants/{tenantId}/landing/{allPaths=**} {
      allow read: if true; // Pubblico per visualizzazione siti
      allow write: if isTenantAdmin(tenantId) &&
                     request.resource.size < 10 * 1024 * 1024 &&
                     request.resource.contentType.matches('image/.*|video/.*');
    }
    
    // Branding assets tenant (logo, favicon, etc)
    match /tenants/{tenantId}/branding/{fileName} {
      allow read: if request.auth != null;
      allow write: if isTenantAdmin(tenantId) &&
                     request.resource.size < 5 * 1024 * 1024 &&
                     request.resource.contentType.matches('image/.*');
    }
    
    // ==================== LEGACY PATHS (retrocompatibilitÃ ) ====================
    
    // Foto profilo (legacy, non tenant-based)
    match /profile_photos/{fileName} {
      allow read: if request.auth != null;
      allow write: if request.auth != null &&
                     request.resource.size < 5 * 1024 * 1024 &&
                     request.resource.contentType.matches('image/.*');
    }
    
    // Video onboarding legacy (solo platform CEO)
    match /onboarding/{allPaths=**} {
      allow read: if request.auth != null;
      allow write: if isPlatformCEO() &&
                     request.resource.size < 100 * 1024 * 1024 &&
                     request.resource.contentType.matches('video/.*');
    }
    
    // Anamnesi photos legacy
    match /clients/{userId}/anamnesi_photos/{allPaths=**} {
      allow read: if request.auth != null && request.auth.uid == userId;
      allow write: if request.auth != null && request.auth.uid == userId &&
                     request.resource.size < 5 * 1024 * 1024 &&
                     request.resource.contentType.matches('image/.*');
    }
    
    // Check photos legacy
    match /clients/{userId}/checks/{allPaths=**} {
      allow read: if request.auth != null && request.auth.uid == userId;
      allow write: if request.auth != null && request.auth.uid == userId &&
                     request.resource.size < 5 * 1024 * 1024 &&
                     request.resource.contentType.matches('image/.*');
    }
    
    // ==================== BLOCCA TUTTO IL RESTO ====================
    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
}