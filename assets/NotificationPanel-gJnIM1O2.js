import{r as a,j as e}from"./react-CrXOBDSJ.js";import{a as h,d as n}from"./index-CYfn4HI_.js";import{J as z,U as k,I,H as R,z as B,$ as F,N as J,A as f,O,D as A}from"./@firebase-CuwLCerw.js";import{m as p,A as H}from"./framer-motion-BAPjnw1b.js";import{a5 as K,B as C,X as L,y as Z}from"./lucide-react-CCY59hBS.js";function _({userType:c="client"}){const[l,P]=a.useState([]),[g,N]=a.useState(!1),[b,j]=a.useState(!1),[d,q]=a.useState(0),m=a.useRef(null),u=a.useRef(0);a.useEffect(()=>{if(!h.currentUser)return;const t=Notification.permission;N(t==="granted");const s=z(I(n,"notifications"),k("userId","==",h.currentUser.uid),k("userType","==",c)),i=R(s,D=>{const r=D.docs.map(o=>({id:o.id,...o.data()})).sort((o,v)=>{var w,y;const U=(w=o.sentAt)!=null&&w.toMillis?o.sentAt.toMillis():0;return((y=v.sentAt)!=null&&y.toMillis?v.sentAt.toMillis():0)-U}),x=r.filter(o=>!o.read).length;x>u.current&&u.current>0&&(E(),t==="granted"&&r[0]&&new Notification(r[0].title||"Nuova notifica",{body:r[0].body||"",icon:"/PtPro/logo192.png",badge:"/PtPro/logo192.png",tag:"notification-"+r[0].id})),u.current=x,P(r),q(x)});return()=>i()},[c]);const E=()=>{m.current&&m.current.play().catch(t=>console.log("Audio play error:",t))},M=async()=>{try{if(await Notification.requestPermission()==="granted"){N(!0);try{const s=B(),i=await F(s,{vapidKey:"BKagOny0KQcd-p9DC2P4pDlZ3Owv1L-n6bqqQWTUl_G2aS9qLJMIvZo3aDlN6hG1IqJeM5HJqVxD4Cc5sqUZqAU"});i?(console.log("Token FCM ottenuto:",i),await J(f(n,"fcmTokens",h.currentUser.uid),{token:i,userType:c,updatedAt:O()},{merge:!0}),console.log("Token salvato su Firestore")):console.log("Nessun token FCM ottenuto")}catch(s){console.error("Errore FCM token:",s)}}}catch(t){console.error("Errore attivazione notifiche:",t)}},S=async t=>{try{await A(f(n,"notifications",t),{read:!0})}catch(s){console.error("Errore marcatura notifica letta:",s)}},T=async()=>{try{const t=l.filter(s=>!s.read);await Promise.all(t.map(s=>A(f(n,"notifications",s.id),{read:!0})))}catch(t){console.error("Errore marcatura tutte lette:",t)}};return e.jsxs("div",{className:"relative",children:[!g&&e.jsxs(p.button,{onClick:M,whileHover:{scale:1.05},whileTap:{scale:.95},className:"flex items-center gap-2 px-4 py-2 bg-rose-600 hover:bg-rose-700 text-white rounded-lg font-medium transition-colors",children:[e.jsx(K,{size:18}),"Attiva Notifiche"]}),g&&e.jsxs("button",{onClick:()=>j(!b),className:"relative p-2 hover:bg-white/10 rounded-lg transition-colors",children:[e.jsx(C,{size:24,className:"text-slate-300"}),d>0&&e.jsx("span",{className:"absolute -top-1 -right-1 bg-rose-600 text-white text-xs font-bold rounded-full w-5 h-5 flex items-center justify-center",children:d})]}),e.jsx(H,{children:b&&e.jsxs(p.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},exit:{opacity:0,y:10},className:"fixed right-2 top-20 w-[calc(100vw-1rem)] sm:w-96 sm:right-4 max-h-[70vh] bg-slate-800 border border-slate-700 rounded-xl shadow-2xl z-[9999] overflow-hidden",children:[e.jsxs("div",{className:"flex items-center justify-between p-4 border-b border-slate-700",children:[e.jsx("h3",{className:"font-bold text-slate-200",children:"Notifiche"}),e.jsxs("div",{className:"flex items-center gap-2",children:[d>0&&e.jsx("button",{onClick:T,className:"text-xs text-rose-400 hover:text-rose-300 transition-colors",children:"Segna tutte lette"}),e.jsx("button",{onClick:()=>j(!1),className:"p-1 hover:bg-white/10 rounded transition-colors",children:e.jsx(L,{size:18,className:"text-slate-400"})})]})]}),e.jsx("div",{className:"overflow-y-auto max-h-[420px]",children:l.length===0?e.jsxs("div",{className:"p-8 text-center text-slate-400",children:[e.jsx(C,{size:48,className:"mx-auto mb-3 opacity-30"}),e.jsx("p",{children:"Nessuna notifica"})]}):l.map(t=>{var s;return e.jsx(p.div,{layout:!0,className:`p-4 border-b border-slate-700 hover:bg-white/5 transition-colors cursor-pointer ${t.read?"":"bg-rose-900/10"}`,onClick:()=>!t.read&&S(t.id),children:e.jsxs("div",{className:"flex items-start justify-between gap-3",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("h4",{className:"font-medium text-slate-200 text-sm",children:t.title}),!t.read&&e.jsx("span",{className:"w-2 h-2 bg-rose-500 rounded-full"})]}),e.jsx("p",{className:"text-sm text-slate-400",children:t.body}),e.jsx("p",{className:"text-xs text-slate-500 mt-2",children:(s=t.sentAt)==null?void 0:s.toDate().toLocaleDateString("it-IT",{day:"numeric",month:"short",hour:"2-digit",minute:"2-digit"})})]}),t.read&&e.jsx(Z,{size:16,className:"text-emerald-500 flex-shrink-0"})]})},t.id)})})]})}),e.jsx("audio",{ref:m,src:"/PtPro/mixkit-long-pop-2358.wav",preload:"auto"})]})}export{_ as N};
