import{h as We,g as Oe,r as o,W,X as O,aO as M,V as h,T as X,j as e,q as f,U as K,A as y,al as de,a0 as Xe,aC as Ke,aI as U,aP as R,aQ as me,aR as qe,aG as Ge,aS as He,aT as Je,M as Ye,av as q,am as Ze,u as p,e as m,f as G,ax as ea,aU as v,a7 as u,aV as ue,aW as xe,aX as he}from"./.pnpm-C04Ba0Xq.js";import{d as n,s as pe}from"./index-DdCoIfwr.js";function ra(){const D=We(),l=Oe().currentUser,[I,fe]=o.useState([]),[i,S]=o.useState(null),[ge,be]=o.useState([]),[N,H]=o.useState(""),[$,J]=o.useState(""),[ve,w]=o.useState(!1),[Y,je]=o.useState([]),[Z,E]=o.useState([]),[ye,Ne]=o.useState(!0),[ee,ae]=o.useState(!1),V=o.useRef(null),[we,P]=o.useState(null),[g,te]=o.useState(!1),[se,Ce]=o.useState(null),[ta,sa]=o.useState([]),le=o.useRef(null),[C,k]=o.useState(!1),[Ue,T]=o.useState(!1),[Re,Ie]=o.useState(!0);o.useEffect(()=>{if(!l)return;(async()=>{var t,s;try{const r=await G(m(n,"roles","admins"));if(r.exists()&&((t=r.data().uids)!=null&&t.includes(l.uid)))P("admin");else{const j=await G(m(n,"roles","coaches"));j.exists()&&((s=j.data().uids)!=null&&s.includes(l.uid))?P("coach"):P("client")}const c=await G(m(n,"users",l.uid));if(c.exists()){const j=c.data(),Qe=j.name&&j.name.trim().length>0,Be=j.photoURL&&j.photoURL.trim().length>0;T(Qe&&Be)}else T(!1)}catch(r){console.error("Errore verifica profilo:",r),T(!1)}finally{Ie(!1)}})()},[l]),o.useEffect(()=>{l&&(async()=>{try{const s=(await ea(h(n,"users"))).docs.map(r=>({id:r.id,...r.data()})).filter(r=>r.name&&r.id!==l.uid);je(s),E(s)}catch(t){console.error("Errore caricamento utenti:",t)}})()},[l]),o.useEffect(()=>{if(!l)return;const a=W(h(n,"chats"),M("participants","array-contains",l.uid),O("lastUpdate","desc")),t=X(a,s=>{const r=s.docs.map(c=>({id:c.id,...c.data()}));fe(r),Ne(!1)});return()=>t()},[l]),o.useEffect(()=>{if(!i)return;const a=W(h(n,"chats",i.id,"messages"),O("timestamp","asc")),t=X(a,s=>{const r=s.docs.map(c=>({id:c.id,...c.data()}));be(r),Se()});return()=>t()},[i]);const Se=()=>{var a;(a=V.current)==null||a.scrollIntoView({behavior:"smooth"})},ke=a=>{if(J(a),!a.trim()){E(Y);return}const t=Y.filter(s=>{var r,c;return((r=s.name)==null?void 0:r.toLowerCase().includes(a.toLowerCase()))||((c=s.email)==null?void 0:c.toLowerCase().includes(a.toLowerCase()))});E(t)},ze=async a=>{try{const t=I.find(c=>c.participants.includes(a.id));if(t){S(t),w(!1);return}const r={id:(await v(h(n,"chats"),{participants:[l.uid,a.id],participantsData:{[l.uid]:{name:l.displayName||"Tu",photoURL:l.photoURL||""},[a.id]:{name:a.name,photoURL:a.photoURL||""}},lastMessage:"",lastUpdate:u(),unreadCount:{[l.uid]:0,[a.id]:0},createdAt:u()})).id,participants:[l.uid,a.id],participantsData:{[l.uid]:{name:l.displayName||"Tu",photoURL:l.photoURL||""},[a.id]:{name:a.name,photoURL:a.photoURL||""}},lastMessage:"",lastUpdate:new Date};S(r),w(!1),setTimeout(()=>{var c;(c=V.current)==null||c.scrollIntoView({behavior:"smooth"})},100)}catch(t){console.error("Errore creazione chat:",t),alert("Errore durante la creazione della chat")}},ie=async()=>{if(!(!N.trim()||!i||ee)){ae(!0);try{await v(h(n,"chats",i.id,"messages"),{text:N.trim(),senderId:l.uid,senderName:l.displayName||"Utente",senderPhotoURL:l.photoURL||"",timestamp:u(),read:!1}),await p(m(n,"chats",i.id),{lastMessage:N.trim(),lastUpdate:u()}),H("")}catch(a){console.error("Errore invio messaggio:",a),alert("Errore durante l'invio del messaggio")}finally{ae(!1)}}},x=a=>{var s;if(!a)return null;const t=a.participants.find(r=>r!==l.uid);return((s=a.participantsData)==null?void 0:s[t])||{name:"Utente",photoURL:""}},[Le,A]=o.useState(!1),[Me,_]=o.useState(!1),[re,F]=o.useState(null),[oe,Q]=o.useState(null),[d,z]=o.useState(null),[De,B]=o.useState(0),L=o.useRef(null),b=o.useRef(null);o.useEffect(()=>{if(!l)return;const a=W(h(n,"notifications"),M("userId","==",l.uid),M("type","in",["videocall","voicecall"]),M("read","==",!1),O("timestamp","desc")),t=X(a,s=>{if(s.empty)z(null);else{const r={id:s.docs[0].id,...s.docs[0].data()};z(r)}});return()=>t()},[l]);const $e=async()=>{if(!i)return;x(i);const a=i.participants.find(s=>s!==l.uid),t=`videocall_${i.id}_${Date.now()}`;try{const s=await v(h(n,"chats",i.id,"messages"),{type:"call",callType:"video",callStatus:"calling",roomId:t,senderId:l.uid,senderName:l.displayName||"Utente",senderPhotoURL:l.photoURL||"",timestamp:u(),read:!1});await v(h(n,"notifications"),{userId:a,type:"videocall",title:"Videochiamata in arrivo",message:`${l.displayName||"Un utente"} sta chiamando...`,roomId:t,callMessageId:s.id,callerId:l.uid,callerName:l.displayName||"Utente",callerPhoto:l.photoURL||"",timestamp:u(),read:!1}),await p(m(n,"chats",i.id),{lastMessage:"ðŸ“¹ Videochiamata",lastUpdate:u()}),b.current={chatId:i.id,messageId:s.id},F(t),A(!0)}catch(s){console.error("Errore avvio videocall:",s),alert("Errore durante l'avvio della videochiamata")}},Ee=async()=>{if(!i)return;x(i);const a=i.participants.find(s=>s!==l.uid),t=`voicecall_${i.id}_${Date.now()}`;try{const s=await v(h(n,"chats",i.id,"messages"),{type:"call",callType:"voice",callStatus:"calling",roomId:t,senderId:l.uid,senderName:l.displayName||"Utente",senderPhotoURL:l.photoURL||"",timestamp:u(),read:!1});await v(h(n,"notifications"),{userId:a,type:"voicecall",title:"Chiamata vocale in arrivo",message:`${l.displayName||"Un utente"} sta chiamando...`,roomId:t,callMessageId:s.id,callerId:l.uid,callerName:l.displayName||"Utente",callerPhoto:l.photoURL||"",timestamp:u(),read:!1}),await p(m(n,"chats",i.id),{lastMessage:"ðŸ“ž Chiamata vocale",lastUpdate:u()}),b.current={chatId:i.id,messageId:s.id},Q(t),_(!0),ne()}catch(s){console.error("Errore avvio chiamata vocale:",s),alert("Errore durante l'avvio della chiamata")}},ne=()=>{B(0),L.current=setInterval(()=>{B(a=>a+1)},1e3)},Ve=()=>{L.current&&(clearInterval(L.current),L.current=null),B(0)},Pe=a=>{const t=Math.floor(a/60),s=a%60;return`${t.toString().padStart(2,"0")}:${s.toString().padStart(2,"0")}`},Te=async a=>{var s;const t=(s=a.target.files)==null?void 0:s[0];if(!(!t||!i)){k(!0);try{const r=ue(pe,`chat-images/${i.id}/${Date.now()}_${t.name}`);await xe(r,t);const c=await he(r);await v(h(n,"chats",i.id,"messages"),{type:"image",imageUrl:c,senderId:l.uid,senderName:l.displayName||"Utente",senderPhotoURL:l.photoURL||"",timestamp:u(),read:!1}),await p(m(n,"chats",i.id),{lastMessage:"ðŸ“· Immagine",lastUpdate:u()})}catch(r){console.error("Errore upload immagine:",r),alert("Errore durante l'invio dell'immagine")}finally{k(!1)}}},Ae=async()=>{try{const a=await navigator.mediaDevices.getUserMedia({audio:!0}),t=new MediaRecorder(a),s=[];t.ondataavailable=r=>{s.push(r.data)},t.onstop=async()=>{const r=new Blob(s,{type:"audio/webm"});await Fe(r),a.getTracks().forEach(c=>c.stop())},t.start(),Ce(t),te(!0)}catch(a){console.error("Errore registrazione audio:",a),alert("Impossibile accedere al microfono")}},_e=()=>{se&&g&&(se.stop(),te(!1))},Fe=async a=>{if(i){k(!0);try{const t=ue(pe,`chat-audio/${i.id}/${Date.now()}.webm`);await xe(t,a);const s=await he(t);await v(h(n,"chats",i.id,"messages"),{type:"audio",audioUrl:s,senderId:l.uid,senderName:l.displayName||"Utente",senderPhotoURL:l.photoURL||"",timestamp:u(),read:!1}),await p(m(n,"chats",i.id),{lastMessage:"ðŸŽ¤ Messaggio vocale",lastUpdate:u()})}catch(t){console.error("Errore upload audio:",t),alert("Errore durante l'invio del messaggio vocale")}finally{k(!1)}}},ce=I.filter(a=>{var s;return(s=x(a).name)==null?void 0:s.toLowerCase().includes($.toLowerCase())});return l?Re?e.jsx("div",{className:"flex items-center justify-center min-h-screen bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-cyan-500 mx-auto mb-4"}),e.jsx("p",{className:"text-slate-400",children:"Verifica profilo in corso..."})]})}):Ue?e.jsx("div",{className:"fixed inset-0 bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 overflow-hidden safe-area-top",children:e.jsxs("div",{className:"h-full flex md:grid md:grid-cols-[384px_1fr] relative",children:[e.jsx(y,{mode:"wait",children:!i&&e.jsxs(f.div,{initial:{opacity:0,x:-20},animate:{opacity:1,x:0},exit:{opacity:0,x:-20},transition:{duration:.2},className:"w-full md:w-auto h-full border-r border-slate-700 flex flex-col bg-slate-800/50 backdrop-blur-sm md:opacity-100 md:translate-x-0",children:[e.jsxs("div",{className:"p-4 border-b border-slate-700",children:[e.jsx("h1",{className:"text-2xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-blue-500 mb-4",children:"ðŸ’¬ Chat"}),e.jsxs("div",{className:"relative",children:[e.jsx(de,{className:"absolute left-3 top-1/2 -translate-y-1/2 text-slate-400",size:20}),e.jsx("input",{type:"text",value:$,onChange:a=>J(a.target.value),placeholder:"Cerca chat...",className:"w-full pl-10 pr-4 py-3 bg-slate-700/50 border border-slate-600 rounded-lg text-slate-100 placeholder:text-slate-400 focus:outline-none focus:ring-2 focus:ring-cyan-500"})]}),e.jsxs("button",{onClick:()=>w(!0),className:"mt-3 w-full flex items-center justify-center gap-2 px-4 py-3 bg-gradient-to-r from-cyan-600 to-blue-600 hover:from-cyan-700 hover:to-blue-700 text-white rounded-lg font-semibold transition-all shadow-lg",children:[e.jsx(Xe,{size:20}),"Nuova Chat"]})]}),e.jsx("div",{className:"flex-1 overflow-y-auto",children:ye?e.jsx("div",{className:"flex items-center justify-center h-32",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-cyan-500"})}):ce.length===0?e.jsxs("div",{className:"text-center py-12 px-4",children:[e.jsx(K,{size:48,className:"mx-auto mb-4 text-slate-600"}),e.jsx("p",{className:"text-slate-400 mb-2",children:"Nessuna chat ancora"}),e.jsx("p",{className:"text-sm text-slate-500",children:"Inizia una nuova conversazione!"})]}):ce.map(a=>{var s;const t=x(a);return e.jsx("button",{onClick:()=>S(a),className:`w-full p-3 md:p-4 border-b border-slate-700 hover:bg-slate-700/50 active:bg-slate-700 transition-all text-left touch-manipulation ${(i==null?void 0:i.id)===a.id?"bg-slate-700/70":""}`,children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("img",{src:t.photoURL||`https://ui-avatars.com/api/?name=${encodeURIComponent(t.name)}`,alt:t.name,className:"w-10 h-10 md:w-12 md:h-12 rounded-full object-cover border-2 border-cyan-500 flex-shrink-0"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("h3",{className:"font-semibold text-sm md:text-base text-slate-100 truncate",children:t.name}),e.jsx("p",{className:"text-xs md:text-sm text-slate-400 truncate",children:a.lastMessage||"Nessun messaggio"})]}),((s=a.unreadCount)==null?void 0:s[l.uid])>0&&e.jsx("span",{className:"px-2 py-1 bg-cyan-600 text-white text-xs font-bold rounded-full",children:a.unreadCount[l.uid]})]})},a.id)})})]},"sidebar")}),e.jsx(y,{mode:"wait",children:i&&e.jsx(f.div,{initial:{opacity:0,x:20},animate:{opacity:1,x:0},exit:{opacity:0,x:20},transition:{duration:.2},className:"flex-1 w-full md:w-auto flex flex-col h-full bg-slate-900 md:bg-transparent md:opacity-100 md:translate-x-0",children:i?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex-shrink-0 p-3 md:p-4 border-b border-slate-700 bg-slate-800/95 backdrop-blur-sm flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("button",{onClick:()=>S(null),className:"md:hidden p-2 hover:bg-slate-700 rounded-lg transition-colors",children:e.jsx(Ke,{size:20,className:"text-slate-300"})}),e.jsx("img",{src:x(i).photoURL||`https://ui-avatars.com/api/?name=${encodeURIComponent(x(i).name)}`,alt:x(i).name,className:"w-9 h-9 md:w-10 md:h-10 rounded-full object-cover border-2 border-cyan-500 flex-shrink-0"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("h2",{className:"font-bold text-sm md:text-base text-slate-100 truncate",children:x(i).name}),e.jsx("p",{className:"text-xs text-slate-400",children:"Online"})]})]}),e.jsxs("div",{className:"flex items-center gap-1 md:gap-2 flex-shrink-0",children:[e.jsx("button",{onClick:Ee,className:"p-2 hover:bg-slate-700 active:bg-slate-600 rounded-lg transition-colors group touch-manipulation",title:"Avvia chiamata vocale",children:e.jsx(U,{size:18,className:"text-slate-300 group-hover:text-green-400 md:w-5 md:h-5"})}),e.jsx("button",{onClick:$e,className:"p-2 hover:bg-slate-700 active:bg-slate-600 rounded-lg transition-colors group touch-manipulation",title:"Avvia videochiamata",children:e.jsx(R,{size:18,className:"text-slate-300 group-hover:text-cyan-400 md:w-5 md:h-5"})})]})]}),e.jsxs("div",{className:"flex-1 basis-0 min-h-0 overflow-y-auto p-3 md:p-4 space-y-3 md:space-y-4",children:[ge.map(a=>{var s,r;const t=a.senderId===l.uid;return e.jsx("div",{className:`flex ${t?"justify-end":"justify-start"}`,children:e.jsxs("div",{className:`flex items-end gap-2 max-w-[70%] ${t?"flex-row-reverse":""}`,children:[!t&&e.jsx("img",{src:a.senderPhotoURL||`https://ui-avatars.com/api/?name=${encodeURIComponent(a.senderName)}`,alt:a.senderName,className:"w-8 h-8 rounded-full object-cover"}),e.jsxs("div",{className:`rounded-2xl ${a.type==="call"?"bg-slate-700/50 border border-slate-600":t?"bg-gradient-to-r from-cyan-600 to-blue-600 text-white":"bg-slate-700 text-slate-100"}`,children:[a.type==="call"&&e.jsxs("div",{className:"px-4 py-3 flex items-center gap-3",children:[e.jsx("div",{className:`p-2 rounded-full ${a.callType==="video"?"bg-cyan-500/20":"bg-green-500/20"}`,children:a.callType==="video"?e.jsx(R,{size:16,className:"text-cyan-400"}):e.jsx(U,{size:16,className:"text-green-400"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"text-sm font-medium text-slate-200",children:a.callType==="video"?"Videochiamata":"Chiamata vocale"}),e.jsxs("p",{className:"text-xs text-slate-400",children:[a.callStatus==="calling"&&"In corso...",a.callStatus==="accepted"&&"âœ“ Accettata",a.callStatus==="declined"&&"âœ— Rifiutata",a.callStatus==="missed"&&"âœ— Persa",a.callStatus==="cancelled"&&"âœ— Annullata"]})]})]}),a.type==="image"&&e.jsx("img",{src:a.imageUrl,alt:"Immagine inviata",className:"max-w-xs rounded-lg cursor-pointer",onClick:()=>window.open(a.imageUrl,"_blank")}),a.type==="audio"&&e.jsxs("div",{className:"flex items-center gap-2 px-4 py-2",children:[e.jsx(me,{size:20}),e.jsx("audio",{controls:!0,className:"max-w-xs",children:e.jsx("source",{src:a.audioUrl,type:"audio/webm"})})]}),(!a.type||a.type==="text")&&e.jsx("p",{className:"break-words px-4 py-2",children:a.text}),e.jsxs("div",{className:"flex items-center gap-1 px-4 pb-2",children:[e.jsx("span",{className:"text-xs opacity-70",children:(r=(s=a.timestamp)==null?void 0:s.toDate)==null?void 0:r.call(s).toLocaleTimeString("it-IT",{hour:"2-digit",minute:"2-digit"})}),t&&(a.read?e.jsx(qe,{size:14,className:"text-cyan-300"}):e.jsx(Ge,{size:14,className:"opacity-70"}))]})]})]})},a.id)}),e.jsx("div",{ref:V})]}),e.jsx("div",{className:"flex-shrink-0 p-3 md:p-4 border-t border-slate-700 bg-slate-800/95 backdrop-blur-sm safe-area-bottom",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{ref:le,type:"file",accept:"image/*",onChange:Te,className:"hidden"}),e.jsx("button",{onClick:()=>{var a;return(a=le.current)==null?void 0:a.click()},disabled:C,className:"p-2 md:p-2.5 hover:bg-slate-700 rounded-lg transition-colors disabled:opacity-50 touch-manipulation",title:"Invia immagine",children:e.jsx(He,{size:18,className:"text-slate-400 md:w-5 md:h-5"})}),e.jsx("button",{onClick:g?_e:Ae,disabled:C,className:`p-2 md:p-2.5 rounded-lg transition-colors touch-manipulation ${g?"bg-red-600 hover:bg-red-700 animate-pulse":"hover:bg-slate-700"}`,title:g?"Ferma registrazione":"Registra audio",children:e.jsx(me,{size:18,className:`${g?"text-white":"text-slate-400"} md:w-5 md:h-5`})}),e.jsx("input",{type:"text",value:N,onChange:a=>H(a.target.value),onKeyDown:a=>a.key==="Enter"&&!a.shiftKey&&ie(),placeholder:C?"Invio...":g?"Registrando...":"Messaggio...",disabled:C||g,className:"flex-1 px-3 md:px-4 py-2 md:py-3 bg-slate-700 border border-slate-600 rounded-full text-sm md:text-base text-slate-100 placeholder:text-slate-400 focus:outline-none focus:ring-2 focus:ring-cyan-500 disabled:opacity-50"}),e.jsx("button",{onClick:ie,disabled:!N.trim()||ee||C||g,className:"p-2.5 md:p-3 bg-gradient-to-r from-cyan-600 to-blue-600 hover:from-cyan-700 hover:to-blue-700 disabled:opacity-50 disabled:cursor-not-allowed text-white rounded-full transition-all shadow-lg touch-manipulation",children:e.jsx(Je,{size:18,className:"md:w-5 md:h-5"})})]})})]}):e.jsx("div",{className:"flex-1 flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx(Ye,{size:64,className:"mx-auto mb-4 text-slate-600"}),e.jsx("h2",{className:"text-2xl font-bold text-slate-300 mb-2",children:"Seleziona una chat"}),e.jsx("p",{className:"text-slate-500",children:"Scegli una conversazione dalla lista o iniziane una nuova"})]})})},"chat-area")}),e.jsx(y,{children:ve&&e.jsx(f.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"fixed inset-0 bg-black/70 backdrop-blur-sm z-50 flex items-center justify-center p-4",onClick:()=>w(!1),children:e.jsxs(f.div,{initial:{scale:.9,y:20},animate:{scale:1,y:0},exit:{scale:.9,y:20},onClick:a=>a.stopPropagation(),className:"bg-slate-800 rounded-2xl shadow-2xl border border-slate-700 w-full max-w-lg max-h-[80vh] overflow-hidden",children:[e.jsxs("div",{className:"p-6 border-b border-slate-700",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h2",{className:"text-2xl font-bold text-slate-100",children:"Nuova Chat"}),e.jsx("button",{onClick:()=>w(!1),className:"p-2 hover:bg-slate-700 rounded-lg transition-colors",children:e.jsx(q,{size:20,className:"text-slate-400"})})]}),e.jsxs("div",{className:"relative",children:[e.jsx(de,{className:"absolute left-3 top-1/2 -translate-y-1/2 text-slate-400",size:20}),e.jsx("input",{type:"text",value:$,onChange:a=>ke(a.target.value),placeholder:"Cerca utente per nome o email...",className:"w-full pl-10 pr-4 py-3 bg-slate-700 border border-slate-600 rounded-lg text-slate-100 placeholder:text-slate-400 focus:outline-none focus:ring-2 focus:ring-cyan-500"})]})]}),e.jsx("div",{className:"p-6 overflow-y-auto max-h-[calc(80vh-180px)]",children:Z.length===0?e.jsxs("div",{className:"text-center py-8",children:[e.jsx(K,{size:48,className:"mx-auto mb-4 text-slate-600"}),e.jsx("p",{className:"text-slate-400",children:"Nessun utente trovato"})]}):e.jsx("div",{className:"space-y-2",children:Z.map(a=>e.jsxs("button",{onClick:()=>ze(a),className:"w-full p-3 flex items-center gap-3 hover:bg-slate-700/50 rounded-lg transition-all text-left",children:[e.jsx("img",{src:a.photoURL||`https://ui-avatars.com/api/?name=${encodeURIComponent(a.name)}`,alt:a.name,className:"w-12 h-12 rounded-full object-cover border-2 border-cyan-500"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h3",{className:"font-semibold text-slate-100",children:a.name}),a.email&&e.jsx("p",{className:"text-sm text-slate-400",children:a.email})]}),e.jsx(Ze,{size:20,className:"text-cyan-400"})]},a.id))})})]})})}),e.jsx(y,{children:d&&e.jsxs(f.div,{initial:{opacity:0,y:-20},animate:{opacity:1,y:0},exit:{opacity:0,y:-20},className:"fixed top-4 right-4 z-50 bg-slate-800 border-2 border-cyan-500 rounded-xl shadow-2xl p-4 max-w-sm",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-3",children:[e.jsx("img",{src:d.callerPhoto||`https://ui-avatars.com/api/?name=${encodeURIComponent(d.callerName)}`,alt:d.callerName,className:"w-12 h-12 rounded-full object-cover border-2 border-cyan-500 animate-pulse"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h3",{className:"font-bold text-slate-100",children:d.callerName}),e.jsx("p",{className:"text-sm text-slate-400 flex items-center gap-1",children:d.type==="voicecall"?e.jsxs(e.Fragment,{children:[e.jsx(U,{size:14,className:"text-green-400"}),"Chiamata vocale in arrivo..."]}):e.jsxs(e.Fragment,{children:[e.jsx(R,{size:14,className:"text-cyan-400"}),"Videochiamata in arrivo..."]})})]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("button",{onClick:async()=>{if(d.type==="voicecall"?(Q(d.roomId),_(!0),ne()):(F(d.roomId),A(!0)),await p(m(n,"notifications",d.id),{read:!0}),d.callMessageId){const a=I.filter(t=>t.participants.includes(d.callerId));if(a.length>0){const t=a[0].id;await p(m(n,"chats",t,"messages",d.callMessageId),{callStatus:"accepted"})}}z(null)},className:"flex-1 px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg font-semibold transition-colors flex items-center justify-center gap-2",children:[d.type==="voicecall"?e.jsx(U,{size:18}):e.jsx(R,{size:18}),"Accetta"]}),e.jsx("button",{onClick:async()=>{if(await p(m(n,"notifications",d.id),{read:!0}),d.callMessageId){const a=I.filter(t=>t.participants.includes(d.callerId));if(a.length>0){const t=a[0].id;await p(m(n,"chats",t,"messages",d.callMessageId),{callStatus:"declined"})}}z(null)},className:"flex-1 px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg font-semibold transition-colors",children:"Rifiuta"})]})]})}),e.jsx(y,{children:Me&&oe&&i&&e.jsx(f.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"fixed inset-0 bg-black/95 backdrop-blur-xl z-50 flex items-center justify-center p-4",children:e.jsxs(f.div,{initial:{scale:.8,opacity:0},animate:{scale:1,opacity:1},exit:{scale:.8,opacity:0},className:"bg-gradient-to-br from-slate-800 to-slate-900 rounded-3xl shadow-2xl border border-slate-700 w-full max-w-md overflow-hidden",children:[e.jsxs("div",{className:"p-6 text-center border-b border-slate-700/50",children:[e.jsxs("div",{className:"relative inline-block mb-4",children:[e.jsx("img",{src:x(i).photoURL||`https://ui-avatars.com/api/?name=${encodeURIComponent(x(i).name)}`,alt:x(i).name,className:"w-32 h-32 rounded-full object-cover border-4 border-green-500 shadow-xl"}),e.jsx("div",{className:"absolute inset-0 rounded-full border-4 border-green-500 animate-ping opacity-50"})]}),e.jsx("h2",{className:"text-2xl font-bold text-slate-100 mb-1",children:x(i).name}),e.jsxs("p",{className:"text-green-400 font-medium flex items-center justify-center gap-2",children:[e.jsx(U,{size:16,className:"animate-pulse"}),"Chiamata in corso"]})]}),e.jsxs("div",{className:"p-6 text-center",children:[e.jsx("div",{className:"text-5xl font-bold text-slate-100 mb-2 font-mono",children:Pe(De)}),e.jsx("p",{className:"text-sm text-slate-400",children:"Durata chiamata"})]}),e.jsx("div",{className:"hidden",children:e.jsx("iframe",{src:`https://meet.jit.si/${oe}#config.startWithVideoMuted=true&config.startWithAudioMuted=false`,allow:"microphone; speaker",className:"w-full h-full border-0",title:"Voice Call"})}),e.jsx("div",{className:"p-6",children:e.jsxs("button",{onClick:async()=>{if(b.current){try{const{chatId:a,messageId:t}=b.current;await p(m(n,"chats",a,"messages",t),{callStatus:"cancelled"})}catch(a){console.error("Errore aggiornamento stato chiamata:",a)}b.current=null}_(!1),Q(null),Ve()},className:"w-full py-4 bg-red-600 hover:bg-red-700 text-white rounded-2xl font-bold text-lg transition-all shadow-lg flex items-center justify-center gap-3",children:[e.jsx(q,{size:24}),"Termina Chiamata"]})})]})})}),e.jsx(y,{children:Le&&re&&e.jsx(f.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"fixed inset-0 bg-black/90 backdrop-blur-sm z-50 flex items-center justify-center p-4",children:e.jsxs(f.div,{initial:{scale:.9},animate:{scale:1},exit:{scale:.9},className:"bg-slate-900 rounded-2xl shadow-2xl border border-slate-700 w-full max-w-6xl h-[90vh] overflow-hidden flex flex-col",children:[e.jsxs("div",{className:"p-4 border-b border-slate-700 flex items-center justify-between bg-slate-800",children:[e.jsxs("h2",{className:"text-xl font-bold text-slate-100 flex items-center gap-2",children:[e.jsx(R,{size:24,className:"text-cyan-500"}),"Videochiamata in corso"]}),e.jsx("button",{onClick:async()=>{if(b.current){try{const{chatId:a,messageId:t}=b.current;await p(m(n,"chats",a,"messages",t),{callStatus:"cancelled"})}catch(a){console.error("Errore aggiornamento stato chiamata:",a)}b.current=null}A(!1),F(null)},className:"p-2 bg-red-600 hover:bg-red-700 rounded-lg transition-colors",title:"Termina chiamata",children:e.jsx(q,{size:20,className:"text-white"})})]}),e.jsx("div",{className:"flex-1 relative",children:e.jsx("iframe",{src:`https://meet.jit.si/${re}`,allow:"camera; microphone; fullscreen; speaker; display-capture",className:"w-full h-full border-0",title:"Video Call"})})]})})})]})}):e.jsx("div",{className:"flex items-center justify-center min-h-screen bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 p-4",children:e.jsxs(f.div,{initial:{opacity:0,scale:.9},animate:{opacity:1,scale:1},className:"bg-slate-800 border-2 border-amber-500 rounded-2xl shadow-2xl p-8 max-w-md text-center",children:[e.jsx("div",{className:"w-20 h-20 bg-amber-500/20 rounded-full flex items-center justify-center mx-auto mb-4",children:e.jsx(K,{size:40,className:"text-amber-500"})}),e.jsx("h2",{className:"text-2xl font-bold text-slate-100 mb-3",children:"Completa il tuo profilo"}),e.jsx("p",{className:"text-slate-400 mb-2",children:"Per accedere alla chat devi completare il tuo profilo Community con:"}),e.jsxs("ul",{className:"text-left text-slate-300 space-y-2 mb-6 bg-slate-700/50 rounded-lg p-4",children:[e.jsxs("li",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-2 h-2 bg-amber-500 rounded-full"}),"Nome completo"]}),e.jsxs("li",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-2 h-2 bg-amber-500 rounded-full"}),"Foto profilo"]})]}),e.jsx("button",{onClick:()=>{D(we==="client"?"/client/community":"/community")},className:"w-full px-6 py-3 bg-gradient-to-r from-amber-600 to-orange-600 hover:from-amber-700 hover:to-orange-700 text-white rounded-lg font-semibold transition-all shadow-lg",children:"Vai alla Community"}),e.jsx("p",{className:"text-xs text-slate-500 mt-4",children:"Dopo aver completato il profilo, torna qui per accedere alla chat"})]})}):e.jsx("div",{className:"flex items-center justify-center min-h-screen bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900",children:e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-slate-400 mb-4",children:"Devi effettuare il login"}),e.jsx("button",{onClick:()=>D("/login"),className:"px-6 py-3 bg-cyan-600 hover:bg-cyan-700 text-white rounded-lg font-medium transition-colors",children:"Vai al Login"})]})})}export{ra as default};
