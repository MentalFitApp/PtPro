var D=Object.defineProperty;var k=(r,o,t)=>o in r?D(r,o,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[o]=t;var S=(r,o,t)=>k(r,typeof o!="symbol"?o+"":o,t);import{r as l,h as q,g as A,j as e,q as f,L as P,aY as U,A as F,aZ as I,f as E,e as g,R as B,a_ as $,a$ as K,b0 as M,u as V}from"./.pnpm-C04Ba0Xq.js";import{d as v}from"./index-DdCoIfwr.js";class W extends B.Component{constructor(){super(...arguments);S(this,"state",{hasError:!1,error:null})}static getDerivedStateFromError(t){return{hasError:!0,error:t}}render(){return this.state.hasError?e.jsxs("div",{className:"text-center text-red-400 p-8",children:["Si è verificato un errore: ",this.state.error.message,". Riprova o contatta il supporto."]}):this.props.children}}const Y=()=>e.jsx("div",{className:"absolute inset-0 -z-10 overflow-hidden bg-slate-900",children:e.jsx("div",{className:"aurora-background"})}),J=()=>{const[r,o]=l.useState(""),[t,C]=l.useState(""),[w,R]=l.useState(""),[b,i]=l.useState(""),[m,j]=l.useState(""),[y,c]=l.useState(!1),[u,N]=l.useState(""),d=q(),a=A().currentUser;l.useEffect(()=>{(async()=>{if(!a){d("/login");return}try{const s=await E(g(v,"clients",a.uid));if(s.exists()&&s.data().firstLogin){N("client");return}const h=await E(g(v,"collaboratori",a.uid));if(h.exists()&&h.data().firstLogin){N("collaboratore");return}d(s.exists()?"/client/dashboard":"/collaboratore/dashboard")}catch{i("Errore verifica account.")}})()},[a,d]);const T=async n=>{if(n.preventDefault(),i(""),j(""),c(!0),!a){i("Utente non autenticato. Effettua nuovamente il login."),setTimeout(()=>d("/login"),3e3),c(!1);return}if(!r){i("Inserisci la password temporanea ricevuta."),c(!1);return}if(t.length<6){i("La nuova password deve contenere almeno 6 caratteri."),c(!1);return}if(t!==w){i("Le password non coincidono. Riprova."),c(!1);return}try{const s=$.credential(a.email,r);await K(a,s),await M(a,t);const z=g(v,u==="client"?"clients":"collaboratori",a.uid);await V(z,{firstLogin:!1}),console.log(`Campo firstLogin aggiornato a false per ${u}:`,a.uid),await new Promise(L=>setTimeout(L,500)),j("Password aggiornata! Sarai reindirizzato alla dashboard."),setTimeout(()=>{d(u==="client"?"/client/dashboard":"/collaboratore/dashboard")},2e3)}catch(s){console.error("Errore aggiornamento password:",s.code,s.message,{uid:a==null?void 0:a.uid,userType:u}),s.code==="auth/wrong-password"?i("La password temporanea inserita non è corretta. Verifica e riprova."):s.code==="auth/too-many-requests"?i("Troppi tentativi falliti. Riprova più tardi o contatta il supporto."):s.code==="auth/requires-recent-login"?(i("Sessione scaduta. Effettua nuovamente il login e riprova."),setTimeout(()=>d("/login"),3e3)):i("Si è verificato un errore durante l'aggiornamento della password. "+(s.message||"Riprova.")),c(!1)}},p="w-full pl-10 pr-3 py-2.5 mt-1 bg-slate-700/50 border border-slate-600 rounded-lg outline-none focus:ring-2 focus:ring-cyan-500 text-slate-200 placeholder:text-slate-500",x="block text-sm font-medium text-slate-300";return u?e.jsx(W,{children:e.jsxs("div",{className:"min-h-screen flex items-center justify-center p-4 relative",children:[e.jsx(Y,{}),e.jsxs(f.div,{initial:{opacity:0,scale:.95},animate:{opacity:1,scale:1},className:"w-full max-w-md bg-slate-900/60 backdrop-blur-xl rounded-2xl border border-slate-700 p-8 space-y-8",children:[e.jsxs("div",{className:"text-center",children:[e.jsx("h2",{className:"text-3xl font-bold text-slate-50",children:"Imposta la tua Password"}),e.jsx("p",{className:"mt-2 text-slate-400",children:"Scegli una password personale per i futuri accessi."})]}),e.jsxs("form",{onSubmit:T,className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"current-password",className:x,children:"Password Temporanea"}),e.jsxs("div",{className:"relative",children:[e.jsx(P,{className:"absolute left-3 top-1/2 -translate-y-1/2 text-slate-400",size:18}),e.jsx("input",{id:"current-password",type:"password",required:!0,value:r,onChange:n=>o(n.target.value),className:p,placeholder:"Inserisci la password temporanea"})]}),e.jsx("p",{className:"text-xs text-slate-500 mt-1",children:"Usa la password temporanea che hai ricevuto via email"})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"new-password",className:x,children:"Nuova Password"}),e.jsxs("div",{className:"relative",children:[e.jsx(U,{className:"absolute left-3 top-1/2 -translate-y-1/2 text-slate-400",size:18}),e.jsx("input",{id:"new-password",type:"password",required:!0,value:t,onChange:n=>C(n.target.value),className:p,placeholder:"Minimo 6 caratteri"})]})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"confirm-password",className:x,children:"Conferma Nuova Password"}),e.jsxs("div",{className:"relative",children:[e.jsx(P,{className:"absolute left-3 top-1/2 -translate-y-1/2 text-slate-400",size:18}),e.jsx("input",{id:"confirm-password",type:"password",required:!0,value:w,onChange:n=>R(n.target.value),className:p,placeholder:"Ripeti la nuova password"})]})]}),e.jsxs(F,{children:[b&&e.jsx(f.p,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"text-red-400 text-sm text-center",children:b}),m&&e.jsxs(f.p,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"text-emerald-400 text-sm text-center flex items-center justify-center gap-2",children:[e.jsx(I,{size:16}),m]})]}),e.jsx("div",{children:e.jsx("button",{type:"submit",className:"w-full px-4 py-2.5 font-bold text-white bg-cyan-600 rounded-lg hover:bg-cyan-700 disabled:opacity-50 transition-colors",disabled:y||!!m,children:m?"Reindirizzamento...":y?"Salvataggio...":"Imposta Nuova Password"})})]})]})]})}):e.jsx("div",{className:"min-h-screen flex items-center justify-center",children:e.jsx("div",{className:"animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-rose-500"})})};export{J as default};
