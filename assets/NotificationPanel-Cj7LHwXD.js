import{r as a,j as e}from"./react-CrXOBDSJ.js";import{a as l,d as o}from"./index-pOkjm1YA.js";import{H as C,I as S,R as j,G as z,D as P,Y as Z,Z as B,A as d,y as m}from"./@firebase-DgmhcEwT.js";import{m as x,A as D}from"./framer-motion-BAPjnw1b.js";import{a5 as H,B as g,X as I,y as T}from"./lucide-react-CCY59hBS.js";function Q({userType:u="client"}){const[n,y]=a.useState([]),[h,f]=a.useState(!1),[p,b]=a.useState(!1),[c,w]=a.useState(0);a.useEffect(()=>{if(!l.currentUser)return;const t=Notification.permission;f(t==="granted");const s=C(z(o,"notifications"),j("userId","==",l.currentUser.uid),j("userType","==",u),S("sentAt","desc")),r=P(s,E=>{const N=E.docs.map(i=>({id:i.id,...i.data()}));y(N),w(N.filter(i=>!i.read).length)});return()=>r()},[u]);const v=async()=>{try{if(await Notification.requestPermission()==="granted"){f(!0);const s=Z(),r=await B(s,{vapidKey:"BLp0b5Z5uqZ3yFHYQcEY6Q7K4FZ5YHT9OHQ7Y5Z5O5Z5"});r&&await d(m(o,"fcmTokens",l.currentUser.uid),{token:r,updatedAt:new Date})}}catch(t){console.error("Errore attivazione notifiche:",t)}},k=async t=>{try{await d(m(o,"notifications",t),{read:!0})}catch(s){console.error("Errore marcatura notifica letta:",s)}},A=async()=>{try{const t=n.filter(s=>!s.read);await Promise.all(t.map(s=>d(m(o,"notifications",s.id),{read:!0})))}catch(t){console.error("Errore marcatura tutte lette:",t)}};return e.jsxs("div",{className:"relative",children:[!h&&e.jsxs(x.button,{onClick:v,whileHover:{scale:1.05},whileTap:{scale:.95},className:"flex items-center gap-2 px-4 py-2 bg-rose-600 hover:bg-rose-700 text-white rounded-lg font-medium transition-colors",children:[e.jsx(H,{size:18}),"Attiva Notifiche"]}),h&&e.jsxs("button",{onClick:()=>b(!p),className:"relative p-2 hover:bg-white/10 rounded-lg transition-colors",children:[e.jsx(g,{size:24,className:"text-slate-300"}),c>0&&e.jsx("span",{className:"absolute -top-1 -right-1 bg-rose-600 text-white text-xs font-bold rounded-full w-5 h-5 flex items-center justify-center",children:c})]}),e.jsx(D,{children:p&&e.jsxs(x.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},exit:{opacity:0,y:10},className:"absolute right-0 top-14 w-96 max-h-[500px] bg-slate-800 border border-slate-700 rounded-xl shadow-2xl z-50 overflow-hidden",children:[e.jsxs("div",{className:"flex items-center justify-between p-4 border-b border-slate-700",children:[e.jsx("h3",{className:"font-bold text-slate-200",children:"Notifiche"}),e.jsxs("div",{className:"flex items-center gap-2",children:[c>0&&e.jsx("button",{onClick:A,className:"text-xs text-rose-400 hover:text-rose-300 transition-colors",children:"Segna tutte lette"}),e.jsx("button",{onClick:()=>b(!1),className:"p-1 hover:bg-white/10 rounded transition-colors",children:e.jsx(I,{size:18,className:"text-slate-400"})})]})]}),e.jsx("div",{className:"overflow-y-auto max-h-[420px]",children:n.length===0?e.jsxs("div",{className:"p-8 text-center text-slate-400",children:[e.jsx(g,{size:48,className:"mx-auto mb-3 opacity-30"}),e.jsx("p",{children:"Nessuna notifica"})]}):n.map(t=>{var s;return e.jsx(x.div,{layout:!0,className:`p-4 border-b border-slate-700 hover:bg-white/5 transition-colors cursor-pointer ${t.read?"":"bg-rose-900/10"}`,onClick:()=>!t.read&&k(t.id),children:e.jsxs("div",{className:"flex items-start justify-between gap-3",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("h4",{className:"font-medium text-slate-200 text-sm",children:t.title}),!t.read&&e.jsx("span",{className:"w-2 h-2 bg-rose-500 rounded-full"})]}),e.jsx("p",{className:"text-sm text-slate-400",children:t.body}),e.jsx("p",{className:"text-xs text-slate-500 mt-2",children:(s=t.sentAt)==null?void 0:s.toDate().toLocaleDateString("it-IT",{day:"numeric",month:"short",hour:"2-digit",minute:"2-digit"})})]}),t.read&&e.jsx(T,{size:16,className:"text-emerald-500 flex-shrink-0"})]})},t.id)})})]})})]})}export{Q as N};
