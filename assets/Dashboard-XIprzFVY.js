import{h as xe,r as d,G as q,T as S,V as P,e as L,W as k,X as A,Y as z,j as e,Z as W,$ as pe,U as ue,a0 as he,x as X,a1 as ge,a2 as Z,a3 as J,a4 as fe,a5 as ye,B as be,A as we,f as $,a6 as je,a7 as Ne,R as ve,q as De,F as Se,a8 as Ce,a9 as ke,aa as Ee,ab as Me,ac as Ae,ad as $e,ae as Fe,af as ze,ag as Re,ah as Ie}from"./.pnpm-C04Ba0Xq.js";import{a as V,t as g,d as j}from"./index-DdCoIfwr.js";ke.register(Ee,Me,Ae,$e,Fe,ze,Re,Ie);const Le=p=>{if(!p)return"";const i=Math.floor((new Date-g(p))/1e3);let x=i/31536e3;return x>1?Math.floor(x)+" anni fa":(x=i/2592e3,x>1?Math.floor(x)+" mesi fa":(x=i/86400,x>1?Math.floor(x)+" gg fa":(x=i/3600,x>1?Math.floor(x)+" ore fa":(x=i/60,x>1?Math.floor(x)+" min fa":"ora"))))},O=({title:p,value:i,icon:x,isCurrency:E=!1,isPercentage:M=!1})=>e.jsxs("div",{className:"bg-slate-800/60 backdrop-blur-sm p-3 sm:p-5 rounded-xl border border-slate-700 shadow-xl h-full",children:[e.jsxs("div",{className:"flex items-center gap-2 sm:gap-3 text-slate-400",children:[ve.cloneElement(x,{size:18,className:`sm:w-5 sm:h-5 ${x.props.className||""}`}),e.jsx("p",{className:"text-xs sm:text-sm font-medium truncate",children:p})]}),e.jsx("p",{className:"text-2xl sm:text-3xl font-bold text-slate-100 mt-2 sm:mt-3 truncate",children:E?new Intl.NumberFormat("it-IT",{style:"currency",currency:"EUR"}).format(i):M?`${i}%`:i})]}),Te=({item:p,navigate:i})=>{const x={expiring:e.jsx(Ce,{className:"text-yellow-500",size:18}),new_check:e.jsx(Z,{className:"text-green-500",size:18}),new_anamnesi:e.jsx(Se,{className:"text-blue-500",size:18}),renewal:e.jsx(J,{className:"text-emerald-500",size:18})},E={expiring:"payments",new_check:"check",new_anamnesi:"anamnesi",renewal:"payments"};return e.jsxs(De.button,{layout:!0,initial:{opacity:0,y:10},animate:{opacity:1,y:0},exit:{opacity:0,x:-10},transition:{duration:.3},onClick:()=>i(`/client/${p.clientId}?tab=${E[p.type]}`),className:"w-full flex items-start gap-4 p-3 rounded-lg bg-slate-500/5 hover:bg-slate-500/10 transition-colors text-left",children:[e.jsx("div",{className:"mt-1 flex-shrink-0",children:x[p.type]}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"text-sm font-semibold text-slate-200",children:p.clientName}),e.jsx("p",{className:"text-xs text-slate-400",children:p.description})]}),e.jsx("div",{className:"text-xs text-slate-500 flex-shrink-0",children:Le(p.date)})]})};function Pe(){const p=xe(),[i,x]=d.useState([]),[E,M]=d.useState([]),[ee,te]=d.useState(0),[R,se]=d.useState(null),[T,ae]=d.useState(null),[ne,re]=d.useState(0),[oe,Y]=d.useState(!0),[v,Q]=d.useState("revenue"),[D,_]=d.useState("monthly"),[B,K]=d.useState([]),[U,I]=d.useState(null);d.useEffect(()=>{const t=sessionStorage.getItem("app_role");if(t!=="admin"&&t!=="coach"){q(V).then(()=>{p("/login")}).catch(l=>{console.error("Logout error:",l),I("Errore durante il logout")});return}},[p]);const[le,ce]=d.useState("");d.useEffect(()=>{const t=V.onAuthStateChanged(l=>{var a;l&&ce(l.displayName||((a=l.email)==null?void 0:a.split("@")[0])||"Admin")});return()=>t()},[]);const G=async()=>{try{await q(V),p("/login")}catch(t){I(`Errore durante il logout: ${t.message}`)}},ie=d.useMemo(()=>{const t=new Date;return{active:i.filter(a=>{const h=g(a.scadenza);return h&&h>t}).length}},[i]);d.useEffect(()=>{const t=S(P(j,"clients"),l=>{try{const a=l.docs.map(h=>({id:h.id,...h.data()}));x(a),Y(!1)}catch(a){console.error("Errore recupero clienti:",a),I("Errore nel recupero dei clienti."),Y(!1)}},l=>{console.error("Errore snapshot clienti:",l),I("Errore connessione."),Y(!1)});return()=>t()},[]),d.useEffect(()=>{const t=L(j,"app-data","lastViewed");(async()=>{try{const a=await $(t),h=a.exists()?a.data().timestamp:null;se(h),await je(t,{timestamp:Ne()},{merge:!0})}catch(a){console.error("Errore lastViewed:",a)}})()},[]),d.useEffect(()=>{if(!R)return;let t=[];const l=new Date,a=new Date(l.getFullYear(),l.getMonth(),1),h=k(z(j,"payments"),A("paymentDate","desc")),C=S(h,async o=>{try{const c=[];for(const n of o.docs){const m=n.data(),y=g(m.paymentDate);if(y&&y>=a){const N=n.ref.parent.parent.id,F=await $(L(j,"clients",N));if(F.exists()){const H=F.data();!H.isOldClient&&!m.isPast&&c.push({type:"renewal",clientId:N,clientName:H.name||"Cliente",description:`Rinnovo di ${m.duration} per ${new Intl.NumberFormat("it-IT",{style:"currency",currency:"EUR"}).format(m.amount||0)}`,date:m.paymentDate})}}}M(n=>[...n.filter(m=>m.type!=="renewal"),...c])}catch(c){console.error("Errore snapshot pagamenti:",c)}});t.push(C);const u=k(z(j,"checks"),A("createdAt","desc")),f=S(u,async o=>{try{const c=[];for(const n of o.docs)if(g(n.data().createdAt)>g(R)){const y=n.ref.parent.parent.id,N=await $(L(j,"clients",y));c.push({type:"new_check",clientId:y,clientName:N.exists()&&N.data().name||"Cliente",description:"Ha inviato un nuovo check-in",date:n.data().createdAt})}M(n=>[...n.filter(m=>m.type!=="new_check"),...c])}catch(c){console.error("Errore snapshot checks:",c)}});t.push(f);const w=k(z(j,"anamnesi"),A("submittedAt","desc")),b=S(w,async o=>{try{const c=[];for(const n of o.docs)if(g(n.data().submittedAt)>g(R)){const y=n.ref.parent.parent.id,N=await $(L(j,"clients",y));c.push({type:"new_anamnesi",clientId:y,clientName:N.exists()&&N.data().name||"Cliente",description:"Ha compilato l'anamnesi iniziale",date:n.data().submittedAt})}M(n=>[...n.filter(m=>m.type!=="new_anamnesi"),...c])}catch(c){console.error("Errore snapshot anamnesi:",c)}});t.push(b);const s=k(P(j,"clients")),r=S(s,o=>{try{const c=o.docs.map(n=>({id:n.id,...n.data()})).filter(n=>{const m=g(n.scadenza);if(!m)return!1;const y=(m-new Date)/(1e3*60*60*24);return y<=15&&y>0}).map(n=>({type:"expiring",clientId:n.id,clientName:n.name,description:`Abbonamento in scadenza tra ${Math.ceil((g(n.scadenza)-new Date)/864e5)} giorni`,date:n.scadenza}));M(n=>[...n.filter(m=>m.type!=="expiring"),...c])}catch(c){console.error("Errore snapshot clienti:",c)}});return t.push(r),()=>{t.forEach(o=>o())}},[R]),d.useEffect(()=>{const t=new Date,l=new Date(t.getFullYear(),t.getMonth(),1),a=k(z(j,"payments"),A("paymentDate","desc")),h=S(a,async C=>{try{let u=0;for(const f of C.docs){const w=g(f.data().paymentDate);if(w&&w>=l){const b=f.ref.parent.parent,s=await $(b);s.exists()&&!s.data().isOldClient&&!f.data().isPast&&(u+=f.data().amount||0)}}te(u)}catch(u){console.error("Errore snapshot pagamenti:",u)}});return()=>h()},[]),d.useEffect(()=>{if(i.length>0){const t=i.filter(l=>{const a=g(l.scadenza);return a&&a>new Date}).length;re(Math.round(t/i.length*100))}},[i]),d.useEffect(()=>{if(i.length>0){const t=i[Math.floor(Math.random()*i.length)];ae({name:t.name,goal:t.goal})}},[i]),d.useEffect(()=>{let t=null;return(async()=>{const a=new Date;if(v==="revenue"){const h=k(z(j,"payments"),A("paymentDate","asc"));t=S(h,async C=>{try{const u={},f={},w={};for(const s of C.docs){const r=g(s.data().paymentDate),o=s.ref.parent.parent,c=await $(o);if(r&&c.exists()&&!c.data().isOldClient&&!s.data().isPast){const m=s.data().amount||0,y=r.toLocaleDateString("it-IT");u[y]=(u[y]||0)+m;const N=`${r.getFullYear()}-${String(r.getMonth()+1).padStart(2,"0")}`;f[N]=(f[N]||0)+m;const F=r.getFullYear().toString();w[F]=(w[F]||0)+m}}let b=[];if(D==="daily")for(let s=29;s>=0;s--){const o=new Date(a.getFullYear(),a.getMonth(),a.getDate()-s).toLocaleDateString("it-IT");b.push({name:o,value:u[o]||0})}else if(D==="monthly")for(let s=11;s>=0;s--){const r=new Date(a.getFullYear(),a.getMonth()-s,1),o=`${r.getFullYear()}-${String(r.getMonth()+1).padStart(2,"0")}`;b.push({name:o,value:f[o]||0})}else for(let s=4;s>=0;s--){const r=a.getFullYear()-s;b.push({name:r.toString(),value:w[r]||0})}K(b)}catch(u){console.error("Errore chart revenue:",u)}})}else{const h=k(P(j,"clients"),A("createdAt","asc"));t=S(h,C=>{try{const u={},f={},w={};C.docs.forEach(s=>{const r=g(s.data().createdAt);if(r){const o=r.toLocaleDateString("it-IT");u[o]=(u[o]||0)+1;const c=`${r.getFullYear()}-${String(r.getMonth()+1).padStart(2,"0")}`;f[c]=(f[c]||0)+1;const n=r.getFullYear().toString();w[n]=(w[n]||0)+1}});let b=[];if(D==="daily")for(let s=29;s>=0;s--){const o=new Date(a.getFullYear(),a.getMonth(),a.getDate()-s).toLocaleDateString("it-IT");b.push({name:o,value:u[o]||0})}else if(D==="monthly")for(let s=11;s>=0;s--){const r=new Date(a.getFullYear(),a.getMonth()-s,1),o=`${r.getFullYear()}-${String(r.getMonth()+1).padStart(2,"0")}`;b.push({name:o,value:f[o]||0})}else for(let s=4;s>=0;s--){const r=a.getFullYear()-s;b.push({name:r.toString(),value:w[r]||0})}K(b)}catch(u){console.error("Errore chart clienti:",u)}})}})(),()=>{t&&t()}},[v,D]);const me={responsive:!0,maintainAspectRatio:!1,scales:{x:{grid:{display:!1},ticks:{color:"#e2e8f0",font:{size:11}}},y:{grid:{color:"rgba(255, 255, 255, 0.1)"},ticks:{color:"#e2e8f0",font:{size:11}}}},plugins:{legend:{position:"top",labels:{font:{size:12},color:"#e2e8f0"}},tooltip:{callbacks:{label:t=>`${t.dataset.label}: ${v==="revenue"?`€${t.raw}`:t.raw}`}}}},de={labels:B.map(t=>t.name),datasets:[{label:v==="revenue"?"Fatturato (€)":"Nuovi Clienti",data:B.map(t=>t.value),borderColor:v==="revenue"?"#22c55e":"#6366f1",backgroundColor:v==="revenue"?"rgba(34, 197, 94, 0.2)":"rgba(99, 102, 241, 0.2)",fill:!0,tension:.4,pointRadius:4,pointHoverRadius:6}]};return oe?e.jsx("div",{className:"min-h-screen flex items-center justify-center p-4",children:e.jsx("div",{className:"animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-rose-500"})}):U?e.jsx("div",{className:"min-h-screen flex items-center justify-center p-4",children:e.jsxs("div",{className:"bg-red-900/80 p-6 rounded-lg text-center",children:[e.jsx("h2",{className:"text-xl font-bold text-red-300 mb-2",children:"Errore"}),e.jsx("p",{className:"text-red-400",children:U}),e.jsx("button",{onClick:G,className:"mt-4 px-4 py-2 bg-red-600 text-white rounded-lg",children:"Torna al Login"})]})}):e.jsx("div",{className:"min-h-screen overflow-x-hidden w-full",children:e.jsxs("div",{className:"w-full py-4 sm:py-6 space-y-4 sm:space-y-6 mobile-safe-bottom",children:[e.jsxs("div",{className:"bg-slate-800/30 backdrop-blur-xl border border-white/10 rounded-2xl p-3 sm:p-5 space-y-3 sm:space-y-5 mx-3 sm:mx-6",children:[e.jsxs("div",{className:"flex flex-col gap-3 sm:flex-row sm:justify-between sm:items-center",children:[e.jsxs("h1",{className:"text-xl sm:text-2xl lg:text-3xl font-bold text-slate-100 flex items-center gap-2",children:[e.jsx(W,{size:24,className:"sm:w-7 sm:h-7"})," Dashboard"]}),e.jsxs("div",{className:"flex items-center gap-2 sm:gap-3",children:[e.jsx("span",{className:"text-slate-300 font-semibold text-sm sm:text-base truncate flex-1 sm:flex-none",children:le}),e.jsxs("button",{onClick:G,className:"flex items-center justify-center gap-1.5 sm:gap-2 px-3 sm:px-4 py-1.5 sm:py-2 bg-rose-600 hover:bg-rose-700 text-white text-xs sm:text-sm font-medium rounded-lg transition-colors whitespace-nowrap",children:[e.jsx(pe,{size:14,className:"sm:w-4 sm:h-4"})," ",e.jsx("span",{className:"hidden sm:inline",children:"Logout"})]})]})]}),e.jsx("div",{className:"border-t border-white/10"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-slate-400 text-xs sm:text-sm mb-3",children:"Panoramica delle metriche chiave e progressi in tempo reale."}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsxs("button",{onClick:()=>p("/clients"),className:"px-3 sm:px-4 py-1.5 sm:py-2 bg-slate-700/50 hover:bg-slate-700/70 text-slate-300 text-xs sm:text-sm font-medium rounded-lg transition-colors flex items-center gap-1.5 sm:gap-2",children:[e.jsx(ue,{size:14,className:"sm:w-4 sm:h-4"})," ",e.jsx("span",{children:"Gestisci"})]}),e.jsxs("button",{onClick:()=>p("/new-client"),className:"px-3 sm:px-4 py-1.5 sm:py-2 bg-rose-600 hover:bg-rose-700 text-white text-xs sm:text-sm font-medium rounded-lg transition-colors flex items-center gap-1.5 sm:gap-2",children:[e.jsx(he,{size:14,className:"sm:w-4 sm:h-4"})," ",e.jsx("span",{children:"Nuovo"})]}),e.jsxs("button",{onClick:()=>p("/business-history"),className:"px-3 sm:px-4 py-1.5 sm:py-2 bg-cyan-600 hover:bg-cyan-700 text-white text-xs sm:text-sm font-medium rounded-lg transition-colors flex items-center gap-1.5 sm:gap-2",children:[e.jsx(X,{size:14,className:"sm:w-4 sm:h-4"})," ",e.jsx("span",{children:"Storico"})]}),e.jsxs("button",{onClick:()=>p("/analytics"),className:"px-3 sm:px-4 py-1.5 sm:py-2 bg-purple-600 hover:bg-purple-700 text-white text-xs sm:text-sm font-medium rounded-lg transition-colors flex items-center gap-1.5 sm:gap-2",children:[e.jsx(W,{size:14,className:"sm:w-4 sm:h-4"})," ",e.jsx("span",{children:"Analytics"})]})]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-4 sm:gap-6 mx-3 sm:mx-6",children:[e.jsxs("div",{className:"lg:col-span-2 space-y-4 sm:space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 sm:gap-5",children:[e.jsx(O,{title:"Incasso Mensile",value:ee,icon:e.jsx(ge,{className:"text-green-500"}),isCurrency:!0}),e.jsx(O,{title:"Clienti Attivi",value:ie.active,icon:e.jsx(Z,{className:"text-blue-500"})}),e.jsx(O,{title:"Retention Rate",value:ne,icon:e.jsx(J,{className:"text-amber-500"}),isPercentage:!0})]}),e.jsxs("div",{className:"bg-slate-800/60 backdrop-blur-sm rounded-xl p-3 sm:p-6 border border-slate-700 shadow-xl",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row justify-between items-start sm:items-center gap-2 mb-3 sm:mb-4",children:[e.jsxs("h2",{className:"text-base sm:text-lg font-semibold text-slate-100 flex items-center gap-2",children:[e.jsx(X,{size:18,className:"sm:w-5 sm:h-5"})," Andamento Business"]}),e.jsxs("div",{className:"flex gap-1 sm:gap-2 bg-slate-800/40 backdrop-blur-xl border border-white/10 p-0.5 sm:p-1 rounded-lg overflow-x-auto shrink-0",children:[e.jsx("button",{onClick:()=>Q("revenue"),className:`px-2 sm:px-3 py-1 text-xs sm:text-sm rounded-md transition whitespace-nowrap ${v==="revenue"?"bg-rose-600 text-white":"text-slate-400 hover:bg-white/10"}`,children:"Fatturato"}),e.jsx("button",{onClick:()=>Q("clients"),className:`px-2 sm:px-3 py-1 text-xs sm:text-sm rounded-md transition whitespace-nowrap ${v==="clients"?"bg-rose-600 text-white":"text-slate-400 hover:bg-white/10"}`,children:"Clienti"})]})]}),e.jsx("div",{className:"mobile-chart-container",children:e.jsx(fe,{data:de,options:me})}),e.jsx("div",{className:"flex justify-center mt-3 sm:mt-4",children:e.jsxs("div",{className:"flex gap-1 sm:gap-2 bg-slate-800/40 backdrop-blur-xl border border-white/10 p-0.5 sm:p-1 rounded-lg flex-wrap justify-center",children:[e.jsx("button",{onClick:()=>_("daily"),className:`px-2 sm:px-3 py-0.5 sm:py-1 text-[10px] sm:text-xs rounded-md transition ${D==="daily"?"bg-rose-600 text-white":"text-slate-400 hover:bg-white/10"}`,children:"Giorno"}),e.jsx("button",{onClick:()=>_("monthly"),className:`px-2 sm:px-3 py-0.5 sm:py-1 text-[10px] sm:text-xs rounded-md transition ${D==="monthly"?"bg-rose-600 text-white":"text-slate-400 hover:bg-white/10"}`,children:"Mese"}),e.jsx("button",{onClick:()=>_("yearly"),className:`px-2 sm:px-3 py-0.5 sm:py-1 text-[10px] sm:text-xs rounded-md transition ${D==="yearly"?"bg-rose-600 text-white":"text-slate-400 hover:bg-white/10"}`,children:"Anno"})]})})]}),T&&e.jsxs("div",{className:"bg-slate-800/60 backdrop-blur-sm rounded-xl p-3 sm:p-4 border border-slate-700 shadow-xl",children:[e.jsxs("h2",{className:"text-base sm:text-lg font-semibold mb-2 sm:mb-3 flex items-center gap-2 text-slate-100",children:[e.jsx(ye,{size:16,className:"sm:w-5 sm:h-5"})," Focus del Giorno"]}),e.jsx("p",{className:"text-sm font-bold text-rose-400 truncate",children:T.name}),e.jsxs("p",{className:"text-xs sm:text-sm text-slate-400 mt-1 line-clamp-2",children:['Obiettivo: "',T.goal||"Non specificato",'"']})]})]}),e.jsxs("div",{className:"bg-slate-800/60 backdrop-blur-sm rounded-xl p-3 sm:p-6 border border-slate-700 shadow-xl",children:[e.jsxs("h2",{className:"text-base sm:text-lg font-semibold mb-3 sm:mb-4 flex items-center gap-2 text-slate-100",children:[e.jsx(be,{size:18,className:"sm:w-5 sm:h-5"})," Feed Attività"]}),e.jsx("div",{className:"space-y-2 sm:space-y-3 max-h-[400px] sm:max-h-[500px] lg:max-h-[calc(100vh-14rem)] overflow-y-auto pr-1 sm:pr-2",children:e.jsx(we,{children:E.length>0?E.sort((t,l)=>g(l.date)-g(t.date)).slice(0,20).map(t=>{var l;return e.jsx(Te,{item:t,navigate:p},`${t.type}-${t.clientId}-${((l=t.date)==null?void 0:l.seconds)||t.date}`)}):e.jsx("p",{className:"text-xs sm:text-sm text-slate-500 p-4 text-center",children:"Nessuna attività recente."})})})]})]})]})})}export{Pe as default};
