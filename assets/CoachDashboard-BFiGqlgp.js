import{r as p,R as ee,j as e}from"./react-FJB7Hj_2.js";import{B as z,D as M,y as te,G as E,H as S,I as Q,Q as se,z as A,J as ae,K as ie}from"./@firebase-D5dUFubL.js";import{a as V,t as o,d as u}from"./index-C1w-7Ivh.js";import{a as R}from"./firebase-CiybzbB3.js";import{a as ne}from"./react-router-DF4cN2Hx.js";import{m as y,A as re}from"./framer-motion-Bo7GrDk8.js";import{U as I,e as ce,C as B,i as F,B as $,V as oe,a as O,F as T,J as le}from"./lucide-react-BYK_Rxhn.js";import"./papaparse-BHXrM2Hc.js";import"./idb-BXWtuYvb.js";import"./react-dom-BrtcLnxQ.js";import"./scheduler-DYLXRpC5.js";import"./react-router-dom-udQfSOCw.js";import"./@remix-run-CjG9tKj3.js";import"./tslib-BGVaTf34.js";import"./motion-dom-C8PdgYBP.js";import"./motion-utils-DBsP9okC.js";const de=s=>{if(!s)return"";try{const c=Math.floor((new Date-o(s))/1e3);let a=c/31536e3;return a>1?Math.floor(a)+" anni fa":(a=c/2592e3,a>1?Math.floor(a)+" mesi fa":(a=c/86400,a>1?Math.floor(a)+" gg fa":(a=c/3600,a>1?Math.floor(a)+" ore fa":(a=c/60,a>1?Math.floor(a)+" min fa":"ora"))))}catch(c){return console.error("Errore in timeAgo:",c),""}},L=({title:s,value:c,icon:a,isPercentage:g=!1,variants:f})=>e.jsxs(y.div,{variants:f,className:"bg-zinc-950/60 backdrop-blur-xl p-4 rounded-xl gradient-border h-full",children:[e.jsxs("div",{className:"flex items-center gap-3 text-slate-400",children:[a,e.jsx("p",{className:"text-sm",children:s})]}),e.jsx("p",{className:"text-3xl font-bold text-slate-50 mt-2",children:g?`${c}%`:c})]}),C=({to:s,title:c,icon:a,variants:g})=>e.jsx(y.div,{variants:g,children:e.jsxs("button",{onClick:s,className:"group bg-zinc-900/70 hover:bg-zinc-800/90 border border-white/10 rounded-lg p-4 flex items-center gap-4 transition-all duration-300 w-full",children:[e.jsx("div",{className:"bg-zinc-800 group-hover:bg-cyan-500 text-cyan-400 group-hover:text-white p-3 rounded-lg transition-colors duration-300",children:a}),e.jsx("div",{className:"flex-1",children:e.jsx("h4",{className:"font-bold text-slate-200",children:c})}),e.jsx(le,{className:"text-slate-500 group-hover:text-white transition-colors duration-300"})]})}),me=({item:s,navigate:c,variants:a})=>{const g={expiring:e.jsx(F,{className:"text-yellow-500",size:18}),new_check:e.jsx(B,{className:"text-green-500",size:18}),new_anamnesi:e.jsx(T,{className:"text-blue-500",size:18}),new_message:e.jsx(O,{className:"text-rose-500",size:18})},f={expiring:"info",new_check:"checks",new_anamnesi:"anamnesi",new_message:"chat"};return e.jsxs(y.button,{variants:a,layout:!0,initial:{opacity:0,y:10},animate:{opacity:1,y:0},exit:{opacity:0,x:-10},transition:{duration:.3},onClick:()=>c(`/client/${s.clientId}?tab=${f[s.type]}`),className:"w-full flex items-start gap-4 p-3 rounded-lg bg-slate-500/5 hover:bg-slate-500/10 transition-colors text-left",children:[e.jsx("div",{className:"mt-1 flex-shrink-0",children:g[s.type]}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"text-sm font-semibold text-slate-200",children:s.clientName}),e.jsx("p",{className:"text-xs text-slate-400",children:s.description})]}),e.jsx("div",{className:"text-xs text-slate-500 flex-shrink-0",children:de(s.date)})]})};function ke(){const s=ne(),[c,a]=p.useState([]),[g,f]=p.useState([]),[w,q]=p.useState(null),[G,k]=p.useState(!0),[H,J]=p.useState(""),[U,b]=p.useState(null),D="l0RI8TzFjbNVoAdmcXNQkP9mWb12",P=["QwWST9OVOlTOi5oheyCqfpXLOLg2","AeZKjJYu5zMZ4mvffaGiqCBb0cF2","3j0AXIRa4XdHq1ywCl4UBxJNsku2",D];p.useEffect(()=>{const i=V.onAuthStateChanged(d=>{d&&d.uid===D?J(d.displayName||d.email||"Coach Mattia"):(R(V),s("/login"))});return()=>i()},[s]),p.useEffect(()=>{const i=z(M(u,"clients"),d=>{try{const x=d.docs.map(h=>({id:h.id,...h.data()}));a(x),k(!1)}catch(x){console.error("Errore nel fetch clients:",x),b("Errore nel caricamento dei clienti."),k(!1)}},d=>{console.error("Errore snapshot clients:",d),b("Errore nel caricamento dei clienti."),k(!1)});return()=>i()},[]),p.useEffect(()=>{const i=te(u,"app-data","lastViewed");(async()=>{try{const x=await A(i),h=x.exists()?x.data().timestamp:null;q(h),await ae(i,{timestamp:ie()},{merge:!0})}catch(x){console.error("Errore fetchLastViewed:",x),b("Errore nel caricamento di lastViewed.")}})()},[]),p.useEffect(()=>{if(!w)return;const i=E(Q(u,"checks"),S("createdAt","desc")),d=z(i,async v=>{try{const l=[];for(const t of v.docs)if(o(t.data().createdAt)>o(w)){const n=t.ref.parent.parent.id,r=await A(t(u,"clients",n));l.push({type:"new_check",clientId:n,clientName:r.exists()&&r.data().name||"Cliente",description:"Ha inviato un nuovo check-in",date:t.data().createdAt})}f(t=>[...t,...l].sort((n,r)=>o(r.date)-o(n.date)))}catch(l){console.error("Errore snapshot checks:",l),b("Errore nel caricamento dei check.")}}),x=E(Q(u,"anamnesi"),S("submittedAt","desc")),h=z(x,async v=>{try{const l=[];for(const t of v.docs)if(o(t.data().submittedAt)>o(w)){const n=t.ref.parent.parent.id,r=await A(t(u,"clients",n));l.push({type:"new_anamnesi",clientId:n,clientName:r.exists()&&r.data().name||"Cliente",description:"Ha compilato l'anamnesi iniziale",date:t.data().submittedAt})}f(t=>[...t,...l].sort((n,r)=>o(r.date)-o(n.date)))}catch(l){console.error("Errore snapshot anamnesi:",l),b("Errore nel caricamento delle anamnesi.")}}),j=E(M(u,"chats"),se("participants","array-contains",D),S("lastUpdate","desc")),W=z(j,async v=>{try{const l=[];for(const t of v.docs){const n=t.data(),r=n.participants.find(N=>!P.includes(N));if(n.lastUpdate&&o(n.lastUpdate)>o(w)){const N=await A(t(u,"clients",r));l.push({type:"new_message",clientId:r,clientName:N.exists()&&N.data().name||"Cliente",description:`Nuovo messaggio: ${n.lastMessage.slice(0,30)}...`,date:n.lastUpdate})}}f(t=>[...t,...l].sort((n,r)=>o(r.date)-o(n.date)))}catch(l){console.error("Errore snapshot chats:",l),b("Errore nel caricamento dei messaggi.")}}),Z=E(M(u,"clients")),Y=z(Z,v=>{try{const l=v.docs.map(t=>({id:t.id,...t.data()})).filter(t=>{const n=o(t.scadenza);if(!n)return!1;const r=(n-new Date)/(1e3*60*60*24);return r<=15&&r>0}).map(t=>({type:"expiring",clientId:t.id,clientName:t.name,description:`Abbonamento in scadenza tra ${Math.ceil((o(t.scadenza)-new Date)/864e5)} giorni`,date:t.scadenza}));f(t=>[...t.filter(r=>r.type!=="expiring"),...l].sort((r,N)=>o(N.date)-o(r.date)))}catch(l){console.error("Errore snapshot clients:",l),b("Errore nel caricamento delle scadenze.")}});return()=>{d(),h(),W(),Y()}},[w]);const _=ee.useMemo(()=>{try{const i=new Date,d=c.filter(h=>{const j=o(h.scadenza);return j&&j>i}).length,x=c.filter(h=>{const j=o(h.scadenza);return j&&(j-i)/(1e3*60*60*24)<=15&&j-i>0}).length;return{active:d,expiring:x}}catch(i){return console.error("Errore in clientStats:",i),{active:0,expiring:0}}},[c]),X=async()=>{try{await R(V),s("/login")}catch(i){console.error("Errore logout:",i),b("Errore durante il logout.")}},K={hidden:{opacity:0},visible:{opacity:1,transition:{staggerChildren:.1}}},m={hidden:{y:20,opacity:0},visible:{y:0,opacity:1}};return U?e.jsx("div",{className:"min-h-screen bg-zinc-950 text-red-400 flex justify-center items-center",children:U}):G?e.jsx("div",{className:"min-h-screen flex justify-center items-center relative",children:e.jsx("div",{className:"animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-cyan-400"})}):e.jsx("div",{className:"min-h-screen text-slate-200 p-4 sm:p-8 relative",children:e.jsxs(y.div,{initial:"hidden",animate:"visible",variants:K,children:[e.jsxs(y.header,{variants:m,className:"bg-zinc-950/60 backdrop-blur-xl p-4 sm:p-6 rounded-xl gradient-border",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-4",children:[e.jsxs("h1",{className:"text-3xl font-bold text-slate-50 flex items-center gap-2",children:[e.jsx(I,{size:28})," Coach Dashboard"]}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("span",{className:"text-slate-300 font-semibold",children:H}),e.jsxs("button",{onClick:X,className:"flex items-center gap-2 px-3 py-1.5 bg-rose-600 hover:bg-rose-700 text-white text-sm rounded-lg transition-colors",children:[e.jsx(ce,{size:16})," Logout"]})]})]}),e.jsx("p",{className:"text-slate-400 mb-4",children:"Gestisci i tuoi clienti e monitora le loro attivitÃ ."})]}),e.jsxs("main",{className:"mt-6",children:[e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6 mb-8",children:[e.jsx(L,{title:"Clienti Attivi",value:_.active,icon:e.jsx(B,{className:"text-blue-500"}),variants:m}),e.jsx(L,{title:"Scadenze Prossime",value:_.expiring,icon:e.jsx(F,{className:"text-yellow-500"}),variants:m}),e.jsx(L,{title:"Totale Clienti",value:c.length,icon:e.jsx(I,{className:"text-cyan-500"}),variants:m})]}),e.jsxs(y.div,{variants:m,className:"bg-zinc-950/60 backdrop-blur-xl p-4 sm:p-6 rounded-xl gradient-border",children:[e.jsxs("h2",{className:"text-lg font-semibold mb-4 flex items-center gap-2 text-slate-200",children:[e.jsx($,{size:20})," Aggiornamenti Recenti"]}),e.jsx("div",{className:"space-y-3 max-h-[90vh] overflow-y-auto pr-2",children:e.jsx(re,{children:g.length>0?g.map(i=>{var d;return e.jsx(me,{item:i,navigate:s,variants:m},`${i.type}-${i.clientId}-${(d=i.date)==null?void 0:d.seconds}`)}):e.jsx("p",{className:"text-slate-400 text-center p-4",children:"Nessun aggiornamento recente."})})})]}),e.jsxs(y.div,{variants:m,className:"mt-8 bg-zinc-950/60 backdrop-blur-xl p-4 sm:p-6 rounded-xl gradient-border",children:[e.jsx("h2",{className:"text-lg font-semibold mb-4 text-slate-200",children:"Funzioni Utili"}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:[e.jsx(C,{to:()=>s("/coach/clients"),title:"Gestisci Clienti",icon:e.jsx(I,{size:22}),variants:m}),e.jsx(C,{to:()=>s("/new"),title:"Aggiungi Nuovo Cliente",icon:e.jsx(oe,{size:22}),variants:m}),e.jsx(C,{to:()=>s("/coach/chat"),title:"Invia Messaggio",icon:e.jsx(O,{size:22}),variants:m}),e.jsx(C,{to:()=>s("/coach/anamnesi"),title:"Visualizza Anamnesi",icon:e.jsx(T,{size:22}),variants:m}),e.jsx(C,{to:()=>s("/coach/updates"),title:"Aggiornamenti",icon:e.jsx($,{size:22}),variants:m})]})]})]})]})})}export{ke as default};
