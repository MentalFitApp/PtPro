import{r as i,j as e}from"./react-FJB7Hj_2.js";import{g as G}from"./firebase-CiybzbB3.js";import{D as g,G as y,H as q,Q as w,B as T,P as H,R as K,y as U,J as L,K as C,T as W}from"./@firebase-D5dUFubL.js";import{d as h}from"./index-C1w-7Ivh.js";import{S as Z,z as Y,a as ee,E as F}from"./lucide-react-BYK_Rxhn.js";import{m as B,A as se}from"./framer-motion-Bo7GrDk8.js";import"./papaparse-BHXrM2Hc.js";import"./tslib-BGVaTf34.js";import"./idb-BXWtuYvb.js";import"./react-dom-BrtcLnxQ.js";import"./scheduler-DYLXRpC5.js";import"./react-router-dom-udQfSOCw.js";import"./react-router-DF4cN2Hx.js";import"./@remix-run-CjG9tKj3.js";import"./motion-dom-C8PdgYBP.js";import"./motion-utils-DBsP9okC.js";const te=()=>(i.useEffect(()=>{const o=document.querySelector(".stars");if(!o)return;const p=()=>{const a=document.createElement("div");a.className="star",a.style.left=`${Math.random()*100}%`,a.style.top=`${Math.random()*100}%`,a.style.animationDuration=`${Math.random()*30+40}s, 5s`,o.appendChild(a)};for(let a=0;a<50;a++)p();return()=>{for(;o.firstChild;)o.removeChild(o.firstChild)}},[]),e.jsx("div",{className:"starry-background",children:e.jsx("div",{className:"stars"})})),$=()=>e.jsx("div",{className:"flex justify-center items-center h-full p-4",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-rose-500"})}),ae=({message:o,onDismiss:p})=>e.jsx(se,{children:o&&e.jsxs(B.div,{initial:{opacity:0,y:-50},animate:{opacity:1,y:0},exit:{opacity:0,y:-50},className:"fixed top-5 right-5 z-50 flex items-center gap-4 p-4 rounded-lg border bg-red-900/80 text-red-300 border-red-500/30 backdrop-blur-md shadow-lg",children:[e.jsx(F,{size:20}),e.jsx("p",{children:o}),e.jsx("button",{onClick:p,className:"p-1 rounded-full hover:bg-white/10",children:e.jsx(F,{size:16})})]})}),Ne=()=>{const[o,p]=i.useState([]),[a,S]=i.useState(null),[E,z]=i.useState([]),[x,R]=i.useState(""),[Q,I]=i.useState(!0),[O,b]=i.useState(!1),[f,A]=i.useState(""),[M,j]=i.useState([]),[v,N]=i.useState(!1),[J,u]=i.useState(""),D=i.useRef(null),l=G().currentUser,d=["QwWST9OVOlTOi5oheyCqfpXLOLg2","AeZKjJYu5zMZ4mvffaGiqCBb0cF2","3j0AXIRa4XdHq1ywCl4UBxJNsku2","l0RI8TzFjbNVoAdmcxNQkP9mWb12"];i.useEffect(()=>{if(!l)return;const s=g(h,"chats"),t=y(s,w("participants","array-contains-any",d),q("lastUpdate","desc")),n=T(t,r=>{p(r.docs.map(c=>({id:c.id,...c.data()}))),I(!1)},r=>{console.error("Errore nel caricare le chat:",r),u("Errore nel caricamento delle chat. Contatta il supporto."),I(!1)});return()=>n()},[l]),i.useEffect(()=>{if(!a){z([]);return}b(!0);const s=g(h,"chats",a,"messages"),t=y(s,q("createdAt")),n=T(t,r=>{z(r.docs.map(c=>({id:c.id,...c.data()}))),b(!1)},r=>{console.error("Errore nel caricare i messaggi:",r),u("Errore nel caricamento dei messaggi: permessi insufficienti. Contatta il supporto."),b(!1)});return()=>n()},[a]),i.useEffect(()=>{var s;(s=D.current)==null||s.scrollIntoView({behavior:"smooth"})},[E]),i.useEffect(()=>{const s=async()=>{if(f.trim().length<2){j([]),N(!1);return}N(!0);const n=g(h,"clients"),r=f.toLowerCase(),c=y(n,w("name_lowercase",">=",r),w("name_lowercase","<=",r+"ï£¿"),H(10));try{const m=await K(c);j(m.docs.map(k=>({id:k.id,...k.data()})))}catch(m){console.error("Errore nella ricerca (indice Firestore mancante?):",m),u("Errore nella ricerca dei clienti. Assicurati che l'indice Firestore sia configurato.")}N(!1)},t=setTimeout(()=>{s()},300);return()=>clearTimeout(t)},[f]);const P=async s=>{if(!l)return;const t=d.includes(l.uid)?l.uid:d[0],n=[s.id,t].sort().join("_"),r=U(h,"chats",n);if(!o.find(m=>m.id===n))try{await L(r,{participants:[s.id,t],participantNames:{[s.id]:s.name,[t]:l.displayName||"Coach"},lastMessage:"Conversazione iniziata",lastUpdate:C()},{merge:!0})}catch(m){console.error("Errore nella creazione della chat:",m),u("Errore nell'avvio della chat. Riprova.")}S(n),A(""),j([])},V=async s=>{if(s.preventDefault(),!(x.trim()===""||!a||!l))try{const t=g(h,"chats",a,"messages");await W(t,{text:x,createdAt:C(),senderId:l.uid}),await L(U(h,"chats",a),{lastMessage:x,lastUpdate:C()},{merge:!0}),R("")}catch(t){console.error("Errore nell'invio del messaggio:",t),u("Errore nell'invio del messaggio. Riprova.")}},X=()=>{var n;if(!a)return"Chat";const s=o.find(r=>r.id===a);if(!s)return"Chat";const t=s.participants.find(r=>!d.includes(r));return((n=s.participantNames)==null?void 0:n[t])||"Cliente"},_=()=>u("");return e.jsxs("div",{className:"min-h-screen relative",children:[e.jsx(te,{}),e.jsx(ae,{message:J,onDismiss:_}),e.jsxs("div",{className:"flex h-[calc(100vh-120px)] bg-zinc-950/60 backdrop-blur-xl rounded-2xl gradient-border overflow-hidden m-4 sm:m-6",children:[e.jsxs("div",{className:"w-full sm:w-1/3 border-r border-white/10 flex flex-col",children:[e.jsx("div",{className:"p-4 border-b border-white/10",children:e.jsxs("div",{className:"relative",children:[e.jsx(Z,{className:"absolute top-1/2 left-3 -translate-y-1/2 text-slate-400",size:18}),e.jsx("input",{type:"text",placeholder:"Cerca o avvia una chat...",value:f,onChange:s=>A(s.target.value),className:"w-full bg-zinc-900/70 p-2 pl-10 rounded-lg border border-white/10 outline-none focus:ring-2 focus:ring-rose-500 text-slate-200 text-sm sm:text-base"})]})}),f.length>1?e.jsxs("div",{className:"flex-1 overflow-y-auto",children:[v&&e.jsx("p",{className:"p-4 text-slate-400 text-sm",children:"Ricerca in corso..."}),!v&&M.length===0&&e.jsx("p",{className:"p-4 text-slate-400 text-sm",children:"Nessun cliente trovato."}),!v&&M.map(s=>e.jsxs("div",{onClick:()=>P(s),className:"p-4 cursor-pointer hover:bg-white/5 transition-colors",children:[e.jsx("p",{className:"font-semibold text-slate-100",children:s.name}),e.jsx("p",{className:"text-sm text-slate-400",children:s.email})]},s.id))]}):e.jsx(e.Fragment,{children:Q?e.jsx($,{}):e.jsx("div",{className:"flex-1 overflow-y-auto",children:o.map(s=>{var r;const t=s.participants.find(c=>!d.includes(c)),n=((r=s.participantNames)==null?void 0:r[t])||"Cliente";return e.jsxs("div",{onClick:()=>S(s.id),className:`p-4 cursor-pointer border-l-4 transition-colors ${a===s.id?"bg-rose-600/20 border-rose-500":"border-transparent hover:bg-white/5"}`,children:[e.jsx("p",{className:"font-semibold text-slate-100",children:n}),e.jsx("p",{className:"text-sm text-slate-400",children:s.lastMessage||"Nessun messaggio"})]},s.id)})})})]}),e.jsx("div",{className:"w-full sm:w-2/3 flex flex-col bg-zinc-900/50",children:a?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"p-4 border-b border-white/10",children:e.jsx("h3",{className:"font-bold text-lg text-slate-50",children:X()})}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-4 sm:p-6 space-y-4",children:[O?e.jsx($,{}):E.map(s=>{var t;return e.jsx("div",{className:`flex ${d.includes(s.senderId)?"justify-end":"justify-start"}`,children:e.jsxs(B.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},className:`max-w-[70%] sm:max-w-md p-3 rounded-2xl shadow-md ${d.includes(s.senderId)?"bg-rose-600 rounded-br-none":"bg-zinc-800 rounded-bl-none"}`,children:[e.jsx("p",{className:"text-white break-words text-sm sm:text-base",children:s.text}),e.jsx("p",{className:"text-xs text-slate-300/70 mt-1.5 text-right",children:(t=s.createdAt)==null?void 0:t.toDate().toLocaleTimeString("it-IT",{hour:"2-digit",minute:"2-digit"})})]})},s.id)}),e.jsx("div",{ref:D})]}),e.jsx("div",{className:"p-4 sm:p-6 border-t border-white/10",children:e.jsxs("form",{onSubmit:V,className:"flex items-center gap-3",children:[e.jsx("input",{type:"text",value:x,onChange:s=>R(s.target.value),placeholder:"Scrivi una risposta...",className:"flex-1 p-3 bg-zinc-800 border border-white/10 rounded-full outline-none focus:ring-2 focus:ring-rose-500 text-white text-sm sm:text-base"}),e.jsx("button",{type:"submit",className:"p-3 bg-rose-600 hover:bg-rose-700 text-white rounded-full transition-colors disabled:opacity-50",disabled:!x.trim(),children:e.jsx(Y,{size:20})})]})})]}):e.jsxs("div",{className:"flex flex-col justify-center items-center h-full text-slate-500",children:[e.jsx(ee,{size:48}),e.jsx("p",{className:"mt-4",children:"Seleziona una conversazione o cercane una nuova."})]})})]})]})};export{Ne as default};
