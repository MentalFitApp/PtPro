import{r as c,j as e}from"./react-CrXOBDSJ.js";import{g as ee,s as se}from"./firebase-Drn0uAfr.js";import{G as w,H as D,Q as I,I as k,R as M,D as G,y as A,z as te,N as ae,T as re,M as P,K as H}from"./@firebase-DgmhcEwT.js";import{d as u}from"./index-pOkjm1YA.js";import{a as ie}from"./react-router-BxpCmtJ-.js";import{u as oe,k as ce,K as ne,M as le,n as de,X as me}from"./lucide-react-CCY59hBS.js";import{A as O,m as U}from"./framer-motion-BAPjnw1b.js";import"./core-js-ChGsxLo2.js";import"./tslib-BGVaTf34.js";import"./idb-Bn1DMRyg.js";import"./react-dom-BpmKF3Ga.js";import"./scheduler-DYLXRpC5.js";import"./react-router-dom-9rcY47vU.js";import"./@remix-run-CjG9tKj3.js";import"./jspdf-7Jyqi_bl.js";import"./@babel-Cvov1XSu.js";import"./fflate-XZmX483V.js";import"./fast-png-CUrN0NP5.js";import"./iobuffer-DZ1zOcUT.js";import"./pako-B9FS3IR_.js";import"./motion-dom-C8PdgYBP.js";import"./motion-utils-DBsP9okC.js";const he=()=>e.jsxs("div",{className:"min-h-screen bg-slate-900 text-slate-200 flex flex-col justify-center items-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-rose-500"}),e.jsx("p",{className:"mt-4 text-slate-400",children:"Caricamento chat..."})]}),ue=({message:n,onDismiss:p})=>e.jsx(O,{children:n&&e.jsxs(U.div,{initial:{opacity:0,y:-50},animate:{opacity:1,y:0},exit:{opacity:0,y:-50},className:"fixed top-5 right-5 z-[1000] flex items-center gap-4 p-4 rounded-lg border bg-red-900/80 text-red-300 border-red-500/30 backdrop-blur-md shadow-lg",children:[e.jsx(de,{size:20}),e.jsx("p",{children:n}),e.jsx("button",{onClick:p,className:"p-1 rounded-full hover:bg-white/10",children:e.jsx(me,{size:16})})]})}),pe=({chat:n,setSelectedChatId:p,selectedChatId:a,coachUid:f})=>{var g;const N=n.participants.find(C=>C!==f),x=((g=n.participantNames)==null?void 0:g[N])||"Cliente";return e.jsxs(U.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},className:`p-4 cursor-pointer border-l-4 transition-colors ${a===n.id?"bg-rose-600/20 border-rose-500":"border-transparent hover:bg-white/5"}`,onClick:()=>p(n.id),children:[e.jsx("p",{className:"font-semibold text-slate-100",children:x}),e.jsx("p",{className:"text-sm text-slate-400",children:n.lastMessage||"Nessun messaggio"})]})};function Te(){var $,K,B;const n=ie(),p=ee(),a=p.currentUser,[f,N]=c.useState([]),[x,g]=c.useState(""),[C,m]=c.useState(!0),[V,d]=c.useState(""),[v,q]=c.useState(null),[b,X]=c.useState([]),[h,T]=c.useState(null),[j,L]=c.useState(""),[_,S]=c.useState([]),[E,z]=c.useState(!1),Q=c.useRef(null),y=c.useRef(null);c.useEffect(()=>{if(!a){console.log("Nessun utente autenticato, redirect a /login"),n("/login");return}console.log("Utente autenticato:",{uid:a.uid,email:a.email}),(async()=>{var r;try{const o=A(u,"roles","coaches"),i=await te(o),t=i.exists()&&i.data().uids.includes(a.uid);console.log("Debug ruolo coach:",{uid:a.uid,coachDocExists:i.exists(),coachUids:(r=i.data())==null?void 0:r.uids,isCoach:t}),t||(console.warn("Accesso non autorizzato per CoachChat:",a.uid),sessionStorage.removeItem("app_role"),await se(p),n("/login"))}catch(o){console.error("Errore verifica ruolo coach:",o),d("Errore nella verifica del ruolo coach."),m(!1)}})()},[a,n]),c.useEffect(()=>{if(!a)return;const s=w(u,"chats"),r=D(s,M("participants","array-contains",a.uid),k("lastUpdate","desc"),I(50)),o=G(r,i=>{try{const t=i.docs.map(l=>({id:l.id,...l.data()}));console.log("Chats caricate:",{count:t.length,chats:t.map(l=>({id:l.id,participants:l.participants}))}),X(t),m(!1)}catch(t){console.error("Errore nel caricare le chat:",t),d(t.code==="permission-denied"?"Permessi insufficienti per accedere alle chat.":"Errore nel caricamento delle chat."),m(!1)}},i=>{console.error("Errore snapshot chats:",i),d(i.code==="permission-denied"?"Permessi insufficienti per accedere alle chat.":"Errore nel caricamento delle chat."),m(!1)});return()=>o()},[a]),c.useEffect(()=>{if(!h){N([]);return}y.current&&(y.current(),y.current=null),m(!0);const s=w(u,"chats",h,"messages"),r=D(s,k("createdAt"),I(100)),o=G(r,i=>{try{const t=i.docs.map(l=>({id:l.id,...l.data()}));console.log("Messaggi caricati per chat:",h,{count:t.length}),N(t),m(!1)}catch(t){console.error("Errore nello snapshot dei messaggi:",t),d(t.code==="permission-denied"?"Permessi insufficienti per i messaggi.":"Errore nel caricamento dei messaggi."),m(!1)}},i=>{console.error("Errore snapshot messaggi:",i),d(i.code==="permission-denied"?"Permessi insufficienti per i messaggi.":"Errore nel caricamento dei messaggi."),m(!1)});return y.current=o,()=>o&&o()},[h]),c.useEffect(()=>{const s=async()=>{if(j.trim().length<2){S([]),z(!1);return}z(!0);const o=w(u,"clients"),i=j.toLowerCase(),t=D(o,M("name_lowercase",">=",i),M("name_lowercase","<=",i+"ï£¿"),k("name_lowercase"),I(10));try{const R=(await ae(t)).docs.map(F=>({id:F.id,...F.data()}));console.log("Risultati ricerca clienti:",{count:R.length,results:R}),S(R)}catch(l){console.error("Errore nella ricerca:",l),d(l.code==="permission-denied"?"Permessi insufficienti per la ricerca clienti.":"Errore nella ricerca dei clienti.")}z(!1)},r=setTimeout(()=>{s()},300);return()=>clearTimeout(r)},[j]),c.useEffect(()=>{var s;(s=Q.current)==null||s.scrollIntoView({behavior:"smooth"})},[f]);const J=async s=>{if(s.preventDefault(),x.trim()===""||!v)return;const r=x;g("");try{const o=w(u,"chats",v,"messages");await re(o,{text:r,createdAt:P(),senderId:a.uid});const i=A(u,"chats",v);await H(i,{lastMessage:r,lastUpdate:P()},{merge:!0}),console.log("Messaggio inviato:",{chatId:v,text:r})}catch(o){console.error("Errore nell'invio del messaggio:",o),d(o.code==="permission-denied"?"Permessi insufficienti per inviare il messaggio.":"Errore nell'invio del messaggio.")}},W=s=>{console.log("Selezionata chat:",s),T(s),q(s),d(""),m(!0)},Y=async s=>{const r=[s.id,a.uid].sort().join("_"),o=A(u,"chats",r);if(!b.find(t=>t.id===r))try{await H(o,{participants:[s.id,a.uid],participantNames:{[s.id]:s.name,[a.uid]:a.displayName||"Coach"},lastMessage:"Conversazione iniziata",lastUpdate:P()},{merge:!0}),console.log("Nuova chat creata:",r)}catch(t){console.error("Errore nella creazione della chat:",t),d(t.code==="permission-denied"?"Permessi insufficienti per creare la chat.":"Errore nella creazione della chat.")}T(r),q(r),L(""),S([])},Z=()=>d("");return C?e.jsx(he,{}):e.jsxs("div",{className:"min-h-screen bg-slate-900 text-slate-200 font-sans flex flex-col h-screen relative",children:[e.jsx(ue,{message:V,onDismiss:Z}),e.jsx("header",{className:"flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 p-4 bg-slate-900/70 backdrop-blur-lg border-b border-white/10 sticky top-0 z-[10]",children:e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("button",{onClick:()=>n("/coach"),className:"flex items-center gap-2 px-3 py-2 bg-slate-700/50 hover:bg-slate-700/70 border border-slate-600 text-slate-200 text-sm font-semibold rounded-lg transition-colors",children:[e.jsx(oe,{size:16}),e.jsx("span",{children:"Dashboard"})]}),e.jsx("h1",{className:"text-xl font-bold text-slate-50",children:"Chat"})]})}),e.jsxs("main",{className:"flex-1 flex flex-col lg:flex-row h-[calc(100vh-8rem)]",children:[e.jsxs("div",{className:"w-full lg:w-1/3 border-r border-white/10 flex flex-col",children:[e.jsxs("div",{className:"p-4 border-b border-white/10",children:[e.jsxs("div",{className:"relative",children:[e.jsx(ce,{className:"absolute top-1/2 left-3 -translate-y-1/2 text-slate-400",size:18}),e.jsx("input",{type:"text",value:j,onChange:s=>L(s.target.value),placeholder:"Cerca cliente...",className:"w-full bg-slate-700/50 p-2 pl-10 rounded-lg border border-white/10 outline-none focus:ring-2 focus:ring-rose-500 text-slate-200 text-sm sm:text-base"})]}),j.length>1&&e.jsxs("div",{className:"mt-2",children:[E&&e.jsx("p",{className:"p-4 text-slate-400 text-sm",children:"Ricerca in corso..."}),!E&&_.length===0&&e.jsx("p",{className:"p-4 text-slate-400 text-sm",children:"Nessun cliente trovato."}),!E&&_.map(s=>e.jsxs("div",{onClick:()=>Y(s),className:"p-4 cursor-pointer hover:bg-white/5 transition-colors",children:[e.jsx("p",{className:"font-semibold text-slate-100",children:s.name}),e.jsx("p",{className:"text-sm text-slate-400",children:s.email})]},s.id))]})]}),e.jsx("div",{className:"flex-1 overflow-y-auto",children:b.length>0?b.map(s=>e.jsx(pe,{chat:s,setSelectedChatId:W,selectedChatId:h,coachUid:a.uid},s.id)):e.jsx("p",{className:"text-slate-400 text-center py-8",children:"Nessuna conversazione disponibile."})})]}),e.jsx("div",{className:"w-full lg:w-2/3 flex flex-col bg-slate-800/50",children:h?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"p-4 border-b border-white/10",children:e.jsx("h3",{className:"font-bold text-lg text-slate-50",children:((B=($=b.find(s=>s.id===h))==null?void 0:$.participantNames)==null?void 0:B[(K=b.find(s=>s.id===h))==null?void 0:K.participants.find(s=>s!==a.uid)])||"Cliente"})}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-4 sm:p-6 space-y-4",children:[f.length>0?e.jsx(O,{children:f.map(s=>{var r;return e.jsx(U.div,{className:`flex ${s.senderId===a.uid?"justify-end":"justify-start"}`,initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{duration:.3},children:e.jsxs("div",{className:`max-w-[70%] sm:max-w-md p-3 rounded-2xl shadow-md ${s.senderId===a.uid?"bg-rose-600/90 text-white rounded-br-none":"bg-cyan-600/90 text-white rounded-bl-none"}`,children:[e.jsx("p",{className:"break-words text-sm sm:text-base",children:s.text}),e.jsx("p",{className:"text-xs text-slate-200/70 mt-1 text-right",children:(r=s.createdAt)==null?void 0:r.toDate().toLocaleTimeString("it-IT",{hour:"2-digit",minute:"2-digit"})})]})},s.id)})}):e.jsx("p",{className:"text-slate-400 text-center py-8",children:"Nessun messaggio. Inizia la conversazione!"}),e.jsx("div",{ref:Q})]}),e.jsx("footer",{className:"p-4 sm:p-6 bg-slate-900/70 backdrop-blur-lg border-t border-white/10 sticky bottom-0",children:e.jsxs("form",{onSubmit:J,className:"flex items-center gap-3 max-w-3xl mx-auto",children:[e.jsx("input",{type:"text",value:x,onChange:s=>g(s.target.value),placeholder:"Scrivi un messaggio...",className:"flex-1 p-3 bg-slate-700/50 border border-slate-600 rounded-full outline-none focus:ring-2 focus:ring-rose-500 text-slate-200 text-sm sm:text-base transition-all placeholder:text-slate-500 shadow-sm"}),e.jsx("button",{type:"submit",className:"p-3 bg-rose-600 hover:bg-rose-700 text-white rounded-full transition-colors disabled:bg-rose-900 disabled:cursor-not-allowed shadow-md",disabled:!x.trim(),children:e.jsx(ne,{size:20})})]})})]}):e.jsxs("div",{className:"flex flex-col justify-center items-center h-full text-slate-500",children:[e.jsx(le,{size:48}),e.jsx("p",{className:"mt-4",children:"Seleziona una conversazione per iniziare."})]})})]})]})}export{Te as default};
