import{r as i,j as e}from"./react-CrXOBDSJ.js";import{g as B}from"./firebase-CCo3Hvf0.js";import{y as f,z as E,K as D,M as N,G as I,H as F,I as G,D as H,T as J}from"./@firebase-Dy5qmm0I.js";import{d}from"./index-s4mEkYh8.js";import{a as K}from"./react-router-BxpCmtJ-.js";import{t as _,J as U,m as M}from"./lucide-react-OWEKwkjs.js";import{A as k,m as A}from"./framer-motion-BAPjnw1b.js";import"./core-js-ChGsxLo2.js";import"./tslib-BGVaTf34.js";import"./idb-Bn1DMRyg.js";import"./react-dom-BpmKF3Ga.js";import"./scheduler-DYLXRpC5.js";import"./react-router-dom-9rcY47vU.js";import"./@remix-run-CjG9tKj3.js";import"./jspdf-7Jyqi_bl.js";import"./@babel-Cvov1XSu.js";import"./fflate-XZmX483V.js";import"./fast-png-CUrN0NP5.js";import"./iobuffer-DZ1zOcUT.js";import"./pako-B9FS3IR_.js";import"./motion-dom-C8PdgYBP.js";import"./motion-utils-DBsP9okC.js";const Y=()=>e.jsxs("div",{className:"min-h-screen bg-slate-900 text-slate-200 flex flex-col justify-center items-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-rose-500"}),e.jsx("p",{className:"mt-4 text-slate-400",children:"Caricamento chat..."})]}),Z=({message:n,onDismiss:v})=>e.jsx(k,{children:n&&e.jsxs(A.div,{initial:{opacity:0,y:-50},animate:{opacity:1,y:0},exit:{opacity:0,y:-50},className:"fixed top-5 right-5 z-50 flex items-center gap-4 p-4 rounded-lg border bg-red-900/80 text-red-300 border-red-500/30 backdrop-blur-md shadow-lg",children:[e.jsx(M,{size:20}),e.jsx("p",{children:n}),e.jsx("button",{onClick:v,className:"p-1 rounded-full hover:bg-white/10",children:e.jsx(M,{size:16})})]})});function ve(){const n=K(),s=B().currentUser,[g,w]=i.useState([]),[x,z]=i.useState(""),[T,m]=i.useState(!0),[L,u]=i.useState(""),[b,C]=i.useState(null),[a,q]=i.useState(null),S=i.useRef(null),l=i.useRef(null),j=[{uid:"QwWST9OVOlTOi5oheyCqfpXLOLg2",name:"Maurizio"},{uid:"l0RI8TzFjbNVoAdmcXNQkP9mWb12",name:"Mattia"}],O=async t=>{if(!s||!t)return;const r=[s.uid,t].sort().join("_");C(r);try{const o=f(d,"chats",r),c=await E(f(d,"clients",s.uid)),h=c.exists()?c.data().name:s.email;await D(o,{participants:[s.uid,t],participantNames:{[s.uid]:h,[t]:j.find(p=>p.uid===t).name},lastMessage:"",lastUpdate:N()},{merge:!0});const y=I(d,"chats",r,"messages"),W=F(y,G("createdAt")),X=H(W,p=>{const $=p.docs.map(R=>({id:R.id,...R.data()}));w($),m(!1)},p=>{console.error("Errore nello snapshot della chat:",p),u("Errore: non hai accesso a questa chat. Contatta il supporto."),m(!1)});l.current=X}catch(o){console.error("Errore nell'inizializzazione della chat:",o),u("Errore nell'avvio della chat. Riprova."),m(!1)}};i.useEffect(()=>{if(!s){n("/login");return}if(!a){m(!1);return}return l.current&&(l.current(),l.current=null),w([]),C(null),O(a.uid),()=>{l.current&&l.current()}},[s,n,a]),i.useEffect(()=>{var t;(t=S.current)==null||t.scrollIntoView({behavior:"smooth"})},[g]);const P=async t=>{if(t.preventDefault(),x.trim()===""||!b||!a)return;const r=x;z("");try{const o=I(d,"chats",b,"messages");await J(o,{text:r,createdAt:N(),senderId:s.uid});const c=f(d,"chats",b),h=await E(f(d,"clients",s.uid)),y=h.exists()?h.data().name:s.email;await D(c,{lastMessage:r,lastUpdate:N(),participants:[s.uid,a.uid],participantNames:{[s.uid]:y,[a.uid]:a.name}},{merge:!0})}catch(o){console.error("Errore nell'invio del messaggio:",o),u("Errore nell'invio del messaggio. Riprova.")}},V=t=>{const r=t.target.value,o=j.find(c=>c.uid===r);q(o),u(""),m(!0)},Q=()=>u("");return T?e.jsx(Y,{}):e.jsxs("div",{className:"min-h-screen bg-slate-900 text-slate-200 font-sans flex flex-col h-screen relative",children:[e.jsx(Z,{message:L,onDismiss:Q}),e.jsxs("header",{className:"flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 p-4 bg-slate-900/50 backdrop-blur-xl border-b border-slate-700 sticky top-0 z-10",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("button",{onClick:()=>n("/client/dashboard"),className:"flex items-center gap-2 px-3 py-2 bg-slate-700/50 hover:bg-slate-700/70 border border-slate-600 text-slate-200 text-sm font-semibold rounded-lg transition-colors",children:[e.jsx(_,{size:16}),e.jsx("span",{children:"Dashboard"})]}),e.jsx("h1",{className:"text-xl font-bold text-slate-50",children:"Chat"})]}),e.jsxs("select",{value:a?a.uid:"",onChange:V,className:"bg-slate-700/50 border border-slate-600 rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-rose-500 text-slate-200 shadow-md transition-shadow",children:[e.jsx("option",{value:"",disabled:!0,children:"Seleziona destinatario"}),j.map(t=>e.jsx("option",{value:t.uid,children:t.name},t.uid))]})]}),e.jsxs("main",{className:"flex-1 overflow-y-auto p-4 sm:p-6 space-y-4 bg-slate-900/30",children:[a?g.length>0?e.jsx(k,{children:g.map(t=>{var r;return e.jsx(A.div,{className:`flex ${t.senderId===s.uid?"justify-end":"justify-start"}`,initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{duration:.3},children:e.jsxs("div",{className:`max-w-[80%] p-3 rounded-2xl shadow-sm ${t.senderId===s.uid?"bg-rose-600/90 text-white rounded-br-none":"bg-cyan-600/90 text-white rounded-bl-none"}`,children:[e.jsx("p",{className:"break-words text-sm sm:text-base",children:t.text}),e.jsx("p",{className:"text-xs text-slate-200/70 mt-1 text-right",children:(r=t.createdAt)==null?void 0:r.toDate().toLocaleTimeString("it-IT",{hour:"2-digit",minute:"2-digit"})})]})},t.id)})}):e.jsx("p",{className:"text-slate-400 text-center py-8",children:"Nessun messaggio. Inizia la conversazione!"}):e.jsx("p",{className:"text-slate-400 text-center py-8",children:"Seleziona un destinatario per iniziare la chat."}),e.jsx("div",{ref:S})]}),e.jsx("footer",{className:"p-4 bg-slate-900/50 backdrop-blur-xl border-t border-slate-700 sticky bottom-0",children:e.jsxs("form",{onSubmit:P,className:"flex items-center gap-3 max-w-3xl mx-auto",children:[e.jsx("input",{type:"text",value:x,onChange:t=>z(t.target.value),placeholder:"Scrivi un messaggio...",className:"flex-1 p-3 bg-slate-700/50 border border-slate-600 rounded-full outline-none focus:ring-2 focus:ring-rose-500 text-slate-200 text-sm sm:text-base transition-all placeholder:text-slate-500 shadow-sm",disabled:!a}),e.jsx("button",{type:"submit",className:"p-3 bg-rose-600 hover:bg-rose-700 text-white rounded-full transition-colors disabled:bg-rose-900 disabled:cursor-not-allowed shadow-md",disabled:!x.trim()||!a,children:e.jsx(U,{size:20})})]})})]})}export{ve as default};
