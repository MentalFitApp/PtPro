import{r as n,j as e}from"./react-CrXOBDSJ.js";import{g as _,s as G}from"./firebase-Bp3EI6Ad.js";import{A as X,B as Y,I as Z,J as ee,K as te,H as se}from"./@firebase-CuwLCerw.js";import{d as E}from"./index-BoOldJoc.js";import{L as ae}from"./react-router-dom-9rcY47vU.js";import{N as ie}from"./NotificationPanel-qgf3dEOf.js";import{a as oe}from"./react-router-BxpCmtJ-.js";import{n as ne,g as re,Q as P,m as M,b as ce,V as le,J as H,x as de,W as me,M as he,C as ue}from"./lucide-react-CCY59hBS.js";import{m as g}from"./framer-motion-BAPjnw1b.js";import"./core-js-ChGsxLo2.js";import"./tslib-BGVaTf34.js";import"./idb-Bn1DMRyg.js";import"./react-dom-BpmKF3Ga.js";import"./scheduler-DYLXRpC5.js";import"./jspdf-7Jyqi_bl.js";import"./@babel-Cvov1XSu.js";import"./fflate-XZmX483V.js";import"./fast-png-CUrN0NP5.js";import"./iobuffer-DZ1zOcUT.js";import"./pako-B9FS3IR_.js";import"./@remix-run-CjG9tKj3.js";import"./motion-dom-C8PdgYBP.js";import"./motion-utils-DBsP9okC.js";const xe=()=>e.jsx("div",{className:"min-h-screen flex justify-center items-center relative",children:e.jsx("div",{className:"animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-cyan-400"})}),D=({title:a,value:p,subtext:h,icon:f,variants:j})=>e.jsxs(g.div,{variants:j,className:"bg-slate-800/60 backdrop-blur-sm rounded-2xl border border-slate-700 p-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h3",{className:"text-lg font-semibold text-slate-300",children:a}),e.jsx("div",{className:"text-cyan-300",children:f})]}),e.jsx("p",{className:"text-3xl font-bold text-slate-50 mt-2",children:p}),e.jsx("p",{className:"text-sm text-slate-400 mt-1",children:h})]}),N=({to:a,title:p,description:h,icon:f,variants:j})=>e.jsx(g.div,{variants:j,children:e.jsxs(ae,{to:a,className:"group bg-slate-700/50 hover:bg-slate-700/70 border border-slate-600 rounded-lg p-4 flex items-center gap-4 transition-all duration-300",children:[e.jsx("div",{className:"bg-slate-700 group-hover:bg-cyan-500 text-cyan-400 group-hover:text-white p-3 rounded-lg transition-colors duration-300",children:f}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h4",{className:"font-bold text-slate-200",children:p}),e.jsx("p",{className:"text-sm text-slate-400",children:h})]}),e.jsx(ue,{className:"text-slate-500 group-hover:text-white transition-colors duration-300"})]})}),Ue=()=>{const[a,p]=n.useState(null),[h,f]=n.useState(null),[j,v]=n.useState(!0),[B,r]=n.useState(""),[R,U]=n.useState(!1),[$,O]=n.useState(!1),[V,q]=n.useState(!1),u=oe(),y=_(),t=y.currentUser;n.useEffect(()=>{if(!t){console.log("ClientDashboard: Nessun utente autenticato, reindirizzamento a /login"),u("/login");return}console.log("ClientDashboard: Caricamento dati per UID:",t.uid,t.email);const s=navigator.userAgent,o=/iPad|iPhone|iPod/.test(s)&&!window.MSStream,c=/Android/.test(s);O(o),q(c),(o||c)&&!window.matchMedia("(display-mode: standalone)").matches&&U(!0);const b=setTimeout(()=>{console.warn("ClientDashboard: Timeout caricamento, forzo setLoading(false)"),v(!1),r("Il caricamento sta impiegando troppo tempo. Riprova o contatta il supporto.")},8e3),F=async()=>{try{const l=X(E,"clients",t.uid),C=await Y(l);if(C.exists()){const x=C.data();if(x.firstLogin===!0){console.log("ClientDashboard: firstLogin ancora true, redirect a /first-access"),clearTimeout(b),u("/first-access");return}p(x),console.log("ClientDashboard: Dati cliente caricati:",x),clearTimeout(b),v(!1)}else clearTimeout(b),v(!1),r("Documento cliente non trovato."),console.log("ClientDashboard: Documento cliente non trovato per UID:",t.uid),setTimeout(()=>u("/login"),2e3)}catch(l){clearTimeout(b),v(!1),console.error("ClientDashboard: Errore nel recupero del documento cliente:",l.code,l.message,{uid:t.uid,email:t.email}),r("Errore nel caricamento dei dati cliente: "+l.message),setTimeout(()=>u("/login"),2e3)}},K=()=>{const l=Z(E,`clients/${t.uid}/checks`),C=ee(l,te("createdAt","desc"));let x=0;return se(C,d=>{var A,I;x++,console.log(`ClientDashboard: Snapshot #${x}, documenti:`,d.docs.length);try{const m=d.docs.map(L=>({id:L.id,...L.data()})),Q=(I=(A=m[0])==null?void 0:A.createdAt)==null?void 0:I.toDate();f(Q||null),m.length===0&&r("Nessun check-in disponibile. Carica il tuo primo check.")}catch(m){console.error("ClientDashboard: Errore nel caricamento dei check-in:",m.code,m.message,{uid:t.uid,email:t.email}),r("Errore nel caricamento dei check-in: "+(m.code==="permission-denied"?"Permessi insufficienti.":m.message))}},d=>{console.error("ClientDashboard: Errore snapshot check-in:",d.code,d.message,{uid:t.uid,email:t.email}),r("Errore nel caricamento dei check-in: "+(d.code==="permission-denied"?"Permessi insufficienti.":d.message))})};F();const T=K();return()=>{clearTimeout(b),T&&T()}},[t,u]);const W=()=>{G(y).then(()=>{sessionStorage.removeItem("app_role"),console.log("ClientDashboard: Logout eseguito per UID:",t.uid),u("/login")}).catch(s=>{console.error("ClientDashboard: Errore durante il logout:",s.code,s.message),r("Errore durante il logout: "+s.message)})};if(j)return e.jsx(xe,{});if(!a)return e.jsx("div",{className:"min-h-screen flex justify-center items-center p-8 relative",children:e.jsxs("p",{className:"text-center text-red-400 flex items-center gap-2",children:[e.jsx(ne,{size:18}),B||"Errore nel caricamento dei dati."]})});let k="N/D",w="Non impostata";if(a.scadenza&&a.scadenza.toDate){const s=a.scadenza.toDate(),o=new Date;s.setHours(23,59,59,999),o.setHours(0,0,0,0);const c=s-o;k=Math.max(0,Math.ceil(c/(1e3*60*60*24))),w=s.toLocaleDateString("it-IT")}let S="Nessun check registrato",z="Carica il tuo primo check!";if(h){const s=new Date;s.setHours(0,0,0,0);const o=new Date(h);o.setDate(o.getDate()+7);const c=Math.max(0,Math.ceil((o-s)/(1e3*60*60*24)));S=c===0?"Oggi":`${c} giorni`,z=`Prossimo check suggerito: ${o.toLocaleDateString("it-IT")}`}const J={hidden:{opacity:0},visible:{opacity:1,transition:{staggerChildren:.1}}},i={hidden:{y:20,opacity:0},visible:{y:0,opacity:1}};return e.jsx("div",{className:"min-h-screen text-slate-200 relative overflow-x-hidden w-full",children:e.jsxs(g.div,{initial:"hidden",animate:"visible",variants:J,className:"w-full py-4 sm:py-6",children:[e.jsxs(g.header,{variants:i,className:"flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-8 mx-3 sm:mx-6",children:[e.jsx("div",{className:"flex items-center gap-4",children:e.jsx(ie,{userType:"client"})}),e.jsxs("div",{children:[e.jsxs("h1",{className:"text-3xl sm:text-4xl font-bold text-slate-50",children:["Ciao, ",a.name,"!"]}),e.jsx("p",{className:"text-slate-300",children:"Benvenuto nella tua area personale."})]}),e.jsxs("button",{onClick:W,className:"flex items-center gap-2 px-3 py-2 bg-red-600/80 hover:bg-red-600 text-white text-sm font-semibold rounded-lg transition-colors",children:[e.jsx(re,{size:16}),e.jsx("span",{children:"Logout"})]})]}),R&&e.jsxs(g.div,{variants:i,className:"mb-6 space-y-3",children:[V&&e.jsxs("div",{className:"bg-gradient-to-r from-emerald-600 to-teal-600 text-white p-4 rounded-xl flex items-center justify-between shadow-lg",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(P,{size:20}),e.jsxs("div",{children:[e.jsx("p",{className:"font-semibold",children:"Aggiungi alla Schermata Home"}),e.jsxs("p",{className:"text-xs opacity-90",children:["Tocca ",e.jsx("strong",{children:"⋮ Menu → Aggiungi alla schermata home"})]})]})]}),e.jsx(M,{size:18})]}),$&&e.jsxs("div",{className:"bg-gradient-to-r from-blue-600 to-indigo-600 text-white p-4 rounded-xl flex items-center justify-between shadow-lg",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(P,{size:20}),e.jsxs("div",{children:[e.jsx("p",{className:"font-semibold",children:"Aggiungi alla Schermata Home"}),e.jsxs("p",{className:"text-xs opacity-90",children:["Tocca ",e.jsx("strong",{children:"Condividi → Aggiungi alla schermata Home"})]})]})]}),e.jsx(M,{size:18})]})]}),e.jsxs("main",{children:[e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6 mb-8",children:[e.jsx(D,{title:"Scadenza Percorso",value:`${k} giorni`,subtext:`Scade il: ${w}`,icon:e.jsx(ce,{size:24}),variants:i}),e.jsx(D,{title:"Tipo Percorso",value:a.planType?a.planType.charAt(0).toUpperCase()+a.planType.slice(1):"Non specificato",subtext:"Il tuo piano attuale",icon:e.jsx(le,{size:24}),variants:i}),e.jsx(D,{title:"Prossimo Check",value:S,subtext:z,icon:e.jsx(H,{size:24}),variants:i})]}),e.jsxs(g.div,{variants:i,className:"bg-slate-800/60 backdrop-blur-sm rounded-2xl border border-slate-700 p-6",children:[e.jsx("h3",{className:"text-2xl font-bold mb-4 text-white",children:"Cosa vuoi fare?"}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:[e.jsx(N,{to:"/client/anamnesi",title:"La mia Anamnesi",description:"Visualizza o aggiorna i tuoi dati",icon:e.jsx(de,{size:22}),variants:i}),e.jsx(N,{to:"/client/checks",title:"I miei Check",description:"Carica i tuoi progressi periodici",icon:e.jsx(H,{size:22}),variants:i}),e.jsx(N,{to:"/client/payments",title:"I miei Pagamenti",description:"Visualizza lo storico dei pagamenti",icon:e.jsx(me,{size:22}),variants:i}),e.jsx(N,{to:"/client/chat",title:"Chat con il Coach",description:"Invia un messaggio diretto",icon:e.jsx(he,{size:22}),variants:i})]})]})]})]})})};export{Ue as default};
