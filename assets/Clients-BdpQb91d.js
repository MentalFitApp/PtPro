import{r as l,j as e}from"./react-FJB7Hj_2.js";import{t as b,c as E,a as q,d as P,u as K}from"./index-C1w-7Ivh.js";import{B as G,D as Q,y as F,z as H,M as J}from"./@firebase-D5dUFubL.js";import{a as W}from"./firebase-CiybzbB3.js";import{P as X}from"./papaparse-BHXrM2Hc.js";import{a as T,b as I}from"./react-router-DF4cN2Hx.js";import{m as f,A as Y}from"./framer-motion-Bo7GrDk8.js";import{S as Z,j as ee,k as te,e as se,l as ae,m as ne,n as oe,o as re,p as ie,q as le,F as ce}from"./lucide-react-BYK_Rxhn.js";import"./react-dom-BrtcLnxQ.js";import"./scheduler-DYLXRpC5.js";import"./react-router-dom-udQfSOCw.js";import"./@remix-run-CjG9tKj3.js";import"./tslib-BGVaTf34.js";import"./idb-BXWtuYvb.js";import"./motion-dom-C8PdgYBP.js";import"./motion-utils-DBsP9okC.js";const de=s=>{const c=s.map(r=>{var x;return{Nome:r.name||"N/D",Email:r.email||"N/D",Telefono:r.phone||"N/D",Scadenza:((x=b(r.scadenza))==null?void 0:x.toLocaleDateString("it-IT"))||"N/D",Stato:r.statoPercorso||E(r.scadenza),Pagamenti:r.payments?r.payments.reduce((j,g)=>j+(g.amount||0),0):0}}),a=X.unparse(c),p=new Blob([a],{type:"text/csv;charset=utf-8;"}),m=document.createElement("a");m.href=URL.createObjectURL(p),m.download="clienti.csv",m.click()},me=({status:s})=>{const c={attivo:"bg-emerald-900/80 text-emerald-300 border border-emerald-500/30",rinnovato:"bg-amber-900/80 text-amber-300 border border-amber-500/30",non_rinnovato:"bg-red-900/80 text-red-400 border border-red-500/30",na:"bg-zinc-700/80 text-zinc-300 border border-zinc-500/30"},a={attivo:"Attivo",rinnovato:"In Scadenza",non_rinnovato:"Scaduto",na:"N/D"};return e.jsx("span",{className:`px-2.5 py-1 text-xs font-medium rounded-full ${c[s]}`,children:a[s]})},xe=({hasAnamnesi:s})=>e.jsxs("span",{className:`px-2.5 py-1 text-xs font-medium rounded-full flex items-center gap-1 ${s?"bg-green-900/80 text-green-300 border border-green-500/30":"bg-gray-700/80 text-gray-300 border border-gray-500/30"}`,children:[e.jsx(ce,{size:12})," ",s?"Inviata":"Non Inviata"]}),ue=({isOpen:s,onClose:c,onConfirm:a,clientName:p})=>e.jsx(Y,{children:s&&e.jsx(f.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},onClick:c,className:"fixed inset-0 bg-black/70 backdrop-blur-sm flex justify-center items-center z-50 p-4",children:e.jsxs(f.div,{initial:{scale:.9,opacity:0},animate:{scale:1,opacity:1},exit:{scale:.9,opacity:0},onClick:m=>m.stopPropagation(),className:"w-full max-w-md bg-zinc-950/80 rounded-2xl gradient-border p-6 text-center shadow-2xl shadow-black/40",children:[e.jsx("div",{className:"mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-900/50 mb-4",children:e.jsx(re,{className:"h-6 w-6 text-red-400"})}),e.jsx("h3",{className:"text-lg font-bold text-slate-50",children:"Conferma Eliminazione"}),e.jsxs("p",{className:"text-sm text-slate-400 mt-2",children:["Sei sicuro di voler eliminare il cliente ",e.jsx("strong",{className:"text-red-400",children:p}),"? L'operazione Ã¨ irreversibile."]}),e.jsxs("div",{className:"mt-6 flex justify-center gap-4",children:[e.jsx("button",{onClick:c,className:"px-6 py-2 text-sm font-semibold text-slate-300 bg-zinc-800 hover:bg-zinc-700 rounded-lg transition-colors",children:"Annulla"}),e.jsx("button",{onClick:a,className:"px-6 py-2 text-sm font-semibold text-white bg-red-600 hover:bg-red-700 rounded-lg transition-colors",children:"Elimina"})]})]})})}),z=({status:s,label:c,count:a})=>{const p=I(),m=T(),r=new URLSearchParams(p.search).get("filter")===s||s==="all"&&!new URLSearchParams(p.search).get("filter");return e.jsxs("button",{onClick:()=>m(s==="all"?"/clients":`/clients?filter=${s}`),className:`px-3 py-1 text-sm rounded-md transition-colors ${r?"bg-rose-600 text-white":"text-slate-400 hover:bg-white/10"}`,children:[c," (",a,")"]})},k=({col:s,sortKey:c,sortDir:a})=>c===s?a==="asc"?e.jsx(ie,{size:14,className:"inline"}):e.jsx(le,{size:14,className:"inline"}):null;function Ae(){const s=T(),c=I(),[a,p]=l.useState([]),[m,r]=l.useState(!0),[x,j]=l.useState(null),[g,R]=l.useState(""),[C,pe]=l.useState(new URLSearchParams(c.search).get("filter")||"all"),[u,U]=l.useState("createdAt"),[h,L]=l.useState("desc"),[v,$]=l.useState(""),[N,_]=l.useState(""),[B,M]=l.useState({}),O=async()=>{try{await W(q),s("/login")}catch(t){console.error("Logout error:",t)}};l.useEffect(()=>{const t=G(Q(P,"clients"),async n=>{try{const o=n.docs.map(i=>({id:i.id,...i.data()}));console.log("Clienti recuperati da Firestore:",o);const d={};for(const i of o){const w=F(P,`clients/${i.id}/anamnesi`,"initial"),S=await H(w);d[i.id]=S.exists()}M(d),o.forEach(i=>K(i.id)),p(o),r(!1)}catch(o){console.error("Errore nel recupero dei clienti:",o),r(!1)}},n=>{console.error("Errore snapshot clienti:",n),r(!1)});return()=>t()},[]);const V=async()=>{if(x)try{await J(F(P,"clients",x.id)),j(null)}catch(t){console.error("Errore nell'eliminazione del cliente:",t)}},D=t=>{u===t?L(h==="asc"?"desc":"asc"):(U(t),L("asc"))},A=l.useMemo(()=>{let t=[...a];if(g){const n=g.toLowerCase();t=t.filter(o=>(o.name||"").toLowerCase().includes(n)||(o.email||"").toLowerCase().includes(n))}if(C!=="all"&&(t=t.filter(n=>n.statoPercorso===C)),v){const n=new Date(v);t=t.filter(o=>{var d;return((d=b(o.createdAt))==null?void 0:d.toDateString())===n.toDateString()})}return N&&(t=t.filter(n=>(n.payments?n.payments.reduce((d,i)=>d+(i.amount||0),0):0)<parseFloat(N))),t.sort((n,o)=>{const d=n[u]||"",i=o[u]||"";if(u==="scadenza"||u==="createdAt"){const w=b(d)||new Date(0),S=b(i)||new Date(0);return h==="asc"?w-S:S-w}return h==="asc"?d<i?-1:1:d>i?-1:1})},[a,g,C,v,N,u,h]),y=l.useMemo(()=>({all:a.length,attivo:a.filter(t=>t.statoPercorso==="attivo").length,rinnovato:a.filter(t=>t.statoPercorso==="rinnovato").length,non_rinnovato:a.filter(t=>t.statoPercorso==="non_rinnovato").length}),[a]);return e.jsxs(e.Fragment,{children:[e.jsx(ue,{isOpen:!!x,onClose:()=>j(null),onConfirm:V,clientName:x==null?void 0:x.name}),e.jsxs(f.div,{className:"w-full",initial:"hidden",animate:"visible",variants:{visible:{transition:{staggerChildren:.1}}},children:[e.jsxs(f.div,{variants:{hidden:{y:-20,opacity:0},visible:{y:0,opacity:1}},className:"flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6",children:[e.jsx("h1",{className:"text-3xl font-bold text-slate-50",children:"Gestione Clienti"}),e.jsxs("div",{className:"flex flex-wrap items-center gap-3",children:[e.jsxs("div",{className:"relative w-full md:w-auto",children:[e.jsx(Z,{className:"absolute left-3 top-1/2 -translate-y-1/2 text-slate-400",size:18}),e.jsx("input",{value:g,onChange:t=>R(t.target.value),className:"bg-zinc-900/70 border border-white/10 rounded-lg px-3 py-2 pl-10 w-full md:w-64 outline-none focus:ring-2 focus:ring-rose-500",placeholder:"Cerca per nome o email..."})]}),e.jsxs("button",{onClick:()=>s("/new"),className:"flex items-center justify-center gap-2 px-4 py-2 bg-rose-600 hover:bg-rose-700 text-white font-semibold rounded-lg transition-colors",children:[e.jsx(ee,{size:16})," Nuovo"]}),e.jsxs("button",{onClick:()=>de(a),className:"flex items-center gap-2 px-4 py-2 bg-cyan-600 hover:bg-cyan-700 text-white font-semibold rounded-lg transition-colors",children:[e.jsx(te,{size:16})," Esporta CSV"]}),e.jsxs("button",{onClick:O,className:"flex items-center gap-2 px-3 py-1.5 bg-rose-600 hover:bg-rose-700 text-white text-sm rounded-lg transition-colors",children:[e.jsx(se,{size:16})," Logout"]})]})]}),e.jsxs(f.div,{variants:{hidden:{y:-20,opacity:0},visible:{y:0,opacity:1}},className:"flex flex-wrap items-center gap-2 mb-4 p-2 bg-zinc-900/70 border border-white/10 rounded-lg",children:[e.jsx(ae,{className:"text-slate-400 ml-1",size:16}),e.jsx(z,{status:"all",label:"Tutti",count:y.all}),e.jsx(z,{status:"attivo",label:"Attivo",count:y.attivo}),e.jsx(z,{status:"rinnovato",label:"In Scadenza",count:y.rinnovato}),e.jsx(z,{status:"non_rinnovato",label:"Scaduto",count:y.non_rinnovato}),e.jsx("div",{className:"relative w-full sm:w-40",children:e.jsx("input",{type:"date",value:v,onChange:t=>$(t.target.value),className:"bg-zinc-900/70 border border-white/10 rounded-lg px-3 py-2 w-full outline-none focus:ring-2 focus:ring-rose-500"})}),e.jsx("div",{className:"relative w-full sm:w-40",children:e.jsx("input",{type:"number",placeholder:"Pagamenti <",value:N,onChange:t=>_(t.target.value),className:"bg-zinc-900/70 border border-white/10 rounded-lg px-3 py-2 w-full outline-none focus:ring-2 focus:ring-rose-500"})})]}),e.jsx(f.div,{variants:{hidden:{opacity:0},visible:{opacity:1}},className:"bg-zinc-950/60 backdrop-blur-xl rounded-2xl gradient-border overflow-hidden",children:e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full text-sm text-left text-slate-300",children:[e.jsx("thead",{className:"bg-white/5 text-slate-400 uppercase text-xs",children:e.jsxs("tr",{children:[e.jsxs("th",{className:"p-4 cursor-pointer select-none",onClick:()=>D("name"),children:["Nome ",e.jsx(k,{col:"name",sortKey:u,sortDir:h})]}),e.jsx("th",{className:"p-4",children:"Stato Percorso"}),e.jsxs("th",{className:"p-4 cursor-pointer select-none",onClick:()=>D("scadenza"),children:["Scadenza ",e.jsx(k,{col:"scadenza",sortKey:u,sortDir:h})]}),e.jsxs("th",{className:"p-4 cursor-pointer select-none",onClick:()=>D("createdAt"),children:["Data Iscrizione ",e.jsx(k,{col:"createdAt",sortKey:u,sortDir:h})]}),e.jsx("th",{className:"p-4 text-right",children:"Azioni"})]})}),e.jsxs("tbody",{children:[A.map(t=>{var n,o;return e.jsxs("tr",{className:"border-t border-white/10 hover:bg-white/5 transition-colors",children:[e.jsx("td",{className:"p-4 font-medium",children:e.jsx("button",{className:"hover:underline hover:text-rose-400",onClick:()=>{console.log("Navigazione a /client/",t.id),s(`/client/${t.id}`)},children:t.name||"-"})}),e.jsxs("td",{className:"p-4 flex gap-2 items-center",children:[e.jsx(me,{status:t.statoPercorso||E(t.scadenza)}),e.jsx(xe,{hasAnamnesi:B[t.id]})]}),e.jsx("td",{className:"p-4",children:((n=b(t.scadenza))==null?void 0:n.toLocaleDateString("it-IT"))||"-"}),e.jsx("td",{className:"p-4",children:((o=b(t.createdAt))==null?void 0:o.toLocaleDateString("it-IT"))||"-"}),e.jsx("td",{className:"p-4",children:e.jsxs("div",{className:"flex items-center gap-2 justify-end",children:[e.jsx("button",{onClick:()=>s(`/edit/${t.id}`),className:"p-2 text-slate-400 hover:text-amber-400 hover:bg-white/10 rounded-md",title:"Modifica",children:e.jsx(ne,{size:16})}),e.jsx("button",{onClick:()=>j(t),className:"p-2 text-slate-400 hover:text-red-400 hover:bg-white/10 rounded-md",title:"Elimina",children:e.jsx(oe,{size:16})})]})})]},t.id)}),m&&e.jsx("tr",{children:e.jsx("td",{colSpan:"5",className:"text-center p-8 text-slate-400",children:"Caricamento clienti..."})}),!m&&A.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:"5",className:"text-center p-8 text-slate-400",children:"Nessun cliente trovato."})})]})]})})})]})]})}export{Ae as default};
