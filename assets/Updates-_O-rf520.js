import{r as n,j as t}from"./react-CrXOBDSJ.js";import{d as v}from"./index-DWA37aLs.js";import{H as w,I as M,J as q,T as F,K as O,M as T}from"./@firebase-CuwLCerw.js";import{a as $}from"./react-router-BxpCmtJ-.js";import{m as d,A as B}from"./framer-motion-BAPjnw1b.js";import{l as G,J as L,F as P,X as z}from"./lucide-react-CCY59hBS.js";import"./core-js-ChGsxLo2.js";import"./react-dom-BpmKF3Ga.js";import"./scheduler-DYLXRpC5.js";import"./react-router-dom-9rcY47vU.js";import"./@remix-run-CjG9tKj3.js";import"./jspdf-7Jyqi_bl.js";import"./@babel-Cvov1XSu.js";import"./fflate-XZmX483V.js";import"./fast-png-CUrN0NP5.js";import"./iobuffer-DZ1zOcUT.js";import"./pako-B9FS3IR_.js";import"./firebase-Bp3EI6Ad.js";import"./tslib-BGVaTf34.js";import"./idb-Bn1DMRyg.js";import"./motion-dom-C8PdgYBP.js";import"./motion-utils-DBsP9okC.js";function y(s){if(!s)return null;if(typeof(s==null?void 0:s.toDate)=="function")return s.toDate();const a=new Date(s);return isNaN(a)?null:a}const b=({title:s,icon:a,items:l,navigate:p,tab:u,onDismiss:x})=>t.jsxs(d.div,{variants:{hidden:{y:20,opacity:0},visible:{y:0,opacity:1}},className:"bg-slate-800/60 backdrop-blur-sm rounded-2xl border border-slate-700 p-4 flex-1 min-w-[280px]",children:[t.jsxs("h3",{className:"font-bold mb-4 flex items-center gap-2 text-slate-200",children:[a," ",s]}),t.jsx("div",{className:"space-y-2",children:t.jsx(B,{children:l.length>0?l.map(r=>{var o;return t.jsxs(d.div,{layout:!0,initial:{opacity:0,x:-10},animate:{opacity:1,x:0},exit:{opacity:0,scale:.9,transition:{duration:.2}},className:"group flex items-center justify-between p-2 rounded-md hover:bg-white/5",children:[t.jsxs("button",{className:"flex-1 text-left",onClick:()=>p(`/client/${r.clientId}?tab=${u}`),children:[t.jsx("p",{className:"font-medium text-sm text-slate-200 group-hover:text-rose-400 transition-colors",children:r.clientName}),t.jsx("p",{className:"text-xs text-slate-400",children:(o=y(r.date))==null?void 0:o.toLocaleDateString("it-IT",{day:"numeric",month:"long"})})]}),t.jsx("button",{onClick:()=>x(r.id),className:"p-1.5 rounded-full text-slate-500 opacity-0 group-hover:opacity-70 hover:!opacity-100 hover:bg-white/10 hover:text-slate-200 transition-all",title:"Archivia notifica",children:t.jsx(z,{size:14})})]},r.id)}):t.jsx("p",{className:"text-sm text-slate-500 px-2 py-4 text-center",children:"Nessun aggiornamento."})})})]});function pe(){const s=$(),[a,l]=n.useState([]),[p,u]=n.useState([]),[x,r]=n.useState([]),[o,C]=n.useState(()=>{const e=sessionStorage.getItem("dismissedUpdates");return e?JSON.parse(e):[]});n.useEffect(()=>{sessionStorage.setItem("dismissedUpdates",JSON.stringify(o))},[o]),n.useEffect(()=>{const e=w(M(v,"clients"),i=>{l(i.docs.map(m=>({id:m.id,...m.data()})))});return()=>e()},[]);const f=n.useMemo(()=>a.reduce((e,i)=>({...e,[i.id]:i.name}),{}),[a]);n.useEffect(()=>{if(Object.keys(f).length===0)return;const e=(g,E)=>{const U=q(T(v,g),O("createdAt","desc"),F(30));return w(U,N=>{const J=N.docs.map(c=>{const j=c.ref.path.split("/")[1];return{id:c.id,clientId:j,clientName:f[j],date:c.data().createdAt}}).filter(c=>c.clientName);E(J.slice(0,10))},N=>{console.error(`Errore collectionGroup ${g}:`,N),console.error(`Se vedi "index", crea l'indice composito su Firebase Console`)})},i=e("checks",u),m=e("anamnesi",r);return()=>{i(),m()}},[f]);const A=n.useMemo(()=>[...a].sort((e,i)=>(y(i.createdAt)||0)-(y(e.createdAt)||0)).slice(0,10).map(e=>({id:e.id,clientId:e.id,clientName:e.name,date:e.createdAt})),[a]),h=e=>{C(i=>[...i,e])},k=A.filter(e=>!o.includes(e.id)),S=p.filter(e=>!o.includes(e.id)),D=x.filter(e=>!o.includes(e.id)),I={hidden:{opacity:0},visible:{opacity:1,transition:{staggerChildren:.15}}};return t.jsxs("div",{className:"w-full",children:[t.jsx(d.h1,{initial:{y:-20,opacity:0},animate:{y:0,opacity:1},className:"text-3xl font-bold mb-6 text-slate-50",children:"Ultimi Aggiornamenti"}),t.jsxs(d.div,{className:"flex flex-col md:flex-row gap-6",variants:I,initial:"hidden",animate:"visible",children:[t.jsx(b,{title:"Nuovi Clienti",icon:t.jsx(G,{className:"text-rose-400"}),items:k,navigate:s,tab:"anamnesi",onDismiss:h}),t.jsx(b,{title:"Nuovi Check",icon:t.jsx(L,{className:"text-emerald-400"}),items:S,navigate:s,tab:"checks",onDismiss:h}),t.jsx(b,{title:"Nuove Anamnesi",icon:t.jsx(P,{className:"text-amber-400"}),items:D,navigate:s,tab:"anamnesi",onDismiss:h})]})]})}export{pe as default};
