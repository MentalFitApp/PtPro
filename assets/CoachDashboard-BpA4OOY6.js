import{h as Z,r as y,e as D,f as S,G as F,T as k,V as M,W as _,X as I,Y as Q,aO as ee,R as te,j as e,q as w,U,$ as se,a2 as G,a8 as V,B,A as ae,ba as ne,M as q,F as O,C as ie}from"./.pnpm-C04Ba0Xq.js";import{a as z,d as g,t as m}from"./index-DdCoIfwr.js";const re=t=>{if(!t)return"";try{const i=Math.floor((new Date-m(t))/1e3);let a=i/31536e3;return a>1?Math.floor(a)+" anni fa":(a=i/2592e3,a>1?Math.floor(a)+" mesi fa":(a=i/86400,a>1?Math.floor(a)+" gg fa":(a=i/3600,a>1?Math.floor(a)+" ore fa":(a=i/60,a>1?Math.floor(a)+" min fa":"ora"))))}catch(i){return console.error("Errore in timeAgo:",i),""}},$=({title:t,value:i,icon:a,isPercentage:f=!1,variants:b})=>e.jsxs(w.div,{variants:b,className:"bg-slate-800/60 backdrop-blur-sm p-4 rounded-xl border border-slate-700 h-full",children:[e.jsxs("div",{className:"flex items-center gap-3 text-slate-400",children:[a,e.jsx("p",{className:"text-sm",children:t})]}),e.jsx("p",{className:"text-3xl font-bold text-slate-50 mt-2",children:f?`${i}%`:i})]}),A=({to:t,title:i,icon:a,variants:f})=>e.jsx(w.div,{variants:f,children:e.jsxs("button",{onClick:t,className:"group bg-slate-700/50 hover:bg-slate-700/70 border border-slate-600 rounded-lg p-4 flex items-center gap-4 transition-all duration-300 w-full",children:[e.jsx("div",{className:"bg-slate-700/70 group-hover:bg-cyan-500 text-cyan-400 group-hover:text-white p-3 rounded-lg transition-colors duration-300",children:a}),e.jsx("div",{className:"flex-1",children:e.jsx("h4",{className:"font-bold text-slate-200",children:i})}),e.jsx(ie,{className:"text-slate-500 group-hover:text-white transition-colors duration-300"})]})}),ce=({item:t,navigate:i,variants:a})=>{const f={expiring:e.jsx(V,{className:"text-yellow-500",size:18}),new_check:e.jsx(G,{className:"text-green-500",size:18}),new_anamnesi:e.jsx(O,{className:"text-blue-500",size:18}),new_message:e.jsx(q,{className:"text-rose-500",size:18})},b={expiring:"info",new_check:"checks",new_anamnesi:"anamnesi",new_message:"chat"};return e.jsxs(w.button,{variants:a,layout:!0,initial:{opacity:0,y:10},animate:{opacity:1,y:0},exit:{opacity:0,x:-10},transition:{duration:.3},onClick:()=>i(`/coach/client/${t.clientId}?tab=${b[t.type]}`),className:"w-full flex items-start gap-4 p-3 rounded-lg bg-slate-500/5 hover:bg-slate-500/10 transition-colors text-left",children:[e.jsx("div",{className:"mt-1 flex-shrink-0",children:f[t.type]}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"text-sm font-semibold text-slate-200",children:t.clientName}),e.jsx("p",{className:"text-xs text-slate-400",children:t.description})]}),e.jsx("div",{className:"text-xs text-slate-500 flex-shrink-0",children:re(t.date)})]})};function de(){const t=Z(),[i,a]=y.useState([]),[f,b]=y.useState([]),[P,T]=y.useState(""),[L,v]=y.useState(null),[H,E]=y.useState(!0);y.useEffect(()=>{const r=z.onAuthStateChanged(async c=>{if(c)try{const u=D(g,"roles","coaches"),h=await S(u);h.exists()&&h.data().uids.includes(c.uid)?T(c.displayName||c.email||"Coach"):(sessionStorage.removeItem("app_role"),await F(z),t("/login"))}catch{v("Errore nella verifica del ruolo coach."),E(!1)}else t("/login")});return()=>r()},[t]),y.useEffect(()=>{const r=k(M(g,"clients"),c=>{try{const u=c.docs.map(h=>({id:h.id,...h.data()}));a(u),E(!1)}catch(u){console.error("Error loading clients:",u),v("Errore nel caricamento dei clienti."),E(!1)}},c=>{console.error("Snapshot error:",c),v("Errore nel caricamento dei clienti."),E(!1)});return()=>r()},[]),y.useEffect(()=>{if(!z.currentUser)return;const r=_(Q(g,"checks"),I("createdAt","desc")),c=k(r,async N=>{try{const l=[];for(const s of N.docs){const o=s.ref.parent.parent.id,n=await S(D(g,"clients",o));l.push({type:"new_check",clientId:o,clientName:n.exists()&&n.data().name||"Cliente",description:"Ha inviato un nuovo check-in",date:s.data().createdAt})}b(s=>[...l,...s.filter(n=>n.type!=="new_check")].sort((n,d)=>m(d.date)-m(n.date)).slice(0,30))}catch{v("Errore nel caricamento dei check.")}}),u=_(Q(g,"anamnesi"),I("submittedAt","desc")),h=k(u,async N=>{try{const l=[];for(const s of N.docs){const o=s.ref.parent.parent.id,n=await S(D(g,"clients",o));l.push({type:"new_anamnesi",clientId:o,clientName:n.exists()&&n.data().name||"Cliente",description:"Ha compilato l'anamnesi iniziale",date:s.data().submittedAt})}b(s=>[...l,...s.filter(n=>n.type!=="new_anamnesi")].sort((n,d)=>m(d.date)-m(n.date)).slice(0,30))}catch{v("Errore nel caricamento delle anamnesi.")}}),p=_(M(g,"chats"),ee("participants","array-contains",z.currentUser.uid),I("lastUpdate","desc")),Y=k(p,async N=>{var l,s;try{const o=[];for(const n of N.docs){const d=n.data(),j=d.participants.find(C=>C!==z.currentUser.uid);if(d.lastUpdate){const C=await S(D(g,"clients",j));o.push({type:"new_message",clientId:j,clientName:C.exists()&&C.data().name||"Cliente",description:`Nuovo messaggio: ${(s=(l=d.lastMessage)==null?void 0:l.slice)==null?void 0:s.call(l,0,30)}...`,date:d.lastUpdate})}}b(n=>[...o,...n.filter(j=>j.type!=="new_message")].sort((j,C)=>m(C.date)-m(j.date)).slice(0,30))}catch{v("Errore nel caricamento dei messaggi.")}}),J=_(M(g,"clients")),K=k(J,N=>{try{const l=N.docs.map(s=>({id:s.id,...s.data()})).filter(s=>{const o=m(s.scadenza);if(!o)return!1;const n=(o-new Date)/(1e3*60*60*24);return n<=15&&n>0}).map(s=>({type:"expiring",clientId:s.id,clientName:s.name,description:`Abbonamento in scadenza tra ${Math.ceil((m(s.scadenza)-new Date)/864e5)} giorni`,date:s.scadenza}));b(s=>[...s.filter(d=>d.type!=="expiring"),...l].sort((d,j)=>m(j.date)-m(d.date)).slice(0,30))}catch{v("Errore nel caricamento delle scadenze.")}});return()=>{c(),h(),Y(),K()}},[]);const R=te.useMemo(()=>{try{const r=new Date,c=i.filter(h=>{const p=m(h.scadenza);return p&&p>r}).length,u=i.filter(h=>{const p=m(h.scadenza);return p&&(p-r)/(1e3*60*60*24)<=15&&p-r>0}).length;return{active:c,expiring:u}}catch{return{active:0,expiring:0}}},[i]),W=async()=>{try{sessionStorage.removeItem("app_role"),await F(z),t("/login")}catch{v("Errore durante il logout.")}},X={hidden:{opacity:0},visible:{opacity:1,transition:{staggerChildren:.1}}},x={hidden:{y:20,opacity:0},visible:{y:0,opacity:1}};return L?e.jsx("div",{className:"min-h-screen bg-slate-900 text-red-400 flex justify-center items-center",children:L}):H?e.jsx("div",{className:"min-h-screen flex justify-center items-center relative",children:e.jsx("div",{className:"animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-cyan-400"})}):e.jsx("div",{className:"min-h-screen text-slate-200 relative overflow-x-hidden w-full",children:e.jsxs(w.div,{initial:"hidden",animate:"visible",variants:X,className:"w-full py-4 sm:py-6 mobile-safe-bottom",children:[e.jsxs(w.header,{variants:x,className:"bg-slate-800/60 backdrop-blur-sm p-4 sm:p-6 rounded-xl border border-slate-700 mx-3 sm:mx-6",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-4",children:[e.jsxs("h1",{className:"text-3xl font-bold text-slate-50 flex items-center gap-2",children:[e.jsx(U,{size:28})," Coach Dashboard"]}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("span",{className:"text-slate-300 font-semibold",children:P}),e.jsxs("button",{onClick:W,className:"flex items-center gap-2 px-3 py-1.5 bg-rose-600 hover:bg-rose-700 text-white text-sm rounded-lg transition-colors",children:[e.jsx(se,{size:16})," Logout"]})]})]}),e.jsx("p",{className:"text-slate-400 mb-4",children:"Gestisci i tuoi clienti e monitora le loro attivitÃ ."})]}),e.jsxs("main",{className:"mt-6 mx-3 sm:mx-6",children:[e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6 mb-8",children:[e.jsx($,{title:"Clienti Attivi",value:R.active,icon:e.jsx(G,{className:"text-blue-500"}),variants:x}),e.jsx($,{title:"Scadenze Prossime",value:R.expiring,icon:e.jsx(V,{className:"text-yellow-500"}),variants:x}),e.jsx($,{title:"Totale Clienti",value:i.length,icon:e.jsx(U,{className:"text-cyan-500"}),variants:x})]}),e.jsxs(w.div,{variants:x,className:"bg-slate-800/60 backdrop-blur-sm p-4 sm:p-6 rounded-xl border border-slate-700",children:[e.jsxs("h2",{className:"text-lg font-semibold mb-4 flex items-center gap-2 text-slate-200",children:[e.jsx(B,{size:20})," Aggiornamenti Recenti"]}),e.jsx("div",{className:"space-y-3 max-h-[90vh] overflow-y-auto pr-2",children:e.jsx(ae,{children:f.length>0?f.map(r=>{var c;return e.jsx(ce,{item:r,navigate:t,variants:x},`${r.type}-${r.clientId}-${((c=r.date)==null?void 0:c.seconds)||r.date}`)}):e.jsx("p",{className:"text-slate-400 text-center p-4",children:"Nessun aggiornamento recente."})})})]}),e.jsxs(w.div,{variants:x,className:"mt-8 bg-slate-800/60 backdrop-blur-sm p-4 sm:p-6 rounded-xl border border-slate-700",children:[e.jsx("h2",{className:"text-lg font-semibold mb-4 text-slate-200",children:"Funzioni Utili"}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:[e.jsx(A,{to:()=>t("/coach/clients"),title:"Gestisci Clienti",icon:e.jsx(U,{size:22}),variants:x}),e.jsx(A,{to:()=>t("/new"),title:"Aggiungi Nuovo Cliente",icon:e.jsx(ne,{size:22}),variants:x}),e.jsx(A,{to:()=>t("/coach/chat"),title:"Invia Messaggio",icon:e.jsx(q,{size:22}),variants:x}),e.jsx(A,{to:()=>t("/coach/anamnesi"),title:"Visualizza Anamnesi",icon:e.jsx(O,{size:22}),variants:x}),e.jsx(A,{to:()=>t("/coach/updates"),title:"Aggiornamenti",icon:e.jsx(B,{size:22}),variants:x})]})]})]})]})})}export{de as default};
