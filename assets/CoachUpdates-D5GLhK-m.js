import{r as f,j as t}from"./react-FJB7Hj_2.js";import{y as T,G as y,H as C,I as D,B as b,Q as $,D as I,z as w,J as F,K as q}from"./@firebase-D5dUFubL.js";import{d,t as r}from"./index-C1w-7Ivh.js";import{a as H}from"./react-router-DF4cN2Hx.js";import{m as j,A as O}from"./framer-motion-Bo7GrDk8.js";import{B as M,A as R,a as X,F as G,C as J,i as K}from"./lucide-react-BYK_Rxhn.js";import"./papaparse-BHXrM2Hc.js";import"./idb-BXWtuYvb.js";import"./react-dom-BrtcLnxQ.js";import"./scheduler-DYLXRpC5.js";import"./react-router-dom-udQfSOCw.js";import"./@remix-run-CjG9tKj3.js";import"./firebase-CiybzbB3.js";import"./tslib-BGVaTf34.js";import"./motion-dom-C8PdgYBP.js";import"./motion-utils-DBsP9okC.js";const P=c=>{if(!c)return"";try{const o=Math.floor((new Date-r(c))/1e3);let s=o/31536e3;return s>1?Math.floor(s)+" anni fa":(s=o/2592e3,s>1?Math.floor(s)+" mesi fa":(s=o/86400,s>1?Math.floor(s)+" gg fa":(s=o/3600,s>1?Math.floor(s)+" ore fa":(s=o/60,s>1?Math.floor(s)+" min fa":"ora"))))}catch(o){return console.error("Errore in timeAgo:",o),""}},W=()=>t.jsx("div",{className:"min-h-screen flex justify-center items-center relative",children:t.jsx("div",{className:"animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-cyan-400"})}),Z=({item:c,navigate:o,variants:s})=>{const m={expiring:t.jsx(K,{className:"text-yellow-500",size:18}),new_check:t.jsx(J,{className:"text-green-500",size:18}),new_anamnesi:t.jsx(G,{className:"text-blue-500",size:18}),new_message:t.jsx(X,{className:"text-rose-500",size:18})},v={expiring:"info",new_check:"checks",new_anamnesi:"anamnesi",new_message:"chat"};return t.jsxs(j.button,{variants:s,layout:!0,initial:{opacity:0,y:10},animate:{opacity:1,y:0},exit:{opacity:0,x:-10},transition:{duration:.3},onClick:()=>o(`/client/${c.clientId}?tab=${v[c.type]}`),className:"w-full flex items-start gap-4 p-3 rounded-lg bg-slate-500/5 hover:bg-slate-500/10 transition-colors text-left",children:[t.jsx("div",{className:"mt-1 flex-shrink-0",children:m[c.type]}),t.jsxs("div",{className:"flex-1",children:[t.jsx("p",{className:"text-sm font-semibold text-slate-200",children:c.clientName}),t.jsx("p",{className:"text-xs text-slate-400",children:c.description})]}),t.jsx("div",{className:"text-xs text-slate-500 flex-shrink-0",children:P(c.date)})]})};function fe(){const c=H(),[o,s]=f.useState([]),[m,v]=f.useState(null),[V,k]=f.useState(!0),[z,u]=f.useState(null),E="l0RI8TzFjbNVoAdmcXNQkP9mWb12",L=["QwWST9OVOlTOi5oheyCqfpXLOLg2","AeZKjJYu5zMZ4mvffaGiqCBb0cF2","3j0AXIRa4XdHq1ywCl4UBxJNsku2",E];f.useEffect(()=>{const l=T(d,"app-data","lastViewed");(async()=>{try{const x=await w(l),A=x.exists()?x.data().timestamp:null;v(A),await F(l,{timestamp:q()},{merge:!0}),k(!1)}catch(x){console.error("Errore fetchLastViewed:",x),u("Errore nel caricamento degli aggiornamenti."),k(!1)}})()},[]),f.useEffect(()=>{if(!m)return;const l=y(D(d,"checks"),C("createdAt","desc")),g=b(l,async p=>{try{const i=[];for(const e of p.docs)if(r(e.data().createdAt)>r(m)){const n=e.ref.parent.parent.id,a=await w(e(d,"clients",n));i.push({type:"new_check",clientId:n,clientName:a.exists()&&a.data().name||"Cliente",description:"Ha inviato un nuovo check-in",date:e.data().createdAt})}s(e=>[...e,...i].sort((n,a)=>r(a.date)-r(n.date)))}catch(i){console.error("Errore snapshot checks:",i),u("Errore nel caricamento dei check.")}}),x=y(D(d,"anamnesi"),C("submittedAt","desc")),A=b(x,async p=>{try{const i=[];for(const e of p.docs)if(r(e.data().submittedAt)>r(m)){const n=e.ref.parent.parent.id,a=await w(e(d,"clients",n));i.push({type:"new_anamnesi",clientId:n,clientName:a.exists()&&a.data().name||"Cliente",description:"Ha compilato l'anamnesi iniziale",date:e.data().submittedAt})}s(e=>[...e,...i].sort((n,a)=>r(a.date)-r(n.date)))}catch(i){console.error("Errore snapshot anamnesi:",i),u("Errore nel caricamento delle anamnesi.")}}),_=y(I(d,"chats"),$("participants","array-contains",E),C("lastUpdate","desc")),S=b(_,async p=>{try{const i=[];for(const e of p.docs){const n=e.data(),a=n.participants.find(h=>!L.includes(h));if(n.lastUpdate&&r(n.lastUpdate)>r(m)){const h=await w(e(d,"clients",a));i.push({type:"new_message",clientId:a,clientName:h.exists()&&h.data().name||"Cliente",description:`Nuovo messaggio: ${n.lastMessage.slice(0,30)}...`,date:e.data().lastUpdate})}}s(e=>[...e,...i].sort((n,a)=>r(a.date)-r(n.date)))}catch(i){console.error("Errore snapshot chats:",i),u("Errore nel caricamento dei messaggi.")}}),B=y(I(d,"clients")),Q=b(B,p=>{try{const i=p.docs.map(e=>({id:e.id,...e.data()})).filter(e=>{const n=r(e.scadenza);if(!n)return!1;const a=(n-new Date)/(1e3*60*60*24);return a<=15&&a>0}).map(e=>({type:"expiring",clientId:e.id,clientName:e.name,description:`Abbonamento in scadenza tra ${Math.ceil((r(e.scadenza)-new Date)/864e5)} giorni`,date:e.scadenza}));s(e=>[...e.filter(a=>a.type!=="expiring"),...i].sort((a,h)=>r(h.date)-r(a.date)))}catch(i){console.error("Errore snapshot clients:",i),u("Errore nel caricamento delle scadenze.")}});return()=>{g(),A(),S(),Q()}},[m]);const U={hidden:{opacity:0},visible:{opacity:1,transition:{staggerChildren:.1}}},N={hidden:{y:20,opacity:0},visible:{y:0,opacity:1}};return z?t.jsx("div",{className:"min-h-screen bg-zinc-950 text-red-400 flex justify-center items-center",children:z}):V?t.jsx(W,{}):t.jsx("div",{className:"min-h-screen text-slate-200 p-4 sm:p-8 relative",children:t.jsxs(j.div,{initial:"hidden",animate:"visible",variants:U,children:[t.jsxs(j.header,{variants:N,className:"flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-8",children:[t.jsxs("h1",{className:"text-3xl sm:text-4xl font-bold text-slate-50 flex items-center gap-2",children:[t.jsx(M,{size:28})," Aggiornamenti Utili"]}),t.jsxs("button",{onClick:()=>c("/coach-dashboard"),className:"flex items-center gap-2 px-3 py-2 bg-zinc-800 hover:bg-zinc-700 text-slate-300 text-sm font-semibold rounded-lg transition-colors",children:[t.jsx(R,{size:16}),t.jsx("span",{children:"Torna alla Dashboard"})]})]}),t.jsxs(j.div,{variants:N,className:"bg-zinc-950/60 backdrop-blur-xl p-4 sm:p-6 rounded-xl gradient-border",children:[t.jsxs("h2",{className:"text-lg font-semibold mb-4 flex items-center gap-2 text-slate-200",children:[t.jsx(M,{size:20})," Ultimi Aggiornamenti"]}),t.jsx("div",{className:"space-y-3 max-h-[90vh] overflow-y-auto pr-2",children:t.jsx(O,{children:o.length>0?o.map(l=>{var g;return t.jsx(Z,{item:l,navigate:c,variants:N},`${l.type}-${l.clientId}-${(g=l.date)==null?void 0:g.seconds}`)}):t.jsx("p",{className:"text-slate-400 text-center p-4",children:"Nessun aggiornamento recente."})})})]})]})})}export{fe as default};
