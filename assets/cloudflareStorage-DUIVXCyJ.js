import{br as B,bs as U,bt as F,bu as S}from"./.pnpm-C04Ba0Xq.js";let d=null;const W=()=>{if(!d){const e="7682069cf34302dfc6988fbe193f2ba6",a="91fda93481d38b755d3591081b173be6",o="5b3b9059a2972cf0b910a05b35d631896187daa809ccb44c6aefb0e06400aede";d=new S({region:"auto",endpoint:`https://${e}.r2.cloudflarestorage.com`,credentials:{accessKeyId:a,secretAccessKey:o}})}return d},K=async e=>{if(!e.type.startsWith("image/")||e.size<200*1024)return e;try{const a={maxSizeMB:1,maxWidthOrHeight:1920,useWebWorker:!0,fileType:e.type},o=await F(e,a);return console.log(`Compressione: ${(e.size/1024).toFixed(2)}KB -> ${(o.size/1024).toFixed(2)}KB (${((e.size-o.size)/e.size*100).toFixed(0)}% riduzione)`),o}catch(a){return console.warn("Errore nella compressione, uso file originale:",a),e}},M=async(e,a,o="anamnesi_photos",t=null,r=!1)=>{if(!e)throw new Error("Nessun file fornito");if(!r){const s=e.type.startsWith("video/")?52428800:10485760;if(e.size>s){const c=s/1048576;throw new Error(`Il file supera il limite di ${c}MB`)}}const u=e.type.startsWith("image/"),$=e.type.startsWith("video/");if(!u&&!$)throw new Error("Il file deve essere un'immagine o un video");try{let s=e;if(u){const n=m=>{try{window.dispatchEvent(new CustomEvent("global-upload-progress",{detail:m}))}catch(x){console.warn("Failed to emit progress event:",x)}};t&&t({stage:"compressing",percent:5,message:"Compressione immagine in corso..."}),n({stage:"compressing",percent:5,message:"Compressione immagine in corso..."}),s=await K(e),t&&t({stage:"compressed",percent:15,message:"Compressione completata"}),n({stage:"compressed",percent:15,message:"Compressione completata"})}const c=e.name.split(".").pop(),g=`${B()}.${c}`,p=`clients/${a}/${o}/${g}`,f="fitflow",i=n=>{try{window.dispatchEvent(new CustomEvent("global-upload-progress",{detail:n}))}catch(m){console.warn("Failed to emit progress event:",m)}};t&&t({stage:"uploading",percent:20,message:"Upload iniziato..."}),i({stage:"uploading",percent:20,message:"Upload iniziato..."});const v=await s.arrayBuffer(),C=new U({Bucket:f,Key:p,Body:new Uint8Array(v),ContentType:s.type,Metadata:{originalName:e.name,uploadedAt:new Date().toISOString()}}),E=W(),w=[40,55,70,85];let l=0;const I=setInterval(()=>{if(l<w.length){const n={stage:"uploading",percent:w[l],message:"Caricamento..."};t&&t(n),i(n),l++}},250);await E.send(C),clearInterval(I);const b={stage:"finalizing",percent:95,message:"Finalizzazione..."},y={stage:"complete",percent:100,message:"Upload completato!"};t&&t(b),i(b),t&&t(y),i(y);const h="https://media.flowfitpro.it",z=h?`${h}/${p}`:`https://pub-7682069cf34302dfc6988fbe193f2ba6.r2.dev/${p}`;return console.log(`Upload completato su R2: ${g} -> ${z}`),z}catch(s){throw console.error("Errore upload R2:",s),new Error(`Errore durante l'upload: ${s.message}`)}},R=async(e,a,o="anamnesi_photos",t=null,r=!1)=>M(e,a,o,t,r);export{M as a,R as u};
