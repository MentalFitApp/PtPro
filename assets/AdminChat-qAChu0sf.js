import{r as o,j as e}from"./react-CrXOBDSJ.js";import{g as Z}from"./firebase-Bp3EI6Ad.js";import{I as g,J as E,T as z,K as O,U as R,H as Q,P as Y,A,N as V,O as I,G as U,V as ee}from"./@firebase-CuwLCerw.js";import{d as p}from"./index-LD97HDty.js";import{k as se,p as te,K as ae,M as re,n as oe,X as ie}from"./lucide-react-CCY59hBS.js";import{m as $,A as ne}from"./framer-motion-BAPjnw1b.js";import"./core-js-ChGsxLo2.js";import"./tslib-BGVaTf34.js";import"./idb-Bn1DMRyg.js";import"./react-dom-BpmKF3Ga.js";import"./scheduler-DYLXRpC5.js";import"./react-router-dom-9rcY47vU.js";import"./react-router-BxpCmtJ-.js";import"./@remix-run-CjG9tKj3.js";import"./jspdf-7Jyqi_bl.js";import"./@babel-Cvov1XSu.js";import"./fflate-XZmX483V.js";import"./fast-png-CUrN0NP5.js";import"./iobuffer-DZ1zOcUT.js";import"./pako-B9FS3IR_.js";import"./motion-dom-C8PdgYBP.js";import"./motion-utils-DBsP9okC.js";const P=()=>e.jsx("div",{className:"flex justify-center items-center h-full p-4",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-rose-500"})}),le=({message:h,type:b,onDismiss:i})=>e.jsx(ne,{children:h&&e.jsxs($.div,{initial:{opacity:0,y:-50},animate:{opacity:1,y:0},exit:{opacity:0,y:-50},className:`fixed top-5 right-5 z-50 flex items-center gap-4 p-4 rounded-lg border ${b==="error"?"bg-red-900/80 text-red-300 border-red-500/30":"bg-emerald-900/80 text-emerald-300 border-emerald-500/30"} backdrop-blur-md shadow-lg`,children:[e.jsx(oe,{size:20}),e.jsx("p",{children:h}),e.jsx("button",{onClick:i,className:"p-1 rounded-full hover:bg-white/10",children:e.jsx(ie,{size:16})})]})}),Te=()=>{const[h,b]=o.useState([]),[i,j]=o.useState(null),[D,N]=o.useState([]),[x,T]=o.useState(""),[B,M]=o.useState(!0),[J,v]=o.useState(!1),[f,k]=o.useState(""),[q,y]=o.useState([]),[w,C]=o.useState(!1),[F,S]=o.useState({message:"",type:""}),L=o.useRef(null),t=Z().currentUser,m=["QwWST9OVOlTOi5oheyCqfpXLOLg2","AeZKjJYu5zMZ4mvffaGiqCBb0cF2","3j0AXIRa4XdHq1ywCl4UBxJNsku2","l0RI8TzFjbNVoAdmcXNQkP9mWb12"],u=t&&(m.includes(t.uid)||t.uid==="l0RI8TzFjbNVoAdmcXNQkP9mWb12"),c=(s,a="error")=>{S({message:s,type:a}),setTimeout(()=>S({message:"",type:""}),6e3)};o.useEffect(()=>{if(!t){c("Utente non autenticato. Effettua il login.","error");return}u||c("Accesso non autorizzato. Area riservata ai coach o admin.","error"),console.log("Utente autenticato:",t==null?void 0:t.uid,t==null?void 0:t.email,{isCoach:u})},[t,u]),o.useEffect(()=>{if(!t||!u)return;const s=g(p,"chats"),a=E(s,R("participants","array-contains-any",m),O("lastUpdate","desc"),z(100)),n=Q(a,r=>{b(r.docs.map(l=>({id:l.id,...l.data()}))),M(!1)},r=>{console.error("Errore nel caricare le chat:",r.code,r.message,{uid:t==null?void 0:t.uid}),c("Errore nel caricamento delle chat. Contatta il supporto.","error"),M(!1)});return()=>n()},[t,u]),o.useEffect(()=>{if(!i){N([]);return}v(!0);const s=g(p,"chats",i,"messages"),a=E(s,O("createdAt"),z(100)),n=Q(a,r=>{N(r.docs.map(l=>({id:l.id,...l.data()}))),v(!1)},r=>{console.error("Errore nel caricare i messaggi:",r.code,r.message,{uid:t==null?void 0:t.uid}),c("Errore nel caricamento dei messaggi: permessi insufficienti. Contatta il supporto.","error"),v(!1)});return()=>n()},[i,t]),o.useEffect(()=>{var s;(s=L.current)==null||s.scrollIntoView({behavior:"smooth"})},[D]),o.useEffect(()=>{const s=async()=>{if(f.trim().length<2){y([]),C(!1);return}C(!0);const n=g(p,"clients"),r=f.toLowerCase(),l=E(n,R("name_lowercase",">=",r),R("name_lowercase","<=",r+"ï£¿"),z(10));try{const d=await Y(l);y(d.docs.map(X=>({id:X.id,...X.data()})))}catch(d){console.error("Errore nella ricerca (indice Firestore mancante?):",d.code,d.message,{uid:t==null?void 0:t.uid}),c("Errore nella ricerca dei clienti. Assicurati che l'indice Firestore sia configurato.","error")}C(!1)},a=setTimeout(()=>{s()},300);return()=>clearTimeout(a)},[f,t]);const K=async s=>{if(!t||!u)return;const a=m.includes(t.uid)?t.uid:m[0],n=[s.id,a].sort().join("_"),r=A(p,"chats",n);if(!h.find(d=>d.id===n))try{await V(r,{participants:[s.id,a],participantNames:{[s.id]:s.name,[a]:t.displayName||"Coach"},lastMessage:"Conversazione iniziata",lastUpdate:I()},{merge:!0})}catch(d){console.error("Errore nella creazione della chat:",d.code,d.message,{uid:t==null?void 0:t.uid}),c("Errore nell'avvio della chat. Riprova.","error")}j(n),k(""),y([])},W=async s=>{if(s.preventDefault(),!(x.trim()===""||!i||!t||!u))try{const a=g(p,"chats",i,"messages");await ee(a,{text:x,createdAt:I(),senderId:t.uid}),await V(A(p,"chats",i),{lastMessage:x,lastUpdate:I()},{merge:!0}),T("")}catch(a){console.error("Errore nell'invio del messaggio:",a.code,a.message,{uid:t==null?void 0:t.uid}),c("Errore nell'invio del messaggio. Riprova.","error")}},_=async()=>{if(!(!i||!t||!u))try{const s=A(p,"chats",i);await U(s),console.log("Documento chat eliminato:",s.path),j(null),N([]),c("Chat eliminata con successo!","success")}catch(s){console.error("Errore nell'eliminazione della chat:",s.code,s.message,{uid:t==null?void 0:t.uid}),c("Errore nell'eliminazione della chat. Riprova.","error")}},G=()=>{var n;if(!i)return"Chat";const s=h.find(r=>r.id===i);if(!s)return"Chat";const a=s.participants.find(r=>!m.includes(r));return((n=s.participantNames)==null?void 0:n[a])||"Cliente"},H=()=>S({message:"",type:""});return e.jsxs("div",{className:"min-h-screen -m-4 sm:-m-6 lg:-m-8 p-4 sm:p-6 lg:p-8",children:[e.jsx(le,{message:F.message,type:F.type,onDismiss:H}),e.jsxs("div",{className:"flex h-[calc(100vh-120px)] bg-slate-800/60 backdrop-blur-sm rounded-2xl border border-slate-700 shadow-xl overflow-hidden",children:[e.jsxs("div",{className:"w-full sm:w-1/3 border-r border-slate-700 flex flex-col bg-slate-800/40",children:[e.jsx("div",{className:"p-4 border-b border-slate-700",children:e.jsxs("div",{className:"relative",children:[e.jsx(se,{className:"absolute top-1/2 left-3 -translate-y-1/2 text-slate-400",size:18}),e.jsx("input",{type:"text",placeholder:"Cerca o avvia una chat...",value:f,onChange:s=>k(s.target.value),className:"w-full bg-slate-700/50 border border-slate-600 p-2 pl-10 rounded-lg outline-none focus:ring-2 focus:ring-rose-500 text-slate-200 text-sm sm:text-base"})]})}),f.length>1?e.jsxs("div",{className:"flex-1 overflow-y-auto",children:[w&&e.jsx("p",{className:"p-4 text-slate-400 text-sm",children:"Ricerca in corso..."}),!w&&q.length===0&&e.jsx("p",{className:"p-4 text-slate-400 text-sm",children:"Nessun cliente trovato."}),!w&&q.map(s=>e.jsxs("div",{onClick:()=>K(s),className:"p-4 cursor-pointer hover:bg-slate-700/30 transition-colors",children:[e.jsx("p",{className:"font-semibold text-slate-100",children:s.name}),e.jsx("p",{className:"text-sm text-slate-400",children:s.email})]},s.id))]}):e.jsx(e.Fragment,{children:B?e.jsx(P,{}):e.jsx("div",{className:"flex-1 overflow-y-auto",children:h.map(s=>{var r;const a=s.participants.find(l=>!m.includes(l)),n=((r=s.participantNames)==null?void 0:r[a])||"Cliente";return e.jsxs("div",{onClick:()=>j(s.id),className:`p-4 cursor-pointer border-l-4 transition-colors ${i===s.id?"bg-rose-600/20 border-rose-500":"border-transparent hover:bg-slate-700/30"}`,children:[e.jsx("p",{className:"font-semibold text-slate-100",children:n}),e.jsx("p",{className:"text-sm text-slate-400",children:s.lastMessage||"Nessun messaggio"})]},s.id)})})})]}),e.jsx("div",{className:"w-full sm:w-2/3 flex flex-col bg-slate-900/40",children:i?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"p-4 border-b border-slate-700 flex justify-between items-center",children:[e.jsx("h3",{className:"font-bold text-lg text-slate-100",children:G()}),e.jsx("button",{onClick:_,className:"p-2 text-red-400 hover:bg-red-900/30 rounded-lg transition-colors",title:"Elimina Chat",children:e.jsx(te,{size:18})})]}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-4 sm:p-6 space-y-4",children:[J?e.jsx(P,{}):D.map(s=>{var a;return e.jsx("div",{className:`flex ${m.includes(s.senderId)?"justify-end":"justify-start"}`,children:e.jsxs($.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},className:`max-w-[70%] sm:max-w-md p-3 rounded-2xl shadow-md ${m.includes(s.senderId)?"bg-rose-600 rounded-br-none":"bg-slate-700/80 rounded-bl-none"}`,children:[e.jsx("p",{className:"text-white break-words text-sm sm:text-base",children:s.text}),e.jsx("p",{className:"text-xs text-slate-300/70 mt-1.5 text-right",children:(a=s.createdAt)==null?void 0:a.toDate().toLocaleTimeString("it-IT",{hour:"2-digit",minute:"2-digit"})})]})},s.id)}),e.jsx("div",{ref:L})]}),e.jsx("div",{className:"p-4 sm:p-6 border-t border-slate-700",children:e.jsxs("form",{onSubmit:W,className:"flex items-center gap-3",children:[e.jsx("input",{type:"text",value:x,onChange:s=>T(s.target.value),placeholder:"Scrivi una risposta...",className:"flex-1 p-3 bg-slate-700/50 border border-slate-600 rounded-full outline-none focus:ring-2 focus:ring-rose-500 text-white text-sm sm:text-base"}),e.jsx("button",{type:"submit",className:"p-3 bg-rose-600 hover:bg-rose-700 text-white rounded-full transition-colors disabled:opacity-50",disabled:!x.trim(),children:e.jsx(ae,{size:20})})]})})]}):e.jsxs("div",{className:"flex flex-col justify-center items-center h-full text-slate-400",children:[e.jsx(re,{size:48}),e.jsx("p",{className:"mt-4",children:"Seleziona una conversazione o cercane una nuova."})]})})]})]})};export{Te as default};
