import{r as m,j as e}from"./react-CrXOBDSJ.js";import{H as S,I as _,A as L,J as k,K as A,M as z,B as $,N as me,O as pe}from"./@firebase-CuwLCerw.js";import{a as O,t as f,d as j}from"./index-DWA37aLs.js";import{s as q}from"./firebase-Bp3EI6Ad.js";import{L as ue}from"./react-chartjs-2-DgEolIMQ.js";import{C as xe,a as he,P as fe,b as ge,c as ye,p as be,d as we,e as je,i as ve}from"./chart.js-m_wzuIQ6.js";import{a as Ne}from"./react-router-BxpCmtJ-.js";import{T as De,g as Se,U as Ce,P as ke,c as J,D as Ee,h as W,R as X,i as Me,B as Ae,F as $e,j as Fe}from"./lucide-react-CCY59hBS.js";import{A as ze,m as Ie}from"./framer-motion-BAPjnw1b.js";import"./core-js-ChGsxLo2.js";import"./idb-Bn1DMRyg.js";import"./react-dom-BpmKF3Ga.js";import"./scheduler-DYLXRpC5.js";import"./react-router-dom-9rcY47vU.js";import"./@remix-run-CjG9tKj3.js";import"./jspdf-7Jyqi_bl.js";import"./@babel-Cvov1XSu.js";import"./fflate-XZmX483V.js";import"./fast-png-CUrN0NP5.js";import"./iobuffer-DZ1zOcUT.js";import"./pako-B9FS3IR_.js";import"./tslib-BGVaTf34.js";import"./@kurkle-D8fDXNIl.js";import"./motion-dom-C8PdgYBP.js";import"./motion-utils-DBsP9okC.js";xe.register(he,fe,ge,ye,be,we,je,ve);const Re=u=>{if(!u)return"";const c=Math.floor((new Date-f(u))/1e3);let p=c/31536e3;return p>1?Math.floor(p)+" anni fa":(p=c/2592e3,p>1?Math.floor(p)+" mesi fa":(p=c/86400,p>1?Math.floor(p)+" gg fa":(p=c/3600,p>1?Math.floor(p)+" ore fa":(p=c/60,p>1?Math.floor(p)+" min fa":"ora"))))},V=({title:u,value:c,icon:p,isCurrency:E=!1,isPercentage:M=!1})=>e.jsxs("div",{className:"bg-slate-800/60 backdrop-blur-sm p-5 rounded-xl border border-slate-700 shadow-xl h-full",children:[e.jsxs("div",{className:"flex items-center gap-3 text-slate-400",children:[p,e.jsx("p",{className:"text-sm font-medium",children:u})]}),e.jsx("p",{className:"text-3xl font-bold text-slate-100 mt-3",children:E?new Intl.NumberFormat("it-IT",{style:"currency",currency:"EUR"}).format(c):M?`${c}%`:c})]}),Le=({item:u,navigate:c})=>{const p={expiring:e.jsx(Fe,{className:"text-yellow-500",size:18}),new_check:e.jsx(W,{className:"text-green-500",size:18}),new_anamnesi:e.jsx($e,{className:"text-blue-500",size:18}),renewal:e.jsx(X,{className:"text-emerald-500",size:18})},E={expiring:"payments",new_check:"check",new_anamnesi:"anamnesi",renewal:"payments"};return e.jsxs(Ie.button,{layout:!0,initial:{opacity:0,y:10},animate:{opacity:1,y:0},exit:{opacity:0,x:-10},transition:{duration:.3},onClick:()=>c(`/client/${u.clientId}?tab=${E[u.type]}`),className:"w-full flex items-start gap-4 p-3 rounded-lg bg-slate-500/5 hover:bg-slate-500/10 transition-colors text-left",children:[e.jsx("div",{className:"mt-1 flex-shrink-0",children:p[u.type]}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"text-sm font-semibold text-slate-200",children:u.clientName}),e.jsx("p",{className:"text-xs text-slate-400",children:u.description})]}),e.jsx("div",{className:"text-xs text-slate-500 flex-shrink-0",children:Re(u.date)})]})};function lt(){const u=Ne(),[c,p]=m.useState([]),[E,M]=m.useState([]),[Z,ee]=m.useState(0),[I,te]=m.useState(null),[T,se]=m.useState(null),[ae,ne]=m.useState(0),[re,Y]=m.useState(!0),[N,B]=m.useState("revenue"),[D,P]=m.useState("monthly"),[K,Q]=m.useState([]),[U,R]=m.useState(null);m.useEffect(()=>{const t=sessionStorage.getItem("app_role");if(t!=="admin"&&t!=="coach"){q(O).then(()=>{u("/login")}).catch(l=>{R("Errore durante il logout")});return}},[u]);const[oe,ie]=m.useState("");m.useEffect(()=>{const t=O.onAuthStateChanged(l=>{var a;l&&ie(l.displayName||((a=l.email)==null?void 0:a.split("@")[0])||"Admin")});return()=>t()},[]);const G=async()=>{try{await q(O),u("/login")}catch(t){R(`Errore durante il logout: ${t.message}`)}},le=m.useMemo(()=>{const t=new Date;return{active:c.filter(a=>{const h=f(a.scadenza);return h&&h>t}).length}},[c]);m.useEffect(()=>{const t=S(_(j,"clients"),l=>{try{const a=l.docs.map(h=>({id:h.id,...h.data()}));p(a),Y(!1)}catch(a){console.error("Errore recupero clienti:",a),R("Errore nel recupero dei clienti."),Y(!1)}},l=>{console.error("Errore snapshot clienti:",l),R("Errore connessione."),Y(!1)});return()=>t()},[]),m.useEffect(()=>{const t=L(j,"app-data","lastViewed");(async()=>{try{const a=await $(t),h=a.exists()?a.data().timestamp:null;te(h),await me(t,{timestamp:pe()},{merge:!0})}catch(a){console.error("Errore lastViewed:",a)}})()},[]),m.useEffect(()=>{if(!I)return;let t=[];const l=new Date,a=new Date(l.getFullYear(),l.getMonth(),1),h=k(z(j,"payments"),A("paymentDate","desc")),C=S(h,async o=>{try{const i=[];for(const n of o.docs){const d=n.data(),y=f(d.paymentDate);if(y&&y>=a){const v=n.ref.parent.parent.id,F=await $(L(j,"clients",v));if(F.exists()){const H=F.data();!H.isOldClient&&!d.isPast&&i.push({type:"renewal",clientId:v,clientName:H.name||"Cliente",description:`Rinnovo di ${d.duration} per ${new Intl.NumberFormat("it-IT",{style:"currency",currency:"EUR"}).format(d.amount||0)}`,date:d.paymentDate})}}}M(n=>[...n.filter(d=>d.type!=="renewal"),...i])}catch(i){console.error("Errore snapshot pagamenti:",i)}});t.push(C);const x=k(z(j,"checks"),A("createdAt","desc")),g=S(x,async o=>{try{const i=[];for(const n of o.docs)if(f(n.data().createdAt)>f(I)){const y=n.ref.parent.parent.id,v=await $(L(j,"clients",y));i.push({type:"new_check",clientId:y,clientName:v.exists()&&v.data().name||"Cliente",description:"Ha inviato un nuovo check-in",date:n.data().createdAt})}M(n=>[...n.filter(d=>d.type!=="new_check"),...i])}catch(i){console.error("Errore snapshot checks:",i)}});t.push(g);const w=k(z(j,"anamnesi"),A("submittedAt","desc")),b=S(w,async o=>{try{const i=[];for(const n of o.docs)if(f(n.data().submittedAt)>f(I)){const y=n.ref.parent.parent.id,v=await $(L(j,"clients",y));i.push({type:"new_anamnesi",clientId:y,clientName:v.exists()&&v.data().name||"Cliente",description:"Ha compilato l'anamnesi iniziale",date:n.data().submittedAt})}M(n=>[...n.filter(d=>d.type!=="new_anamnesi"),...i])}catch(i){console.error("Errore snapshot anamnesi:",i)}});t.push(b);const s=k(_(j,"clients")),r=S(s,o=>{try{const i=o.docs.map(n=>({id:n.id,...n.data()})).filter(n=>{const d=f(n.scadenza);if(!d)return!1;const y=(d-new Date)/(1e3*60*60*24);return y<=15&&y>0}).map(n=>({type:"expiring",clientId:n.id,clientName:n.name,description:`Abbonamento in scadenza tra ${Math.ceil((f(n.scadenza)-new Date)/864e5)} giorni`,date:n.scadenza}));M(n=>[...n.filter(d=>d.type!=="expiring"),...i])}catch(i){console.error("Errore snapshot clienti:",i)}});return t.push(r),()=>{t.forEach(o=>o())}},[I]),m.useEffect(()=>{const t=new Date,l=new Date(t.getFullYear(),t.getMonth(),1),a=k(z(j,"payments"),A("paymentDate","desc")),h=S(a,async C=>{try{let x=0;for(const g of C.docs){const w=f(g.data().paymentDate);if(w&&w>=l){const b=g.ref.parent.parent,s=await $(b);s.exists()&&!s.data().isOldClient&&!g.data().isPast&&(x+=g.data().amount||0)}}ee(x)}catch(x){console.error("Errore snapshot pagamenti:",x)}});return()=>h()},[]),m.useEffect(()=>{if(c.length>0){const t=c.filter(l=>{const a=f(l.scadenza);return a&&a>new Date}).length;ne(Math.round(t/c.length*100))}},[c]),m.useEffect(()=>{if(c.length>0){const t=c[Math.floor(Math.random()*c.length)];se({name:t.name,goal:t.goal})}},[c]),m.useEffect(()=>{let t=null;return(async()=>{const a=new Date;if(N==="revenue"){const h=k(z(j,"payments"),A("paymentDate","asc"));t=S(h,async C=>{try{const x={},g={},w={};for(const s of C.docs){const r=f(s.data().paymentDate),o=s.ref.parent.parent,i=await $(o);if(r&&i.exists()&&!i.data().isOldClient&&!s.data().isPast){const d=s.data().amount||0,y=r.toLocaleDateString("it-IT");x[y]=(x[y]||0)+d;const v=`${r.getFullYear()}-${String(r.getMonth()+1).padStart(2,"0")}`;g[v]=(g[v]||0)+d;const F=r.getFullYear().toString();w[F]=(w[F]||0)+d}}let b=[];if(D==="daily")for(let s=29;s>=0;s--){const o=new Date(a.getFullYear(),a.getMonth(),a.getDate()-s).toLocaleDateString("it-IT");b.push({name:o,value:x[o]||0})}else if(D==="monthly")for(let s=11;s>=0;s--){const r=new Date(a.getFullYear(),a.getMonth()-s,1),o=`${r.getFullYear()}-${String(r.getMonth()+1).padStart(2,"0")}`;b.push({name:o,value:g[o]||0})}else for(let s=4;s>=0;s--){const r=a.getFullYear()-s;b.push({name:r.toString(),value:w[r]||0})}Q(b)}catch(x){console.error("Errore chart revenue:",x)}})}else{const h=k(_(j,"clients"),A("createdAt","asc"));t=S(h,C=>{try{const x={},g={},w={};C.docs.forEach(s=>{const r=f(s.data().createdAt);if(r){const o=r.toLocaleDateString("it-IT");x[o]=(x[o]||0)+1;const i=`${r.getFullYear()}-${String(r.getMonth()+1).padStart(2,"0")}`;g[i]=(g[i]||0)+1;const n=r.getFullYear().toString();w[n]=(w[n]||0)+1}});let b=[];if(D==="daily")for(let s=29;s>=0;s--){const o=new Date(a.getFullYear(),a.getMonth(),a.getDate()-s).toLocaleDateString("it-IT");b.push({name:o,value:x[o]||0})}else if(D==="monthly")for(let s=11;s>=0;s--){const r=new Date(a.getFullYear(),a.getMonth()-s,1),o=`${r.getFullYear()}-${String(r.getMonth()+1).padStart(2,"0")}`;b.push({name:o,value:g[o]||0})}else for(let s=4;s>=0;s--){const r=a.getFullYear()-s;b.push({name:r.toString(),value:w[r]||0})}Q(b)}catch(x){console.error("Errore chart clienti:",x)}})}})(),()=>{t&&t()}},[N,D]);const ce={responsive:!0,maintainAspectRatio:!1,scales:{x:{grid:{display:!1},ticks:{color:"#e2e8f0",font:{size:11}}},y:{grid:{color:"rgba(255, 255, 255, 0.1)"},ticks:{color:"#e2e8f0",font:{size:11}}}},plugins:{legend:{position:"top",labels:{font:{size:12},color:"#e2e8f0"}},tooltip:{callbacks:{label:t=>`${t.dataset.label}: ${N==="revenue"?`€${t.raw}`:t.raw}`}}}},de={labels:K.map(t=>t.name),datasets:[{label:N==="revenue"?"Fatturato (€)":"Nuovi Clienti",data:K.map(t=>t.value),borderColor:N==="revenue"?"#22c55e":"#6366f1",backgroundColor:N==="revenue"?"rgba(34, 197, 94, 0.2)":"rgba(99, 102, 241, 0.2)",fill:!0,tension:.4,pointRadius:4,pointHoverRadius:6}]};return re?e.jsx("div",{className:"min-h-screen flex items-center justify-center p-4",children:e.jsx("div",{className:"animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-rose-500"})}):U?e.jsx("div",{className:"min-h-screen flex items-center justify-center p-4",children:e.jsxs("div",{className:"bg-red-900/80 p-6 rounded-lg text-center",children:[e.jsx("h2",{className:"text-xl font-bold text-red-300 mb-2",children:"Errore"}),e.jsx("p",{className:"text-red-400",children:U}),e.jsx("button",{onClick:G,className:"mt-4 px-4 py-2 bg-red-600 text-white rounded-lg",children:"Torna al Login"})]})}):e.jsx("div",{className:"min-h-screen -m-4 sm:-m-6 lg:-m-8 p-4 sm:p-6 lg:p-8",children:e.jsxs("div",{className:"max-w-7xl mx-auto space-y-6",children:[e.jsxs("div",{className:"bg-slate-800/30 backdrop-blur-xl border border-white/10 rounded-2xl p-5 space-y-5",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4",children:[e.jsxs("h1",{className:"text-2xl sm:text-3xl font-bold text-slate-100 flex items-center gap-2",children:[e.jsx(De,{size:28})," Dashboard"]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:"text-slate-300 font-semibold",children:oe}),e.jsxs("button",{onClick:G,className:"flex items-center gap-2 px-4 py-2 bg-rose-600 hover:bg-rose-700 text-white text-sm font-medium rounded-lg transition-colors",children:[e.jsx(Se,{size:16})," Logout"]})]})]}),e.jsx("div",{className:"border-t border-white/10"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-slate-400 text-sm mb-3",children:"Panoramica delle metriche chiave e progressi in tempo reale."}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsxs("button",{onClick:()=>u("/clients"),className:"px-4 py-2 bg-slate-700/50 hover:bg-slate-700/70 text-slate-300 text-sm font-medium rounded-lg transition-colors flex items-center gap-2",children:[e.jsx(Ce,{size:16})," Gestisci"]}),e.jsxs("button",{onClick:()=>u("/new-client"),className:"px-4 py-2 bg-rose-600 hover:bg-rose-700 text-white text-sm font-medium rounded-lg transition-colors flex items-center gap-2",children:[e.jsx(ke,{size:16})," Nuovo"]}),e.jsxs("button",{onClick:()=>u("/business-history"),className:"px-4 py-2 bg-cyan-600 hover:bg-cyan-700 text-white text-sm font-medium rounded-lg transition-colors flex items-center gap-2",children:[e.jsx(J,{size:16})," Storico"]})]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[e.jsxs("div",{className:"lg:col-span-2 space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-5",children:[e.jsx(V,{title:"Incasso Mensile",value:Z,icon:e.jsx(Ee,{className:"text-green-500"}),isCurrency:!0}),e.jsx(V,{title:"Clienti Attivi",value:le.active,icon:e.jsx(W,{className:"text-blue-500"})}),e.jsx(V,{title:"Retention Rate",value:ae,icon:e.jsx(X,{className:"text-amber-500"}),isPercentage:!0})]}),e.jsxs("div",{className:"bg-slate-800/60 backdrop-blur-sm rounded-xl p-6 border border-slate-700 shadow-xl h-[450px] flex flex-col",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row justify-between items-start sm:items-center gap-2 mb-4",children:[e.jsxs("h2",{className:"text-lg font-semibold text-slate-100 flex items-center gap-2",children:[e.jsx(J,{size:20})," Andamento Business"]}),e.jsxs("div",{className:"flex gap-2 bg-slate-800/40 backdrop-blur-xl border border-white/10 p-1 rounded-lg",children:[e.jsx("button",{onClick:()=>B("revenue"),className:`px-3 py-1 text-sm rounded-md transition ${N==="revenue"?"bg-rose-600 text-white":"text-slate-400 hover:bg-white/10"}`,children:"Fatturato"}),e.jsx("button",{onClick:()=>B("clients"),className:`px-3 py-1 text-sm rounded-md transition ${N==="clients"?"bg-rose-600 text-white":"text-slate-400 hover:bg-white/10"}`,children:"Clienti"})]})]}),e.jsx("div",{className:"flex-1",children:e.jsx(ue,{data:de,options:ce})}),e.jsx("div",{className:"flex justify-center mt-4",children:e.jsxs("div",{className:"flex gap-2 bg-slate-800/40 backdrop-blur-xl border border-white/10 p-1 rounded-lg",children:[e.jsx("button",{onClick:()=>P("daily"),className:`px-3 py-1 text-xs rounded-md transition ${D==="daily"?"bg-rose-600 text-white":"text-slate-400 hover:bg-white/10"}`,children:"Giorno"}),e.jsx("button",{onClick:()=>P("monthly"),className:`px-3 py-1 text-xs rounded-md transition ${D==="monthly"?"bg-rose-600 text-white":"text-slate-400 hover:bg-white/10"}`,children:"Mese"}),e.jsx("button",{onClick:()=>P("yearly"),className:`px-3 py-1 text-xs rounded-md transition ${D==="yearly"?"bg-rose-600 text-white":"text-slate-400 hover:bg-white/10"}`,children:"Anno"})]})})]}),T&&e.jsxs("div",{className:"bg-slate-800/60 backdrop-blur-sm rounded-xl p-4 border border-slate-700 shadow-xl",children:[e.jsxs("h2",{className:"text-lg font-semibold mb-3 flex items-center gap-2 text-slate-100",children:[e.jsx(Me,{size:18})," Focus del Giorno"]}),e.jsx("p",{className:"text-sm font-bold text-rose-400",children:T.name}),e.jsxs("p",{className:"text-sm text-slate-400 mt-1",children:['Obiettivo: "',T.goal||"Non specificato",'"']})]})]}),e.jsxs("div",{className:"bg-slate-800/60 backdrop-blur-sm rounded-xl p-4 sm:p-6 border border-slate-700 shadow-xl",children:[e.jsxs("h2",{className:"text-lg font-semibold mb-4 flex items-center gap-2 text-slate-100",children:[e.jsx(Ae,{size:20})," Feed Attività"]}),e.jsx("div",{className:"space-y-3 max-h-[90vh] lg:max-h-[calc(100vh-14rem)] overflow-y-auto pr-2",children:e.jsx(ze,{children:E.length>0?E.sort((t,l)=>f(l.date)-f(t.date)).slice(0,20).map(t=>{var l;return e.jsx(Le,{item:t,navigate:u},`${t.type}-${t.clientId}-${((l=t.date)==null?void 0:l.seconds)||t.date}`)}):e.jsx("p",{className:"text-sm text-slate-500 p-4 text-center",children:"Nessuna attività recente."})})})]})]})]})})}export{lt as default};
