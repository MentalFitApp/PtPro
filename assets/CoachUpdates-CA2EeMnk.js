import{h as q,r as f,e as B,W as y,X as A,Y as D,T as b,aO as F,V as M,j as t,q as j,B as V,aC as O,A as Q,f as w,a6 as X,a7 as H,M as R,F as W,a2 as G,a8 as J}from"./.pnpm-C04Ba0Xq.js";import{d,t as i}from"./index-DdCoIfwr.js";const P=c=>{if(!c)return"";try{const o=Math.floor((new Date-i(c))/1e3);let s=o/31536e3;return s>1?Math.floor(s)+" anni fa":(s=o/2592e3,s>1?Math.floor(s)+" mesi fa":(s=o/86400,s>1?Math.floor(s)+" gg fa":(s=o/3600,s>1?Math.floor(s)+" ore fa":(s=o/60,s>1?Math.floor(s)+" min fa":"ora"))))}catch(o){return console.error("Errore in timeAgo:",o),""}},Y=()=>t.jsx("div",{className:"min-h-screen flex justify-center items-center relative",children:t.jsx("div",{className:"animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-cyan-400"})}),Z=({item:c,navigate:o,variants:s})=>{const m={expiring:t.jsx(J,{className:"text-yellow-500",size:18}),new_check:t.jsx(G,{className:"text-green-500",size:18}),new_anamnesi:t.jsx(W,{className:"text-blue-500",size:18}),new_message:t.jsx(R,{className:"text-rose-500",size:18})},v={expiring:"info",new_check:"checks",new_anamnesi:"anamnesi",new_message:"chat"};return t.jsxs(j.button,{variants:s,layout:!0,initial:{opacity:0,y:10},animate:{opacity:1,y:0},exit:{opacity:0,x:-10},transition:{duration:.3},onClick:()=>o(`/client/${c.clientId}?tab=${v[c.type]}`),className:"w-full flex items-start gap-4 p-3 rounded-lg bg-slate-500/5 hover:bg-slate-500/10 transition-colors text-left",children:[t.jsx("div",{className:"mt-1 flex-shrink-0",children:m[c.type]}),t.jsxs("div",{className:"flex-1",children:[t.jsx("p",{className:"text-sm font-semibold text-slate-200",children:c.clientName}),t.jsx("p",{className:"text-xs text-slate-400",children:c.description})]}),t.jsx("div",{className:"text-xs text-slate-500 flex-shrink-0",children:P(c.date)})]})};function te(){const c=q(),[o,s]=f.useState([]),[m,v]=f.useState(null),[I,k]=f.useState(!0),[E,u]=f.useState(null),z="l0RI8TzFjbNVoAdmcXNQkP9mWb12",L=["QwWST9OVOlTOi5oheyCqfpXLOLg2","AeZKjJYu5zMZ4mvffaGiqCBb0cF2","3j0AXIRa4XdHq1ywCl4UBxJNsku2",z];f.useEffect(()=>{const l=B(d,"app-data","lastViewed");(async()=>{try{const p=await w(l),C=p.exists()?p.data().timestamp:null;v(C),await X(l,{timestamp:H()},{merge:!0}),k(!1)}catch(p){console.error("Errore fetchLastViewed:",p),u("Errore nel caricamento degli aggiornamenti."),k(!1)}})()},[]),f.useEffect(()=>{if(!m)return;const l=y(D(d,"checks"),A("createdAt","desc")),g=b(l,async x=>{try{const r=[];for(const e of x.docs)if(i(e.data().createdAt)>i(m)){const n=e.ref.parent.parent.id,a=await w(e(d,"clients",n));r.push({type:"new_check",clientId:n,clientName:a.exists()&&a.data().name||"Cliente",description:"Ha inviato un nuovo check-in",date:e.data().createdAt})}s(e=>[...e,...r].sort((n,a)=>i(a.date)-i(n.date)))}catch(r){console.error("Errore snapshot checks:",r),u("Errore nel caricamento dei check.")}}),p=y(D(d,"anamnesi"),A("submittedAt","desc")),C=b(p,async x=>{try{const r=[];for(const e of x.docs)if(i(e.data().submittedAt)>i(m)){const n=e.ref.parent.parent.id,a=await w(e(d,"clients",n));r.push({type:"new_anamnesi",clientId:n,clientName:a.exists()&&a.data().name||"Cliente",description:"Ha compilato l'anamnesi iniziale",date:e.data().submittedAt})}s(e=>[...e,...r].sort((n,a)=>i(a.date)-i(n.date)))}catch(r){console.error("Errore snapshot anamnesi:",r),u("Errore nel caricamento delle anamnesi.")}}),_=y(M(d,"chats"),F("participants","array-contains",z),A("lastUpdate","desc")),S=b(_,async x=>{try{const r=[];for(const e of x.docs){const n=e.data(),a=n.participants.find(h=>!L.includes(h));if(n.lastUpdate&&i(n.lastUpdate)>i(m)){const h=await w(e(d,"clients",a));r.push({type:"new_message",clientId:a,clientName:h.exists()&&h.data().name||"Cliente",description:`Nuovo messaggio: ${n.lastMessage.slice(0,30)}...`,date:e.data().lastUpdate})}}s(e=>[...e,...r].sort((n,a)=>i(a.date)-i(n.date)))}catch(r){console.error("Errore snapshot chats:",r),u("Errore nel caricamento dei messaggi.")}}),T=y(M(d,"clients")),$=b(T,x=>{try{const r=x.docs.map(e=>({id:e.id,...e.data()})).filter(e=>{const n=i(e.scadenza);if(!n)return!1;const a=(n-new Date)/(1e3*60*60*24);return a<=15&&a>0}).map(e=>({type:"expiring",clientId:e.id,clientName:e.name,description:`Abbonamento in scadenza tra ${Math.ceil((i(e.scadenza)-new Date)/864e5)} giorni`,date:e.scadenza}));s(e=>[...e.filter(a=>a.type!=="expiring"),...r].sort((a,h)=>i(h.date)-i(a.date)))}catch(r){console.error("Errore snapshot clients:",r),u("Errore nel caricamento delle scadenze.")}});return()=>{g(),C(),S(),$()}},[m]);const U={hidden:{opacity:0},visible:{opacity:1,transition:{staggerChildren:.1}}},N={hidden:{y:20,opacity:0},visible:{y:0,opacity:1}};return E?t.jsx("div",{className:"min-h-screen bg-slate-900 text-red-400 flex justify-center items-center",children:E}):I?t.jsx(Y,{}):t.jsx("div",{className:"min-h-screen text-slate-200 relative overflow-x-hidden w-full",children:t.jsxs(j.div,{initial:"hidden",animate:"visible",variants:U,className:"w-full py-4 sm:py-6",children:[t.jsxs(j.header,{variants:N,className:"flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-8 mx-3 sm:mx-6",children:[t.jsxs("h1",{className:"text-3xl sm:text-4xl font-bold text-slate-50 flex items-center gap-2",children:[t.jsx(V,{size:28})," Aggiornamenti Utili"]}),t.jsxs("button",{onClick:()=>c("/coach-dashboard"),className:"flex items-center gap-2 px-3 py-2 bg-slate-700/50 hover:bg-slate-700/70 border border-slate-600 text-slate-300 text-sm font-semibold rounded-lg transition-colors",children:[t.jsx(O,{size:16}),t.jsx("span",{children:"Torna alla Dashboard"})]})]}),t.jsxs(j.div,{variants:N,className:"bg-slate-800/60 backdrop-blur-sm p-4 sm:p-6 rounded-xl border border-slate-700 mx-3 sm:mx-6",children:[t.jsxs("h2",{className:"text-lg font-semibold mb-4 flex items-center gap-2 text-slate-200",children:[t.jsx(V,{size:20})," Ultimi Aggiornamenti"]}),t.jsx("div",{className:"space-y-3 max-h-[90vh] overflow-y-auto pr-2",children:t.jsx(Q,{children:o.length>0?o.map(l=>{var g;return t.jsx(Z,{item:l,navigate:c,variants:N},`${l.type}-${l.clientId}-${(g=l.date)==null?void 0:g.seconds}`)}):t.jsx("p",{className:"text-slate-400 text-center p-4",children:"Nessun aggiornamento recente."})})})]})]})})}export{te as default};
