import{r as d,h as K,g as Q,j as e,aC as ee,q as S,b7 as te,e as I,f as se,V as M,W as ae,X as re,T as oe,A as O,aZ as le,b8 as ne,av as R,aT as ie,a7 as $,u as ce,aU as de,at as he,b6 as ue}from"./.pnpm-C04Ba0Xq.js";import{d as C}from"./index-DdCoIfwr.js";import{u as me}from"./storageUtils-DXx8Ax3l.js";import{n as A}from"./normalizePhotoURLs-D7k3b5VC.js";import"./cloudflareStorage-DUIVXCyJ.js";const xe=`
  .react-calendar { width: 100%; background: transparent; border: none; font-family: inherit; }
  .react-calendar__navigation button { color: #67e8f9; font-weight: bold; font-size: 1.1em; }
  .react-calendar__navigation button:hover, .react-calendar__navigation button:focus { background: rgba(255, 255, 255, 0.1); border-radius: 0.5rem; }
  .react-calendar__month-view__weekdays__weekday { color: #9ca3af; text-transform: uppercase; font-size: 0.75rem; font-weight: 600; }
  .react-calendar__tile { color: #d1d5db; border-radius: 0.5rem; height: 50px; }
  .react-calendar__tile:disabled { color: #6b7280; }
  .react-calendar__tile:enabled:hover, .react-calendar__tile:enabled:focus { background: rgba(255, 255, 255, 0.1); }
  .react-calendar__tile--now { background: rgba(63, 63, 70, 0.7); font-weight: bold; }
  .react-calendar__tile--active { background: #0891b2; color: white; }
  .check-day { position: relative; }
  .check-day::after { content: ''; position: absolute; bottom: 8px; left: 50%; transform: translateX(-50%); width: 6px; height: 6px; border-radius: 50%; background-color: #f43f5e; }
  .check-submitted { position: relative; background-color: rgba(16, 185, 129, 0.2); }
  .check-submitted::after { content: ''; position: absolute; bottom: 8px; left: 50%; transform: translateX(-50%); width: 6px; height: 6px; border-radius: 50%; background-color: #10b981; }
`,ge=()=>e.jsx("div",{className:"min-h-screen flex justify-center items-center relative",children:e.jsx("div",{className:"animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-cyan-400"})}),pe=({message:a,type:i,onDismiss:l})=>e.jsx(O,{children:a&&e.jsxs(S.div,{initial:{opacity:0,y:-50},animate:{opacity:1,y:0},exit:{opacity:0,y:-50},className:`fixed top-5 right-5 z-50 flex items-center gap-4 p-4 rounded-lg border ${i==="success"?"bg-emerald-900/80 text-emerald-300 border-emerald-500/30":"bg-red-900/80 text-red-300 border-red-500/30"} backdrop-blur-md shadow-lg`,children:[i==="success"?e.jsx(le,{}):e.jsx(ne,{}),e.jsx("p",{children:a}),e.jsx("button",{onClick:l,className:"p-2 rounded-full hover:bg-white/10 min-w-[44px] min-h-[44px] flex items-center justify-center",children:e.jsx(R,{size:16})})]})}),fe=({formState:a,setFormState:i,handleSubmit:l,isUploading:x,uploadProgress:b,handleFileChange:p})=>{const w=()=>i({id:null,notes:"",weight:"",photos:{},photoPreviews:{}}),o=({type:h,label:m,preview:N})=>e.jsxs("div",{className:"text-center",children:[e.jsx("label",{className:"block text-sm font-medium text-slate-300",children:m}),e.jsxs("div",{className:"mt-2 flex justify-center items-center w-full h-48 bg-slate-700/30 rounded-lg border-2 border-dashed border-slate-600 hover:border-cyan-500 transition-colors relative group",children:[N?e.jsx("img",{src:N,alt:"preview",className:"h-full w-full object-contain rounded-lg p-1"}):e.jsxs("div",{className:"flex flex-col items-center text-slate-400 transition-colors group-hover:text-cyan-400",children:[e.jsx(ue,{size:32}),e.jsx("p",{className:"mt-2 text-sm",children:"Carica foto"})]}),e.jsx("input",{type:"file",accept:"image/*",onChange:D=>p(D,h),className:"absolute inset-0 w-full h-full opacity-0 cursor-pointer"})]})]});return e.jsxs("div",{children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("h3",{className:"font-bold text-lg mb-4 text-cyan-300",children:a.id?"Modifica Check":"Carica Check"}),e.jsx("button",{onClick:w,className:"text-slate-400 hover:text-white p-2 rounded-full min-w-[44px] min-h-[44px] flex items-center justify-center",children:e.jsx(R,{size:20})})]}),e.jsxs("form",{onSubmit:l,className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-300 mb-2",children:"Peso Attuale (kg)*"}),e.jsx("input",{type:"number",step:"0.1",value:a.weight,onChange:h=>i(m=>({...m,weight:h.target.value})),required:!0,className:"w-full p-2.5 bg-slate-700/50 border border-slate-600 rounded-lg outline-none focus:ring-2 focus:ring-cyan-500 text-slate-200",placeholder:"Es. 75.5"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-300 mb-2",children:"Note sul check"}),e.jsx("textarea",{value:a.notes,onChange:h=>i(m=>({...m,notes:h.target.value})),rows:"4",className:"w-full p-2.5 bg-slate-700/50 border border-slate-600 rounded-lg outline-none focus:ring-2 focus:ring-cyan-500 text-slate-200"})]}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6",children:[e.jsx(o,{type:"front",label:"Frontale",preview:a.photoPreviews.front}),e.jsx(o,{type:"right",label:"Laterale Destro",preview:a.photoPreviews.right}),e.jsx(o,{type:"left",label:"Laterale Sinistro",preview:a.photoPreviews.left}),e.jsx(o,{type:"back",label:"Posteriore",preview:a.photoPreviews.back})]}),x&&e.jsx("div",{className:"w-full bg-slate-700/50 rounded-lg h-3 overflow-hidden",children:e.jsx("div",{className:"h-full bg-gradient-to-r from-cyan-500 via-cyan-400 to-teal-400 transition-all",style:{width:`${b}%`}})}),e.jsx("div",{className:"flex justify-end",children:e.jsxs("button",{type:"submit",disabled:x,className:"flex items-center gap-2 px-5 py-2.5 bg-cyan-600 hover:bg-cyan-700 text-white rounded-lg transition font-semibold disabled:opacity-50",children:[e.jsx(ie,{size:16}),x?`Caricamento ${b}%`:a.id?"Salva Modifiche":"Invia Check"]})})]})]})},be=({isOpen:a,imageUrl:i,onClose:l})=>e.jsx(O,{children:a&&e.jsx(S.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},onClick:l,className:"fixed inset-0 bg-black/90 backdrop-blur-sm flex justify-center items-center z-50 p-4",children:e.jsxs(S.div,{initial:{scale:.9},animate:{scale:1},exit:{scale:.9},onClick:x=>x.stopPropagation(),className:"relative max-w-6xl max-h-[90vh] w-full",children:[e.jsx("button",{onClick:l,className:"absolute top-4 right-4 p-2 bg-slate-800/80 hover:bg-slate-700 text-white rounded-full z-10 transition-colors",children:e.jsx(R,{size:24})}),e.jsx("img",{src:i,alt:"Full size",className:"w-full h-full object-contain rounded-lg"})]})})}),je=({check:a,handleEditClick:i})=>{const[l,x]=d.useState({}),[b,p]=d.useState(null),w=(new Date-a.createdAt.toDate())/(1e3*60*60)<2;return d.useEffect(()=>{(async()=>{if(a.photoURLs){const h=A(a.photoURLs);x(h),console.debug("[ClientChecks] Normalized photoURLs for check",a.id,h)}})()},[a.photoURLs]),e.jsxs("div",{children:[e.jsx(be,{isOpen:!!b,imageUrl:b,onClose:()=>p(null)}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("h3",{className:"font-bold text-lg text-cyan-300",children:["Riepilogo del ",a.createdAt.toDate().toLocaleDateString("it-IT")]}),w&&e.jsxs("button",{onClick:()=>i(a),className:"flex items-center gap-2 px-3 py-1.5 bg-slate-700/50 hover:bg-slate-700/70 text-slate-300 text-sm font-semibold rounded-lg",children:[e.jsx(he,{size:14})," Modifica"]})]}),e.jsxs("div",{className:"mt-4 space-y-4",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold text-slate-300",children:"Peso Registrato:"}),e.jsxs("p",{className:"text-white text-xl font-bold",children:[a.weight," kg"]})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold text-slate-300",children:"Note:"}),e.jsx("p",{className:"text-slate-400 p-3 bg-slate-700/50 rounded-lg whitespace-pre-wrap",children:a.notes||"Nessuna nota."})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold text-slate-300",children:"Foto:"}),e.jsx("div",{className:"grid grid-cols-2 sm:grid-cols-4 gap-4 mt-2",children:["front","right","left","back"].map(o=>e.jsxs("div",{className:"text-center relative group",children:[e.jsx("h5",{className:"text-sm font-semibold text-slate-400 capitalize",children:o==="front"?"Frontale":o==="back"?"Posteriore":`Laterale ${o==="left"?"Sinistro":"Destro"}`}),l[o]?e.jsx("button",{onClick:()=>p(l[o]),className:"block w-full h-48 overflow-hidden rounded-lg transition-all duration-300 group-hover:shadow-lg group-hover:shadow-cyan-500/20 cursor-pointer",children:e.jsx("img",{src:l[o],alt:o,className:"w-full h-full object-cover rounded-lg hover:opacity-90 transition-opacity"})}):e.jsx("div",{className:"w-full h-48 bg-slate-700/50 rounded-lg text-slate-500 flex items-center justify-center",children:"Foto non disponibile"})]},o))})]})]})]})};function Ce(){const[a,i]=d.useState(null),[l,x]=d.useState([]),[b,p]=d.useState(!0),[w,o]=d.useState(new Date),[h,m]=d.useState({id:null,notes:"",weight:"",photos:{},photoPreviews:{}}),[N,D]=d.useState(!1),[q,P]=d.useState(0),[z,U]=d.useState({message:"",type:""}),[F,T]=d.useState(null),_=K(),f=Q().currentUser;d.useEffect(()=>{if(!f){_("/login");return}(async()=>{try{const t=I(C,"clients",f.uid),r=await se(t);r.exists()&&r.data().createdAt?i(r.data().createdAt.toDate()):i(new Date);const n=M(C,`clients/${f.uid}/checks`),k=ae(n,re("createdAt","desc"));return oe(k,async g=>{const v=g.docs.map(c=>({id:c.id,...c.data()})).map(c=>c.photoURLs?{...c,photoURLs:A(c.photoURLs)}:c);console.debug("[ClientChecks] Snapshot normalized"),x(v),p(!1)},g=>{console.error("Errore snapshot checks:",g),T("Errore nel caricamento dei check."),p(!1)})}catch(t){console.error("Errore fetchInitialData:",t),T("Errore nel caricamento dei dati."),p(!1)}})()},[f,_]);const y=(s,t="error")=>{U({message:s,type:t}),setTimeout(()=>U({message:"",type:""}),5e3)},X=s=>{try{if(!l.length)return[];const t=l.reduce((u,g)=>{var v;const j=(v=g.createdAt)==null?void 0:v.toDate();return!u||j&&j<u?j:u},null);if(!t)return[];let r=[],n=new Date(t.getTime());const k=new Date(s.getFullYear(),s.getMonth()+2,1);for(;n.getTime()<k.getTime();)n.getMonth()===s.getMonth()&&n.getFullYear()===s.getFullYear()&&r.push(new Date(n.getTime())),n.setDate(n.getDate()+7);return r}catch(t){return console.error("Errore getSuggestedCheckDays:",t),[]}},Y=({date:s,view:t})=>{try{if(t==="month"){if(l.some(r=>r.createdAt&&r.createdAt.toDate&&r.createdAt.toDate().toDateString()===s.toDateString()))return"check-submitted";if(X(s).some(r=>r.toDateString()===s.toDateString()))return"check-day"}return null}catch(r){return console.error("Errore tileClassName:",r),null}},B=(s,t)=>{try{const r=s.target.files[0];r&&m(n=>({...n,photos:{...n.photos,[t]:r},photoPreviews:{...n.photoPreviews,[t]:URL.createObjectURL(r)}}))}catch(r){console.error("Errore handleFileChange:",r),y("Errore nel caricamento della foto.")}},V=s=>{try{o(s.createdAt.toDate()),m({id:s.id,notes:s.notes||"",weight:s.weight||"",photos:{},photoPreviews:A(s.photoURLs)||{}})}catch(t){console.error("Errore handleEditClick:",t),y("Errore nella modifica del check.")}},W=async s=>{s.preventDefault();const{id:t,notes:r,weight:n,photos:k}=h;if(!f||!t&&Object.values(k).some(u=>!u)||!n){y("Compila il peso e carica tutte e 4 le foto se è un nuovo check.");return}D(!0),P(0);try{const u=t?l.find(c=>c.id===t):null;let g=u?{...u.photoURLs}:{front:null,right:null,left:null,back:null};const j=Object.entries(k).filter(([,c])=>c);if(j.length>0){const c=j.map(async([E,L])=>{const H=await me(L,f.uid,"check_photos",J=>{P(J.percent)});return{type:E,url:H}}),G=await Promise.all(c);g={...g,...Object.fromEntries(G.map(({type:E,url:L})=>[E,L]))}}const v={notes:r,weight:parseFloat(n),photoURLs:g,createdAt:t?u.createdAt:$()};t?(await ce(I(C,`clients/${f.uid}/checks`,t),{...v,lastUpdatedAt:$()}),y("Check modificato con successo!","success")):(await de(M(C,`clients/${f.uid}/checks`),v),y("Check caricato con successo!","success")),m({id:null,notes:"",weight:"",photos:{},photoPreviews:{}})}catch(u){console.error("Errore handleSubmit:",u),y("Si è verificato un errore.")}finally{setTimeout(()=>{D(!1),P(0)},400)}},Z=()=>{try{const s=l.find(t=>t.createdAt&&t.createdAt.toDate&&t.createdAt.toDate().toDateString()===w.toDateString());return h.id||!s?e.jsx(fe,{formState:h,setFormState:m,handleSubmit:W,isUploading:N,uploadProgress:q,handleFileChange:B}):s?e.jsx(je,{check:s,handleEditClick:V}):e.jsx("p",{className:"text-center text-slate-400 p-8",children:"Nessun check previsto o registrato per questa data."})}catch(s){return console.error("Errore renderContentForDate:",s),e.jsx("p",{className:"text-center text-red-400 p-8",children:"Errore nel caricamento del contenuto."})}};return F?e.jsx("div",{className:"min-h-screen text-red-400 flex justify-center items-center p-4",children:F}):b?e.jsx(ge,{}):e.jsxs(e.Fragment,{children:[e.jsx("style",{children:xe}),e.jsxs("div",{className:"min-h-screen text-slate-200 p-4 sm:p-8 relative",children:[e.jsx(pe,{message:z.message,type:z.type,onDismiss:()=>U({message:"",type:""})}),e.jsxs("header",{className:"flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-8",children:[e.jsx("h1",{className:"text-3xl sm:text-4xl font-bold text-slate-50",children:"I miei Check"}),e.jsxs("button",{onClick:()=>_("/client/dashboard"),className:"flex items-center gap-2 px-3 py-2 bg-slate-700/50 hover:bg-slate-700/70 text-slate-300 text-sm font-semibold rounded-lg transition-colors",children:[e.jsx(ee,{size:16}),e.jsx("span",{children:"Dashboard"})]})]}),e.jsxs(S.div,{initial:{opacity:0},animate:{opacity:1},className:"grid grid-cols-1 lg:grid-cols-3 gap-8",children:[e.jsx("div",{className:"lg:col-span-1 bg-slate-800/60 backdrop-blur-sm rounded-2xl border border-slate-700 p-4",children:e.jsx(te,{onChange:o,value:w,tileClassName:Y})}),e.jsx("div",{className:"lg:col-span-2 bg-slate-800/60 backdrop-blur-sm rounded-2xl border border-slate-700 p-6 min-h-[400px]",children:Z()})]})]})]})}export{Ce as default};
