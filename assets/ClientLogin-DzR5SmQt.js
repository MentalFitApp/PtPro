import{r,j as e}from"./react-CrXOBDSJ.js";import{L as D}from"./react-router-dom-9rcY47vU.js";import{g as O,a as V}from"./firebase-CCo3Hvf0.js";import{y,z as b}from"./@firebase-Dy5qmm0I.js";import{d as v}from"./index-s4mEkYh8.js";import{a as T}from"./react-router-BxpCmtJ-.js";import{m as L}from"./framer-motion-BAPjnw1b.js";import{d as U,L as B,E as H,e as K,K as W}from"./lucide-react-OWEKwkjs.js";import"./core-js-ChGsxLo2.js";import"./react-dom-BpmKF3Ga.js";import"./scheduler-DYLXRpC5.js";import"./@remix-run-CjG9tKj3.js";import"./tslib-BGVaTf34.js";import"./idb-Bn1DMRyg.js";import"./jspdf-7Jyqi_bl.js";import"./@babel-Cvov1XSu.js";import"./fflate-XZmX483V.js";import"./fast-png-CUrN0NP5.js";import"./iobuffer-DZ1zOcUT.js";import"./pako-B9FS3IR_.js";import"./motion-dom-C8PdgYBP.js";import"./motion-utils-DBsP9okC.js";const _=()=>{const s=r.useRef(null),n=r.useRef(!1);return r.useEffect(()=>{if(n.current)return;let i=document.querySelector(".stars");if(i)s.current=i;else{i=document.createElement("div"),i.className="stars";let a=document.querySelector(".starry-background");a||(a=document.createElement("div"),a.className="starry-background",document.body.appendChild(a)),a.appendChild(i),s.current=i}for(let a=0;a<30;a++){const o=document.createElement("div");o.className="star",o.style.setProperty("--top-offset",`${Math.random()*100}vh`),o.style.setProperty("--fall-duration",`${8+Math.random()*6}s`),o.style.setProperty("--fall-delay",`${Math.random()*5}s`),o.style.setProperty("--star-width",`${1+Math.random()*2}px`),s.current.appendChild(o)}return n.current=!0,()=>{if(s.current)for(;s.current.firstChild;)s.current.removeChild(s.current.firstChild)}},[]),e.jsx("div",{className:"starry-background",children:e.jsx("div",{className:"stars"})})};function fe(){const s=T(),n=O(),[i,a]=r.useState(""),[o,R]=r.useState(""),[w,c]=r.useState(""),[d,f]=r.useState(!1),[u,j]=r.useState(!0),[x,q]=r.useState(!1);r.useEffect(()=>{const l=n.onAuthStateChanged(async t=>{var m,p;try{if(t){console.log("Utente autenticato all'avvio:",{uid:t.uid,email:t.email});const g=y(v,"roles","admins"),M=y(v,"roles","coaches"),$=y(v,"clients",t.uid),[S,k,h]=await Promise.all([b(g).catch(()=>({exists:()=>!1,data:()=>({uids:[]})})),b(M).catch(()=>({exists:()=>!1,data:()=>({uids:[]})})),b($).catch(()=>({exists:()=>!1,data:()=>({})}))]),z=S.exists()&&((m=S.data().uids)==null?void 0:m.includes(t.uid)),A=k.exists()&&((p=k.data().uids)==null?void 0:p.includes(t.uid)),P=h.exists()&&h.data().isClient===!0;if(console.log("Debug ruolo in ClientLogin:",{uid:t.uid,email:t.email,isAdmin:z,isCoach:A,isClient:P,clientDocData:h.exists()?h.data():null}),z||A){c("Accesso non autorizzato per admin/coach. Usa il login admin."),await n.signOut(),j(!1);return}P?(sessionStorage.setItem("app_role","client"),s(h.data().firstLogin?"/client/first-access":"/client/dashboard")):(c("Accesso non autorizzato. Contatta il tuo coach."),await n.signOut())}}catch(g){console.error("Errore verifica ruolo:",g),c("Errore durante la verifica del ruolo. Riprova.")}finally{j(!1)}});return()=>l()},[s,n]);const I=async l=>{l.preventDefault(),c(""),f(!0);try{const t=i.trim().toLowerCase(),m=o.trim();if(!t||!m){c("Email e password sono obbligatori."),f(!1);return}console.log("Tentativo di login:",{email:t});const p=await V(n,t,m);console.log("Login riuscito:",{uid:p.user.uid,email:p.user.email})}catch(t){console.error("Errore login:",t.code,t.message),c(t.code==="auth/invalid-credential"?"Credenziali non valide. Verifica email e password.":t.code==="auth/user-not-found"?"Utente non trovato. Verifica l'email.":t.code==="auth/wrong-password"?"Password errata. Riprova.":t.code==="auth/too-many-requests"?"Troppi tentativi. Riprova tra qualche minuto.":t.code==="auth/network-request-failed"?"Errore di connessione. Verifica la tua rete.":"Errore durante il login: "+t.message),f(!1)}},C="relative",N="w-full p-3 pl-10 bg-slate-700/50 border border-slate-600 rounded-lg outline-none focus:ring-2 focus:ring-cyan-500 text-slate-200",E="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400";return u?e.jsxs("div",{className:"flex flex-col justify-center items-center min-h-screen bg-slate-900",children:[e.jsx("div",{className:"animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-rose-500"}),e.jsx("p",{className:"mt-4 text-sm",children:"Verifica autenticazione..."})]}):e.jsxs("div",{className:"min-h-screen flex items-center justify-center p-4",children:[e.jsx(_,{}),e.jsxs(L.div,{className:"w-full max-w-md bg-slate-800/60 backdrop-blur-sm rounded-2xl border border-slate-700 p-8 space-y-8 shadow-2xl shadow-black/20",initial:{opacity:0,scale:.9},animate:{opacity:1,scale:1},transition:{duration:.5,ease:"easeInOut"},children:[e.jsxs("div",{className:"text-center",children:[e.jsx("h2",{className:"text-3xl font-bold text-slate-50",children:"Login Cliente"}),e.jsx("p",{className:"text-sm text-slate-400 mt-2",children:"Accedi al tuo account per gestire il tuo percorso."})]}),e.jsxs("form",{onSubmit:I,className:"space-y-6",children:[e.jsxs("div",{className:C,children:[e.jsx(U,{size:18,className:E}),e.jsx("input",{type:"email",value:i,onChange:l=>a(l.target.value),required:!0,placeholder:"Email",className:N,autoComplete:"email",disabled:d||u})]}),e.jsxs("div",{className:C,children:[e.jsx(B,{size:18,className:E}),e.jsx("input",{type:x?"text":"password",value:o,onChange:l=>R(l.target.value),required:!0,placeholder:"Password",className:`${N} pr-10`,autoComplete:"current-password",disabled:d||u}),e.jsx("button",{type:"button",onClick:()=>q(!x),className:"absolute right-3 top-1/2 transform -translate-y-1/2 text-slate-400",children:x?e.jsx(H,{size:18}):e.jsx(K,{size:18})})]}),w&&e.jsx("p",{className:"text-red-500 text-sm text-center",children:w}),e.jsx("div",{children:e.jsxs(L.button,{type:"submit",disabled:d||u,className:"w-full flex items-center justify-center gap-2 px-4 py-3 font-bold text-white bg-cyan-600 rounded-lg hover:bg-cyan-700 transition-colors disabled:bg-cyan-900 disabled:cursor-not-allowed",whileHover:{scale:d||u?1:1.02},whileTap:{scale:d||u?1:.98},transition:{duration:.2},children:[e.jsx(W,{size:18}),d?"Accesso in corso...":"Accedi"]})})]}),e.jsxs("div",{className:"text-center",children:[e.jsx(D,{to:"/client/forgot-password",className:"text-sm text-slate-400 hover:text-cyan-400 hover:underline transition-colors",children:"Password dimenticata?"}),e.jsx(D,{to:"/login",className:"text-sm text-slate-400 hover:text-cyan-400 hover:underline transition-colors block mt-2",children:"Sei un coach o admin? Accedi qui"})]})]})]})}export{fe as default};
