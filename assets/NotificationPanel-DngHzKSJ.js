import{r as i,j as e}from"./react-CrXOBDSJ.js";import{a as h,d as n}from"./index-DGG2IrXP.js";import{H,R as A,G as M,D as U,Y,Z as q,K as B,y as f,A as k}from"./@firebase-DgmhcEwT.js";import{m as p,A as I}from"./framer-motion-BAPjnw1b.js";import{a5 as K,B as P,X as O,y as Q}from"./lucide-react-CCY59hBS.js";function J({userType:c="client"}){const[l,C]=i.useState([]),[b,g]=i.useState(!1),[N,j]=i.useState(!1),[d,E]=i.useState(0),m=i.useRef(null),u=i.useRef(0);i.useEffect(()=>{if(!h.currentUser)return;const t=Notification.permission;g(t==="granted");const s=H(M(n,"notifications"),A("userId","==",h.currentUser.uid),A("userType","==",c)),r=U(s,Z=>{const o=Z.docs.map(a=>({id:a.id,...a.data()})).sort((a,y)=>{var v,w;const D=(v=a.sentAt)!=null&&v.toMillis?a.sentAt.toMillis():0;return((w=y.sentAt)!=null&&w.toMillis?y.sentAt.toMillis():0)-D}),x=o.filter(a=>!a.read).length;x>u.current&&u.current>0&&(S(),t==="granted"&&o[0]&&new Notification(o[0].title||"Nuova notifica",{body:o[0].body||"",icon:"/PtPro/logo192.png",badge:"/PtPro/logo192.png",tag:"notification-"+o[0].id})),u.current=x,C(o),E(x)});return()=>r()},[c]);const S=()=>{m.current&&m.current.play().catch(t=>console.log("Audio play error:",t))},R=async()=>{try{if(await Notification.requestPermission()==="granted"){g(!0);const s=Y(),r=await q(s,{vapidKey:"BLp0b5Z5uqZ3yFHYQcEY6Q7K4FZ5YHT9OHQ7Y5Z5O5Z5"});r&&await B(f(n,"fcmTokens",h.currentUser.uid),{token:r,userType:c,updatedAt:serverTimestamp()},{merge:!0})}}catch(t){console.error("Errore attivazione notifiche:",t)}},T=async t=>{try{await k(f(n,"notifications",t),{read:!0})}catch(s){console.error("Errore marcatura notifica letta:",s)}},z=async()=>{try{const t=l.filter(s=>!s.read);await Promise.all(t.map(s=>k(f(n,"notifications",s.id),{read:!0})))}catch(t){console.error("Errore marcatura tutte lette:",t)}};return e.jsxs("div",{className:"relative",children:[!b&&e.jsxs(p.button,{onClick:R,whileHover:{scale:1.05},whileTap:{scale:.95},className:"flex items-center gap-2 px-4 py-2 bg-rose-600 hover:bg-rose-700 text-white rounded-lg font-medium transition-colors",children:[e.jsx(K,{size:18}),"Attiva Notifiche"]}),b&&e.jsxs("button",{onClick:()=>j(!N),className:"relative p-2 hover:bg-white/10 rounded-lg transition-colors",children:[e.jsx(P,{size:24,className:"text-slate-300"}),d>0&&e.jsx("span",{className:"absolute -top-1 -right-1 bg-rose-600 text-white text-xs font-bold rounded-full w-5 h-5 flex items-center justify-center",children:d})]}),e.jsx(I,{children:N&&e.jsxs(p.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},exit:{opacity:0,y:10},className:"absolute right-0 top-14 w-96 max-h-[500px] bg-slate-800 border border-slate-700 rounded-xl shadow-2xl z-50 overflow-hidden",children:[e.jsxs("div",{className:"flex items-center justify-between p-4 border-b border-slate-700",children:[e.jsx("h3",{className:"font-bold text-slate-200",children:"Notifiche"}),e.jsxs("div",{className:"flex items-center gap-2",children:[d>0&&e.jsx("button",{onClick:z,className:"text-xs text-rose-400 hover:text-rose-300 transition-colors",children:"Segna tutte lette"}),e.jsx("button",{onClick:()=>j(!1),className:"p-1 hover:bg-white/10 rounded transition-colors",children:e.jsx(O,{size:18,className:"text-slate-400"})})]})]}),e.jsx("div",{className:"overflow-y-auto max-h-[420px]",children:l.length===0?e.jsxs("div",{className:"p-8 text-center text-slate-400",children:[e.jsx(P,{size:48,className:"mx-auto mb-3 opacity-30"}),e.jsx("p",{children:"Nessuna notifica"})]}):l.map(t=>{var s;return e.jsx(p.div,{layout:!0,className:`p-4 border-b border-slate-700 hover:bg-white/5 transition-colors cursor-pointer ${t.read?"":"bg-rose-900/10"}`,onClick:()=>!t.read&&T(t.id),children:e.jsxs("div",{className:"flex items-start justify-between gap-3",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("h4",{className:"font-medium text-slate-200 text-sm",children:t.title}),!t.read&&e.jsx("span",{className:"w-2 h-2 bg-rose-500 rounded-full"})]}),e.jsx("p",{className:"text-sm text-slate-400",children:t.body}),e.jsx("p",{className:"text-xs text-slate-500 mt-2",children:(s=t.sentAt)==null?void 0:s.toDate().toLocaleDateString("it-IT",{day:"numeric",month:"short",hour:"2-digit",minute:"2-digit"})})]}),t.read&&e.jsx(Q,{size:16,className:"text-emerald-500 flex-shrink-0"})]})},t.id)})})]})}),e.jsx("audio",{ref:m,src:"/PtPro/mixkit-long-pop-2358.wav",preload:"auto"})]})}export{J as N};
