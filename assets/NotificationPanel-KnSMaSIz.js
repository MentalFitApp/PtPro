import{r as a,W as U,aO as k,V as F,T as z,j as e,q as h,bm as I,B as C,A as L,av as O,aG as B,d as K,bn as G,a6 as J,e as p,a7 as W,u as P}from"./.pnpm-C04Ba0Xq.js";import{a as g,d as n}from"./index-DdCoIfwr.js";function V({userType:c="client"}){const[l,A]=a.useState([]),[N,d]=a.useState(!1),[b,v]=a.useState(!1),[u,M]=a.useState(0),m=a.useRef(null),f=a.useRef(0);a.useEffect(()=>{if(!g.currentUser)return;const t=typeof Notification<"u"?Notification.permission:"denied";d(t==="granted");const s=U(F(n,"notifications"),k("userId","==",g.currentUser.uid),k("userType","==",c)),i=z(s,D=>{const r=D.docs.map(o=>({id:o.id,...o.data()})).sort((o,w)=>{var j,y;const R=(j=o.sentAt)!=null&&j.toMillis?o.sentAt.toMillis():0;return((y=w.sentAt)!=null&&y.toMillis?w.sentAt.toMillis():0)-R}),x=r.filter(o=>!o.read).length;x>f.current&&f.current>0&&(q(),typeof Notification<"u"&&t==="granted"&&r[0]&&new Notification(r[0].title||"Nuova notifica",{body:r[0].body||"",icon:"/PtPro/logo192.png",badge:"/PtPro/logo192.png",tag:"notification-"+r[0].id})),f.current=x,A(r),M(x)});return()=>i()},[c]);const q=()=>{m.current&&m.current.play().catch(t=>console.log("Audio play error:",t))},E=async()=>{try{if(typeof Notification>"u"){alert("âš ï¸ Le notifiche browser non sono supportate su questo dispositivo. Riceverai comunque le notifiche in-app!"),d(!0);return}console.log("ðŸ”” Richiesta permessi notifica...");const t=await Notification.requestPermission();if(console.log("âœ… Permesso notifica:",t),t==="granted"){d(!0);try{console.log("ðŸ“± Ottenendo token FCM...");const s=K();console.log("Messaging instance:",s?"OK":"NULL");const i=await G(s,{vapidKey:"BKagOny0KQcd-p9DC2P4pDlZ3Owv1L-n6bqqQWTUl_G2aS9qLJMIvZo3aDlN6hG1IqJeM5HJqVxD4Cc5sqUZqAU"});i?(console.log("âœ… Token FCM ottenuto:",i),console.log("ðŸ’¾ Salvando token su Firestore..."),await J(p(n,"fcmTokens",g.currentUser.uid),{token:i,userType:c,updatedAt:W()},{merge:!0}),console.log("âœ… Token salvato su Firestore con successo!"),alert("âœ… Notifiche attivate con successo! Token: "+i.substring(0,20)+"...")):(console.warn("âš ï¸ Nessun token FCM ottenuto"),alert("âš ï¸ Notifiche browser attive, ma FCM token non disponibile"))}catch(s){console.error("âŒ Errore FCM token:",s),console.error("Dettagli errore:",s.code,s.message),alert("âŒ Errore FCM: "+s.message)}}else console.warn("âš ï¸ Permesso notifica negato"),alert("âš ï¸ Permesso notifica negato")}catch(t){console.error("âŒ Errore attivazione notifiche:",t),alert("âŒ Errore: "+t.message)}},T=async t=>{try{await P(p(n,"notifications",t),{read:!0})}catch(s){console.error("Errore marcatura notifica letta:",s)}},S=async()=>{try{const t=l.filter(s=>!s.read);await Promise.all(t.map(s=>P(p(n,"notifications",s.id),{read:!0})))}catch(t){console.error("Errore marcatura tutte lette:",t)}};return e.jsxs("div",{className:"relative",children:[!N&&e.jsxs(h.button,{onClick:E,whileHover:{scale:1.05},whileTap:{scale:.95},className:"flex items-center gap-2 px-4 py-2 bg-rose-600 hover:bg-rose-700 text-white rounded-lg font-medium transition-colors",children:[e.jsx(I,{size:18}),"Attiva Notifiche"]}),N&&e.jsxs("button",{onClick:()=>v(!b),className:"relative p-2 hover:bg-white/10 rounded-lg transition-colors",children:[e.jsx(C,{size:24,className:"text-slate-300"}),u>0&&e.jsx("span",{className:"absolute -top-1 -right-1 bg-rose-600 text-white text-xs font-bold rounded-full w-5 h-5 flex items-center justify-center",children:u})]}),e.jsx(L,{children:b&&e.jsxs(h.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},exit:{opacity:0,y:10},className:"fixed right-2 top-20 w-[calc(100vw-1rem)] sm:w-96 sm:right-4 max-h-[70vh] bg-slate-800 border border-slate-700 rounded-xl shadow-2xl z-[9999] overflow-hidden",children:[e.jsxs("div",{className:"flex items-center justify-between p-4 border-b border-slate-700",children:[e.jsx("h3",{className:"font-bold text-slate-200",children:"Notifiche"}),e.jsxs("div",{className:"flex items-center gap-2",children:[u>0&&e.jsx("button",{onClick:S,className:"text-xs text-rose-400 hover:text-rose-300 transition-colors",children:"Segna tutte lette"}),e.jsx("button",{onClick:()=>v(!1),className:"p-1 hover:bg-white/10 rounded transition-colors",children:e.jsx(O,{size:18,className:"text-slate-400"})})]})]}),e.jsx("div",{className:"overflow-y-auto max-h-[420px]",children:l.length===0?e.jsxs("div",{className:"p-8 text-center text-slate-400",children:[e.jsx(C,{size:48,className:"mx-auto mb-3 opacity-30"}),e.jsx("p",{children:"Nessuna notifica"})]}):l.map(t=>{var s;return e.jsx(h.div,{layout:!0,className:`p-4 border-b border-slate-700 hover:bg-white/5 transition-colors cursor-pointer ${t.read?"":"bg-rose-900/10"}`,onClick:()=>!t.read&&T(t.id),children:e.jsxs("div",{className:"flex items-start justify-between gap-3",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("h4",{className:"font-medium text-slate-200 text-sm",children:t.title}),!t.read&&e.jsx("span",{className:"w-2 h-2 bg-rose-500 rounded-full"})]}),e.jsx("p",{className:"text-sm text-slate-400",children:t.body}),e.jsx("p",{className:"text-xs text-slate-500 mt-2",children:(s=t.sentAt)==null?void 0:s.toDate().toLocaleDateString("it-IT",{day:"numeric",month:"short",hour:"2-digit",minute:"2-digit"})})]}),t.read&&e.jsx(B,{size:16,className:"text-emerald-500 flex-shrink-0"})]})},t.id)})})]})}),e.jsx("audio",{ref:m,src:"/PtPro/mixkit-long-pop-2358.wav",preload:"auto"})]})}export{V as N};
