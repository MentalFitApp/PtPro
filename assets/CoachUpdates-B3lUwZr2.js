import{r as f,j as t}from"./react-CrXOBDSJ.js";import{A as $,J as y,K as C,M,H as b,U as F,I as D,B as w,N as O,O as Q}from"./@firebase-CuwLCerw.js";import{d,t as i}from"./index-CqnSUkzk.js";import{a as q}from"./react-router-BxpCmtJ-.js";import{m as j,A as H}from"./framer-motion-BAPjnw1b.js";import{B as I,u as R,M as X,F as J,h as G,j as K}from"./lucide-react-CCY59hBS.js";import"./core-js-ChGsxLo2.js";import"./idb-Bn1DMRyg.js";import"./react-dom-BpmKF3Ga.js";import"./scheduler-DYLXRpC5.js";import"./react-router-dom-9rcY47vU.js";import"./@remix-run-CjG9tKj3.js";import"./jspdf-7Jyqi_bl.js";import"./@babel-Cvov1XSu.js";import"./fflate-XZmX483V.js";import"./fast-png-CUrN0NP5.js";import"./iobuffer-DZ1zOcUT.js";import"./pako-B9FS3IR_.js";import"./firebase-Bp3EI6Ad.js";import"./tslib-BGVaTf34.js";import"./motion-dom-C8PdgYBP.js";import"./motion-utils-DBsP9okC.js";const P=o=>{if(!o)return"";try{const c=Math.floor((new Date-i(o))/1e3);let s=c/31536e3;return s>1?Math.floor(s)+" anni fa":(s=c/2592e3,s>1?Math.floor(s)+" mesi fa":(s=c/86400,s>1?Math.floor(s)+" gg fa":(s=c/3600,s>1?Math.floor(s)+" ore fa":(s=c/60,s>1?Math.floor(s)+" min fa":"ora"))))}catch(c){return console.error("Errore in timeAgo:",c),""}},W=()=>t.jsx("div",{className:"min-h-screen flex justify-center items-center relative",children:t.jsx("div",{className:"animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-cyan-400"})}),Z=({item:o,navigate:c,variants:s})=>{const m={expiring:t.jsx(K,{className:"text-yellow-500",size:18}),new_check:t.jsx(G,{className:"text-green-500",size:18}),new_anamnesi:t.jsx(J,{className:"text-blue-500",size:18}),new_message:t.jsx(X,{className:"text-rose-500",size:18})},v={expiring:"info",new_check:"checks",new_anamnesi:"anamnesi",new_message:"chat"};return t.jsxs(j.button,{variants:s,layout:!0,initial:{opacity:0,y:10},animate:{opacity:1,y:0},exit:{opacity:0,x:-10},transition:{duration:.3},onClick:()=>c(`/client/${o.clientId}?tab=${v[o.type]}`),className:"w-full flex items-start gap-4 p-3 rounded-lg bg-slate-500/5 hover:bg-slate-500/10 transition-colors text-left",children:[t.jsx("div",{className:"mt-1 flex-shrink-0",children:m[o.type]}),t.jsxs("div",{className:"flex-1",children:[t.jsx("p",{className:"text-sm font-semibold text-slate-200",children:o.clientName}),t.jsx("p",{className:"text-xs text-slate-400",children:o.description})]}),t.jsx("div",{className:"text-xs text-slate-500 flex-shrink-0",children:P(o.date)})]})};function je(){const o=q(),[c,s]=f.useState([]),[m,v]=f.useState(null),[V,k]=f.useState(!0),[E,u]=f.useState(null),z="l0RI8TzFjbNVoAdmcXNQkP9mWb12",U=["QwWST9OVOlTOi5oheyCqfpXLOLg2","AeZKjJYu5zMZ4mvffaGiqCBb0cF2","3j0AXIRa4XdHq1ywCl4UBxJNsku2",z];f.useEffect(()=>{const l=$(d,"app-data","lastViewed");(async()=>{try{const x=await w(l),A=x.exists()?x.data().timestamp:null;v(A),await O(l,{timestamp:Q()},{merge:!0}),k(!1)}catch(x){console.error("Errore fetchLastViewed:",x),u("Errore nel caricamento degli aggiornamenti."),k(!1)}})()},[]),f.useEffect(()=>{if(!m)return;const l=y(M(d,"checks"),C("createdAt","desc")),g=b(l,async p=>{try{const r=[];for(const e of p.docs)if(i(e.data().createdAt)>i(m)){const n=e.ref.parent.parent.id,a=await w(e(d,"clients",n));r.push({type:"new_check",clientId:n,clientName:a.exists()&&a.data().name||"Cliente",description:"Ha inviato un nuovo check-in",date:e.data().createdAt})}s(e=>[...e,...r].sort((n,a)=>i(a.date)-i(n.date)))}catch(r){console.error("Errore snapshot checks:",r),u("Errore nel caricamento dei check.")}}),x=y(M(d,"anamnesi"),C("submittedAt","desc")),A=b(x,async p=>{try{const r=[];for(const e of p.docs)if(i(e.data().submittedAt)>i(m)){const n=e.ref.parent.parent.id,a=await w(e(d,"clients",n));r.push({type:"new_anamnesi",clientId:n,clientName:a.exists()&&a.data().name||"Cliente",description:"Ha compilato l'anamnesi iniziale",date:e.data().submittedAt})}s(e=>[...e,...r].sort((n,a)=>i(a.date)-i(n.date)))}catch(r){console.error("Errore snapshot anamnesi:",r),u("Errore nel caricamento delle anamnesi.")}}),_=y(D(d,"chats"),F("participants","array-contains",z),C("lastUpdate","desc")),S=b(_,async p=>{try{const r=[];for(const e of p.docs){const n=e.data(),a=n.participants.find(h=>!U.includes(h));if(n.lastUpdate&&i(n.lastUpdate)>i(m)){const h=await w(e(d,"clients",a));r.push({type:"new_message",clientId:a,clientName:h.exists()&&h.data().name||"Cliente",description:`Nuovo messaggio: ${n.lastMessage.slice(0,30)}...`,date:e.data().lastUpdate})}}s(e=>[...e,...r].sort((n,a)=>i(a.date)-i(n.date)))}catch(r){console.error("Errore snapshot chats:",r),u("Errore nel caricamento dei messaggi.")}}),B=y(D(d,"clients")),T=b(B,p=>{try{const r=p.docs.map(e=>({id:e.id,...e.data()})).filter(e=>{const n=i(e.scadenza);if(!n)return!1;const a=(n-new Date)/(1e3*60*60*24);return a<=15&&a>0}).map(e=>({type:"expiring",clientId:e.id,clientName:e.name,description:`Abbonamento in scadenza tra ${Math.ceil((i(e.scadenza)-new Date)/864e5)} giorni`,date:e.scadenza}));s(e=>[...e.filter(a=>a.type!=="expiring"),...r].sort((a,h)=>i(h.date)-i(a.date)))}catch(r){console.error("Errore snapshot clients:",r),u("Errore nel caricamento delle scadenze.")}});return()=>{g(),A(),S(),T()}},[m]);const L={hidden:{opacity:0},visible:{opacity:1,transition:{staggerChildren:.1}}},N={hidden:{y:20,opacity:0},visible:{y:0,opacity:1}};return E?t.jsx("div",{className:"min-h-screen bg-slate-900 text-red-400 flex justify-center items-center",children:E}):V?t.jsx(W,{}):t.jsx("div",{className:"min-h-screen text-slate-200 relative overflow-x-hidden w-full",children:t.jsxs(j.div,{initial:"hidden",animate:"visible",variants:L,className:"w-full py-4 sm:py-6",children:[t.jsxs(j.header,{variants:N,className:"flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-8 mx-3 sm:mx-6",children:[t.jsxs("h1",{className:"text-3xl sm:text-4xl font-bold text-slate-50 flex items-center gap-2",children:[t.jsx(I,{size:28})," Aggiornamenti Utili"]}),t.jsxs("button",{onClick:()=>o("/coach-dashboard"),className:"flex items-center gap-2 px-3 py-2 bg-slate-700/50 hover:bg-slate-700/70 border border-slate-600 text-slate-300 text-sm font-semibold rounded-lg transition-colors",children:[t.jsx(R,{size:16}),t.jsx("span",{children:"Torna alla Dashboard"})]})]}),t.jsxs(j.div,{variants:N,className:"bg-slate-800/60 backdrop-blur-sm p-4 sm:p-6 rounded-xl border border-slate-700 mx-3 sm:mx-6",children:[t.jsxs("h2",{className:"text-lg font-semibold mb-4 flex items-center gap-2 text-slate-200",children:[t.jsx(I,{size:20})," Ultimi Aggiornamenti"]}),t.jsx("div",{className:"space-y-3 max-h-[90vh] overflow-y-auto pr-2",children:t.jsx(H,{children:c.length>0?c.map(l=>{var g;return t.jsx(Z,{item:l,navigate:o,variants:N},`${l.type}-${l.clientId}-${(g=l.date)==null?void 0:g.seconds}`)}):t.jsx("p",{className:"text-slate-400 text-center p-4",children:"Nessun aggiornamento recente."})})})]})]})})}export{je as default};
