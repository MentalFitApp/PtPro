import{r as m,j as e}from"./react-CrXOBDSJ.js";import{g as G}from"./firebase-Bp3EI6Ad.js";import{x as Z,A as I,B as ee,I as M,J as te,K as se,H as re,R as U,Q as F,W as oe,O as q,D as ae,V as ie}from"./@firebase-CuwLCerw.js";import{d as E}from"./index-CYfn4HI_.js";import{C as ne}from"./react-calendar-fvZi8T_s.js";import{a as le}from"./react-router-BxpCmtJ-.js";import{u as ce,O as de,$ as he,X as B,K as ue,o as me,_ as pe}from"./lucide-react-CCY59hBS.js";import{m as W,A as ge}from"./framer-motion-BAPjnw1b.js";import{v as fe}from"./uuid-CtRu48qb.js";import"./core-js-ChGsxLo2.js";import"./tslib-BGVaTf34.js";import"./idb-Bn1DMRyg.js";import"./react-dom-BpmKF3Ga.js";import"./scheduler-DYLXRpC5.js";import"./react-router-dom-9rcY47vU.js";import"./@remix-run-CjG9tKj3.js";import"./jspdf-7Jyqi_bl.js";import"./@babel-Cvov1XSu.js";import"./fflate-XZmX483V.js";import"./fast-png-CUrN0NP5.js";import"./iobuffer-DZ1zOcUT.js";import"./pako-B9FS3IR_.js";import"./clsx-B-dksMZM.js";import"./get-user-locale-CTD1oYsn.js";import"./memoize-BZNdjcd3.js";import"./mimic-function-BIlJVoeO.js";import"./@wojtekmaj-CaFejNaN.js";import"./motion-dom-C8PdgYBP.js";import"./motion-utils-DBsP9okC.js";const xe=`
  .react-calendar { width: 100%; background: transparent; border: none; font-family: inherit; }
  .react-calendar__navigation button { color: #67e8f9; font-weight: bold; font-size: 1.1em; }
  .react-calendar__navigation button:hover, .react-calendar__navigation button:focus { background: rgba(255, 255, 255, 0.1); border-radius: 0.5rem; }
  .react-calendar__month-view__weekdays__weekday { color: #9ca3af; text-transform: uppercase; font-size: 0.75rem; font-weight: 600; }
  .react-calendar__tile { color: #d1d5db; border-radius: 0.5rem; height: 50px; }
  .react-calendar__tile:disabled { color: #6b7280; }
  .react-calendar__tile:enabled:hover, .react-calendar__tile:enabled:focus { background: rgba(255, 255, 255, 0.1); }
  .react-calendar__tile--now { background: rgba(63, 63, 70, 0.7); font-weight: bold; }
  .react-calendar__tile--active { background: #0891b2; color: white; }
  .check-day { position: relative; }
  .check-day::after { content: ''; position: absolute; bottom: 8px; left: 50%; transform: translateX(-50%); width: 6px; height: 6px; border-radius: 50%; background-color: #f43f5e; }
  .check-submitted { position: relative; background-color: rgba(16, 185, 129, 0.2); }
  .check-submitted::after { content: ''; position: absolute; bottom: 8px; left: 50%; transform: translateX(-50%); width: 6px; height: 6px; border-radius: 50%; background-color: #10b981; }
`,be=()=>e.jsx("div",{className:"min-h-screen flex justify-center items-center relative",children:e.jsx("div",{className:"animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-cyan-400"})}),je=({message:o,type:u,onDismiss:l})=>e.jsx(ge,{children:o&&e.jsxs(W.div,{initial:{opacity:0,y:-50},animate:{opacity:1,y:0},exit:{opacity:0,y:-50},className:`fixed top-5 right-5 z-50 flex items-center gap-4 p-4 rounded-lg border ${u==="success"?"bg-emerald-900/80 text-emerald-300 border-emerald-500/30":"bg-red-900/80 text-red-300 border-red-500/30"} backdrop-blur-md shadow-lg`,children:[u==="success"?e.jsx(de,{}):e.jsx(he,{}),e.jsx("p",{children:o}),e.jsx("button",{onClick:l,className:"p-1 rounded-full hover:bg-white/10",children:e.jsx(B,{size:16})})]})}),ve=({formState:o,setFormState:u,handleSubmit:l,isUploading:y,handleFileChange:D})=>{const a=()=>u({id:null,notes:"",weight:"",photos:{},photoPreviews:{}}),f=({type:p,label:i,preview:c})=>e.jsxs("div",{className:"text-center",children:[e.jsx("label",{className:"block text-sm font-medium text-slate-300",children:i}),e.jsxs("div",{className:"mt-2 flex justify-center items-center w-full h-48 bg-slate-700/30 rounded-lg border-2 border-dashed border-slate-600 hover:border-cyan-500 transition-colors relative group",children:[c?e.jsx("img",{src:c,alt:"preview",className:"h-full w-full object-contain rounded-lg p-1"}):e.jsxs("div",{className:"flex flex-col items-center text-slate-400 transition-colors group-hover:text-cyan-400",children:[e.jsx(pe,{size:32}),e.jsx("p",{className:"mt-2 text-sm",children:"Carica foto"})]}),e.jsx("input",{type:"file",accept:"image/*",onChange:C=>D(C,p),className:"absolute inset-0 w-full h-full opacity-0 cursor-pointer"})]})]});return e.jsxs("div",{children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("h3",{className:"font-bold text-lg mb-4 text-cyan-300",children:o.id?"Modifica Check":"Carica Check"}),e.jsx("button",{onClick:a,className:"text-slate-400 hover:text-white p-1 rounded-full",children:e.jsx(B,{size:20})})]}),e.jsxs("form",{onSubmit:l,className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-300 mb-2",children:"Peso Attuale (kg)*"}),e.jsx("input",{type:"number",step:"0.1",value:o.weight,onChange:p=>u(i=>({...i,weight:p.target.value})),required:!0,className:"w-full p-2.5 bg-slate-700/50 border border-slate-600 rounded-lg outline-none focus:ring-2 focus:ring-cyan-500 text-slate-200",placeholder:"Es. 75.5"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-300 mb-2",children:"Note sul check"}),e.jsx("textarea",{value:o.notes,onChange:p=>u(i=>({...i,notes:p.target.value})),rows:"4",className:"w-full p-2.5 bg-slate-700/50 border border-slate-600 rounded-lg outline-none focus:ring-2 focus:ring-cyan-500 text-slate-200"})]}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6",children:[e.jsx(f,{type:"front",label:"Frontale",preview:o.photoPreviews.front}),e.jsx(f,{type:"right",label:"Laterale Destro",preview:o.photoPreviews.right}),e.jsx(f,{type:"left",label:"Laterale Sinistro",preview:o.photoPreviews.left}),e.jsx(f,{type:"back",label:"Posteriore",preview:o.photoPreviews.back})]}),e.jsx("div",{className:"flex justify-end",children:e.jsxs("button",{type:"submit",disabled:y,className:"flex items-center gap-2 px-5 py-2.5 bg-cyan-600 hover:bg-cyan-700 text-white rounded-lg transition font-semibold disabled:opacity-50",children:[e.jsx(ue,{size:16}),y?"Salvataggio...":o.id?"Salva Modifiche":"Invia Check"]})})]})]})},we=({check:o,handleEditClick:u})=>{const[l,y]=m.useState({}),D=(new Date-o.createdAt.toDate())/(1e3*60*60)<2;return m.useEffect(()=>{(async()=>{if(o.photoURLs){const f=Object.entries(o.photoURLs).map(async([i,c])=>{if(c&&typeof c=="string"&&!c.startsWith("http")){const C=U(storage,c),S=await F(C).catch(()=>null);return{type:i,url:S}}return{type:i,url:c}}),p=await Promise.all(f);y(Object.fromEntries(p.map(i=>[i.type,i.url])))}})()},[o.photoURLs]),e.jsxs("div",{children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("h3",{className:"font-bold text-lg text-cyan-300",children:["Riepilogo del ",o.createdAt.toDate().toLocaleDateString("it-IT")]}),D&&e.jsxs("button",{onClick:()=>u(o),className:"flex items-center gap-2 px-3 py-1.5 bg-slate-700/50 hover:bg-slate-700/70 text-slate-300 text-sm font-semibold rounded-lg",children:[e.jsx(me,{size:14})," Modifica"]})]}),e.jsxs("div",{className:"mt-4 space-y-4",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold text-slate-300",children:"Peso Registrato:"}),e.jsxs("p",{className:"text-white text-xl font-bold",children:[o.weight," kg"]})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold text-slate-300",children:"Note:"}),e.jsx("p",{className:"text-slate-400 p-3 bg-slate-700/50 rounded-lg whitespace-pre-wrap",children:o.notes||"Nessuna nota."})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold text-slate-300",children:"Foto:"}),e.jsx("div",{className:"grid grid-cols-2 sm:grid-cols-4 gap-4 mt-2",children:["front","right","left","back"].map(a=>e.jsxs("div",{className:"text-center relative group",children:[e.jsx("h5",{className:"text-sm font-semibold text-slate-400 capitalize",children:a==="front"?"Frontale":a==="back"?"Posteriore":`Laterale ${a==="left"?"Sinistro":"Destro"}`}),l[a]?e.jsx("a",{href:l[a],target:"_blank",rel:"noopener noreferrer",className:"block w-full h-48 overflow-hidden rounded-lg transition-all duration-300 group-hover:shadow-lg group-hover:shadow-cyan-500/20",children:e.jsx("img",{src:l[a],alt:a,className:"w-full h-full object-cover rounded-lg hover:opacity-90 transition-opacity"})}):e.jsx("div",{className:"w-full h-48 bg-slate-700/50 rounded-lg text-slate-500 flex items-center justify-center",children:"Foto non disponibile"})]},a))})]})]})]})};function Ge(){const[o,u]=m.useState(null),[l,y]=m.useState([]),[D,a]=m.useState(!0),[f,p]=m.useState(new Date),[i,c]=m.useState({id:null,notes:"",weight:"",photos:{},photoPreviews:{}}),[C,S]=m.useState(!1),[O,A]=m.useState({message:"",type:""}),[z,T]=m.useState(null),R=le(),b=G().currentUser,$=Z();m.useEffect(()=>{if(!b){R("/login");return}(async()=>{try{const t=I(E,"clients",b.uid),r=await ee(t);r.exists()&&r.data().createdAt?u(r.data().createdAt.toDate()):u(new Date);const n=M(E,`clients/${b.uid}/checks`),N=te(n,se("createdAt","desc"));return re(N,async x=>{const j=x.docs.map(d=>({id:d.id,...d.data()})),v=await Promise.all(j.map(async d=>{if(d.photoURLs){const L=Object.entries(d.photoURLs).map(async([g,w])=>{if(w&&typeof w=="string"&&!w.startsWith("http")){const _=U($,w),V=await F(_).catch(()=>null);return{type:g,url:V}}return{type:g,url:w}}),P=await Promise.all(L);return{...d,photoURLs:Object.fromEntries(P.map(g=>[g.type,g.url]))}}return d}));y(v),a(!1)},x=>{console.error("Errore snapshot checks:",x),T("Errore nel caricamento dei check."),a(!1)})}catch(t){console.error("Errore fetchInitialData:",t),T("Errore nel caricamento dei dati."),a(!1)}})()},[b,R]);const k=(s,t="error")=>{A({message:s,type:t}),setTimeout(()=>A({message:"",type:""}),5e3)},X=s=>{try{if(!l.length)return[];const t=l.reduce((h,x)=>{var v;const j=(v=x.createdAt)==null?void 0:v.toDate();return!h||j&&j<h?j:h},null);if(!t)return[];let r=[],n=new Date(t.getTime());const N=new Date(s.getFullYear(),s.getMonth()+2,1);for(;n.getTime()<N.getTime();)n.getMonth()===s.getMonth()&&n.getFullYear()===s.getFullYear()&&r.push(new Date(n.getTime())),n.setDate(n.getDate()+7);return r}catch(t){return console.error("Errore getSuggestedCheckDays:",t),[]}},Y=({date:s,view:t})=>{try{if(t==="month"){if(l.some(r=>r.createdAt&&r.createdAt.toDate&&r.createdAt.toDate().toDateString()===s.toDateString()))return"check-submitted";if(X(s).some(r=>r.toDateString()===s.toDateString()))return"check-day"}return null}catch(r){return console.error("Errore tileClassName:",r),null}},K=(s,t)=>{try{const r=s.target.files[0];r&&c(n=>({...n,photos:{...n.photos,[t]:r},photoPreviews:{...n.photoPreviews,[t]:URL.createObjectURL(r)}}))}catch(r){console.error("Errore handleFileChange:",r),k("Errore nel caricamento della foto.")}},H=s=>{try{p(s.createdAt.toDate()),c({id:s.id,notes:s.notes||"",weight:s.weight||"",photos:{},photoPreviews:s.photoURLs||{}})}catch(t){console.error("Errore handleEditClick:",t),k("Errore nella modifica del check.")}},J=async s=>{s.preventDefault();const{id:t,notes:r,weight:n,photos:N}=i;if(!b||!t&&Object.values(N).some(h=>!h)||!n){k("Compila il peso e carica tutte e 4 le foto se è un nuovo check.");return}S(!0);try{const h=t?l.find(d=>d.id===t):null;let x=h?{...h.photoURLs}:{front:null,right:null,left:null,back:null};const j=Object.entries(N).filter(([,d])=>d);if(j.length>0){const d=j.map(async([P,g])=>{const w=`clients/${b.uid}/checks/${fe()}-${g.name}`,_=U($,w);return await oe(_,g),{type:P,url:await F(_)}}),L=await Promise.all(d);x={...x,...Object.fromEntries(L.map(({type:P,url:g})=>[P,g]))}}const v={notes:r,weight:parseFloat(n),photoURLs:x,createdAt:t?h.createdAt:q()};t?(await ae(I(E,`clients/${b.uid}/checks`,t),{...v,lastUpdatedAt:q()}),k("Check modificato con successo!","success")):(await ie(M(E,`clients/${b.uid}/checks`),v),k("Check caricato con successo!","success")),c({id:null,notes:"",weight:"",photos:{},photoPreviews:{}})}catch(h){console.error("Errore handleSubmit:",h),k("Si è verificato un errore.")}finally{S(!1)}},Q=()=>{try{const s=l.find(t=>t.createdAt&&t.createdAt.toDate&&t.createdAt.toDate().toDateString()===f.toDateString());return i.id||!s?e.jsx(ve,{formState:i,setFormState:c,handleSubmit:J,isUploading:C,handleFileChange:K}):s?e.jsx(we,{check:s,handleEditClick:H}):e.jsx("p",{className:"text-center text-slate-400 p-8",children:"Nessun check previsto o registrato per questa data."})}catch(s){return console.error("Errore renderContentForDate:",s),e.jsx("p",{className:"text-center text-red-400 p-8",children:"Errore nel caricamento del contenuto."})}};return z?e.jsx("div",{className:"min-h-screen text-red-400 flex justify-center items-center p-4",children:z}):D?e.jsx(be,{}):e.jsxs(e.Fragment,{children:[e.jsx("style",{children:xe}),e.jsxs("div",{className:"min-h-screen text-slate-200 p-4 sm:p-8 relative",children:[e.jsx(je,{message:O.message,type:O.type,onDismiss:()=>A({message:"",type:""})}),e.jsxs("header",{className:"flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-8",children:[e.jsx("h1",{className:"text-3xl sm:text-4xl font-bold text-slate-50",children:"I miei Check"}),e.jsxs("button",{onClick:()=>R("/client/dashboard"),className:"flex items-center gap-2 px-3 py-2 bg-slate-700/50 hover:bg-slate-700/70 text-slate-300 text-sm font-semibold rounded-lg transition-colors",children:[e.jsx(ce,{size:16}),e.jsx("span",{children:"Dashboard"})]})]}),e.jsxs(W.div,{initial:{opacity:0},animate:{opacity:1},className:"grid grid-cols-1 lg:grid-cols-3 gap-8",children:[e.jsx("div",{className:"lg:col-span-1 bg-slate-800/60 backdrop-blur-sm rounded-2xl border border-slate-700 p-4",children:e.jsx(ne,{onChange:p,value:f,tileClassName:Y})}),e.jsx("div",{className:"lg:col-span-2 bg-slate-800/60 backdrop-blur-sm rounded-2xl border border-slate-700 p-6 min-h-[400px]",children:Q()})]})]})]})}export{Ge as default};
