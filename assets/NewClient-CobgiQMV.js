import{r as g,j as e}from"./react-CrXOBDSJ.js";import{u as G}from"./react-hook-form-yCRcHKQw.js";import{a as L,f as J,d as E}from"./index-D2WmDvAv.js";import{g as K,c as ee}from"./firebase-Bp3EI6Ad.js";import{v as ae,A as $,O as q,N as U,I as te,Y as se}from"./@firebase-CuwLCerw.js";import{a as ie,b as oe}from"./react-router-BxpCmtJ-.js";import{m as b,A as F}from"./framer-motion-BAPjnw1b.js";import{u as re,D as ne,I as le,y as ce,z as me,$ as de,X as pe}from"./lucide-react-CCY59hBS.js";import"./core-js-ChGsxLo2.js";import"./react-dom-BpmKF3Ga.js";import"./scheduler-DYLXRpC5.js";import"./react-router-dom-9rcY47vU.js";import"./@remix-run-CjG9tKj3.js";import"./jspdf-7Jyqi_bl.js";import"./@babel-Cvov1XSu.js";import"./fflate-XZmX483V.js";import"./fast-png-CUrN0NP5.js";import"./iobuffer-DZ1zOcUT.js";import"./pako-B9FS3IR_.js";import"./tslib-BGVaTf34.js";import"./idb-Bn1DMRyg.js";import"./motion-dom-C8PdgYBP.js";import"./motion-utils-DBsP9okC.js";const ue=({message:p,type:n,onDismiss:i})=>e.jsx(F,{children:p&&e.jsxs(b.div,{initial:{opacity:0,y:-50},animate:{opacity:1,y:0},exit:{opacity:0,y:-50},className:`fixed top-5 right-5 z-50 flex items-center gap-4 p-4 rounded-lg border ${n==="error"?"bg-red-900/80 text-red-300 border-red-500/30":"bg-emerald-900/80 text-emerald-300 border-emerald-500/30"} backdrop-blur-md shadow-lg`,children:[e.jsx(de,{className:n==="error"?"text-red-400":"text-emerald-400"}),e.jsx("p",{children:p}),e.jsx("button",{onClick:i,className:"p-1 rounded-full hover:bg-white/10",children:e.jsx(pe,{size:16})})]})}),xe=()=>{const n="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*";let i="";for(let y=0,u=n.length;y<8;++y)i+=n.charAt(Math.floor(Math.random()*u));return i};function Fe(){const p=ie(),n=oe(),{register:i,handleSubmit:y,reset:u,watch:O,formState:{isSubmitting:N,errors:s}}=G({defaultValues:{name:"",email:"",phone:"",planType:"",duration:"",customStartDate:new Date().toISOString().split("T")[0],customExpiryDate:"",paymentAmount:"",paymentMethod:""}}),[H,T]=g.useState(!1),[f,R]=g.useState(null),[V,I]=g.useState(!1),[M,w]=g.useState({message:"",type:""}),[x,D]=g.useState(!1),Z=O("customStartDate");g.useEffect(()=>{var a;if((a=n.state)!=null&&a.prefill){const t=n.state.prefill;console.log("Dati precompilati ricevuti:",t),u({name:t.name||"",email:t.email||"",phone:t.phone||"",planType:t.planType||"",duration:t.duration?String(t.duration):"",paymentAmount:t.paymentAmount?String(t.paymentAmount):"",paymentMethod:t.paymentMethod||"",customStartDate:t.customStartDate||new Date().toISOString().split("T")[0]}),t.duration&&D(!1)}},[n.state,u]);const c=(a,t="error")=>{w({message:a,type:t}),setTimeout(()=>w({message:"",type:""}),6e3)},B=async a=>{if(!L.currentUser){c("Devi essere autenticato come coach o admin per creare un cliente.","error"),p("/login");return}const t=xe(),h=ae(J,`user-creation-${Date.now()}`),W=K(h);try{let o=new Date(a.customStartDate);o.setHours(0,0,0,0);let d,C=!1;const v=new Date;v.setHours(0,0,0,0);const X=new Date(v.getFullYear(),v.getMonth(),1);if(o>v){c("La data di inizio non può essere futura.","error");return}if(x&&a.customExpiryDate){if(d=new Date(a.customExpiryDate),d<o){c("La data di scadenza deve essere successiva alla data di inizio.","error");return}C=o<X}else if(a.duration){const j=parseInt(a.duration,10);d=new Date(o),d.setMonth(d.getMonth()+j),d.setDate(d.getDate()+7)}else{c("Seleziona una durata o una data di scadenza.","error");return}console.log("Inizio creazione cliente:",{email:a.email,name:a.name,paymentAmount:a.paymentAmount,userId:L.currentUser.uid});const A=(await ee(W,a.email.trim(),t)).user.uid;console.log("Utente creato con UID:",A);const k=$(E,"clients",A),_={name:a.name,name_lowercase:a.name.toLowerCase(),email:a.email.trim(),phone:a.phone||null,status:"attivo",planType:a.planType,createdAt:q(),startDate:o,scadenza:d,isClient:!0,firstLogin:!0,tempPassword:t,isOldClient:C};if(await U(k,_),console.log("Documento cliente creato:",k.path),a.paymentAmount){const j=$(te(E,"clients",A,"payments")),P={amount:parseFloat(a.paymentAmount),duration:x?"personalizzata":`${parseInt(a.duration,10)} mes${parseInt(a.duration,10)>1?"i":"e"}`,paymentMethod:a.paymentMethod||"N/A",paymentDate:q(),isPast:C};console.log("Tentativo creazione pagamento:",{paymentRef:j.path,paymentData:P}),await U(j,P),console.log("Documento pagamento creato:",j.path)}R({name:a.name,email:a.email.trim(),password:t}),T(!0),c("Cliente creato con successo!","success"),u()}catch(o){console.error("Errore nella creazione del cliente:",o.code,o.message,{data:a}),o.code==="permission-denied"?c("Permessi insufficienti. Verifica che il tuo UID sia nei documenti /roles/admins o /roles/coaches.","error"):o.code==="auth/email-already-in-use"?c("Questa email è già in uso da un altro utente.","error"):c("Si è verificato un errore imprevisto: "+o.message,"error")}finally{await se(h)}},Y=()=>{const t=`Ciao ${f.name},

Benvenuto in PT Manager, la tua area personale per monitorare i progressi e comunicare con il tuo coach!

Ecco le credenziali per il tuo primo accesso:

Link: https://MentalFitApp.github.io/PtPro/#/login
Email: ${f.email}
Password Temporanea: ${f.password}

Al primo accesso ti verrà chiesto di impostare una password personale.
A presto!`;navigator.clipboard.writeText(t),I(!0),setTimeout(()=>I(!1),2500)},Q=()=>{T(!1),u(),p("/clients")},l="w-full p-2.5 bg-slate-700/50 border border-slate-600 rounded-lg outline-none focus:ring-2 focus:ring-rose-500 text-slate-200 placeholder:text-slate-500",r="block mb-1 text-sm font-medium text-slate-300",z="bg-slate-800/60 backdrop-blur-sm rounded-2xl border border-slate-700 p-6",S="font-bold mb-4 text-lg text-rose-300 border-b border-rose-400/20 pb-2 flex items-center gap-2",m="text-red-500 text-sm mt-1";return e.jsxs(e.Fragment,{children:[e.jsx(ue,{message:M.message,type:M.type,onDismiss:()=>w({message:"",type:""})}),e.jsxs(b.div,{className:"w-full max-w-2xl mx-auto",initial:{opacity:0,y:20},animate:{opacity:1,y:0},children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsx("h1",{className:"text-2xl font-bold text-slate-50",children:"Onboarding Nuovo Cliente"}),e.jsxs("button",{onClick:()=>p("/clients"),className:"flex items-center gap-2 px-3 py-1.5 bg-slate-700/50 hover:bg-slate-700/70 border border-slate-600 text-slate-300 text-sm rounded-lg transition-colors",children:[e.jsx(re,{size:16})," Torna Indietro"]})]}),e.jsxs("form",{onSubmit:y(B),className:"space-y-6",children:[e.jsxs("div",{className:z,children:[e.jsx("h4",{className:S,children:"1. Anagrafica"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:r,children:"Nome e Cognome*"}),e.jsx("input",{...i("name",{required:"Il nome è obbligatorio",minLength:{value:2,message:"Il nome deve essere lungo almeno 2 caratteri"}}),className:l}),s.name&&e.jsx("p",{className:m,children:s.name.message})]}),e.jsxs("div",{children:[e.jsx("label",{className:r,children:"Email (sarà il suo username)*"}),e.jsx("input",{type:"email",...i("email",{required:"L'email è obbligatoria",pattern:{value:/^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/,message:"Inserisci un'email valida"}}),className:l}),s.email&&e.jsx("p",{className:m,children:s.email.message})]}),e.jsxs("div",{children:[e.jsx("label",{className:r,children:"Telefono (Opzionale)"}),e.jsx("input",{...i("phone",{pattern:{value:/^\+?[0-9]{7,15}$/,message:"Inserisci un numero di telefono valido (7-15 cifre)"}}),className:l}),s.phone&&e.jsx("p",{className:m,children:s.phone.message})]})]})]}),e.jsxs("div",{className:z,children:[e.jsx("h4",{className:S,children:"2. Dettagli Percorso"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:r,children:"Tipo di Percorso*"}),e.jsxs("select",{...i("planType",{required:"Il tipo di percorso è obbligatorio"}),className:l,children:[e.jsx("option",{value:"",children:"Seleziona tipo"}),e.jsx("option",{value:"allenamento",children:"Solo Allenamento"}),e.jsx("option",{value:"alimentazione",children:"Solo Alimentazione"}),e.jsx("option",{value:"completo",children:"Completo"})]}),s.planType&&e.jsx("p",{className:m,children:s.planType.message})]}),e.jsxs("div",{children:[e.jsx("label",{className:r,children:"Modalità Scadenza*"}),e.jsxs("div",{className:"flex items-center gap-4 mb-2",children:[e.jsxs("label",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"radio",checked:!x,onChange:()=>D(!1),className:"text-rose-500"}),"Durata in mesi"]}),e.jsxs("label",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"radio",checked:x,onChange:()=>D(!0),className:"text-rose-500"}),"Data personalizzata"]})]}),x?e.jsxs("div",{children:[e.jsx("label",{className:r,children:"Data di Inizio*"}),e.jsx("input",{type:"date",...i("customStartDate",{required:'La data di inizio è obbligatoria quando si usa "Data personalizzata"',validate:a=>{const t=new Date(a),h=new Date;return h.setHours(0,0,0,0),t<=h||"La data di inizio non può essere futura"}}),className:l}),s.customStartDate&&e.jsx("p",{className:m,children:s.customStartDate.message}),e.jsx("label",{className:r,children:"Data di Scadenza*"}),e.jsx("input",{type:"date",...i("customExpiryDate",{required:'La data di scadenza è obbligatoria quando si usa "Data personalizzata"',validate:a=>{if(!x)return!0;const t=new Date(Z);return new Date(a)>=t||"La data di scadenza deve essere successiva alla data di inizio"}}),className:l}),s.customExpiryDate&&e.jsx("p",{className:m,children:s.customExpiryDate.message})]}):e.jsxs("div",{children:[e.jsx("label",{className:r,children:"Durata del Percorso*"}),e.jsxs("select",{...i("duration",{required:'La durata è obbligatoria quando si usa "Durata in mesi"'}),className:l,children:[e.jsx("option",{value:"",children:"Seleziona durata"}),[...Array(24).keys()].map(a=>e.jsxs("option",{value:a+1,children:[a+1," mes",a>0?"i":"e"]},a+1))]}),s.duration&&e.jsx("p",{className:m,children:s.duration.message})]})]})]})]}),e.jsxs("div",{className:z,children:[e.jsxs("h4",{className:S,children:[e.jsx(ne,{size:20})," 3. Primo Pagamento (Opzionale)"]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:r,children:"Importo Pagato (€)"}),e.jsx("input",{type:"number",step:"0.01",...i("paymentAmount",{validate:a=>!a||parseFloat(a)>0||"L'importo deve essere maggiore di 0"}),className:l}),s.paymentAmount&&e.jsx("p",{className:m,children:s.paymentAmount.message})]}),e.jsxs("div",{children:[e.jsx("label",{className:r,children:"Metodo di Pagamento"}),e.jsx("input",{...i("paymentMethod"),className:l,placeholder:"Es. Bonifico"})]})]})]}),e.jsx("div",{className:"flex justify-center md:justify-end pt-4 pb-20 md:pb-4",children:e.jsxs(b.button,{type:"submit",disabled:N,className:"w-full md:w-auto flex items-center justify-center gap-2 px-5 py-3 bg-rose-600 hover:bg-rose-700 text-white rounded-lg transition disabled:opacity-50 font-semibold disabled:cursor-not-allowed",whileHover:{scale:N?1:1.05},whileTap:{scale:N?1:.95},children:[e.jsx(le,{size:18})," ",N?"Creazione in corso...":"Crea Cliente"]})})]})]}),e.jsx(F,{children:H&&e.jsx(b.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"fixed inset-0 bg-black/70 backdrop-blur-sm flex justify-center items-center z-50 p-4",children:e.jsxs(b.div,{className:"bg-slate-800/95 backdrop-blur-sm rounded-2xl border border-slate-700 p-6 text-center w-full max-w-md shadow-2xl shadow-black/40",initial:{scale:.9,opacity:0},animate:{scale:1,opacity:1},exit:{scale:.9,opacity:0},children:[e.jsx("h2",{className:"text-xl font-bold text-slate-50",children:"Cliente Creato!"}),e.jsx("p",{className:"text-slate-400 text-sm mt-2",children:"Copia e invia le credenziali al cliente."}),e.jsxs("div",{className:"my-6 space-y-3 text-left",children:[e.jsxs("div",{className:"bg-slate-700/50 p-3 rounded-lg border border-slate-600",children:[e.jsx("p",{className:"text-xs text-slate-400",children:"Email (Username)"}),e.jsx("p",{className:"font-mono text-slate-200",children:f.email})]}),e.jsxs("div",{className:"bg-slate-700/50 p-3 rounded-lg border border-slate-600",children:[e.jsx("p",{className:"text-xs text-slate-400",children:"Password Temporanea"}),e.jsx("p",{className:"font-mono text-slate-200",children:f.password})]})]}),e.jsx(b.button,{onClick:Y,className:"w-full py-3 bg-emerald-600 hover:bg-emerald-700 text-white font-semibold rounded-lg flex items-center justify-center gap-2 transition-colors",whileHover:{scale:1.02},whileTap:{scale:.98},children:V?e.jsxs(e.Fragment,{children:[e.jsx(ce,{size:18})," Copiato!"]}):e.jsxs(e.Fragment,{children:[e.jsx(me,{size:16})," Copia Credenziali"]})}),e.jsx("button",{onClick:Q,className:"w-full mt-3 py-2 text-slate-400 hover:text-white text-sm text-center transition-colors",children:"Chiudi"})]})})})]})}export{Fe as default};
