import{r as o,h as pe,ax as A,V as S,j as e,bN as b,S as he,a3 as be,A as V,q as k,aG as fe,b8 as X,av as je,bO as y,U as n,bP as u,am as U,L as H,au as J,e as p,a6 as W,bp as Y,u as Z,bq as _,l as I}from"./.pnpm-C04Ba0Xq.js";import{a as i,d as l}from"./index-DdCoIfwr.js";import{i as ge,a as Ne,r as R}from"./superadmin-B-ShD6zK.js";function ze(){var q,G;const[ee,E]=o.useState(!0),[se,te]=o.useState(!1),[f,ae]=o.useState([]),[re,ie]=o.useState([]),[ce,oe]=o.useState([]),[le,ne]=o.useState([]),[j,de]=o.useState(""),[h,w]=o.useState({show:!1,message:"",type:"success"}),[m,x]=o.useState({show:!1,action:null,user:null}),D=pe();o.useEffect(()=>{me()},[]);const me=async()=>{const s=i.currentUser;if(!s){D("/login");return}if(!await ge(s.uid)){D("/dashboard");return}te(!0),c()},c=async()=>{try{const s=await A(S(l,"roles")),t={};s.docs.forEach(r=>{t[r.id]=r.data().uids||[]}),ie(t.admins||[]),oe(t.coaches||[]),ne(t.superadmins||[]);const z=(await A(S(l,"clients"))).docs.map(r=>({id:r.id,email:r.data().email||"N/D",name:r.data().name||"Senza nome",role:"client",...r.data()})),xe=(await A(S(l,"collaboratori"))).docs.map(r=>{var d;return{id:r.id,email:r.data().email||"N/D",name:r.data().nome||r.data().name||"Senza nome",role:((d=r.data().role)==null?void 0:d.toLowerCase())||"collaboratore",...r.data()}}),ue=[...z,...xe].map(r=>{var K,O,Q;let d=r.role;return(K=t.superadmins)!=null&&K.includes(r.id)?d="superadmin":(O=t.admins)!=null&&O.includes(r.id)?d="admin":(Q=t.coaches)!=null&&Q.includes(r.id)&&(d="coach"),{...r,effectiveRole:d}});ae(ue),E(!1)}catch(s){console.error("Error loading users:",s),a("Errore caricamento utenti","error"),E(!1)}},a=(s,t="success")=>{w({show:!0,message:s,type:t}),setTimeout(()=>w({show:!1,message:"",type:"success"}),4e3)},L=async s=>{try{const t=await Ne(i.currentUser.uid,s);t.success?(a("Utente promosso a SuperAdmin","success"),c()):a(t.message,"error")}catch(t){a("Errore promozione: "+t.message,"error")}},P=async s=>{if(s===i.currentUser.uid){a("Non puoi rimuovere te stesso come SuperAdmin","error");return}try{const t=await R(i.currentUser.uid,s);t.success?(a("SuperAdmin rimosso","success"),c()):a(t.message,"error")}catch(t){a("Errore rimozione: "+t.message,"error")}},T=async s=>{try{const t=p(l,"roles","admins");await W(t,{uids:Y(s),updatedAt:new Date,updatedBy:i.currentUser.uid},{merge:!0}),a("Utente promosso ad Admin","success"),c()}catch(t){a("Errore promozione admin: "+t.message,"error")}},g=async s=>{try{const t=p(l,"roles","admins");await Z(t,{uids:_(s),updatedAt:new Date,updatedBy:i.currentUser.uid}),a("Admin retrocesso","success"),c()}catch(t){a("Errore rimozione admin: "+t.message,"error")}},B=async s=>{try{const t=p(l,"roles","coaches");await W(t,{uids:Y(s),updatedAt:new Date,updatedBy:i.currentUser.uid},{merge:!0}),a("Utente promosso a Coach","success"),c()}catch(t){a("Errore promozione coach: "+t.message,"error")}},N=async s=>{try{const t=p(l,"roles","coaches");await Z(t,{uids:_(s),updatedAt:new Date,updatedBy:i.currentUser.uid}),a("Coach retrocesso","success"),c()}catch(t){a("Errore rimozione coach: "+t.message,"error")}},F=async s=>{x({show:!0,action:"revoke",user:f.find(t=>t.id===s),onConfirm:async()=>{try{await Promise.all([R(i.currentUser.uid,s).catch(()=>{}),g(s).catch(()=>{}),N(s).catch(()=>{})]),a("Accesso revocato (tutti i ruoli rimossi)","success"),x({show:!1,action:null,user:null}),c()}catch(t){a("Errore revoca accesso: "+t.message,"error")}}})},$=async s=>{x({show:!0,action:"delete",user:f.find(t=>t.id===s),onConfirm:async()=>{try{const t=p(l,"clients",s),C=p(l,"collaboratori",s);await Promise.all([I(t).catch(()=>{}),I(C).catch(()=>{}),R(i.currentUser.uid,s).catch(()=>{}),g(s).catch(()=>{}),N(s).catch(()=>{})]),a("Utente eliminato (nota: account Auth rimane attivo)","success"),x({show:!1,action:null,user:null}),c()}catch(t){a("Errore eliminazione: "+t.message,"error")}}})},v=f.filter(s=>s.name.toLowerCase().includes(j.toLowerCase())||s.email.toLowerCase().includes(j.toLowerCase())||s.effectiveRole.toLowerCase().includes(j.toLowerCase()));if(!se)return e.jsx("div",{className:"min-h-screen flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx(b,{size:64,className:"mx-auto text-red-500 mb-4"}),e.jsx("h2",{className:"text-2xl font-bold text-white mb-2",children:"Accesso Negato"}),e.jsx("p",{className:"text-slate-400",children:"Solo i SuperAdmin possono accedere alle impostazioni."})]})});if(ee)return e.jsx("div",{className:"min-h-screen flex items-center justify-center",children:e.jsx("div",{className:"animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-cyan-400"})});const M=({role:s})=>{const t={superadmin:"bg-rose-500/20 text-rose-300 border-rose-500/30",admin:"bg-purple-500/20 text-purple-300 border-purple-500/30",coach:"bg-cyan-500/20 text-cyan-300 border-cyan-500/30",client:"bg-slate-500/20 text-slate-300 border-slate-500/30",setter:"bg-amber-500/20 text-amber-300 border-amber-500/30",collaboratore:"bg-emerald-500/20 text-emerald-300 border-emerald-500/30"},z={superadmin:y,admin:b,coach:n,client:n,setter:U,collaboratore:n}[s]||n;return e.jsxs("span",{className:`inline-flex items-center gap-1.5 px-2.5 py-1 text-xs font-medium rounded-full border ${t[s]||t.client}`,children:[e.jsx(z,{size:12}),s.charAt(0).toUpperCase()+s.slice(1)]})};return e.jsx("div",{className:"min-h-screen p-4 sm:p-8",children:e.jsxs("div",{className:"max-w-7xl mx-auto",children:[e.jsxs("div",{className:"flex items-center justify-between mb-8",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(he,{className:"text-cyan-400",size:32}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-white",children:"Impostazioni SuperAdmin"}),e.jsx("p",{className:"text-slate-400",children:"Gestione completa piattaforma e utenti"})]})]}),e.jsxs("button",{onClick:()=>c(),className:"flex items-center gap-2 px-4 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg transition-colors",children:[e.jsx(be,{size:16}),"Ricarica"]})]}),e.jsx(V,{children:h.show&&e.jsxs(k.div,{initial:{opacity:0,y:-50},animate:{opacity:1,y:0},exit:{opacity:0,y:-50},className:`fixed top-5 right-5 z-50 flex items-center gap-3 p-4 rounded-lg border backdrop-blur-md shadow-lg ${h.type==="success"?"bg-emerald-900/80 text-emerald-300 border-emerald-500/30":"bg-red-900/80 text-red-300 border-red-500/30"}`,children:[h.type==="success"?e.jsx(fe,{size:20}):e.jsx(X,{size:20}),e.jsx("p",{children:h.message}),e.jsx("button",{onClick:()=>w({...h,show:!1}),className:"ml-2",children:e.jsx(je,{size:16})})]})}),e.jsx(V,{children:m.show&&e.jsx(k.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4",onClick:()=>x({show:!1,action:null,user:null}),children:e.jsxs(k.div,{initial:{scale:.9},animate:{scale:1},exit:{scale:.9},onClick:s=>s.stopPropagation(),className:"bg-slate-800 rounded-2xl border border-slate-700 p-6 max-w-md w-full",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-4",children:[e.jsx(X,{className:"text-rose-400",size:24}),e.jsx("h3",{className:"text-xl font-bold text-white",children:m.action==="delete"?"Elimina Utente":"Revoca Accesso"})]}),e.jsx("p",{className:"text-slate-300 mb-6",children:m.action==="delete"?`Sei sicuro di voler eliminare "${(q=m.user)==null?void 0:q.name}"? Questa azione rimuoverà tutti i dati ma non l'account Firebase Auth (serve Admin SDK).`:`Sei sicuro di voler revocare tutti gli accessi a "${(G=m.user)==null?void 0:G.name}"? L'utente perderà tutti i ruoli.`}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx("button",{onClick:()=>x({show:!1,action:null,user:null}),className:"flex-1 px-4 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg transition-colors",children:"Annulla"}),e.jsx("button",{onClick:m.onConfirm,className:"flex-1 px-4 py-2 bg-rose-600 hover:bg-rose-700 text-white rounded-lg transition-colors",children:"Conferma"})]})]})})}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4 mb-6",children:[e.jsxs("div",{className:"bg-slate-800/60 backdrop-blur-sm rounded-xl border border-slate-700 p-4",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(y,{size:16,className:"text-rose-400"}),e.jsx("span",{className:"text-sm text-slate-400",children:"SuperAdmins"})]}),e.jsx("p",{className:"text-2xl font-bold text-white",children:le.length})]}),e.jsxs("div",{className:"bg-slate-800/60 backdrop-blur-sm rounded-xl border border-slate-700 p-4",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(b,{size:16,className:"text-purple-400"}),e.jsx("span",{className:"text-sm text-slate-400",children:"Admins"})]}),e.jsx("p",{className:"text-2xl font-bold text-white",children:re.length})]}),e.jsxs("div",{className:"bg-slate-800/60 backdrop-blur-sm rounded-xl border border-slate-700 p-4",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(n,{size:16,className:"text-cyan-400"}),e.jsx("span",{className:"text-sm text-slate-400",children:"Coaches"})]}),e.jsx("p",{className:"text-2xl font-bold text-white",children:ce.length})]}),e.jsxs("div",{className:"bg-slate-800/60 backdrop-blur-sm rounded-xl border border-slate-700 p-4",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(n,{size:16,className:"text-slate-400"}),e.jsx("span",{className:"text-sm text-slate-400",children:"Totale Utenti"})]}),e.jsx("p",{className:"text-2xl font-bold text-white",children:f.length})]})]}),e.jsx("div",{className:"mb-6 sticky top-2 z-20",children:e.jsx("div",{className:"bg-slate-900/70 backdrop-blur rounded-xl border border-slate-700 p-2",children:e.jsx("input",{type:"text",placeholder:"Cerca per nome, email o ruolo...",value:j,onChange:s=>de(s.target.value),className:"w-full px-4 py-3 bg-slate-800/60 border border-slate-700 rounded-lg text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-cyan-500"})})}),e.jsxs("div",{className:"bg-slate-800/60 backdrop-blur-sm rounded-2xl border border-slate-700 overflow-hidden hidden sm:block",children:[e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{className:"bg-slate-900/50 border-b border-slate-700",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-6 py-4 text-left text-xs font-semibold text-slate-400 uppercase",children:"Utente"}),e.jsx("th",{className:"px-6 py-4 text-left text-xs font-semibold text-slate-400 uppercase",children:"Email"}),e.jsx("th",{className:"px-6 py-4 text-left text-xs font-semibold text-slate-400 uppercase",children:"Ruolo"}),e.jsx("th",{className:"px-6 py-4 text-right text-xs font-semibold text-slate-400 uppercase",children:"Azioni"})]})}),e.jsx("tbody",{className:"divide-y divide-slate-700",children:v.map(s=>e.jsxs("tr",{className:"hover:bg-slate-700/30 transition-colors",children:[e.jsxs("td",{className:"px-6 py-4",children:[e.jsx("p",{className:"font-medium text-white",children:s.name}),s.id===i.currentUser.uid&&e.jsx("span",{className:"text-xs text-cyan-400",children:"(Tu)"})]}),e.jsx("td",{className:"px-6 py-4 text-slate-300",children:s.email}),e.jsx("td",{className:"px-6 py-4",children:e.jsx(M,{role:s.effectiveRole})}),e.jsx("td",{className:"px-6 py-4",children:e.jsxs("div",{className:"flex items-center justify-end gap-2",children:[s.effectiveRole!=="superadmin"&&e.jsx("button",{onClick:()=>L(s.id),className:"p-2 text-rose-400 hover:bg-rose-500/10 rounded-lg transition-colors",title:"Promuovi a SuperAdmin",children:e.jsx(y,{size:16})}),s.effectiveRole==="superadmin"&&s.id!==i.currentUser.uid&&e.jsx("button",{onClick:()=>P(s.id),className:"p-2 text-rose-400 hover:bg-rose-500/10 rounded-lg transition-colors",title:"Rimuovi SuperAdmin",children:e.jsx(u,{size:16})}),!["superadmin","admin"].includes(s.effectiveRole)&&e.jsx("button",{onClick:()=>T(s.id),className:"p-2 text-purple-400 hover:bg-purple-500/10 rounded-lg transition-colors",title:"Promuovi ad Admin",children:e.jsx(b,{size:16})}),s.effectiveRole==="admin"&&e.jsx("button",{onClick:()=>g(s.id),className:"p-2 text-purple-400 hover:bg-purple-500/10 rounded-lg transition-colors",title:"Retrocedi Admin",children:e.jsx(u,{size:16})}),!["superadmin","admin","coach"].includes(s.effectiveRole)&&e.jsx("button",{onClick:()=>B(s.id),className:"p-2 text-cyan-400 hover:bg-cyan-500/10 rounded-lg transition-colors",title:"Promuovi a Coach",children:e.jsx(U,{size:16})}),s.effectiveRole==="coach"&&e.jsx("button",{onClick:()=>N(s.id),className:"p-2 text-cyan-400 hover:bg-cyan-500/10 rounded-lg transition-colors",title:"Retrocedi Coach",children:e.jsx(u,{size:16})}),s.id!==i.currentUser.uid&&e.jsx("button",{onClick:()=>F(s.id),className:"p-2 text-amber-400 hover:bg-amber-500/10 rounded-lg transition-colors",title:"Revoca Tutti gli Accessi",children:e.jsx(H,{size:16})}),s.id!==i.currentUser.uid&&e.jsx("button",{onClick:()=>$(s.id),className:"p-2 text-red-400 hover:bg-red-500/10 rounded-lg transition-colors",title:"Elimina Utente",children:e.jsx(J,{size:16})})]})})]},s.id))})]})}),v.length===0&&e.jsxs("div",{className:"text-center py-12 text-slate-400",children:[e.jsx(n,{size:48,className:"mx-auto mb-4 opacity-50"}),e.jsx("p",{children:"Nessun utente trovato"})]})]}),e.jsxs("div",{className:"space-y-3 sm:hidden",children:[v.length===0&&e.jsxs("div",{className:"text-center py-12 text-slate-400 bg-slate-800/60 rounded-2xl border border-slate-700",children:[e.jsx(n,{size:48,className:"mx-auto mb-4 opacity-50"}),e.jsx("p",{children:"Nessun utente trovato"})]}),v.map(s=>e.jsxs("div",{className:"bg-slate-800/70 backdrop-blur rounded-xl border border-slate-700 p-4 flex flex-col gap-3",children:[e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{children:[e.jsxs("p",{className:"font-semibold text-white text-sm leading-tight",children:[s.name," ",s.id===i.currentUser.uid&&e.jsx("span",{className:"text-cyan-400 text-xs",children:"(Tu)"})]}),e.jsx("p",{className:"text-xs text-slate-400 break-all",children:s.email}),e.jsx("div",{className:"mt-2",children:e.jsx(M,{role:s.effectiveRole})})]}),s.effectiveRole!=="superadmin"&&e.jsx("button",{onClick:()=>L(s.id),className:"p-2 rounded-lg bg-rose-500/10 text-rose-400 hover:bg-rose-500/20 active:scale-95",title:"Promuovi SuperAdmin",children:e.jsx(y,{size:18})})]}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[!["superadmin","admin"].includes(s.effectiveRole)&&e.jsxs("button",{onClick:()=>T(s.id),className:"flex items-center gap-1 px-3 py-1.5 rounded-lg bg-purple-500/15 text-purple-300 text-xs font-medium active:scale-95",children:[e.jsx(b,{size:14})," Admin"]}),s.effectiveRole==="admin"&&e.jsxs("button",{onClick:()=>g(s.id),className:"flex items-center gap-1 px-3 py-1.5 rounded-lg bg-purple-500/15 text-purple-300 text-xs font-medium active:scale-95",children:[e.jsx(u,{size:14})," -Admin"]}),!["superadmin","admin","coach"].includes(s.effectiveRole)&&e.jsxs("button",{onClick:()=>B(s.id),className:"flex items-center gap-1 px-3 py-1.5 rounded-lg bg-cyan-500/15 text-cyan-300 text-xs font-medium active:scale-95",children:[e.jsx(U,{size:14})," Coach"]}),s.effectiveRole==="coach"&&e.jsxs("button",{onClick:()=>N(s.id),className:"flex items-center gap-1 px-3 py-1.5 rounded-lg bg-cyan-500/15 text-cyan-300 text-xs font-medium active:scale-95",children:[e.jsx(u,{size:14})," -Coach"]}),s.id!==i.currentUser.uid&&e.jsxs("button",{onClick:()=>F(s.id),className:"flex items-center gap-1 px-3 py-1.5 rounded-lg bg-amber-500/15 text-amber-300 text-xs font-medium active:scale-95",children:[e.jsx(H,{size:14})," Revoca"]}),s.id!==i.currentUser.uid&&e.jsxs("button",{onClick:()=>$(s.id),className:"flex items-center gap-1 px-3 py-1.5 rounded-lg bg-red-500/15 text-red-300 text-xs font-medium active:scale-95",children:[e.jsx(J,{size:14})," Elimina"]}),s.effectiveRole==="superadmin"&&s.id!==i.currentUser.uid&&e.jsxs("button",{onClick:()=>P(s.id),className:"flex items-center gap-1 px-3 py-1.5 rounded-lg bg-rose-500/15 text-rose-300 text-xs font-medium active:scale-95",children:[e.jsx(u,{size:14})," -Super"]})]})]},s.id))]})]})})}export{ze as default};
