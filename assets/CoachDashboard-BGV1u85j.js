import{r as y,R as Z,j as e}from"./react-CrXOBDSJ.js";import{A as E,B as M,H as k,I as S,J as _,K as I,M as B,U as ee}from"./@firebase-CuwLCerw.js";import{a as z,d as g,t as m}from"./index-BVkI2ezc.js";import{s as F}from"./firebase-Bp3EI6Ad.js";import{a as te}from"./react-router-BxpCmtJ-.js";import{m as w,A as se}from"./framer-motion-BAPjnw1b.js";import{U,g as ae,h as G,j as H,B as Q,a1 as ie,M as P,F as V,C as ne}from"./lucide-react-CCY59hBS.js";import"./core-js-ChGsxLo2.js";import"./idb-Bn1DMRyg.js";import"./react-dom-BpmKF3Ga.js";import"./scheduler-DYLXRpC5.js";import"./react-router-dom-9rcY47vU.js";import"./@remix-run-CjG9tKj3.js";import"./jspdf-7Jyqi_bl.js";import"./@babel-Cvov1XSu.js";import"./fflate-XZmX483V.js";import"./fast-png-CUrN0NP5.js";import"./iobuffer-DZ1zOcUT.js";import"./pako-B9FS3IR_.js";import"./tslib-BGVaTf34.js";import"./motion-dom-C8PdgYBP.js";import"./motion-utils-DBsP9okC.js";const re=t=>{if(!t)return"";try{const n=Math.floor((new Date-m(t))/1e3);let a=n/31536e3;return a>1?Math.floor(a)+" anni fa":(a=n/2592e3,a>1?Math.floor(a)+" mesi fa":(a=n/86400,a>1?Math.floor(a)+" gg fa":(a=n/3600,a>1?Math.floor(a)+" ore fa":(a=n/60,a>1?Math.floor(a)+" min fa":"ora"))))}catch(n){return console.error("Errore in timeAgo:",n),""}},$=({title:t,value:n,icon:a,isPercentage:f=!1,variants:b})=>e.jsxs(w.div,{variants:b,className:"bg-slate-800/60 backdrop-blur-sm p-4 rounded-xl border border-slate-700 h-full",children:[e.jsxs("div",{className:"flex items-center gap-3 text-slate-400",children:[a,e.jsx("p",{className:"text-sm",children:t})]}),e.jsx("p",{className:"text-3xl font-bold text-slate-50 mt-2",children:f?`${n}%`:n})]}),A=({to:t,title:n,icon:a,variants:f})=>e.jsx(w.div,{variants:f,children:e.jsxs("button",{onClick:t,className:"group bg-slate-700/50 hover:bg-slate-700/70 border border-slate-600 rounded-lg p-4 flex items-center gap-4 transition-all duration-300 w-full",children:[e.jsx("div",{className:"bg-slate-700/70 group-hover:bg-cyan-500 text-cyan-400 group-hover:text-white p-3 rounded-lg transition-colors duration-300",children:a}),e.jsx("div",{className:"flex-1",children:e.jsx("h4",{className:"font-bold text-slate-200",children:n})}),e.jsx(ne,{className:"text-slate-500 group-hover:text-white transition-colors duration-300"})]})}),ce=({item:t,navigate:n,variants:a})=>{const f={expiring:e.jsx(H,{className:"text-yellow-500",size:18}),new_check:e.jsx(G,{className:"text-green-500",size:18}),new_anamnesi:e.jsx(V,{className:"text-blue-500",size:18}),new_message:e.jsx(P,{className:"text-rose-500",size:18})},b={expiring:"info",new_check:"checks",new_anamnesi:"anamnesi",new_message:"chat"};return e.jsxs(w.button,{variants:a,layout:!0,initial:{opacity:0,y:10},animate:{opacity:1,y:0},exit:{opacity:0,x:-10},transition:{duration:.3},onClick:()=>n(`/coach/client/${t.clientId}?tab=${b[t.type]}`),className:"w-full flex items-start gap-4 p-3 rounded-lg bg-slate-500/5 hover:bg-slate-500/10 transition-colors text-left",children:[e.jsx("div",{className:"mt-1 flex-shrink-0",children:f[t.type]}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"text-sm font-semibold text-slate-200",children:t.clientName}),e.jsx("p",{className:"text-xs text-slate-400",children:t.description})]}),e.jsx("div",{className:"text-xs text-slate-500 flex-shrink-0",children:re(t.date)})]})};function Me(){const t=te(),[n,a]=y.useState([]),[f,b]=y.useState([]),[q,O]=y.useState(""),[L,v]=y.useState(null),[T,D]=y.useState(!0);y.useEffect(()=>{const r=z.onAuthStateChanged(async l=>{if(l)try{const u=E(g,"roles","coaches"),p=await M(u);p.exists()&&p.data().uids.includes(l.uid)?O(l.displayName||l.email||"Coach"):(sessionStorage.removeItem("app_role"),await F(z),t("/login"))}catch{v("Errore nella verifica del ruolo coach."),D(!1)}else t("/login")});return()=>r()},[t]),y.useEffect(()=>{const r=k(S(g,"clients"),l=>{try{const u=l.docs.map(p=>({id:p.id,...p.data()}));a(u),D(!1)}catch{v("Errore nel caricamento dei clienti."),D(!1)}},l=>{v("Errore nel caricamento dei clienti."),D(!1)});return()=>r()},[]),y.useEffect(()=>{if(!z.currentUser)return;const r=_(B(g,"checks"),I("createdAt","desc")),l=k(r,async N=>{try{const c=[];for(const s of N.docs){const o=s.ref.parent.parent.id,i=await M(E(g,"clients",o));c.push({type:"new_check",clientId:o,clientName:i.exists()&&i.data().name||"Cliente",description:"Ha inviato un nuovo check-in",date:s.data().createdAt})}b(s=>[...c,...s.filter(i=>i.type!=="new_check")].sort((i,d)=>m(d.date)-m(i.date)).slice(0,30))}catch{v("Errore nel caricamento dei check.")}}),u=_(B(g,"anamnesi"),I("submittedAt","desc")),p=k(u,async N=>{try{const c=[];for(const s of N.docs){const o=s.ref.parent.parent.id,i=await M(E(g,"clients",o));c.push({type:"new_anamnesi",clientId:o,clientName:i.exists()&&i.data().name||"Cliente",description:"Ha compilato l'anamnesi iniziale",date:s.data().submittedAt})}b(s=>[...c,...s.filter(i=>i.type!=="new_anamnesi")].sort((i,d)=>m(d.date)-m(i.date)).slice(0,30))}catch{v("Errore nel caricamento delle anamnesi.")}}),h=_(S(g,"chats"),ee("participants","array-contains",z.currentUser.uid),I("lastUpdate","desc")),W=k(h,async N=>{var c,s;try{const o=[];for(const i of N.docs){const d=i.data(),j=d.participants.find(C=>C!==z.currentUser.uid);if(d.lastUpdate){const C=await M(E(g,"clients",j));o.push({type:"new_message",clientId:j,clientName:C.exists()&&C.data().name||"Cliente",description:`Nuovo messaggio: ${(s=(c=d.lastMessage)==null?void 0:c.slice)==null?void 0:s.call(c,0,30)}...`,date:d.lastUpdate})}}b(i=>[...o,...i.filter(j=>j.type!=="new_message")].sort((j,C)=>m(C.date)-m(j.date)).slice(0,30))}catch{v("Errore nel caricamento dei messaggi.")}}),X=_(S(g,"clients")),Y=k(X,N=>{try{const c=N.docs.map(s=>({id:s.id,...s.data()})).filter(s=>{const o=m(s.scadenza);if(!o)return!1;const i=(o-new Date)/(1e3*60*60*24);return i<=15&&i>0}).map(s=>({type:"expiring",clientId:s.id,clientName:s.name,description:`Abbonamento in scadenza tra ${Math.ceil((m(s.scadenza)-new Date)/864e5)} giorni`,date:s.scadenza}));b(s=>[...s.filter(d=>d.type!=="expiring"),...c].sort((d,j)=>m(j.date)-m(d.date)).slice(0,30))}catch{v("Errore nel caricamento delle scadenze.")}});return()=>{l(),p(),W(),Y()}},[]);const R=Z.useMemo(()=>{try{const r=new Date,l=n.filter(p=>{const h=m(p.scadenza);return h&&h>r}).length,u=n.filter(p=>{const h=m(p.scadenza);return h&&(h-r)/(1e3*60*60*24)<=15&&h-r>0}).length;return{active:l,expiring:u}}catch{return{active:0,expiring:0}}},[n]),J=async()=>{try{sessionStorage.removeItem("app_role"),await F(z),t("/login")}catch{v("Errore durante il logout.")}},K={hidden:{opacity:0},visible:{opacity:1,transition:{staggerChildren:.1}}},x={hidden:{y:20,opacity:0},visible:{y:0,opacity:1}};return L?e.jsx("div",{className:"min-h-screen bg-slate-900 text-red-400 flex justify-center items-center",children:L}):T?e.jsx("div",{className:"min-h-screen flex justify-center items-center relative",children:e.jsx("div",{className:"animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-cyan-400"})}):e.jsx("div",{className:"min-h-screen text-slate-200 relative overflow-x-hidden w-full",children:e.jsxs(w.div,{initial:"hidden",animate:"visible",variants:K,className:"w-full py-4 sm:py-6",children:[e.jsxs(w.header,{variants:x,className:"bg-slate-800/60 backdrop-blur-sm p-4 sm:p-6 rounded-xl border border-slate-700 mx-3 sm:mx-6",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-4",children:[e.jsxs("h1",{className:"text-3xl font-bold text-slate-50 flex items-center gap-2",children:[e.jsx(U,{size:28})," Coach Dashboard"]}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("span",{className:"text-slate-300 font-semibold",children:q}),e.jsxs("button",{onClick:J,className:"flex items-center gap-2 px-3 py-1.5 bg-rose-600 hover:bg-rose-700 text-white text-sm rounded-lg transition-colors",children:[e.jsx(ae,{size:16})," Logout"]})]})]}),e.jsx("p",{className:"text-slate-400 mb-4",children:"Gestisci i tuoi clienti e monitora le loro attivitÃ ."})]}),e.jsxs("main",{className:"mt-6 mx-3 sm:mx-6",children:[e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6 mb-8",children:[e.jsx($,{title:"Clienti Attivi",value:R.active,icon:e.jsx(G,{className:"text-blue-500"}),variants:x}),e.jsx($,{title:"Scadenze Prossime",value:R.expiring,icon:e.jsx(H,{className:"text-yellow-500"}),variants:x}),e.jsx($,{title:"Totale Clienti",value:n.length,icon:e.jsx(U,{className:"text-cyan-500"}),variants:x})]}),e.jsxs(w.div,{variants:x,className:"bg-slate-800/60 backdrop-blur-sm p-4 sm:p-6 rounded-xl border border-slate-700",children:[e.jsxs("h2",{className:"text-lg font-semibold mb-4 flex items-center gap-2 text-slate-200",children:[e.jsx(Q,{size:20})," Aggiornamenti Recenti"]}),e.jsx("div",{className:"space-y-3 max-h-[90vh] overflow-y-auto pr-2",children:e.jsx(se,{children:f.length>0?f.map(r=>{var l;return e.jsx(ce,{item:r,navigate:t,variants:x},`${r.type}-${r.clientId}-${((l=r.date)==null?void 0:l.seconds)||r.date}`)}):e.jsx("p",{className:"text-slate-400 text-center p-4",children:"Nessun aggiornamento recente."})})})]}),e.jsxs(w.div,{variants:x,className:"mt-8 bg-slate-800/60 backdrop-blur-sm p-4 sm:p-6 rounded-xl border border-slate-700",children:[e.jsx("h2",{className:"text-lg font-semibold mb-4 text-slate-200",children:"Funzioni Utili"}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:[e.jsx(A,{to:()=>t("/coach/clients"),title:"Gestisci Clienti",icon:e.jsx(U,{size:22}),variants:x}),e.jsx(A,{to:()=>t("/new"),title:"Aggiungi Nuovo Cliente",icon:e.jsx(ie,{size:22}),variants:x}),e.jsx(A,{to:()=>t("/coach/chat"),title:"Invia Messaggio",icon:e.jsx(P,{size:22}),variants:x}),e.jsx(A,{to:()=>t("/coach/anamnesi"),title:"Visualizza Anamnesi",icon:e.jsx(V,{size:22}),variants:x}),e.jsx(A,{to:()=>t("/coach/updates"),title:"Aggiornamenti",icon:e.jsx(Q,{size:22}),variants:x})]})]})]})]})})}export{Me as default};
