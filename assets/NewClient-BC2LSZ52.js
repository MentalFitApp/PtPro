import{r as d,j as e}from"./react-CrXOBDSJ.js";import{u as se}from"./react-hook-form-yCRcHKQw.js";import{a as L,f as ie,d as O}from"./index-dCbZtuAy.js";import{g as oe,c as re}from"./firebase-Bp3EI6Ad.js";import{v as ne,A as H,O as V,N as Z,I as le,Y as ce}from"./@firebase-CuwLCerw.js";import{a as de,b as me}from"./react-router-BxpCmtJ-.js";import{m as f,A as B}from"./framer-motion-BAPjnw1b.js";import{u as pe,D as ue,I as xe,y as he,z as ge,$ as be,X as je}from"./lucide-react-CCY59hBS.js";import"./core-js-ChGsxLo2.js";import"./react-dom-BpmKF3Ga.js";import"./scheduler-DYLXRpC5.js";import"./react-router-dom-9rcY47vU.js";import"./@remix-run-CjG9tKj3.js";import"./jspdf-7Jyqi_bl.js";import"./@babel-Cvov1XSu.js";import"./fflate-XZmX483V.js";import"./fast-png-CUrN0NP5.js";import"./iobuffer-DZ1zOcUT.js";import"./pako-B9FS3IR_.js";import"./tslib-BGVaTf34.js";import"./idb-Bn1DMRyg.js";import"./motion-dom-C8PdgYBP.js";import"./motion-utils-DBsP9okC.js";const ye=({message:x,type:n,onDismiss:i})=>e.jsx(B,{children:x&&e.jsxs(f.div,{initial:{opacity:0,y:-50},animate:{opacity:1,y:0},exit:{opacity:0,y:-50},className:`fixed top-5 right-5 z-50 flex items-center gap-4 p-4 rounded-lg border ${n==="error"?"bg-red-900/80 text-red-300 border-red-500/30":"bg-emerald-900/80 text-emerald-300 border-emerald-500/30"} backdrop-blur-md shadow-lg`,children:[e.jsx(be,{className:n==="error"?"text-red-400":"text-emerald-400"}),e.jsx("p",{children:x}),e.jsx("button",{onClick:i,className:"p-1 rounded-full hover:bg-white/10",children:e.jsx(je,{size:16})})]})}),fe=()=>{const n="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*";let i="";for(let w=0,b=n.length;w<8;++w)i+=n.charAt(Math.floor(Math.random()*b));return i};function Be(){const x=de(),n=me(),{register:i,handleSubmit:w,reset:b,watch:Y,formState:{isSubmitting:D,errors:s}}=se({defaultValues:{name:"",email:"",phone:"",planType:"",duration:"",customStartDate:new Date().toISOString().split("T")[0],customExpiryDate:"",paymentAmount:"",paymentMethod:""}}),[_,$]=d.useState(!1),[N,Q]=d.useState(null),[W,R]=d.useState(!1),[U,C]=d.useState({message:"",type:""}),[j,A]=d.useState(!1),[z,X]=d.useState(!1),[y,T]=d.useState([]),[h,k]=d.useState({amount:"",dueDate:"",paid:!1}),G=Y("customStartDate");d.useEffect(()=>{var a;if((a=n.state)!=null&&a.prefill){const t=n.state.prefill;console.log("Dati precompilati ricevuti:",t),b({name:t.name||"",email:t.email||"",phone:t.phone||"",planType:t.planType||"",duration:t.duration?String(t.duration):"",paymentAmount:t.paymentAmount?String(t.paymentAmount):"",paymentMethod:t.paymentMethod||"",customStartDate:t.customStartDate||new Date().toISOString().split("T")[0]}),t.duration&&A(!1)}},[n.state,b]);const m=(a,t="error")=>{C({message:a,type:t}),setTimeout(()=>C({message:"",type:""}),6e3)},J=async a=>{if(!L.currentUser){m("Devi essere autenticato come coach o admin per creare un cliente.","error"),x("/login");return}const t=fe(),c=ne(ie,`user-creation-${Date.now()}`),g=oe(c);try{let o=new Date(a.customStartDate);o.setHours(0,0,0,0);let u,P=!1;const S=new Date;S.setHours(0,0,0,0);const ae=new Date(S.getFullYear(),S.getMonth(),1);if(o>S){m("La data di inizio non può essere futura.","error");return}if(j&&a.customExpiryDate){if(u=new Date(a.customExpiryDate),u<o){m("La data di scadenza deve essere successiva alla data di inizio.","error");return}P=o<ae}else if(a.duration){const v=parseInt(a.duration,10);u=new Date(o),u.setMonth(u.getMonth()+v),u.setDate(u.getDate()+7)}else{m("Seleziona una durata o una data di scadenza.","error");return}console.log("Inizio creazione cliente:",{email:a.email,name:a.name,paymentAmount:a.paymentAmount,userId:L.currentUser.uid});const E=(await re(g,a.email.trim(),t)).user.uid;console.log("Utente creato con UID:",E);const q=H(O,"clients",E),te={...a,rateizzato:z,rate:z?y:[],name:a.name,name_lowercase:a.name.toLowerCase(),email:a.email.trim(),phone:a.phone||null,status:"attivo",planType:a.planType,createdAt:V(),startDate:o,scadenza:u,isClient:!0,firstLogin:!0,tempPassword:t,isOldClient:P,assignedCoaches:[L.currentUser.uid],statoPercorso:"Attivo"};if(await Z(q,te),console.log("Documento cliente creato:",q.path),a.paymentAmount){const v=H(le(O,"clients",E,"payments")),F={amount:parseFloat(a.paymentAmount),duration:j?"personalizzata":`${parseInt(a.duration,10)} mes${parseInt(a.duration,10)>1?"i":"e"}`,paymentMethod:a.paymentMethod||"N/A",paymentDate:V(),isPast:P};console.log("Tentativo creazione pagamento:",{paymentRef:v.path,paymentData:F}),await Z(v,F),console.log("Documento pagamento creato:",v.path)}Q({name:a.name,email:a.email.trim(),password:t}),$(!0),m("Cliente creato con successo!","success"),b()}catch(o){console.error("Errore nella creazione del cliente:",o.code,o.message,{data:a}),o.code==="permission-denied"?m("Permessi insufficienti. Verifica che il tuo UID sia nei documenti /roles/admins o /roles/coaches.","error"):o.code==="auth/email-already-in-use"?m("Questa email è già in uso da un altro utente.","error"):m("Si è verificato un errore imprevisto: "+o.message,"error")}finally{await ce(c)}},K=()=>{const a=`${window.location.origin}${window.location.pathname}#/login`,t=`Ciao ${N.name},

Benvenuto in PT Manager, la tua area personale per monitorare i progressi e comunicare con il tuo coach!

Ecco le credenziali per il tuo primo accesso:

Link: ${a}
Email: ${N.email}
Password Temporanea: ${N.password}

Al primo accesso ti verrà chiesto di impostare una password personale.
A presto!`;navigator.clipboard.writeText(t),R(!0),setTimeout(()=>R(!1),2500)},ee=()=>{$(!1),b(),x("/clients")},l="w-full p-2.5 bg-slate-700/50 border border-slate-600 rounded-lg outline-none focus:ring-2 focus:ring-rose-500 text-slate-200 placeholder:text-slate-500",r="block mb-1 text-sm font-medium text-slate-300",I="bg-slate-800/60 backdrop-blur-sm rounded-2xl border border-slate-700 p-6",M="font-bold mb-4 text-lg text-rose-300 border-b border-rose-400/20 pb-2 flex items-center gap-2",p="text-red-500 text-sm mt-1";return e.jsxs(e.Fragment,{children:[e.jsx(ye,{message:U.message,type:U.type,onDismiss:()=>C({message:"",type:""})}),e.jsxs(f.div,{className:"w-full max-w-2xl mx-auto",initial:{opacity:0,y:20},animate:{opacity:1,y:0},children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsx("h1",{className:"text-2xl font-bold text-slate-50",children:"Onboarding Nuovo Cliente"}),e.jsxs("button",{onClick:()=>x("/clients"),className:"flex items-center gap-2 px-3 py-1.5 bg-slate-700/50 hover:bg-slate-700/70 border border-slate-600 text-slate-300 text-sm rounded-lg transition-colors",children:[e.jsx(pe,{size:16})," Torna Indietro"]})]}),e.jsxs("form",{onSubmit:w(J),className:"space-y-6",children:[e.jsxs("div",{className:I,children:[e.jsx("h4",{className:M,children:"1. Anagrafica"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:r,children:"Nome e Cognome*"}),e.jsx("input",{...i("name",{required:"Il nome è obbligatorio",minLength:{value:2,message:"Il nome deve essere lungo almeno 2 caratteri"}}),className:l}),s.name&&e.jsx("p",{className:p,children:s.name.message})]}),e.jsxs("div",{children:[e.jsx("label",{className:r,children:"Email (sarà il suo username)*"}),e.jsx("input",{type:"email",...i("email",{required:"L'email è obbligatoria",pattern:{value:/^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/,message:"Inserisci un'email valida"}}),className:l}),s.email&&e.jsx("p",{className:p,children:s.email.message})]}),e.jsxs("div",{children:[e.jsx("label",{className:r,children:"Telefono (Opzionale)"}),e.jsx("input",{...i("phone",{pattern:{value:/^\+?[0-9]{7,15}$/,message:"Inserisci un numero di telefono valido (7-15 cifre)"}}),className:l}),s.phone&&e.jsx("p",{className:p,children:s.phone.message})]})]})]}),e.jsxs("div",{className:I,children:[e.jsx("h4",{className:M,children:"2. Dettagli Percorso"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:r,children:"Tipo di Percorso*"}),e.jsxs("select",{...i("planType",{required:"Il tipo di percorso è obbligatorio"}),className:l,children:[e.jsx("option",{value:"",children:"Seleziona tipo"}),e.jsx("option",{value:"allenamento",children:"Solo Allenamento"}),e.jsx("option",{value:"alimentazione",children:"Solo Alimentazione"}),e.jsx("option",{value:"completo",children:"Completo"})]}),s.planType&&e.jsx("p",{className:p,children:s.planType.message})]}),e.jsxs("div",{children:[e.jsx("label",{className:r,children:"Modalità Scadenza*"}),e.jsxs("div",{className:"flex items-center gap-4 mb-2",children:[e.jsxs("label",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"radio",checked:!j,onChange:()=>A(!1),className:"text-rose-500"}),"Durata in mesi"]}),e.jsxs("label",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"radio",checked:j,onChange:()=>A(!0),className:"text-rose-500"}),"Data personalizzata"]})]}),j?e.jsxs("div",{children:[e.jsx("label",{className:r,children:"Data di Inizio*"}),e.jsx("input",{type:"date",...i("customStartDate",{required:'La data di inizio è obbligatoria quando si usa "Data personalizzata"',validate:a=>{const t=new Date(a),c=new Date;return c.setHours(0,0,0,0),t<=c||"La data di inizio non può essere futura"}}),className:l}),s.customStartDate&&e.jsx("p",{className:p,children:s.customStartDate.message}),e.jsx("label",{className:r,children:"Data di Scadenza*"}),e.jsx("input",{type:"date",...i("customExpiryDate",{required:'La data di scadenza è obbligatoria quando si usa "Data personalizzata"',validate:a=>{if(!j)return!0;const t=new Date(G);return new Date(a)>=t||"La data di scadenza deve essere successiva alla data di inizio"}}),className:l}),s.customExpiryDate&&e.jsx("p",{className:p,children:s.customExpiryDate.message})]}):e.jsxs("div",{children:[e.jsx("label",{className:r,children:"Durata del Percorso*"}),e.jsxs("select",{...i("duration",{required:'La durata è obbligatoria quando si usa "Durata in mesi"'}),className:l,children:[e.jsx("option",{value:"",children:"Seleziona durata"}),[...Array(24).keys()].map(a=>e.jsxs("option",{value:a+1,children:[a+1," mes",a>0?"i":"e"]},a+1))]}),s.duration&&e.jsx("p",{className:p,children:s.duration.message})]})]})]})]}),e.jsxs("div",{className:I,children:[e.jsxs("h4",{className:M,children:[e.jsx(ue,{size:20})," 3. Primo Pagamento (Opzionale)"]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:r,children:"Importo Pagato (€)"}),e.jsx("input",{type:"number",step:"0.01",...i("paymentAmount",{validate:a=>!a||parseFloat(a)>0||"L'importo deve essere maggiore di 0"}),className:l}),s.paymentAmount&&e.jsx("p",{className:p,children:s.paymentAmount.message})]}),e.jsxs("div",{children:[e.jsx("label",{className:r,children:"Metodo di Pagamento"}),e.jsx("input",{...i("paymentMethod"),className:l,placeholder:"Es. Bonifico"})]})]})]}),e.jsxs("div",{className:"flex items-center gap-3 mt-2",children:[e.jsx("label",{className:"font-semibold text-slate-200 text-sm",children:"Rateizzato:"}),e.jsx("input",{type:"checkbox",checked:z,onChange:a=>X(a.target.checked)})]}),z&&e.jsxs("div",{className:"mt-4 p-4 bg-slate-900/60 rounded-xl border border-slate-700 flex flex-col gap-3",children:[e.jsx("h3",{className:"text-lg font-bold text-slate-200 mb-2",children:"Rate iniziali"}),e.jsxs("table",{className:"w-full text-xs bg-slate-800/60 rounded-xl border border-slate-700 mb-2",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"bg-slate-900/50",children:[e.jsx("th",{className:"px-2 py-2",children:"Importo"}),e.jsx("th",{className:"px-2 py-2",children:"Scadenza"}),e.jsx("th",{className:"px-2 py-2",children:"Pagata"}),e.jsx("th",{className:"px-2 py-2",children:"Azioni"})]})}),e.jsx("tbody",{children:y.length>0?y.map((a,t)=>e.jsxs("tr",{className:"border-b border-slate-700",children:[e.jsxs("td",{className:"px-2 py-2",children:["€",a.amount]}),e.jsx("td",{className:"px-2 py-2",children:a.dueDate?new Date(a.dueDate).toLocaleDateString():"-"}),e.jsx("td",{className:"px-2 py-2",children:e.jsx("input",{type:"checkbox",checked:a.paid,onChange:()=>{const c=y.map((g,o)=>o===t?{...g,paid:!g.paid}:g);T(c)}})}),e.jsx("td",{className:"px-2 py-2",children:e.jsx("button",{type:"button",onClick:()=>T(y.filter((c,g)=>g!==t)),className:"text-red-400 px-2",children:"Elimina"})})]},t)):e.jsx("tr",{children:e.jsx("td",{colSpan:4,className:"text-center py-2 text-slate-400",children:"Nessuna rata"})})})]}),e.jsxs("div",{className:"flex gap-2 mt-3",children:[e.jsx("input",{type:"number",placeholder:"Importo (€)",value:h.amount,onChange:a=>k({...h,amount:a.target.value}),className:"p-2 rounded bg-slate-700/50 border border-slate-600 text-white"}),e.jsx("input",{type:"date",value:h.dueDate,onChange:a=>k({...h,dueDate:a.target.value}),className:"p-2 rounded bg-slate-700/50 border border-slate-600 text-white"}),e.jsx("button",{type:"button",onClick:()=>{h.amount&&h.dueDate&&(T([...y,h]),k({amount:"",dueDate:"",paid:!1}))},className:"bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded",children:"Aggiungi rata"})]})]}),e.jsx("div",{className:"flex justify-center md:justify-end pt-4 pb-20 md:pb-4",children:e.jsxs(f.button,{type:"submit",disabled:D,className:"w-full md:w-auto flex items-center justify-center gap-2 px-5 py-3 bg-rose-600 hover:bg-rose-700 text-white rounded-lg transition disabled:opacity-50 font-semibold disabled:cursor-not-allowed",whileHover:{scale:D?1:1.05},whileTap:{scale:D?1:.95},children:[e.jsx(xe,{size:18})," ",D?"Creazione in corso...":"Crea Cliente"]})})]})]}),e.jsx(B,{children:_&&e.jsx(f.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"fixed inset-0 bg-black/70 backdrop-blur-sm flex justify-center items-center z-50 p-4",children:e.jsxs(f.div,{className:"bg-slate-800/95 backdrop-blur-sm rounded-2xl border border-slate-700 p-6 text-center w-full max-w-md shadow-2xl shadow-black/40",initial:{scale:.9,opacity:0},animate:{scale:1,opacity:1},exit:{scale:.9,opacity:0},children:[e.jsx("h2",{className:"text-xl font-bold text-slate-50",children:"Cliente Creato!"}),e.jsx("p",{className:"text-slate-400 text-sm mt-2",children:"Copia e invia le credenziali al cliente."}),e.jsxs("div",{className:"my-6 space-y-3 text-left",children:[e.jsxs("div",{className:"bg-slate-700/50 p-3 rounded-lg border border-slate-600",children:[e.jsx("p",{className:"text-xs text-slate-400",children:"Email (Username)"}),e.jsx("p",{className:"font-mono text-slate-200",children:N.email})]}),e.jsxs("div",{className:"bg-slate-700/50 p-3 rounded-lg border border-slate-600",children:[e.jsx("p",{className:"text-xs text-slate-400",children:"Password Temporanea"}),e.jsx("p",{className:"font-mono text-slate-200",children:N.password})]})]}),e.jsx(f.button,{onClick:K,className:"w-full py-3 bg-emerald-600 hover:bg-emerald-700 text-white font-semibold rounded-lg flex items-center justify-center gap-2 transition-colors",whileHover:{scale:1.02},whileTap:{scale:.98},children:W?e.jsxs(e.Fragment,{children:[e.jsx(he,{size:18})," Copiato!"]}):e.jsxs(e.Fragment,{children:[e.jsx(ge,{size:16})," Copia Credenziali"]})}),e.jsx("button",{onClick:ee,className:"w-full mt-3 py-2 text-slate-400 hover:text-white text-sm text-center transition-colors",children:"Chiudi"})]})})})]})}export{Be as default};
