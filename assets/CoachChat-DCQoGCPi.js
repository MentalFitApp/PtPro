import{r as a,j as e}from"./react-FJB7Hj_2.js";import{g as se}from"./firebase-CiybzbB3.js";import{D as w,G as R,H as F,Q as A,B as H,R as te,T as ae,K as D,y as J,J as V}from"./@firebase-D5dUFubL.js";import{d as u}from"./index-C1w-7Ivh.js";import{a as re}from"./react-router-DF4cN2Hx.js";import{A as ie,S as ne,z as oe,a as le,E as $}from"./lucide-react-BYK_Rxhn.js";import{A as G,m as k}from"./framer-motion-Bo7GrDk8.js";import"./papaparse-BHXrM2Hc.js";import"./tslib-BGVaTf34.js";import"./idb-BXWtuYvb.js";import"./react-dom-BrtcLnxQ.js";import"./scheduler-DYLXRpC5.js";import"./react-router-dom-udQfSOCw.js";import"./@remix-run-CjG9tKj3.js";import"./motion-dom-C8PdgYBP.js";import"./motion-utils-DBsP9okC.js";const ce=()=>e.jsxs("div",{className:"min-h-screen bg-zinc-950 text-slate-200 flex flex-col justify-center items-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-rose-500"}),e.jsx("p",{className:"mt-4 text-slate-400",children:"Caricamento chat..."})]}),de=({message:o,onDismiss:N})=>e.jsx(G,{children:o&&e.jsxs(k.div,{initial:{opacity:0,y:-50},animate:{opacity:1,y:0},exit:{opacity:0,y:-50},className:"fixed top-5 right-5 z-50 flex items-center gap-4 p-4 rounded-lg border bg-red-900/80 text-red-300 border-red-500/30 backdrop-blur-md shadow-lg",children:[e.jsx($,{size:20}),e.jsx("p",{children:o}),e.jsx("button",{onClick:N,className:"p-1 rounded-full hover:bg-white/10",children:e.jsx($,{size:16})})]})}),me=({chat:o,setSelectedChatId:N,selectedChatId:d,adminUIDs:p})=>{var f;const y=o.participants.find(C=>!p.includes(C)),h=((f=o.participantNames)==null?void 0:f[y])||"Cliente";return e.jsxs(k.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},className:`p-4 cursor-pointer border-l-4 transition-colors ${d===o.id?"bg-rose-600/20 border-rose-500":"border-transparent hover:bg-white/5"}`,onClick:()=>N(o.id),children:[e.jsx("p",{className:"font-semibold text-slate-100",children:h}),e.jsx("p",{className:"text-sm text-slate-400",children:o.lastMessage||"Nessun messaggio"})]})};function Ie(){var Q,B,X;const o=re(),d=se().currentUser,[p,y]=a.useState([]),[h,f]=a.useState(""),[C,c]=a.useState(!0),[K,l]=a.useState(""),[S,M]=a.useState(null),[g,P]=a.useState([]),[m,T]=a.useState(null),[b,q]=a.useState(""),[U,z]=a.useState([]),[E,I]=a.useState(!1),L=a.useRef(null),v=a.useRef(null),j="l0RI8TzFjbNVoAdmcXNQkP9mWb12",O=["QwWST9OVOlTOi5oheyCqfpXLOLg2","AeZKjJYu5zMZ4mvffaGiqCBb0cF2","3j0AXIRa4XdHq1ywCl4UBxJNsku2",j];a.useEffect(()=>{if(!d){o("/login");return}const s=w(u,"chats"),t=R(s,A("participants","array-contains",j),F("lastUpdate","desc")),i=H(t,n=>{try{P(n.docs.map(r=>({id:r.id,...r.data()}))),c(!1)}catch(r){console.error("Errore nel caricare le chat:",r),l("Errore nel caricamento delle chat."),c(!1)}},n=>{console.error("Errore snapshot chats:",n),l("Errore nel caricamento delle chat."),c(!1)});return()=>i()},[d,o]),a.useEffect(()=>{if(!m){y([]);return}v.current&&(v.current(),v.current=null),c(!0);const s=w(u,"chats",m,"messages"),t=R(s,F("createdAt")),i=H(t,n=>{try{const r=n.docs.map(x=>({id:x.id,...x.data()}));y(r),c(!1)}catch(r){console.error("Errore nello snapshot dei messaggi:",r),l("Errore nel caricamento dei messaggi."),c(!1)}},n=>{console.error("Errore snapshot messaggi:",n),l("Errore nel caricamento dei messaggi."),c(!1)});return v.current=i,()=>i&&i()},[m]),a.useEffect(()=>{const s=async()=>{if(b.trim().length<2){z([]),I(!1);return}I(!0);const i=w(u,"clients"),n=b.toLowerCase(),r=R(i,A("name_lowercase",">=",n),A("name_lowercase","<=",n+"ï£¿"),limit(10));try{const x=await te(r);z(x.docs.map(_=>({id:_.id,..._.data()})))}catch(x){console.error("Errore nella ricerca:",x),l("Errore nella ricerca dei clienti.")}I(!1)},t=setTimeout(()=>{s()},300);return()=>clearTimeout(t)},[b]),a.useEffect(()=>{var s;(s=L.current)==null||s.scrollIntoView({behavior:"smooth"})},[p]);const W=async s=>{if(s.preventDefault(),h.trim()===""||!S)return;const t=h;f("");try{const i=w(u,"chats",S,"messages");await ae(i,{text:t,createdAt:D(),senderId:d.uid});const n=J(u,"chats",S);await V(n,{lastMessage:t,lastUpdate:D()},{merge:!0})}catch(i){console.error("Errore nell'invio del messaggio:",i),l("Errore nell'invio del messaggio. Riprova.")}},Z=s=>{T(s),M(s),l(""),c(!0)},Y=async s=>{const t=[s.id,j].sort().join("_"),i=J(u,"chats",t);if(!g.find(r=>r.id===t))try{await V(i,{participants:[s.id,j],participantNames:{[s.id]:s.name,[j]:"Coach Mattia"},lastMessage:"Conversazione iniziata",lastUpdate:D()},{merge:!0})}catch(r){console.error("Errore nella creazione della chat:",r),l("Errore nella creazione della chat.")}T(t),M(t),q(""),z([])},ee=()=>l("");return C?e.jsx(ce,{}):e.jsxs("div",{className:"min-h-screen bg-zinc-950 text-slate-200 font-sans flex flex-col h-screen relative",children:[e.jsx(de,{message:K,onDismiss:ee}),e.jsx("header",{className:"flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 p-4 bg-zinc-950/70 backdrop-blur-lg border-b border-white/10 sticky top-0 z-10",children:e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("button",{onClick:()=>o("/coach-dashboard"),className:"flex items-center gap-2 px-3 py-2 bg-zinc-800/80 hover:bg-zinc-700/80 text-slate-200 text-sm font-semibold rounded-lg transition-colors",children:[e.jsx(ie,{size:16}),e.jsx("span",{children:"Dashboard"})]}),e.jsx("h1",{className:"text-xl font-bold text-slate-50",children:"Chat"})]})}),e.jsxs("main",{className:"flex-1 flex flex-col lg:flex-row h-[calc(100vh-8rem)]",children:[e.jsxs("div",{className:"w-full lg:w-1/3 border-r border-white/10 flex flex-col",children:[e.jsxs("div",{className:"p-4 border-b border-white/10",children:[e.jsxs("div",{className:"relative",children:[e.jsx(ne,{className:"absolute top-1/2 left-3 -translate-y-1/2 text-slate-400",size:18}),e.jsx("input",{type:"text",value:b,onChange:s=>q(s.target.value),placeholder:"Cerca cliente...",className:"w-full bg-zinc-900/70 p-2 pl-10 rounded-lg border border-white/10 outline-none focus:ring-2 focus:ring-rose-500 text-slate-200 text-sm sm:text-base"})]}),b.length>1&&e.jsxs("div",{className:"mt-2",children:[E&&e.jsx("p",{className:"p-4 text-slate-400 text-sm",children:"Ricerca in corso..."}),!E&&U.length===0&&e.jsx("p",{className:"p-4 text-slate-400 text-sm",children:"Nessun cliente trovato."}),!E&&U.map(s=>e.jsxs("div",{onClick:()=>Y(s),className:"p-4 cursor-pointer hover:bg-white/5 transition-colors",children:[e.jsx("p",{className:"font-semibold text-slate-100",children:s.name}),e.jsx("p",{className:"text-sm text-slate-400",children:s.email})]},s.id))]})]}),e.jsx("div",{className:"flex-1 overflow-y-auto",children:g.length>0?g.map(s=>e.jsx(me,{chat:s,setSelectedChatId:Z,selectedChatId:m,adminUIDs:O},s.id)):e.jsx("p",{className:"text-slate-400 text-center py-8",children:"Nessuna conversazione disponibile."})})]}),e.jsx("div",{className:"w-full lg:w-2/3 flex flex-col bg-zinc-900/50",children:m?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"p-4 border-b border-white/10",children:e.jsx("h3",{className:"font-bold text-lg text-slate-50",children:((X=(Q=g.find(s=>s.id===m))==null?void 0:Q.participantNames)==null?void 0:X[(B=g.find(s=>s.id===m))==null?void 0:B.participants.find(s=>!O.includes(s))])||"Cliente"})}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-4 sm:p-6 space-y-4",children:[p.length>0?e.jsx(G,{children:p.map(s=>{var t;return e.jsx(k.div,{className:`flex ${s.senderId===d.uid?"justify-end":"justify-start"}`,initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{duration:.3},children:e.jsxs("div",{className:`max-w-[70%] sm:max-w-md p-3 rounded-2xl shadow-md ${s.senderId===d.uid?"bg-rose-600/90 text-white rounded-br-none":"bg-cyan-600/90 text-white rounded-bl-none"}`,children:[e.jsx("p",{className:"break-words text-sm sm:text-base",children:s.text}),e.jsx("p",{className:"text-xs text-slate-200/70 mt-1 text-right",children:(t=s.createdAt)==null?void 0:t.toDate().toLocaleTimeString("it-IT",{hour:"2-digit",minute:"2-digit"})})]})},s.id)})}):e.jsx("p",{className:"text-slate-400 text-center py-8",children:"Nessun messaggio. Inizia la conversazione!"}),e.jsx("div",{ref:L})]}),e.jsx("footer",{className:"p-4 sm:p-6 bg-zinc-950/70 backdrop-blur-lg border-t border-white/10 sticky bottom-0",children:e.jsxs("form",{onSubmit:W,className:"flex items-center gap-3 max-w-3xl mx-auto",children:[e.jsx("input",{type:"text",value:h,onChange:s=>f(s.target.value),placeholder:"Scrivi un messaggio...",className:"flex-1 p-3 bg-zinc-900 border border-zinc-700 rounded-full outline-none focus:ring-2 focus:ring-rose-500 text-slate-200 text-sm sm:text-base transition-all placeholder:text-slate-500 shadow-sm"}),e.jsx("button",{type:"submit",className:"p-3 bg-rose-600 hover:bg-rose-700 text-white rounded-full transition-colors disabled:bg-rose-900 disabled:cursor-not-allowed shadow-md",disabled:!h.trim(),children:e.jsx(oe,{size:20})})]})})]}):e.jsxs("div",{className:"flex flex-col justify-center items-center h-full text-slate-500",children:[e.jsx(le,{size:48}),e.jsx("p",{className:"mt-4",children:"Seleziona una conversazione per iniziare."})]})})]})]})}export{Ie as default};
