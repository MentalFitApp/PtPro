import{r as d,j as e,bJ as S,av as V,A as $,q as O,aS as D,aP as B,aQ as q,F as J}from"./.pnpm-C04Ba0Xq.js";import{a as N}from"./cloudflareStorage-DUIVXCyJ.js";const E=(a,t="image")=>{const o={image:{maxSize:10485760,types:["image/jpeg","image/png","image/gif","image/webp"]},video:{maxSize:104857600,types:["video/mp4","video/webm","video/quicktime"]},audio:{maxSize:26214400,types:["audio/mpeg","audio/mp3","audio/wav","audio/webm","audio/ogg"]},document:{maxSize:10485760,types:["application/pdf","application/msword"]}}[t];return o?a.size>o.maxSize?{valid:!1,error:`File troppo grande. Massimo: ${(o.maxSize/1024/1024).toFixed(0)}MB`}:o.types.includes(a.type)?{valid:!0}:{valid:!1,error:`Formato non supportato. Formati accettati: ${o.types.join(", ")}`}:{valid:!1,error:"Tipo file non supportato"}},Q=async(a,t,r="images",o=null)=>{const l=E(a,"image");if(!l.valid)throw new Error(l.error);try{return{type:"image",url:await N(a,t,r,o,!0)}}catch(i){throw console.error("Error uploading image:",i),new Error("Errore durante il caricamento dell'immagine")}},X=async(a,t,r="videos",o=null)=>{const l=E(a,"video");if(!l.valid)throw new Error(l.error);try{const i=await N(a,t,r,o,!1),p=await _(a);return{type:"video",url:i,duration:p}}catch(i){throw console.error("Error uploading video:",i),new Error("Errore durante il caricamento del video")}},U=async(a,t,r="audio",o=null)=>{const l=E(a,"audio");if(!l.valid)throw new Error(l.error);try{const i=await N(a,t,r,o,!1),p=await G(a);return{type:"audio",url:i,duration:p}}catch(i){throw console.error("Error uploading audio:",i),new Error("Errore durante il caricamento dell'audio")}},_=a=>new Promise(t=>{try{const r=document.createElement("video");r.preload="metadata",r.onloadedmetadata=()=>{window.URL.revokeObjectURL(r.src),t(Math.round(r.duration))},r.onerror=()=>{t(null)},r.src=URL.createObjectURL(a)}catch{t(null)}}),G=a=>new Promise(t=>{try{const r=document.createElement("audio");r.preload="metadata",r.onloadedmetadata=()=>{window.URL.revokeObjectURL(r.src),t(Math.round(r.duration))},r.onerror=()=>{t(null)},r.src=URL.createObjectURL(a)}catch{t(null)}});class H{constructor(){this.mediaRecorder=null,this.audioChunks=[],this.stream=null}async start(){try{return this.stream=await navigator.mediaDevices.getUserMedia({audio:!0}),this.mediaRecorder=new MediaRecorder(this.stream),this.audioChunks=[],this.mediaRecorder.ondataavailable=t=>{this.audioChunks.push(t.data)},this.mediaRecorder.start(),!0}catch(t){throw console.error("Error starting recording:",t),new Error("Impossibile accedere al microfono")}}stop(){return new Promise((t,r)=>{if(!this.mediaRecorder){r(new Error("Nessuna registrazione in corso"));return}this.mediaRecorder.onstop=()=>{const o=new Blob(this.audioChunks,{type:"audio/webm"}),l=new File([o],`voice_${Date.now()}.webm`,{type:"audio/webm"});this.stream&&this.stream.getTracks().forEach(i=>i.stop()),t(l)},this.mediaRecorder.stop()})}cancel(){this.mediaRecorder&&this.mediaRecorder.state!=="inactive"&&this.mediaRecorder.stop(),this.stream&&this.stream.getTracks().forEach(t=>t.stop()),this.audioChunks=[]}}const K=a=>{if(!a)return"0:00";const t=Math.floor(a/60),r=a%60;return`${t}:${r.toString().padStart(2,"0")}`};function Z({userId:a,onUploadComplete:t,type:r="all",folder:o="media",showLabel:l=!0,className:i=""}){const[p,u]=d.useState(!1),[k,m]=d.useState(0),[F,j]=d.useState(!1),[C,w]=d.useState(0),[z,h]=d.useState(!1),v=d.useRef(null),y=d.useRef(null),b=d.useRef(null),g=d.useRef(null),f=d.useRef(null),M=async s=>{const c=s.target.files[0];if(c){u(!0),m(0);try{const n=await Q(c,a,o,x=>{m(x.percent)});t(n),h(!1)}catch(n){alert(n.message||"Errore durante il caricamento")}finally{u(!1),v.current&&(v.current.value="")}}},I=async s=>{const c=s.target.files[0];if(c){u(!0),m(0);try{const n=await X(c,a,o,x=>{m(x.percent)});t(n),h(!1)}catch(n){alert(n.message||"Errore durante il caricamento")}finally{u(!1),y.current&&(y.current.value="")}}},L=async s=>{const c=s.target.files[0];if(c){u(!0),m(0);try{const n=await U(c,a,o,x=>{m(x.percent)});t(n),h(!1)}catch(n){alert(n.message||"Errore durante il caricamento")}finally{u(!1),b.current&&(b.current.value="")}}},A=async()=>{try{g.current=new H,await g.current.start(),j(!0),w(0),f.current=setInterval(()=>{w(s=>s+1)},1e3)}catch(s){alert(s.message||"Impossibile accedere al microfono")}},P=async()=>{try{f.current&&clearInterval(f.current);const s=await g.current.stop();j(!1),w(0),u(!0),m(0);const c=await U(s,a,o,n=>{m(n.percent)});t(c),h(!1)}catch(s){alert(s.message||"Errore durante il salvataggio")}finally{u(!1)}},T=()=>{g.current&&g.current.cancel(),f.current&&clearInterval(f.current),j(!1),w(0)},R=s=>r==="all"||r===s;return p?e.jsxs("div",{className:"flex items-center gap-2 px-3 py-2 bg-slate-700 rounded-lg",children:[e.jsx(S,{size:16,className:"text-slate-400 animate-pulse"}),e.jsx("div",{className:"flex-1 bg-slate-600 rounded-full h-2 overflow-hidden",children:e.jsx("div",{className:"h-full bg-rose-600 transition-all duration-300",style:{width:`${k}%`}})}),e.jsxs("span",{className:"text-xs text-slate-400",children:[k,"%"]})]}):F?e.jsxs("div",{className:"flex items-center gap-2 px-3 py-2 bg-red-900/40 border border-red-600/50 rounded-lg",children:[e.jsx("div",{className:"w-2 h-2 bg-red-500 rounded-full animate-pulse"}),e.jsxs("span",{className:"text-sm text-slate-200 flex-1",children:["Registrazione... ",K(C)]}),e.jsx("button",{onClick:P,className:"px-3 py-1 bg-emerald-600 hover:bg-emerald-700 text-white text-xs rounded transition-colors",children:"Salva"}),e.jsx("button",{onClick:T,className:"p-1 hover:bg-white/10 rounded transition-colors",children:e.jsx(V,{size:16,className:"text-slate-400"})})]}):e.jsxs("div",{className:`relative ${i}`,children:[e.jsxs("button",{onClick:()=>h(!z),className:"flex items-center gap-2 px-3 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg transition-colors",title:"Allega media",children:[e.jsx(S,{size:18,className:"text-slate-400"}),l&&e.jsx("span",{className:"text-sm text-slate-300",children:"Media"})]}),e.jsx($,{children:z&&e.jsxs(O.div,{initial:{opacity:0,y:-10,scale:.95},animate:{opacity:1,y:0,scale:1},exit:{opacity:0,y:-10,scale:.95},transition:{duration:.15},className:"absolute bottom-full left-0 mb-2 bg-slate-800 border border-slate-700 rounded-lg shadow-xl p-2 space-y-1 min-w-[180px] z-50",children:[R("image")&&e.jsxs("button",{onClick:()=>{var s;return(s=v.current)==null?void 0:s.click()},className:"w-full flex items-center gap-3 px-3 py-2 hover:bg-slate-700 rounded-lg transition-colors text-left",children:[e.jsx(D,{size:18,className:"text-cyan-400"}),e.jsx("span",{className:"text-sm text-slate-200",children:"Foto"})]}),R("video")&&e.jsxs("button",{onClick:()=>{var s;return(s=y.current)==null?void 0:s.click()},className:"w-full flex items-center gap-3 px-3 py-2 hover:bg-slate-700 rounded-lg transition-colors text-left",children:[e.jsx(B,{size:18,className:"text-purple-400"}),e.jsx("span",{className:"text-sm text-slate-200",children:"Video"})]}),R("audio")&&e.jsxs(e.Fragment,{children:[e.jsxs("button",{onClick:A,className:"w-full flex items-center gap-3 px-3 py-2 hover:bg-slate-700 rounded-lg transition-colors text-left",children:[e.jsx(q,{size:18,className:"text-red-400"}),e.jsx("span",{className:"text-sm text-slate-200",children:"Vocale"})]}),e.jsxs("button",{onClick:()=>{var s;return(s=b.current)==null?void 0:s.click()},className:"w-full flex items-center gap-3 px-3 py-2 hover:bg-slate-700 rounded-lg transition-colors text-left",children:[e.jsx(J,{size:18,className:"text-amber-400"}),e.jsx("span",{className:"text-sm text-slate-200",children:"File Audio"})]})]})]})}),e.jsx("input",{ref:v,type:"file",accept:"image/*",onChange:M,className:"hidden"}),e.jsx("input",{ref:y,type:"file",accept:"video/*",onChange:I,className:"hidden"}),e.jsx("input",{ref:b,type:"file",accept:"audio/*",onChange:L,className:"hidden"})]})}export{Z as M,K as f};
