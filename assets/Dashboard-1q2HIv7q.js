import{r as o,j as e}from"./react-FJB7Hj_2.js";import{B as y,D as $,y as L,G as C,H as S,I as F,z as E,J as V,K as O}from"./@firebase-D5dUFubL.js";import{c as ae,a as Y,t as u,d as h}from"./index-C1w-7Ivh.js";import{a as ne}from"./firebase-CiybzbB3.js";import{L as ie}from"./react-chartjs-2-OZwe24ob.js";import{C as re,a as oe,P as le,b as ce,c as de,p as me,d as ue,e as xe,i as pe}from"./chart.js-aqGQq52y.js";import{a as ge}from"./react-router-DF4cN2Hx.js";import{m as w,A as he}from"./framer-motion-Bo7GrDk8.js";import{T as fe,e as be,U as ye,P as Q,D as ve,C as I,R as je,f as Ne,g as we,B as Ce,h as ke,F as ze,i as Se}from"./lucide-react-BYK_Rxhn.js";import"./papaparse-BHXrM2Hc.js";import"./idb-BXWtuYvb.js";import"./react-dom-BrtcLnxQ.js";import"./scheduler-DYLXRpC5.js";import"./react-router-dom-udQfSOCw.js";import"./@remix-run-CjG9tKj3.js";import"./tslib-BGVaTf34.js";import"./@kurkle-D8fDXNIl.js";import"./motion-dom-C8PdgYBP.js";import"./motion-utils-DBsP9okC.js";re.register(oe,le,ce,de,me,ue,xe,pe);const De=d=>{if(!d)return"";const n=Math.floor((new Date-u(d))/1e3);let l=n/31536e3;return l>1?Math.floor(l)+" anni fa":(l=n/2592e3,l>1?Math.floor(l)+" mesi fa":(l=n/86400,l>1?Math.floor(l)+" gg fa":(l=n/3600,l>1?Math.floor(l)+" ore fa":(l=n/60,l>1?Math.floor(l)+" min fa":"ora"))))},R=({title:d,value:n,icon:l,isCurrency:f=!1,isPercentage:v=!1})=>e.jsxs("div",{className:"bg-zinc-950/60 backdrop-blur-xl p-4 rounded-xl gradient-border h-full",children:[e.jsxs("div",{className:"flex items-center gap-3 text-slate-400",children:[l,e.jsx("p",{className:"text-sm",children:d})]}),e.jsx("p",{className:"text-3xl font-bold text-slate-50 mt-2",children:f?new Intl.NumberFormat("it-IT",{style:"currency",currency:"EUR"}).format(n):v?`${n}%`:n})]}),Ae=({item:d,navigate:n})=>{const l={expiring:e.jsx(Se,{className:"text-yellow-500",size:18}),new_check:e.jsx(I,{className:"text-green-500",size:18}),new_anamnesi:e.jsx(ze,{className:"text-blue-500",size:18})},f={expiring:"payments",new_check:"checks",new_anamnesi:"anamnesi"};return e.jsxs(w.button,{layout:!0,initial:{opacity:0,y:10},animate:{opacity:1,y:0},exit:{opacity:0,x:-10},transition:{duration:.3},onClick:()=>n(`/client/${d.clientId}?tab=${f[d.type]}`),className:"w-full flex items-start gap-4 p-3 rounded-lg bg-slate-500/5 hover:bg-slate-500/10 transition-colors text-left",children:[e.jsx("div",{className:"mt-1 flex-shrink-0",children:l[d.type]}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"text-sm font-semibold text-slate-200",children:d.clientName}),e.jsx("p",{className:"text-xs text-slate-400",children:d.description})]}),e.jsx("div",{className:"text-xs text-slate-500 flex-shrink-0",children:De(d.date)})]})},Fe=()=>{const[d,n]=o.useState(""),[l,f]=o.useState(!1);o.useEffect(()=>{const k=y(L(h,"app-data","quickNotes"),D=>D.exists()&&n(D.data().content||""));return()=>k()},[]);const v=async()=>{await V(L(h,"app-data","quickNotes"),{content:d,updatedAt:O()}),f(!0),setTimeout(()=>f(!1),2e3)};return e.jsxs("div",{className:"bg-zinc-950/60 backdrop-blur-xl p-4 rounded-xl gradient-border",children:[e.jsxs("h2",{className:"text-lg font-semibold mb-3 flex items-center gap-2 text-slate-200",children:[e.jsx(ke,{size:18})," Note Rapide"]}),e.jsx("textarea",{value:d,onChange:k=>n(k.target.value),className:"w-full h-32 p-3 bg-zinc-900/70 border border-white/10 rounded-lg outline-none focus:ring-2 focus:ring-rose-500 resize-none text-slate-200",placeholder:"Annota idee, promemoria o task rapidi..."}),e.jsx("button",{onClick:v,className:"mt-3 px-4 py-2 bg-rose-600 text-sm font-semibold rounded-lg hover:bg-rose-700 transition-colors flex items-center justify-center gap-2 w-full",children:l?e.jsxs(e.Fragment,{children:[e.jsx(I,{size:16})," Salvato!"]}):e.jsxs(e.Fragment,{children:[e.jsx(Q,{size:16})," Salva Note"]})})]})};function We(){const d=ge(),[n,l]=o.useState([]),[f,v]=o.useState([]),[k,D]=o.useState(0),[A,U]=o.useState(null),[M,G]=o.useState(null),[H,q]=o.useState(0),[Me,J]=o.useState(!0),[b,T]=o.useState("revenue"),[j,B]=o.useState("monthly"),[_,P]=o.useState([]);o.useMemo(()=>{const s={attivo:0,rinnovato:0,non_rinnovato:0,na:0};return n.forEach(i=>{const m=i.statoPercorso||ae(i.scadenza);s[m]++}),[{name:"Attivo",value:s.attivo,color:"#10B981"},{name:"In Scadenza",value:s.rinnovato,color:"#F59E0B"},{name:"Scaduto",value:s.non_rinnovato,color:"#EF4444"},{name:"N/D",value:s.na,color:"#6B7280"}].filter(i=>i.value>0)},[n]);const[K,W]=o.useState("");o.useEffect(()=>{const s=Y.onAuthStateChanged(i=>{i&&W(i.displayName||i.email||"Admin")});return()=>s()},[]);const X=async()=>{try{await ne(Y),d("/login")}catch(s){console.error("Logout error:",s)}},Z=o.useMemo(()=>{const s=new Date;return{active:n.filter(m=>{const p=u(m.scadenza);return p&&p>s}).length}},[n]);o.useEffect(()=>{const s=y($(h,"clients"),i=>{const m=i.docs.map(p=>({id:p.id,...p.data()}));l(m),J(!1)});return()=>s()},[]),o.useEffect(()=>{const s=L(h,"app-data","lastViewed");(async()=>{const m=await E(s),p=m.exists()?m.data().timestamp:null;U(p),await V(s,{timestamp:O()},{merge:!0})})()},[]),o.useEffect(()=>{if(!A)return;const s=C(F(h,"checks"),S("createdAt","desc")),i=y(s,async c=>{const a=[];for(const t of c.docs)if(u(t.data().createdAt)>u(A)){const r=t.ref.parent.parent.id,x=await E(t(h,"clients",r));a.push({type:"new_check",clientId:r,clientName:x.exists()&&x.data().name||"Cliente",description:"Ha inviato un nuovo check-in",date:t.data().createdAt})}v(t=>[...t,...a].sort((r,x)=>u(x.date)-u(r.date)))}),m=C(F(h,"anamnesi"),S("submittedAt","desc")),p=y(m,async c=>{const a=[];for(const t of c.docs)if(u(t.data().submittedAt)>u(A)){const r=t.ref.parent.parent.id,x=await E(t(h,"clients",r));a.push({type:"new_anamnesi",clientId:r,clientName:x.exists()&&x.data().name||"Cliente",description:"Ha compilato l'anamnesi iniziale",date:t.data().submittedAt})}v(t=>[...t,...a].sort((r,x)=>u(x.date)-u(r.date)))}),N=C($(h,"clients")),g=y(N,c=>{const a=c.docs.map(t=>({id:t.id,...t.data()})).filter(t=>{const r=u(t.scadenza);if(!r)return!1;const x=(r-new Date)/(1e3*60*60*24);return x<=15&&x>0}).map(t=>({type:"expiring",clientId:t.id,clientName:t.name,description:`Abbonamento in scadenza tra ${Math.ceil((u(t.scadenza)-new Date)/864e5)} giorni`,date:t.scadenza}));v(t=>[...t.filter(x=>x.type!=="expiring"),...a].sort((x,se)=>u(se.date)-u(x.date)))});return()=>{i(),p(),g()}},[A]),o.useEffect(()=>{const s=C(F(h,"payments"),S("paymentDate","desc")),i=y(s,m=>{const p=new Date,N=m.docs.filter(g=>{const c=u(g.data().paymentDate);return c&&c.getMonth()===p.getMonth()&&c.getFullYear()===p.getFullYear()}).reduce((g,c)=>g+(c.data().amount||0),0);D(N)});return()=>i()},[]),o.useEffect(()=>{if(n.length>0){const s=n.filter(i=>{const m=u(i.scadenza);return m&&m>new Date}).length;q(Math.round(s/n.length*100))}},[n]),o.useEffect(()=>{if(n.length>0){const s=n[Math.floor(Math.random()*n.length)];G({name:s.name,goal:s.goal})}},[n]),o.useEffect(()=>(()=>{const i=new Date;if(b==="revenue"){const m=C(F(h,"payments"),S("paymentDate","asc"));return y(m,N=>{let g=[];const c={};if(N.docs.forEach(a=>{const t=u(a.data().paymentDate);if(t){const r=j==="monthly"?`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}`:t.getFullYear().toString();c[r]=(c[r]||0)+(a.data().amount||0)}}),j==="monthly")for(let a=11;a>=0;a--){const t=new Date(i.getFullYear(),i.getMonth()-a,1),r=`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}`;g.push({name:r,value:c[r]||0})}else g=Object.entries(c).sort((a,t)=>a[0]-t[0]).map(([a,t])=>({name:a,value:t}));P(g)})}else{const m=C($(h,"clients"),S("createdAt","asc"));return y(m,N=>{let g=[];const c={};if(N.docs.forEach(a=>{const t=u(a.data().createdAt);if(t){const r=j==="monthly"?`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}`:t.getFullYear().toString();c[r]=(c[r]||0)+1}}),j==="monthly")for(let a=11;a>=0;a--){const t=new Date(i.getFullYear(),i.getMonth()-a,1),r=`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}`;g.push({name:r,value:c[r]||0})}else g=Object.entries(c).sort((a,t)=>a[0]-t[0]).map(([a,t])=>({name:a,value:t}));P(g)})}})(),[b,j]);const ee={responsive:!0,maintainAspectRatio:!1,scales:{x:{grid:{display:!1},ticks:{color:"#e2e8f0",font:{size:12}}},y:{grid:{color:"rgba(255, 255, 255, 0.1)"},ticks:{color:"#e2e8f0",font:{size:12},callback:function(s){return b==="revenue"?`€${s}`:s}}}},plugins:{legend:{position:"top",labels:{font:{size:12,family:"'Inter', sans-serif",weight:"500"},color:"#e2e8f0"}},tooltip:{callbacks:{label:function(s){return`${s.dataset.label}: ${b==="revenue"?`€${s.raw}`:s.raw}`}}}}},te={labels:_.map(s=>s.name),datasets:[{label:b==="revenue"?"Fatturato (€)":"Nuovi Clienti",data:_.map(s=>s.value),borderColor:b==="revenue"?"#22c55e":"#6366f1",backgroundColor:b==="revenue"?"rgba(34, 197, 94, 0.2)":"rgba(99, 102, 241, 0.2)",fill:!0,tension:.4,pointRadius:4,pointHoverRadius:6}]},z={hidden:{opacity:0,y:20},visible:{opacity:1,y:0,transition:{duration:.5}}};return e.jsxs(w.div,{initial:"hidden",animate:"visible",variants:{visible:{transition:{staggerChildren:.1}}},className:"w-full space-y-6",children:[e.jsxs(w.div,{variants:z,className:"bg-zinc-950/60 backdrop-blur-xl p-4 sm:p-6 rounded-xl gradient-border",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-4",children:[e.jsxs("h1",{className:"text-3xl font-bold text-slate-50 flex items-center gap-2",children:[e.jsx(fe,{size:28})," Dashboard"]}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("span",{className:"text-slate-300 font-semibold",children:K}),e.jsxs("button",{onClick:X,className:"flex items-center gap-2 px-3 py-1.5 bg-rose-600 hover:bg-rose-700 text-white text-sm rounded-lg transition-colors",children:[e.jsx(be,{size:16})," Logout"]})]})]}),e.jsx("p",{className:"text-slate-400 mb-4",children:"Panoramica delle metriche chiave e progressi in tempo reale."}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("button",{onClick:()=>d("/clients"),className:"px-4 py-2 bg-zinc-800/80 text-sm font-semibold rounded-lg hover:bg-zinc-700/80 transition-colors flex items-center gap-2",children:[e.jsx(ye,{size:16})," Gestisci"]}),e.jsxs("button",{onClick:()=>d("/new"),className:"px-4 py-2 bg-rose-600 text-sm font-semibold rounded-lg hover:bg-rose-700 transition-colors flex items-center gap-2",children:[e.jsx(Q,{size:16})," Nuovo"]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[e.jsxs("div",{className:"lg:col-span-2 space-y-6",children:[e.jsxs(w.div,{variants:z,className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-5",children:[e.jsx(R,{title:"Incasso Mensile",value:k,icon:e.jsx(ve,{className:"text-green-500"}),isCurrency:!0}),e.jsx(R,{title:"Clienti Attivi",value:Z.active,icon:e.jsx(I,{className:"text-blue-500"})}),e.jsx(R,{title:"Retention Rate",value:H,icon:e.jsx(je,{className:"text-amber-500"}),isPercentage:!0})]}),e.jsxs(w.div,{className:"bg-zinc-950/60 backdrop-blur-xl p-4 sm:p-6 rounded-xl gradient-border h-[450px] flex flex-col",variants:z,children:[e.jsxs("div",{className:"flex flex-col sm:flex-row justify-between items-start sm:items-center gap-2 mb-4",children:[e.jsxs("h2",{className:"text-lg font-semibold text-slate-200 flex items-center gap-2",children:[e.jsx(Ne,{size:20})," Andamento Business"]}),e.jsxs("div",{className:"flex gap-2 bg-zinc-900/70 p-1 rounded-lg border border-white/5",children:[e.jsx("button",{onClick:()=>T("revenue"),className:`px-3 py-1 text-sm rounded-md transition ${b==="revenue"?"bg-zinc-700 text-white":"text-slate-400"}`,children:"Fatturato"}),e.jsx("button",{onClick:()=>T("clients"),className:`px-3 py-1 text-sm rounded-md transition ${b==="clients"?"bg-zinc-700 text-white":"text-slate-400"}`,children:"Clienti"})]})]}),e.jsx("div",{className:"flex-1",children:e.jsx(ie,{data:te,options:ee})}),e.jsx("div",{className:"flex justify-center mt-4",children:e.jsxs("div",{className:"flex gap-2 bg-zinc-900/70 p-1 rounded-lg border border-white/5",children:[e.jsx("button",{onClick:()=>B("monthly"),className:`px-3 py-1 text-xs rounded-md transition ${j==="monthly"?"bg-zinc-700 text-white":"text-slate-400"}`,children:"Mese"}),e.jsx("button",{onClick:()=>B("yearly"),className:`px-3 py-1 text-xs rounded-md transition ${j==="yearly"?"bg-zinc-700 text-white":"text-slate-400"}`,children:"Anno"})]})})]}),e.jsxs(w.div,{className:"grid grid-cols-1 md:grid-cols-2 gap-6",variants:z,children:[M&&e.jsxs("div",{className:"bg-zinc-950/60 backdrop-blur-xl p-4 rounded-xl gradient-border",children:[e.jsxs("h2",{className:"text-lg font-semibold mb-3 flex items-center gap-2 text-slate-200",children:[e.jsx(we,{size:18})," Focus del Giorno"]}),e.jsx("p",{className:"text-sm font-bold text-rose-500",children:M.name}),e.jsxs("p",{className:"text-sm text-slate-400 mt-1",children:['Obiettivo: "',M.goal||"Non specificato",'"']})]}),e.jsx(Fe,{})]})]}),e.jsxs(w.div,{className:"bg-zinc-950/60 backdrop-blur-xl p-4 sm:p-6 rounded-xl gradient-border",variants:z,children:[e.jsxs("h2",{className:"text-lg font-semibold mb-4 flex items-center gap-2 text-slate-200",children:[e.jsx(Ce,{size:20})," Feed Attività"]}),e.jsx("div",{className:"space-y-3 max-h-[90vh] lg:max-h-[calc(100vh-14rem)] overflow-y-auto pr-2",children:e.jsx(he,{children:f.length>0?f.map(s=>{var i;return e.jsx(Ae,{item:s,navigate:d},`${s.type}-${s.clientId}-${(i=s.date)==null?void 0:i.seconds}`)}):e.jsx("p",{className:"text-sm text-slate-500 p-4 text-center",children:"Nessuna attività recente."})})})]})]})]})}export{We as default};
