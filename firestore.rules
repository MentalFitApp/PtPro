rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ==================== FUNZIONI DI SUPPORTO ====================
    
    // Platform CEO (gestisce TUTTA la piattaforma)
    function isPlatformCEO() {
      return request.auth != null &&
             exists(/databases/$(database)/documents/platform_admins/superadmins) &&
             request.auth.uid in get(/databases/$(database)/documents/platform_admins/superadmins).data.uids;
    }

    // SuperAdmin di un tenant specifico (proprietario business)
    function isTenantSuperAdmin(tenantId) {
      return request.auth != null &&
             exists(/databases/$(database)/documents/tenants/$(tenantId)/roles/superadmins) &&
             request.auth.uid in get(/databases/$(database)/documents/tenants/$(tenantId)/roles/superadmins).data.uids;
    }

    // Admin di un tenant (può essere superadmin o admin normale)
    function isTenantAdmin(tenantId) {
      return isTenantSuperAdmin(tenantId) ||
             (request.auth != null &&
              exists(/databases/$(database)/documents/tenants/$(tenantId)/roles/admins) &&
              request.auth.uid in get(/databases/$(database)/documents/tenants/$(tenantId)/roles/admins).data.uids);
    }

    // Coach di un tenant
    function isTenantCoach(tenantId) {
      return isTenantAdmin(tenantId) ||
             (request.auth != null &&
              exists(/databases/$(database)/documents/tenants/$(tenantId)/roles/coaches) &&
              request.auth.uid in get(/databases/$(database)/documents/tenants/$(tenantId)/roles/coaches).data.uids);
    }

    // Client di un tenant
    function isTenantClient(tenantId, userId) {
      return request.auth != null &&
             request.auth.uid == userId &&
             exists(/databases/$(database)/documents/tenants/$(tenantId)/clients/$(userId)) &&
             get(/databases/$(database)/documents/tenants/$(tenantId)/clients/$(userId)).data.isClient == true;
    }

    // Collaboratore di un tenant
    function isTenantCollaboratore(tenantId, userId) {
      return request.auth != null &&
             request.auth.uid == userId &&
             exists(/databases/$(database)/documents/tenants/$(tenantId)/collaboratori/$(userId));
    }

    // Validazione payment
    function isValidPayment() {
      return request.resource.data.keys().hasAll(['amount', 'duration', 'paymentDate']) &&
             request.resource.data.amount is number &&
             request.resource.data.amount > 0 &&
             request.resource.data.duration is string &&
             request.resource.data.paymentDate is timestamp;
    }

    // ==================== PLATFORM ADMINS ====================
    match /platform_admins/{docId} {
      allow read: if isPlatformCEO();
      allow write: if isPlatformCEO();
    }

    // ==================== TENANTS (METADATA) ====================
    match /tenants/{tenantId} {
      // Lettura pubblica per routing landing pages (solo campi pubblici: name, siteSlug, customDomain, status)
      allow read: if true;
      
      // Platform CEO può vedere, creare e gestire tutti i tenants
      allow list: if isPlatformCEO();
      allow create, update: if isPlatformCEO();
      allow delete: if isPlatformCEO();
      
      // SuperAdmin del tenant può aggiornare il proprio metadata
      allow update: if isTenantSuperAdmin(tenantId);
    }

    // ==================== TENANT DATA ====================
    match /tenants/{tenantId}/{document=**} {
      
      // Platform CEO ha accesso completo a TUTTI i tenant (per analytics)
      allow read: if isPlatformCEO();
      
      // Regole specifiche per collection
      
      // --- USERS (community members) ---
      match /users/{userId} {
        allow read, list: if request.auth != null;
        allow create, update: if request.auth.uid == userId;
        allow update: if isTenantSuperAdmin(tenantId);
        allow delete: if isTenantAdmin(tenantId);
      }

      // --- CLIENTS ---
      match /clients/{userId} {
        allow create: if isTenantSuperAdmin(tenantId) || isTenantCoach(tenantId) || isTenantAdmin(tenantId) || isTenantCollaboratore(tenantId, request.auth.uid);
        allow read: if isTenantSuperAdmin(tenantId) ||
                      request.auth.uid == userId ||
                      isTenantCoach(tenantId) ||
                      isTenantAdmin(tenantId) ||
                      isTenantCollaboratore(tenantId, request.auth.uid);
        allow list: if isTenantSuperAdmin(tenantId) || isTenantCoach(tenantId) || isTenantAdmin(tenantId) || isTenantCollaboratore(tenantId, request.auth.uid);
        allow update: if isTenantSuperAdmin(tenantId) || isTenantCoach(tenantId) || isTenantAdmin(tenantId) || isTenantClient(tenantId, userId) || isTenantCollaboratore(tenantId, request.auth.uid);
        allow delete: if isTenantSuperAdmin(tenantId) || isTenantAdmin(tenantId);

        // Subcollections
        match /anamnesi/{docId} {
          allow read, write: if request.auth != null && (
            request.auth.uid == userId ||
            isTenantCoach(tenantId) ||
            isTenantAdmin(tenantId)
          );
        }

        match /checks/{docId} {
          allow read, write: if request.auth != null && (
            request.auth.uid == userId ||
            isTenantCoach(tenantId) ||
            isTenantAdmin(tenantId)
          );
        }

        match /payments/{docId} {
          allow read, list: if request.auth != null && (
            request.auth.uid == userId ||
            isTenantCoach(tenantId) ||
            isTenantAdmin(tenantId) ||
            isTenantCollaboratore(tenantId, request.auth.uid)
          );
          allow create, update: if (isTenantCoach(tenantId) || isTenantAdmin(tenantId) || isTenantCollaboratore(tenantId, request.auth.uid)) && isValidPayment();
          allow delete: if isTenantCoach(tenantId) || isTenantAdmin(tenantId);
        }
      }

      // --- ROLES ---
      match /roles/{docId} {
        allow read: if request.auth != null;
        allow write: if isTenantSuperAdmin(tenantId) || isTenantAdmin(tenantId);
      }

      // --- COLLABORATORI ---
      match /collaboratori/{collabId} {
        // Tutti i collaboratori possono vedere tutti gli altri collaboratori (per grafici e statistiche di team)
        allow read, list: if isTenantAdmin(tenantId) || 
                            request.auth != null && 
                            exists(/databases/$(database)/documents/tenants/$(tenantId)/collaboratori/$(request.auth.uid));
        allow create: if isTenantAdmin(tenantId);
        allow update: if isTenantCollaboratore(tenantId, collabId) || isTenantAdmin(tenantId);
        allow delete: if isTenantAdmin(tenantId);
      }

      // --- COMMUNITY POSTS ---
      match /community_posts/{postId} {
        allow read: if request.auth != null;
        allow list: if request.auth != null;
        allow create: if request.auth != null && request.resource.data.author.uid == request.auth.uid;
        allow update: if request.auth != null && (
          resource.data.author.uid == request.auth.uid ||
          isTenantSuperAdmin(tenantId)
        );
        allow delete: if isTenantSuperAdmin(tenantId) || resource.data.author.uid == request.auth.uid;

        match /comments/{commentId} {
          allow read: if request.auth != null;
          allow list: if request.auth != null;
          allow create: if request.auth != null && request.resource.data.author.uid == request.auth.uid;
          allow update: if request.auth != null && resource.data.author.uid == request.auth.uid;
          allow delete: if isTenantSuperAdmin(tenantId) || resource.data.author.uid == request.auth.uid;
        }
      }

      // --- CHAT ---
      match /chats/{chatId} {
        allow read: if request.auth != null && (
          request.auth.uid in resource.data.participants ||
          isTenantSuperAdmin(tenantId) || isTenantAdmin(tenantId)
        );
        allow list: if request.auth != null && (
          isTenantSuperAdmin(tenantId) || isTenantAdmin(tenantId)
        );
        allow create: if request.auth != null &&
                        request.auth.uid in request.resource.data.participants &&
                        request.resource.data.participants.size() == 2;
        allow update: if request.auth != null && request.auth.uid in resource.data.participants;
        allow delete: if request.auth != null && request.auth.uid in resource.data.participants;

        match /messages/{messageId} {
          allow read: if request.auth != null && (
            request.auth.uid in get(/databases/$(database)/documents/tenants/$(tenantId)/chats/$(chatId)).data.participants ||
            isTenantSuperAdmin(tenantId) || isTenantAdmin(tenantId)
          );
          allow create: if request.auth != null &&
                          request.auth.uid in get(/databases/$(database)/documents/tenants/$(tenantId)/chats/$(chatId)).data.participants;
          allow update: if request.auth != null && resource.data.senderId == request.auth.uid;
          allow delete: if request.auth != null && resource.data.senderId == request.auth.uid;
        }
      }
      
      // --- NOTIFICATIONS ---
      match /notifications/{notifId} {
        allow read: if request.auth != null && (
          request.auth.uid == resource.data.userId ||
          isTenantAdmin(tenantId)
        );
        allow list: if request.auth != null;
        allow create: if isTenantAdmin(tenantId);
        allow update, delete: if request.auth != null && (
          request.auth.uid == resource.data.userId ||
          isTenantAdmin(tenantId)
        );
      }
      
      // --- CALENDAR EVENTS ---
      match /calendarEvents/{eventId} {
        allow read, list: if isTenantAdmin(tenantId) || isTenantCoach(tenantId) || isTenantCollaboratore(tenantId, request.auth.uid);
        allow create, update, delete: if isTenantAdmin(tenantId) || isTenantCoach(tenantId) || isTenantCollaboratore(tenantId, request.auth.uid);
      }
      
      // --- CALENDAR NOTES/TASKS ---
      match /calendarNotes/{noteId} {
        allow read, list: if isTenantAdmin(tenantId) || isTenantCoach(tenantId) || isTenantCollaboratore(tenantId, request.auth.uid);
        // Utenti possono creare, modificare ed eliminare solo le proprie note
        allow create: if request.auth != null && 
                        (isTenantAdmin(tenantId) || isTenantCoach(tenantId) || isTenantCollaboratore(tenantId, request.auth.uid)) &&
                        request.resource.data.createdBy == request.auth.uid;
        allow update: if request.auth != null && 
                        (isTenantAdmin(tenantId) || resource.data.createdBy == request.auth.uid);
        allow delete: if request.auth != null && 
                        (isTenantAdmin(tenantId) || resource.data.createdBy == request.auth.uid);
      }
      
      // --- LEADS ---
      match /leads/{leadId} {
        allow read, list: if isTenantAdmin(tenantId) || isTenantCollaboratore(tenantId, request.auth.uid);
        allow create, update: if isTenantAdmin(tenantId) || isTenantCollaboratore(tenantId, request.auth.uid);
        // Collaboratori possono eliminare solo i propri leads
        allow delete: if isTenantAdmin(tenantId) || 
                         (isTenantCollaboratore(tenantId, request.auth.uid) && 
                          resource.data.assignedTo == request.auth.uid);
      }
      
      // --- GUIDE LEADS ---
      match /guideLeads/{leadId} {
        allow read, list: if isTenantAdmin(tenantId);
        allow create, update, delete: if isTenantAdmin(tenantId);
      }
      
      // --- GUIDES ---
      match /guides/{guideId} {
        allow read: if request.auth != null;
        allow create, update, delete: if isTenantAdmin(tenantId);
      }
      
      // --- SETTINGS ---
      match /settings/{docId} {
        // DashboardLayout per-user (tutti gli utenti autenticati possono salvare il proprio layout)
        allow read, write: if request.auth != null && docId.matches('dashboardLayout_.*');
        
        // Widget Config per-widget (tutti gli utenti autenticati possono configurare widget)
        allow read, write: if request.auth != null && docId.matches('widgetConfig_.*');
        
        // Custom Widgets (admin possono creare, utenti autenticati possono leggere)
        allow read: if request.auth != null && docId == 'customWidgets';
        allow write: if (isTenantAdmin(tenantId) || isPlatformCEO()) && docId == 'customWidgets';
        
        // LeadStatuses configurabili da admin
        allow read: if request.auth != null && docId == 'leadStatuses';
        allow write: if (isTenantAdmin(tenantId) || isPlatformCEO()) && docId == 'leadStatuses';
        
        // LeadColumns configurabili da admin
        allow read: if request.auth != null && docId == 'leadColumns';
        allow write: if (isTenantAdmin(tenantId) || isPlatformCEO()) && docId == 'leadColumns';
        
        // Tutti gli altri settings - solo admin
        allow read: if request.auth != null;
        allow write: if isTenantAdmin(tenantId) || isPlatformCEO();
      }
      
      // --- PLATFORM SETTINGS (gestione piattaforma) ---
      match /platform_settings/{docId} {
        // Tutti possono leggere le impostazioni globali (per controllo permessi)
        allow read: if request.auth != null;
        // Solo admin/coach possono modificare
        allow write: if isTenantAdmin(tenantId) || isTenantCoach(tenantId);
      }
      
      // --- LANDING PAGE CONFIG ---
      match /settings/landing {
        allow read: if true; // Pubblico per visualizzazione siti
        allow write: if isTenantAdmin(tenantId) || isPlatformCEO();
      }
      
      // --- BRANDING CONFIG ---
      match /settings/branding {
        allow read: if request.auth != null;
        allow write: if isTenantAdmin(tenantId) || isPlatformCEO();
      }
      
      // --- SITE CUSTOMIZATION ---
      match /settings/site_customization {
        allow read: if request.auth != null;
        allow write: if isTenantAdmin(tenantId) || isPlatformCEO();
      }
      
      // --- INTEGRATIONS (ManyChat, etc.) ---
      match /integrations/{integrationId} {
        allow read: if isTenantAdmin(tenantId);
        allow write: if isTenantAdmin(tenantId);
      }
      
      // --- APP DATA ---
      match /app-data/{docId} {
        allow read: if request.auth != null;
        allow write: if isTenantAdmin(tenantId);
      }
      
      // --- SALES REPORTS ---
      match /salesReports/{reportId} {
        allow read, list: if isTenantAdmin(tenantId) || isTenantCollaboratore(tenantId, request.auth.uid);
        allow create, update, delete: if isTenantAdmin(tenantId);
      }
      
      // --- SETTING REPORTS ---
      match /settingReports/{reportId} {
        allow read, list: if isTenantAdmin(tenantId) || isTenantCollaboratore(tenantId, request.auth.uid);
        allow create, update, delete: if isTenantAdmin(tenantId);
      }
      
      // --- USER STATUS ---
      match /userStatus/{userId} {
        allow read: if request.auth != null;
        allow write: if request.auth.uid == userId || isTenantAdmin(tenantId);
      }
      
      // --- USER LEVELS & PROGRESS ---
      match /user_levels/{userId} {
        allow read: if request.auth != null;
        allow write: if request.auth.uid == userId || isTenantAdmin(tenantId);
      }
      
      match /user_progress/{userId} {
        allow read: if request.auth != null;
        allow write: if request.auth.uid == userId || isTenantAdmin(tenantId);
      }
      
      // --- DIPENDENTI ---
      match /dipendenti_provvigioni/{docId} {
        allow read, list: if isTenantAdmin(tenantId);
        allow create, update, delete: if isTenantAdmin(tenantId);
      }
      
      // --- LANDING ANALYTICS ---
      match /landing_analytics/{docId} {
        allow read: if isTenantAdmin(tenantId) || isPlatformCEO();
        allow create: if true; // Pubblico per tracking visite
        allow update, delete: if isTenantAdmin(tenantId) || isPlatformCEO();
      }
      
      // --- SITE VISITS & CONVERSIONS ---
      match /site_visits/{visitId} {
        allow read: if isTenantAdmin(tenantId) || isPlatformCEO();
        allow create: if true; // Tracking pubblico
        allow update, delete: if isPlatformCEO();
      }
      
      match /pagamenti_dipendenti/{docId} {
        allow read, list: if isTenantAdmin(tenantId);
        allow create, update, delete: if isTenantAdmin(tenantId);
      }
      
      // --- VIDEO CALLS ---
      match /video_calls/{callId} {
        allow read, list: if isTenantAdmin(tenantId) || isTenantCoach(tenantId);
        allow create, update, delete: if isTenantAdmin(tenantId) || isTenantCoach(tenantId);
      }
      
      // --- DAILY ROOMS ---
      match /daily_rooms/{roomId} {
        allow read, list: if isTenantAdmin(tenantId) || isTenantCoach(tenantId);
        allow create, update, delete: if isTenantAdmin(tenantId) || isTenantCoach(tenantId);
      }
      
      // --- COMMUNITY CONFIG ---
      match /community_config/{docId} {
        allow read: if request.auth != null;
        allow write: if isTenantAdmin(tenantId);
      }
      
      // --- SCHEDE ALIMENTAZIONE ---
      match /schede_alimentazione/{userId} {
        allow read: if request.auth != null && (
          request.auth.uid == userId ||
          isTenantAdmin(tenantId) ||
          isTenantCoach(tenantId)
        );
        allow create: if isTenantAdmin(tenantId) || isTenantCoach(tenantId);
        allow update: if request.auth.uid == userId || isTenantAdmin(tenantId) || isTenantCoach(tenantId);
        allow delete: if isTenantAdmin(tenantId);
        
        // Storico schede alimentazione (subcollection)
        match /history/{historyId} {
          allow read, list: if request.auth != null && (
            request.auth.uid == userId ||
            isTenantAdmin(tenantId) ||
            isTenantCoach(tenantId)
          );
          allow create: if isTenantAdmin(tenantId) || isTenantCoach(tenantId);
          allow delete: if isTenantAdmin(tenantId);
        }
      }
      
      // --- SCHEDE ALLENAMENTO ---
      match /schede_allenamento/{userId} {
        allow read: if request.auth != null && (
          request.auth.uid == userId ||
          isTenantAdmin(tenantId) ||
          isTenantCoach(tenantId)
        );
        allow create: if isTenantAdmin(tenantId) || isTenantCoach(tenantId);
        allow update: if request.auth.uid == userId || isTenantAdmin(tenantId) || isTenantCoach(tenantId);
        allow delete: if isTenantAdmin(tenantId);
      }
      
      // --- ESERCIZI CUSTOM (per tenant) ---
      match /exercises/{exerciseId} {
        allow read: if request.auth != null && (
          isTenantClient(tenantId, request.auth.uid) ||
          isTenantCoach(tenantId) ||
          isTenantAdmin(tenantId)
        );
        allow create, update, delete: if isTenantAdmin(tenantId) || isTenantCoach(tenantId);
      }

      // --- EXERCISE SETTINGS (configurazione database globale) ---
      match /exercise_settings/{docId} {
        allow read: if request.auth != null;
        allow write: if isTenantAdmin(tenantId);
      }
      
      // --- ESERCIZI VECCHIA COLLECTION (deprecated, mantieni per retrocompatibilità) ---
      match /esercizi/{exerciseId} {
        allow read: if request.auth != null;
        allow create, update, delete: if isTenantAdmin(tenantId) || isTenantCoach(tenantId);
      }
      
      // --- ALIMENTI ---
      match /alimenti/{category}/items/{itemId} {
        allow read: if request.auth != null;
        allow create, update, delete: if isTenantAdmin(tenantId) || isTenantCoach(tenantId);
      }
      
      // --- REGOLA CATCH-ALL per altre collections nel tenant ---
      // Admin e Coach possono accedere a tutto
      match /{anyCollection}/{anyDoc} {
        allow read, write: if isTenantAdmin(tenantId) || isTenantCoach(tenantId);
      }

    }

    // ==================== COLLECTION GLOBALI (fuori dai tenant) ====================
    
    // --- COURSES (global) ---
    match /courses/{courseId} {
      allow read: if request.auth != null;
      allow create, update, delete: if isPlatformCEO();
      
      match /modules/{moduleId} {
        allow read: if request.auth != null;
        allow create, update, delete: if isPlatformCEO();
        
        match /lessons/{lessonId} {
          allow read: if request.auth != null;
          allow create, update, delete: if isPlatformCEO();
        }
      }
    }
    
    // --- COURSE ENROLLMENTS (global) ---
    match /course_enrollments/{enrollmentId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      allow update, delete: if request.auth != null && request.auth.uid == resource.data.userId;
    }
    
    // --- COMMUNITY NOTIFICATIONS (global) ---
    match /community_notifications/{notificationId} {
      allow read: if request.auth != null && request.auth.uid == resource.data.userId;
      allow list: if request.auth != null;
      allow create: if request.auth != null;
      allow update: if request.auth != null && request.auth.uid == resource.data.userId;
      allow delete: if request.auth != null && request.auth.uid == resource.data.userId;
    }
    
    // --- FCM TOKENS (global) ---
    match /fcmTokens/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    
    // --- ANALYTICS (global) ---
    match /analytics/{eventId} {
      allow create: if request.auth != null;
      allow read, list: if isPlatformCEO();
    }
    
    // --- PLATFORM CONFIG (global, solo CEO) ---
    match /platform_config/{docId} {
      allow read, write: if isPlatformCEO();
    }
    
    // --- PLATFORM BACKUPS (global, solo CEO) ---
    match /platform_backups/{backupId} {
      allow read, write: if isPlatformCEO();
    }
    
    // --- CUSTOM DOMAINS (global, gestito da CEO) ---
    match /custom_domains/{domainId} {
      allow read: if isPlatformCEO();
      allow create, update, delete: if isPlatformCEO();
    }
    
    // --- SITE TEMPLATES (global, gestito da CEO) ---
    match /site_templates/{templateId} {
      allow read: if request.auth != null;
      allow create, update, delete: if isPlatformCEO();
    }
    
    // --- LANDING PAGE ANALYTICS AGGREGATED (global) ---
    match /landing_stats_aggregated/{statId} {
      allow read: if isPlatformCEO();
      allow write: if isPlatformCEO();
    }

    // --- PLATFORM EXERCISES (database globale esercizi) ---
    match /platform_exercises/{exerciseId} {
      allow read: if request.auth != null; // Tutti gli utenti autenticati possono leggere
      allow create, update, delete: if isPlatformCEO(); // Solo platform CEO può modificare
    }

    // --- PLATFORM FOODS (database globale alimenti) ---
    match /platform_foods/{foodId} {
      allow read: if request.auth != null; // Tutti gli utenti autenticati possono leggere
      allow create, update, delete: if isPlatformCEO(); // Solo platform CEO può modificare
    }

    // ==================== BLOCCA TUTTO IL RESTO ====================
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
