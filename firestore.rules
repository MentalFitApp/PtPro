rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ==================== FUNZIONI DI SUPPORTO ====================
    
    // Platform CEO (gestisce TUTTA la piattaforma)
    function isPlatformCEO() {
      return request.auth != null &&
             exists(/databases/$(database)/documents/platform_admins/superadmins) &&
             request.auth.uid in get(/databases/$(database)/documents/platform_admins/superadmins).data.uids;
    }

    // [RIMOSSO 03/01/2026] Editor temporanei - ora solo isPlatformCEO gestisce platform_exercises

    // SuperAdmin di un tenant specifico (proprietario business)
    function isTenantSuperAdmin(tenantId) {
      return request.auth != null &&
             exists(/databases/$(database)/documents/tenants/$(tenantId)/roles/superadmins) &&
             request.auth.uid in get(/databases/$(database)/documents/tenants/$(tenantId)/roles/superadmins).data.uids;
    }

    // Admin di un tenant (può essere superadmin o admin normale)
    function isTenantAdmin(tenantId) {
      return isTenantSuperAdmin(tenantId) ||
             (request.auth != null &&
              exists(/databases/$(database)/documents/tenants/$(tenantId)/roles/admins) &&
              request.auth.uid in get(/databases/$(database)/documents/tenants/$(tenantId)/roles/admins).data.uids);
    }

    // Coach di un tenant
    function isTenantCoach(tenantId) {
      return isTenantAdmin(tenantId) ||
             (request.auth != null &&
              exists(/databases/$(database)/documents/tenants/$(tenantId)/roles/coaches) &&
              request.auth.uid in get(/databases/$(database)/documents/tenants/$(tenantId)/roles/coaches).data.uids);
    }

    // Client di un tenant
    function isTenantClient(tenantId, userId) {
      return request.auth != null &&
             request.auth.uid == userId &&
             exists(/databases/$(database)/documents/tenants/$(tenantId)/clients/$(userId)) &&
             get(/databases/$(database)/documents/tenants/$(tenantId)/clients/$(userId)).data.isClient == true;
    }

    // Collaboratore di un tenant
    function isTenantCollaboratore(tenantId, userId) {
      return request.auth != null &&
             request.auth.uid == userId &&
             exists(/databases/$(database)/documents/tenants/$(tenantId)/collaboratori/$(userId));
    }

    // Validazione payment
    function isValidPayment() {
      return request.resource.data.keys().hasAll(['amount', 'duration', 'paymentDate']) &&
             request.resource.data.amount is number &&
             request.resource.data.amount > 0 &&
             request.resource.data.duration is string &&
             request.resource.data.paymentDate is timestamp;
    }

    // ==================== PLATFORM ADMINS ====================
    match /platform_admins/{docId} {
      // Lettura permessa a tutti gli autenticati per verificare ruolo CEO al login
      allow read: if request.auth != null;
      allow write: if isPlatformCEO();
    }

    // ==================== TENANTS (METADATA) ====================
    match /tenants/{tenantId} {
      // Lettura pubblica per routing landing pages (get singolo e list per query siteSlug)
      allow get: if true;
      allow list: if true;  // Necessario per query where('siteSlug', '==', slug)
      
      // Platform CEO può creare e gestire tutti i tenants
      allow create, update: if isPlatformCEO();
      allow delete: if isPlatformCEO();
      
      // SuperAdmin del tenant può aggiornare il proprio metadata
      allow update: if isTenantSuperAdmin(tenantId);
    }

    // ==================== TENANT DATA ====================
    match /tenants/{tenantId}/{document=**} {
      
      // Platform CEO ha accesso completo a TUTTI i tenant (per analytics)
      allow read: if isPlatformCEO();
      
      // Regole specifiche per collection
      
      // --- USERS (community members) ---
      match /users/{userId} {
        allow read, list: if request.auth != null;
        allow create, update: if request.auth.uid == userId;
        allow update: if isTenantSuperAdmin(tenantId);
        allow delete: if isTenantAdmin(tenantId);
      }

      // --- FCM TOKENS (push notifications per tenant) ---
      match /fcmTokens/{userId} {
        allow read: if request.auth != null && (
          request.auth.uid == userId ||
          isTenantAdmin(tenantId)
        );
        allow create, update: if request.auth != null && request.auth.uid == userId;
        allow delete: if request.auth != null && request.auth.uid == userId;
      }

      // --- CLIENTS ---
      match /clients/{userId} {
        allow create: if isTenantSuperAdmin(tenantId) || isTenantCoach(tenantId) || isTenantAdmin(tenantId) || isTenantCollaboratore(tenantId, request.auth.uid);
        allow read: if isTenantSuperAdmin(tenantId) ||
                      request.auth.uid == userId ||
                      isTenantCoach(tenantId) ||
                      isTenantAdmin(tenantId) ||
                      isTenantCollaboratore(tenantId, request.auth.uid);
        allow list: if isTenantSuperAdmin(tenantId) || isTenantCoach(tenantId) || isTenantAdmin(tenantId) || isTenantCollaboratore(tenantId, request.auth.uid);
        allow update: if isTenantSuperAdmin(tenantId) || isTenantCoach(tenantId) || isTenantAdmin(tenantId) || isTenantClient(tenantId, userId) || isTenantCollaboratore(tenantId, request.auth.uid);
        allow delete: if isTenantSuperAdmin(tenantId) || isTenantAdmin(tenantId);

        // Subcollections
        match /anamnesi/{docId} {
          allow read, write: if request.auth != null && (
            request.auth.uid == userId ||
            isTenantCoach(tenantId) ||
            isTenantAdmin(tenantId)
          );
        }

        match /checks/{docId} {
          allow read, write: if request.auth != null && (
            request.auth.uid == userId ||
            isTenantCoach(tenantId) ||
            isTenantAdmin(tenantId)
          );
        }

        match /payments/{docId} {
          allow read, list: if request.auth != null && (
            request.auth.uid == userId ||
            isTenantCoach(tenantId) ||
            isTenantAdmin(tenantId) ||
            isTenantCollaboratore(tenantId, request.auth.uid)
          );
          allow create, update: if (isTenantCoach(tenantId) || isTenantAdmin(tenantId) || isTenantCollaboratore(tenantId, request.auth.uid)) && isValidPayment();
          allow delete: if isTenantCoach(tenantId) || isTenantAdmin(tenantId);
        }

        // Subcollection calls per prenotare chiamate
        match /calls/{callId} {
          // Tutti possono leggere le proprie chiamate (cliente) o tutte (admin/coach)
          allow read: if request.auth != null && (
            request.auth.uid == userId ||
            isTenantCoach(tenantId) ||
            isTenantAdmin(tenantId)
          );
          // Admin può creare/modificare/eliminare chiamate programmate
          allow create, update, delete: if isTenantAdmin(tenantId);
          // Cliente può solo creare/modificare/eliminare richieste (document 'request')
          allow create, update, delete: if request.auth.uid == userId && callId == 'request';
        }
      }

      // --- ROLES ---
      match /roles/{docId} {
        allow read: if request.auth != null;
        allow write: if isTenantSuperAdmin(tenantId) || isTenantAdmin(tenantId);
      }

      // --- COLLABORATORI ---
      match /collaboratori/{collabId} {
        // Tutti i collaboratori possono vedere tutti gli altri collaboratori (per grafici e statistiche di team)
        // Ogni utente autenticato può leggere il proprio documento (per verifica ruolo al login)
        allow read: if isTenantAdmin(tenantId) || 
                      request.auth.uid == collabId ||
                      (request.auth != null && 
                       exists(/databases/$(database)/documents/tenants/$(tenantId)/collaboratori/$(request.auth.uid)));
        allow list: if isTenantAdmin(tenantId) || 
                      (request.auth != null && 
                       exists(/databases/$(database)/documents/tenants/$(tenantId)/collaboratori/$(request.auth.uid)));
        allow create: if isTenantAdmin(tenantId);
        allow update: if isTenantCollaboratore(tenantId, collabId) || isTenantAdmin(tenantId);
        allow delete: if isTenantAdmin(tenantId);
      }

      // --- COMMUNITY POSTS ---
      match /community_posts/{postId} {
        allow read: if request.auth != null;
        allow list: if request.auth != null;
        allow create: if request.auth != null && request.resource.data.author.uid == request.auth.uid;
        allow update: if request.auth != null && (
          resource.data.author.uid == request.auth.uid ||
          isTenantSuperAdmin(tenantId)
        );
        allow delete: if isTenantSuperAdmin(tenantId) || resource.data.author.uid == request.auth.uid;

        match /comments/{commentId} {
          allow read: if request.auth != null;
          allow list: if request.auth != null;
          allow create: if request.auth != null && request.resource.data.author.uid == request.auth.uid;
          allow update: if request.auth != null && resource.data.author.uid == request.auth.uid;
          allow delete: if isTenantSuperAdmin(tenantId) || resource.data.author.uid == request.auth.uid;
        }
      }

      // --- CHAT ---
      match /chats/{chatId} {
        // Read singolo doc (get): partecipanti o admin
        allow get: if request.auth != null && (
          request.auth.uid in resource.data.participants ||
          isTenantSuperAdmin(tenantId) || isTenantAdmin(tenantId)
        );
        // List query: serve array-contains sull'utente corrente per filtrare
        // Firebase permette list se la query filtra sui partecipanti
        allow list: if request.auth != null;
        allow create: if request.auth != null &&
                        request.auth.uid in request.resource.data.participants &&
                        request.resource.data.participants.size() == 2;
        allow update: if request.auth != null && request.auth.uid in resource.data.participants;
        allow delete: if request.auth != null && request.auth.uid in resource.data.participants;

        match /messages/{messageId} {
          allow read: if request.auth != null && (
            request.auth.uid in get(/databases/$(database)/documents/tenants/$(tenantId)/chats/$(chatId)).data.participants ||
            isTenantSuperAdmin(tenantId) || isTenantAdmin(tenantId)
          );
          allow create: if request.auth != null &&
                          request.auth.uid in get(/databases/$(database)/documents/tenants/$(tenantId)/chats/$(chatId)).data.participants;
          // Update permesso a: mittente (per edit) + partecipanti (per reactions, read receipts)
          allow update: if request.auth != null && (
            resource.data.senderId == request.auth.uid ||
            request.auth.uid in get(/databases/$(database)/documents/tenants/$(tenantId)/chats/$(chatId)).data.participants
          );
          allow delete: if request.auth != null && resource.data.senderId == request.auth.uid;
        }
      }
      
      // --- PRESENCE (online status) ---
      match /presence/{usrId} {
        // Ogni utente può leggere la presence di tutti (per vedere chi è online)
        allow read, list: if request.auth != null;
        // Ogni utente può scrivere solo la propria presenza
        allow create, update: if request.auth != null && request.auth.uid == usrId;
        allow delete: if request.auth != null && request.auth.uid == usrId;
      }
      
      // --- NOTIFICATIONS ---
      match /notifications/{notifId} {
        allow read: if request.auth != null && (
          request.auth.uid == resource.data.userId ||
          isTenantAdmin(tenantId) ||
          isTenantCoach(tenantId)
        );
        allow list: if request.auth != null;
        allow create: if isTenantAdmin(tenantId) || isTenantCoach(tenantId);
        allow update, delete: if request.auth != null && (
          request.auth.uid == resource.data.userId ||
          isTenantAdmin(tenantId) ||
          isTenantCoach(tenantId)
        );
      }
      
      // --- CALENDAR EVENTS ---
      match /calendarEvents/{eventId} {
        allow read, list: if isTenantAdmin(tenantId) || isTenantCoach(tenantId) || isTenantCollaboratore(tenantId, request.auth.uid);
        allow create, update, delete: if isTenantAdmin(tenantId) || isTenantCoach(tenantId) || isTenantCollaboratore(tenantId, request.auth.uid);
      }
      
      // --- CALENDAR NOTES/TASKS ---
      match /calendarNotes/{noteId} {
        allow read, list: if isTenantAdmin(tenantId) || isTenantCoach(tenantId) || isTenantCollaboratore(tenantId, request.auth.uid);
        // Utenti possono creare, modificare ed eliminare solo le proprie note
        allow create: if request.auth != null && 
                        (isTenantAdmin(tenantId) || isTenantCoach(tenantId) || isTenantCollaboratore(tenantId, request.auth.uid)) &&
                        request.resource.data.createdBy == request.auth.uid;
        allow update: if request.auth != null && 
                        (isTenantAdmin(tenantId) || resource.data.createdBy == request.auth.uid);
        allow delete: if request.auth != null && 
                        (isTenantAdmin(tenantId) || resource.data.createdBy == request.auth.uid);
      }
      
      // --- LEADS ---
      match /leads/{leadId} {
        allow read, list: if isTenantAdmin(tenantId) || isTenantCollaboratore(tenantId, request.auth.uid);
        allow create, update: if isTenantAdmin(tenantId) || isTenantCollaboratore(tenantId, request.auth.uid);
        // Collaboratori possono eliminare solo i propri leads
        allow delete: if isTenantAdmin(tenantId) || 
                         (isTenantCollaboratore(tenantId, request.auth.uid) && 
                          resource.data.assignedTo == request.auth.uid);
      }
      
      // --- GUIDE LEADS ---
      match /guideLeads/{leadId} {
        allow read, list: if isTenantAdmin(tenantId);
        allow create, update, delete: if isTenantAdmin(tenantId);
      }
      
      // --- GUIDES ---
      match /guides/{guideId} {
        allow read: if request.auth != null;
        allow create, update, delete: if isTenantAdmin(tenantId);
      }
      
      // --- SETTINGS ---
      match /settings/{docId} {
        // DashboardLayout per-user (tutti gli utenti autenticati possono salvare il proprio layout)
        allow read, write: if request.auth != null && docId.matches('dashboardLayout_.*');
        
        // Widget Config per-widget (tutti gli utenti autenticati possono configurare widget)
        allow read, write: if request.auth != null && docId.matches('widgetConfig_.*');
        
        // Custom Widgets (admin possono creare, utenti autenticati possono leggere)
        allow read: if request.auth != null && docId == 'customWidgets';
        allow write: if (isTenantAdmin(tenantId) || isPlatformCEO()) && docId == 'customWidgets';
        
        // LeadStatuses configurabili da admin
        allow read: if request.auth != null && docId == 'leadStatuses';
        allow write: if (isTenantAdmin(tenantId) || isPlatformCEO()) && docId == 'leadStatuses';
        
        // LeadColumns configurabili da admin
        allow read: if request.auth != null && docId == 'leadColumns';
        allow write: if (isTenantAdmin(tenantId) || isPlatformCEO()) && docId == 'leadColumns';
        
        // Tutti gli altri settings - solo admin
        allow read: if request.auth != null;
        allow write: if isTenantAdmin(tenantId) || isPlatformCEO();
      }
      
      // --- PLATFORM SETTINGS (gestione piattaforma) ---
      match /platform_settings/{docId} {
        // Tutti possono leggere le impostazioni globali (per controllo permessi)
        allow read: if request.auth != null;
        // Solo admin/coach possono modificare
        allow write: if isTenantAdmin(tenantId) || isTenantCoach(tenantId);
      }
      
      // --- LANDING PAGES ---
      match /landing_pages/{pageId} {
        // GET singolo documento: pubblico se pubblicato
        allow get: if resource.data.status == 'published' || 
                      isTenantAdmin(tenantId) || 
                      isPlatformCEO();
        
        // LIST (query): pubblico per permettere ricerca per slug
        // La sicurezza è garantita dal fatto che solo pagine pubblicate sono utili
        allow list: if true;
        
        // Scrittura: solo admin
        allow create, update, delete: if isTenantAdmin(tenantId) || isPlatformCEO();
      }
      
      // --- LEADS (form submissions) ---
      // NOTA: C'è già una regola leads sopra (riga ~278) per collaboratori.
      // Questa regola aggiunge il create pubblico per form.
      match /leads/{leadId} {
        // Validazione anti-spam: richiede campi minimi e limita dimensioni
        // Supporta sia campi inglesi (email, phone, name) che italiani (nome, cognome, telefono)
        allow create: if request.resource.data.keys().hasAny(['email', 'phone', 'name', 'nome', 'cognome', 'telefono']) &&
                        request.resource.data.size() < 30 &&
                        (!request.resource.data.keys().hasAny(['email']) || 
                         (request.resource.data.email is string && request.resource.data.email.size() < 100)) &&
                        (!request.resource.data.keys().hasAny(['name']) || 
                         (request.resource.data.name is string && request.resource.data.name.size() < 200)) &&
                        (!request.resource.data.keys().hasAny(['nome']) || 
                         (request.resource.data.nome is string && request.resource.data.nome.size() < 200)) &&
                        (!request.resource.data.keys().hasAny(['cognome']) || 
                         (request.resource.data.cognome is string && request.resource.data.cognome.size() < 200));
        
        // Solo admin possono leggere e gestire i leads
        allow read, list: if isTenantAdmin(tenantId) || isPlatformCEO();
        allow update, delete: if isTenantAdmin(tenantId) || isPlatformCEO();
      }
      
      // --- LANDING PAGE CONFIG ---
      match /settings/landing {
        allow read: if true; // Pubblico per visualizzazione siti
        allow write: if isTenantAdmin(tenantId) || isPlatformCEO();
      }
      
      // --- BRANDING CONFIG ---
      match /settings/branding {
        allow read: if request.auth != null;
        allow write: if isTenantAdmin(tenantId) || isPlatformCEO();
      }
      
      // --- SITE CUSTOMIZATION ---
      match /settings/site_customization {
        allow read: if request.auth != null;
        allow write: if isTenantAdmin(tenantId) || isPlatformCEO();
      }
      
      // --- INTEGRATIONS (ManyChat, etc.) ---
      match /integrations/{integrationId} {
        allow read: if isTenantAdmin(tenantId);
        allow write: if isTenantAdmin(tenantId);
      }
      
      // --- APP DATA ---
      match /app-data/{docId} {
        allow read: if request.auth != null;
        allow write: if isTenantAdmin(tenantId);
      }
      
      // --- SALES REPORTS ---
      match /salesReports/{reportId} {
        allow read, list: if isTenantAdmin(tenantId) || isTenantCollaboratore(tenantId, request.auth.uid);
        allow create, update, delete: if isTenantAdmin(tenantId);
      }
      
      // --- SETTING REPORTS ---
      match /settingReports/{reportId} {
        allow read, list: if isTenantAdmin(tenantId) || isTenantCollaboratore(tenantId, request.auth.uid);
        allow create, update, delete: if isTenantAdmin(tenantId);
      }
      
      // --- USER STATUS ---
      match /userStatus/{userId} {
        allow read: if request.auth != null;
        allow write: if request.auth.uid == userId || isTenantAdmin(tenantId);
      }
      
      // --- USER LEVELS & PROGRESS ---
      match /user_levels/{userId} {
        allow read: if request.auth != null;
        allow write: if request.auth.uid == userId || isTenantAdmin(tenantId);
      }
      
      match /user_progress/{userId} {
        allow read: if request.auth != null;
        allow write: if request.auth.uid == userId || isTenantAdmin(tenantId);
      }
      
      // --- DIPENDENTI ---
      match /dipendenti_provvigioni/{docId} {
        allow read, list: if isTenantAdmin(tenantId);
        allow create, update, delete: if isTenantAdmin(tenantId);
      }
      
      // --- LANDING ANALYTICS ---
      match /landing_analytics/{docId} {
        allow read: if isTenantAdmin(tenantId) || isPlatformCEO();
        // Validazione anti-abuse: limita campi e dimensioni per tracking
        allow create: if request.resource.data.keys().hasAll(['timestamp']) &&
                        request.resource.data.size() < 15 &&
                        request.resource.data.timestamp is timestamp;
        allow update, delete: if isTenantAdmin(tenantId) || isPlatformCEO();
      }
      
      // --- SITE VISITS & CONVERSIONS ---
      match /site_visits/{visitId} {
        allow read: if isTenantAdmin(tenantId) || isPlatformCEO();
        // Validazione anti-abuse: limita campi per tracking visite
        allow create: if request.resource.data.keys().hasAll(['timestamp', 'page']) &&
                        request.resource.data.size() < 20 &&
                        request.resource.data.timestamp is timestamp &&
                        request.resource.data.page is string &&
                        request.resource.data.page.size() < 500;
        allow update, delete: if isPlatformCEO();
      }
      
      match /pagamenti_dipendenti/{docId} {
        allow read, list: if isTenantAdmin(tenantId);
        allow create, update, delete: if isTenantAdmin(tenantId);
      }
      
      // --- VIDEO CALLS ---
      match /video_calls/{callId} {
        allow read, list: if isTenantAdmin(tenantId) || isTenantCoach(tenantId);
        allow create, update, delete: if isTenantAdmin(tenantId) || isTenantCoach(tenantId);
      }
      
      // --- DAILY ROOMS ---
      match /daily_rooms/{roomId} {
        allow read, list: if isTenantAdmin(tenantId) || isTenantCoach(tenantId);
        allow create, update, delete: if isTenantAdmin(tenantId) || isTenantCoach(tenantId);
      }
      
      // --- COMMUNITY CONFIG ---
      match /community_config/{docId} {
        allow read: if request.auth != null;
        allow write: if isTenantAdmin(tenantId);
      }
      
      // --- SCHEDE ALIMENTAZIONE ---
      match /schede_alimentazione/{userId} {
        allow read: if request.auth != null && (
          request.auth.uid == userId ||
          isTenantAdmin(tenantId) ||
          isTenantCoach(tenantId)
        );
        allow create: if isTenantAdmin(tenantId) || isTenantCoach(tenantId);
        allow update: if request.auth.uid == userId || isTenantAdmin(tenantId) || isTenantCoach(tenantId);
        allow delete: if isTenantAdmin(tenantId);
        
        // Storico schede alimentazione (subcollection)
        match /history/{historyId} {
          allow read, list: if request.auth != null && (
            request.auth.uid == userId ||
            isTenantAdmin(tenantId) ||
            isTenantCoach(tenantId)
          );
          allow create: if isTenantAdmin(tenantId) || isTenantCoach(tenantId);
          allow delete: if isTenantAdmin(tenantId);
        }
      }
      
      // --- SCHEDE ALLENAMENTO ---
      match /schede_allenamento/{userId} {
        allow read: if request.auth != null && (
          request.auth.uid == userId ||
          isTenantAdmin(tenantId) ||
          isTenantCoach(tenantId)
        );
        allow create: if isTenantAdmin(tenantId) || isTenantCoach(tenantId);
        allow update: if request.auth.uid == userId || isTenantAdmin(tenantId) || isTenantCoach(tenantId);
        allow delete: if isTenantAdmin(tenantId);
      }
      
      // --- PRESET ALIMENTAZIONE ---
      match /preset_alimentazione/{presetId} {
        allow read, list: if request.auth != null && (
          isTenantAdmin(tenantId) ||
          isTenantCoach(tenantId)
        );
        allow create, update, delete: if isTenantAdmin(tenantId) || isTenantCoach(tenantId);
      }
      
      // --- PRESET ALLENAMENTO ---
      match /preset_allenamento/{presetId} {
        allow read, list: if request.auth != null && (
          isTenantAdmin(tenantId) ||
          isTenantCoach(tenantId)
        );
        allow create, update, delete: if isTenantAdmin(tenantId) || isTenantCoach(tenantId);
      }
      
      // --- ESERCIZI CUSTOM (per tenant) ---
      match /exercises/{exerciseId} {
        allow read: if request.auth != null && (
          isTenantClient(tenantId, request.auth.uid) ||
          isTenantCoach(tenantId) ||
          isTenantAdmin(tenantId)
        );
        allow create, update, delete: if isTenantAdmin(tenantId) || isTenantCoach(tenantId);
      }

      // --- EXERCISE SETTINGS (configurazione database globale) ---
      match /exercise_settings/{docId} {
        allow read: if request.auth != null;
        allow write: if isTenantAdmin(tenantId);
      }
      
      // --- ESERCIZI VECCHIA COLLECTION (deprecated, mantieni per retrocompatibilità) ---
      match /esercizi/{exerciseId} {
        allow read: if request.auth != null;
        allow create, update, delete: if isTenantAdmin(tenantId) || isTenantCoach(tenantId);
      }
      
      // --- ALIMENTI ---
      match /alimenti/{category}/items/{itemId} {
        allow read: if request.auth != null;
        allow create, update, delete: if isTenantAdmin(tenantId) || isTenantCoach(tenantId);
      }
      
      // --- BLOCCO ESPLICITO per collections non definite ---
      // [FIX SICUREZZA 03/01/2026] Rimossa catch-all rule pericolosa.
      // Ogni nuova collection DEVE essere definita esplicitamente sopra.
      // Se vedi errori di permessi, aggiungi la collection qui sopra.

    }

    // ==================== COLLECTION GLOBALI (fuori dai tenant) ====================
    
    // --- USERS (profili utente globali) ---
    match /users/{userId} {
      // Ogni utente può leggere e aggiornare solo il proprio documento
      allow read: if request.auth != null && request.auth.uid == userId;
      allow create: if request.auth != null && request.auth.uid == userId;
      allow update: if request.auth != null && request.auth.uid == userId;
      // Solo Platform CEO può eliminare utenti
      allow delete: if isPlatformCEO();
      
      // --- PREFERENCES (sotto-collezione per preferenze utente) ---
      match /preferences/{prefId} {
        // Ogni utente può leggere e scrivere le proprie preferenze
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
    }
    
    // --- COURSES (global) ---
    // I corsi possono essere gestiti da Platform CEO o da qualsiasi tenant admin
    match /courses/{courseId} {
      // Lettura: utenti autenticati vedono corsi pubblici, admin vedono tutti
      allow read: if request.auth != null;
      
      // Scrittura: Platform CEO o admin di qualsiasi tenant
      allow create: if isPlatformCEO() || 
                       (request.auth != null && 
                        exists(/databases/$(database)/documents/tenants/$(request.resource.data.tenantId)/roles/admins) &&
                        request.auth.uid in get(/databases/$(database)/documents/tenants/$(request.resource.data.tenantId)/roles/admins).data.uids);
      
      allow update, delete: if isPlatformCEO() || 
                              (request.auth != null && 
                               resource.data.tenantId != null &&
                               exists(/databases/$(database)/documents/tenants/$(resource.data.tenantId)/roles/admins) &&
                               request.auth.uid in get(/databases/$(database)/documents/tenants/$(resource.data.tenantId)/roles/admins).data.uids);
      
      match /modules/{moduleId} {
        allow read: if request.auth != null;
        allow create, update, delete: if isPlatformCEO() || 
                                        (request.auth != null && 
                                         get(/databases/$(database)/documents/courses/$(courseId)).data.tenantId != null &&
                                         exists(/databases/$(database)/documents/tenants/$(get(/databases/$(database)/documents/courses/$(courseId)).data.tenantId)/roles/admins) &&
                                         request.auth.uid in get(/databases/$(database)/documents/tenants/$(get(/databases/$(database)/documents/courses/$(courseId)).data.tenantId)/roles/admins).data.uids);
        
        match /lessons/{lessonId} {
          allow read: if request.auth != null;
          allow create, update, delete: if isPlatformCEO() || 
                                          (request.auth != null && 
                                           get(/databases/$(database)/documents/courses/$(courseId)).data.tenantId != null &&
                                           exists(/databases/$(database)/documents/tenants/$(get(/databases/$(database)/documents/courses/$(courseId)).data.tenantId)/roles/admins) &&
                                           request.auth.uid in get(/databases/$(database)/documents/tenants/$(get(/databases/$(database)/documents/courses/$(courseId)).data.tenantId)/roles/admins).data.uids);
        }
      }
    }
    
    // --- COURSE ENROLLMENTS (global) ---
    match /course_enrollments/{enrollmentId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      allow update, delete: if request.auth != null && request.auth.uid == resource.data.userId;
    }
    
    // --- COMMUNITY NOTIFICATIONS (global) ---
    match /community_notifications/{notificationId} {
      allow read: if request.auth != null && request.auth.uid == resource.data.userId;
      allow list: if request.auth != null;
      allow create: if request.auth != null;
      allow update: if request.auth != null && request.auth.uid == resource.data.userId;
      allow delete: if request.auth != null && request.auth.uid == resource.data.userId;
    }
    
    // --- FCM TOKENS (global) ---
    match /fcmTokens/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    
    // --- ANALYTICS (global) ---
    match /analytics/{eventId} {
      allow create: if request.auth != null;
      allow read, list: if isPlatformCEO();
    }
    
    // --- PLATFORM CONFIG (global, solo CEO) ---
    match /platform_config/{docId} {
      allow read, write: if isPlatformCEO();
    }
    
    // --- PLATFORM BACKUPS (global, solo CEO) ---
    match /platform_backups/{backupId} {
      allow read, write: if isPlatformCEO();
    }
    
    // --- CUSTOM DOMAINS (global, gestito da CEO) ---
    match /custom_domains/{domainId} {
      allow read: if isPlatformCEO();
      allow create, update, delete: if isPlatformCEO();
    }
    
    // --- SITE TEMPLATES (global, gestito da CEO) ---
    match /site_templates/{templateId} {
      allow read: if request.auth != null;
      allow create, update, delete: if isPlatformCEO();
    }
    
    // --- LANDING PAGE ANALYTICS AGGREGATED (global) ---
    match /landing_stats_aggregated/{statId} {
      allow read: if isPlatformCEO();
      allow write: if isPlatformCEO();
    }

    // --- PLATFORM MAIN LANDING PAGE (pubblico per lettura) ---
    match /platform/{docId} {
      // mainLanding è leggibile pubblicamente per la landing page principale
      allow read: if docId == 'mainLanding';
      // Solo CEO può scrivere
      allow write: if isPlatformCEO();
    }

    // --- PLATFORM EXERCISES (database globale esercizi) ---
    match /platform_exercises/{exerciseId} {
      allow read: if request.auth != null; // Tutti gli utenti autenticati possono leggere
      allow create, update, delete: if isPlatformCEO(); // Solo platform CEO può gestire
    }

    // --- PLATFORM FOODS (database globale alimenti) ---
    match /platform_foods/{foodId} {
      allow read: if request.auth != null; // Tutti gli utenti autenticati possono leggere
      allow create, update, delete: if isPlatformCEO(); // Solo platform CEO può modificare
    }

    // ==================== USER-TENANT MAPPING (globale) ====================
    // Mappa userId → tenantId per login veloce e sicuro
    match /user_tenants/{userId} {
      // L'utente può leggere SOLO il proprio documento
      allow read: if request.auth != null && request.auth.uid == userId;
      // Solo Cloud Functions (admin SDK) possono scrivere
      allow write: if false;
    }

    // ==================== BLOCCA TUTTO IL RESTO ====================
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
