// src/pages/tenant/InstagramHub.jsx
import React, { useState, useEffect } from 'react';
import { motion } from 'framer-motion';
import {
  Instagram, TrendingUp, Users, Send, Heart, Settings,
  BarChart3, Clock, CheckCircle, AlertCircle, Plus, Search,
  Filter, Download, Tag, Mail, Phone, Calendar, ExternalLink, MessageCircle, Image
} from 'lucide-react';
import { doc, getDoc, setDoc, updateDoc, collection, query, where, getDocs } from 'firebase/firestore';
import { db, auth } from '../../firebase';
import OAuthButton from '../../components/integrations/OAuthButton';

export default function InstagramHub() {
  const currentUser = auth.currentUser;
  const userTenantId = localStorage.getItem('tenantId');
  const [loading, setLoading] = useState(true);
  const [activeTab, setActiveTab] = useState('overview');
  const [manychatConfig, setManychatConfig] = useState(null);
  const [stats, setStats] = useState(null);
  const [conversations, setConversations] = useState([]);
  const [subscribers, setSubscribers] = useState([]);
  const [flows, setFlows] = useState([]);
  const [campaigns, setCampaigns] = useState([]);

  useEffect(() => {
    loadManyChatData();
  }, []);

  const loadManyChatData = async () => {
    if (!userTenantId) return;
    
    setLoading(true);
    try {
      // Carica configurazione ManyChat
      const configRef = doc(db, `tenants/${userTenantId}/integrations/manychat`);
      const configSnap = await getDoc(configRef);
      
      if (configSnap.exists()) {
        const config = configSnap.data();
        setManychatConfig(config);
        
        // Se configurato, carica dati dall'API ManyChat
        if (config.apiKey) {
          await fetchManyChatData(config.apiKey, config.pageId);
        }
      }
    } catch (error) {
      console.error('Errore caricamento ManyChat:', error);
    } finally {
      setLoading(false);
    }
  };

  const fetchManyChatData = async (apiKey, pageId) => {
    try {
      console.log('üîÑ Caricamento dati ManyChat per tenant:', userTenantId);
      
      const { httpsCallable } = await import('firebase/functions');
      const { functions } = await import('../../firebase');
      const { collection, getDocs, query, orderBy, limit } = await import('firebase/firestore');
      const { db } = await import('../../firebase');
      const { getTenantCollection } = await import('../../config/tenant');
      const manychatProxy = httpsCallable(functions, 'manychatProxy');

      // 1. Leggi subscribers salvati dai webhook
      console.log('üìñ Caricamento subscribers da Firestore...');
      const subscribersRef = getTenantCollection(db, 'manychat_subscribers');
      const subscribersSnap = await getDocs(
        query(subscribersRef, orderBy('subscribed_at', 'desc'), limit(100))
      );
      
      const savedSubscribers = subscribersSnap.docs.map(doc => ({
        id: doc.id,
        ...doc.data()
      }));
      console.log('‚úÖ Subscribers trovati in Firestore:', savedSubscribers.length);

      // 2. Leggi statistiche salvate
      const statsRef = getTenantCollection(db, 'stats');
      const statsSnap = await getDocs(statsRef);
      let manychatStats = null;
      statsSnap.forEach(doc => {
        if (doc.id === 'manychat') {
          manychatStats = doc.data();
        }
      });

      // 3. Usa stats salvate se disponibili, altrimenti chiama API
      let pageInfo = null;
      let growthTools = null;

      if (manychatStats && manychatStats.page_name) {
        console.log('‚úÖ Dati ManyChat trovati in Firestore');
        pageInfo = {
          name: manychatStats.page_name,
          is_pro: manychatStats.is_pro,
          timezone: manychatStats.timezone
        };
      } else {
        console.log('üìû Chiamata API: page/getInfo');
        const pageInfoResult = await manychatProxy({
          tenantId: userTenantId,
          endpoint: '/page/getInfo',
          method: 'GET'
        });
        pageInfo = pageInfoResult.data?.data;
        console.log('‚úÖ Page Info ricevuto:', pageInfo?.name);
      }

      // 4. Ottieni Growth Tools (automation triggers)
      console.log('üìû Chiamata API: page/getGrowthTools');
      const growthToolsResult = await manychatProxy({
        tenantId: userTenantId,
        endpoint: '/page/getGrowthTools',
        method: 'GET'
      });
      growthTools = growthToolsResult.data;
      console.log('‚úÖ Growth Tools ricevuti:', growthTools?.data?.length || 0);

      // Processa dati reali da Firestore + API
      console.log('üìä Elaborazione dati ManyChat...');

      // Usa dati dai webhook se disponibili
      const totalSubs = manychatStats?.total_subscribers || savedSubscribers.length;
      const todayStart = new Date();
      todayStart.setHours(0, 0, 0, 0);
      
      const newToday = savedSubscribers.filter(sub => {
        const subDate = sub.subscribed_at?.toDate?.() || new Date(sub.subscribed_at);
        return subDate >= todayStart;
      }).length;

      setStats({
        totalSubscribers: totalSubs,
        newToday: newToday,
        openRate: 0,
        activeConversations: savedSubscribers.filter(s => s.status === 'active').length,
        leadsToday: newToday,
        growthRate: totalSubs > 0 ? ((newToday / totalSubs) * 100).toFixed(1) : 0
      });
      console.log('‚úÖ Stats:', { totalSubscribers: totalSubs, newToday });

      // Processa subscribers da Firestore
      const processedSubscribers = savedSubscribers.map(sub => ({
        id: sub.subscriber_id || sub.id,
        name: sub.name || `${sub.first_name || ''} ${sub.last_name || ''}`.trim() || 'Senza nome',
        email: sub.email || '',
        phone: sub.phone || '',
        subscribedAt: sub.subscribed_at?.toDate?.() || new Date(sub.subscribed_at),
        tags: sub.tags || [],
        lastInteraction: sub.last_interaction?.toDate?.() || new Date(sub.last_interaction),
        status: sub.status || 'active'
      }));
      setSubscribers(processedSubscribers);
      console.log('‚úÖ Subscribers processati:', processedSubscribers.length);

      // Conversazioni recenti (ultimi 10)
      const recentConvos = processedSubscribers.slice(0, 10).map(sub => ({
        id: sub.id,
        subscriber: { name: sub.name, avatar: null },
        lastMessage: 'Ultima interazione',
        timestamp: sub.lastInteraction,
        unread: false,
        tags: sub.tags
      }));
      setConversations(recentConvos);

      // Growth Tools = Automation Triggers
      const tools = growthTools?.data || [];
      const processedTools = tools.map(tool => ({
        id: tool.id,
        name: tool.name,
        status: 'active',
        type: tool.type,
        triggered: 0,
        completed: 0,
        lastTrigger: null
      }));
      setFlows(processedTools);
      console.log('‚úÖ Automation Triggers caricati:', processedTools.length);

    } catch (error) {
      console.error('‚ùå Errore chiamata API ManyChat:', error);
      console.error('Dettaglio errore:', error.message);
      // In caso di errore, mantieni dati vuoti o mostra messaggio
      setStats({
        totalSubscribers: 0,
        newToday: 0,
        openRate: 0,
        activeConversations: 0,
        leadsToday: 0,
        growthRate: 0
      });
      setSubscribers([]);
      setConversations([]);
      setFlows([]);
    }

    setCampaigns([
      {
        id: 1,
        name: 'Promo Black Friday',
        status: 'completed',
        sent: 1100,
        opened: 756,
        clicked: 234,
        sentAt: new Date(Date.now() - 2 * 24 * 60 * 60000)
      }
    ]);
  };

  const saveManyChatConfig = async (apiKey, pageId) => {
    if (!userTenantId) return;

    try {
      const configRef = doc(db, `tenants/${userTenantId}/integrations/manychat`);
      await setDoc(configRef, {
        apiKey,
        pageId,
        enabled: true,
        configuredAt: new Date(),
        configuredBy: currentUser.uid
      }, { merge: true });

      setManychatConfig({ apiKey, pageId, enabled: true });
      await fetchManyChatData(apiKey, pageId);
    } catch (error) {
      console.error('Errore salvataggio config:', error);
    }
  };

  const formatRelativeTime = (date) => {
    const seconds = Math.floor((new Date() - date) / 1000);
    if (seconds < 60) return 'Ora';
    if (seconds < 3600) return `${Math.floor(seconds / 60)}m fa`;
    if (seconds < 86400) return `${Math.floor(seconds / 3600)}h fa`;
    return `${Math.floor(seconds / 86400)}g fa`;
  };

  if (loading) {
    return (
      <div className="flex items-center justify-center min-h-screen">
        <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500"></div>
      </div>
    );
  }

  if (!manychatConfig || !manychatConfig.apiKey) {
    return <ManyChatSetup onSave={saveManyChatConfig} />;
  }

  return (
    <div className="p-6">
      <div className="max-w-7xl mx-auto">
        {/* Header */}
        <div className="bg-slate-800/30 rounded-2xl shadow-lg p-6 mb-6 backdrop-blur-md">
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-4">
              <div className="w-12 h-12 bg-gradient-to-br from-blue-500 to-purple-600 rounded-xl flex items-center justify-center">
                <MessageSquare className="text-white" size={24} />
              </div>
              <div>
                <h1 className="text-2xl font-bold text-white">ManyChat Hub</h1>
                <p className="text-sm text-slate-400">Gestione automazioni e conversazioni</p>
              </div>
            </div>
            <button
              onClick={() => setActiveTab('settings')}
              className="p-2 hover:bg-slate-700 rounded-lg transition-colors"
            >
              <Settings size={20} className="text-slate-400" />
            </button>
          </div>
        </div>

        {/* Tabs Navigation */}
        <div className="bg-slate-800/30 rounded-2xl shadow-lg mb-6 p-2">
          <div className="flex gap-2">
            {[
              { id: 'overview', label: 'Dashboard', icon: BarChart3 },
              { id: 'inbox', label: 'Inbox', icon: MessageSquare },
              { id: 'subscribers', label: 'Subscribers', icon: Users },
              { id: 'automations', label: 'Automazioni', icon: Bot },
              { id: 'broadcast', label: 'Campagne', icon: Send }
            ].map(tab => (
              <button
                key={tab.id}
                onClick={() => setActiveTab(tab.id)}
                className={`flex-1 px-4 py-3 rounded-xl font-medium transition-all flex items-center justify-center gap-2 ${
                  activeTab === tab.id
                    ? 'bg-gradient-to-r from-blue-500 to-purple-600 text-white shadow-lg'
                    : 'text-slate-400 hover:bg-slate-700'
                }`}
              >
                <tab.icon size={18} />
                {tab.label}
              </button>
            ))}
          </div>
        </div>

        {/* Info Banner */}
        {subscribers.length === 0 && activeTab !== 'settings' && (
          <div className="bg-blue-500/10 border border-blue-500/30 rounded-2xl p-6">
            <div className="flex items-start gap-4">
              <div className="w-10 h-10 bg-blue-500/20 rounded-lg flex items-center justify-center flex-shrink-0">
                <MessageSquare className="text-blue-400" size={20} />
              </div>
              <div>
                <h4 className="font-bold text-white mb-2">üéâ ManyChat Connesso!</h4>
                <p className="text-sm text-slate-300 mb-3">
                  Hai <strong>{flows?.length || 0} automation triggers</strong> attivi (Story Reply, Comment Triggers).
                </p>
                <p className="text-sm text-slate-400 mb-2">
                  <strong>üìä Dati Subscribers:</strong> ManyChat non fornisce questi dati via API standard. 
                  I dati appariranno automaticamente quando:
                </p>
                <ul className="text-sm text-slate-400 space-y-1 ml-4">
                  <li>‚Ä¢ Qualcuno interagisce con i tuoi bot Instagram/Facebook</li>
                  <li>‚Ä¢ Le automations ricevono nuovi messaggi</li>
                  <li>‚Ä¢ I dati vengono sincronizzati ogni 15 minuti</li>
                </ul>
                <p className="text-sm text-slate-300 mt-3">
                  üí° <strong>Suggerimento:</strong> Puoi vedere le statistiche complete nella dashboard ManyChat.
                </p>
              </div>
            </div>
          </div>
        )}

        {/* Content */}
        <div className="space-y-6">
          {activeTab === 'overview' && <OverviewTab stats={stats} flows={flows} campaigns={campaigns} />}
          {activeTab === 'inbox' && <InboxTab conversations={conversations} />}
          {activeTab === 'subscribers' && <SubscribersTab subscribers={subscribers} />}
          {activeTab === 'automations' && <AutomationsTab flows={flows} />}
          {activeTab === 'broadcast' && <BroadcastTab campaigns={campaigns} />}
          {activeTab === 'settings' && <SettingsTab config={manychatConfig} onSave={saveManyChatConfig} />}
        </div>
      </div>
    </div>
  );
}

// Setup iniziale
function ManyChatSetup({ onSave }) {
  const [apiKey, setApiKey] = useState('');
  const [pageId, setPageId] = useState('');

  const handleSubmit = (e) => {
    e.preventDefault();
    if (apiKey && pageId) {
      onSave(apiKey, pageId);
    }
  };

  return (
    <div className="min-h-screen flex items-center justify-center p-6">
      <motion.div
        initial={{ opacity: 0, y: 20 }}
        animate={{ opacity: 1, y: 0 }}
        className="bg-slate-800/30 backdrop-blur-md rounded-2xl shadow-2xl p-8 max-w-md w-full"
      >
        <div className="text-center mb-8">
          <div className="w-16 h-16 bg-gradient-to-br from-blue-500 to-purple-600 rounded-2xl flex items-center justify-center mx-auto mb-4">
            <MessageSquare className="text-white" size={32} />
          </div>
          <h2 className="text-2xl font-bold text-white mb-2">Configura ManyChat</h2>
          <p className="text-slate-400">Inserisci le credenziali API per iniziare</p>
        </div>

        <form onSubmit={handleSubmit} className="space-y-4">
          <div>
            <label className="block text-sm font-medium text-slate-300 mb-2">
              API Key
            </label>
            <input
              type="text"
              value={apiKey}
              onChange={(e) => setApiKey(e.target.value)}
              placeholder="sk_..."
              className="w-full px-4 py-3 bg-slate-700 border border-slate-600 text-white placeholder-slate-400 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              required
            />
          </div>

          <div>
            <label className="block text-sm font-medium text-slate-300 mb-2">
              Page ID
            </label>
            <input
              type="text"
              value={pageId}
              onChange={(e) => setPageId(e.target.value)}
              placeholder="123456789"
              className="w-full px-4 py-3 bg-slate-700 border border-slate-600 text-white placeholder-slate-400 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              required
            />
          </div>

          <button
            type="submit"
            className="w-full bg-gradient-to-r from-blue-500 to-purple-600 text-white py-3 rounded-xl font-bold hover:shadow-lg transition-all"
          >
            Connetti ManyChat
          </button>
        </form>

        <div className="mt-6 p-4 bg-slate-800/20 backdrop-blur-sm rounded-xl border border-slate-700/50">
          <p className="text-xs text-slate-300">
            <strong className="text-white">Dove trovo le credenziali?</strong><br />
            Dashboard ManyChat ‚Üí Settings ‚Üí API ‚Üí Generate API Key
          </p>
        </div>
      </motion.div>
    </div>
  );
}

// Tab Dashboard Overview
function OverviewTab({ stats, flows, campaigns }) {
  return (
    <div className="space-y-6">
      {/* Stats Cards */}
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
        <StatCard
          icon={Users}
          label="Total Subscribers"
          value={stats?.totalSubscribers?.toLocaleString() || '0'}
          change={`+${stats?.newToday || 0} oggi`}
          color="blue"
        />
        <StatCard
          icon={TrendingUp}
          label="Open Rate"
          value={`${stats?.openRate || 0}%`}
          change={`+${stats?.growthRate || 0}%`}
          color="green"
        />
        <StatCard
          icon={MessageSquare}
          label="Conversazioni Attive"
          value={stats?.activeConversations || 0}
          change="In tempo reale"
          color="purple"
        />
        <StatCard
          icon={CheckCircle}
          label="Lead Oggi"
          value={stats?.leadsToday || 0}
          change="Ultimi 24h"
          color="orange"
        />
      </div>

      {/* Quick Actions */}
      <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
        <QuickAction
          icon={Send}
          title="Nuova Campagna"
          description="Invia messaggio broadcast"
          color="blue"
        />
        <QuickAction
          icon={Bot}
          title="Crea Automazione"
          description="Nuovo flow automatico"
          color="purple"
        />
        <QuickAction
          icon={Users}
          title="Importa Contatti"
          description="Carica CSV subscribers"
          color="green"
        />
      </div>

      {/* Recent Activity */}
      <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
        {/* Active Flows */}
        <div className="bg-slate-800/30 rounded-2xl shadow-lg p-6">
          <h3 className="text-lg font-bold text-white mb-4 flex items-center gap-2">
            <Bot size={20} className="text-purple-500" />
            Automazioni Attive
          </h3>
          <div className="space-y-3">
            {flows?.map(flow => (
              <div key={flow.id} className="p-4 bg-slate-750 rounded-xl">
                <div className="flex items-center justify-between mb-2">
                  <span className="font-medium text-white">{flow.name}</span>
                  <span className="text-xs text-green-600 font-semibold">ATTIVO</span>
                </div>
                <div className="flex items-center gap-4 text-sm text-slate-400">
                  <span>{flow.triggered} trigger</span>
                  <span>‚Ä¢</span>
                  <span>{flow.completed} completati</span>
                  <span>‚Ä¢</span>
                  <span className="text-xs">{new Date(flow.lastTrigger).toLocaleTimeString()}</span>
                </div>
              </div>
            ))}
          </div>
        </div>

        {/* Recent Campaigns */}
        <div className="bg-slate-800/30 rounded-2xl shadow-lg p-6">
          <h3 className="text-lg font-bold text-white mb-4 flex items-center gap-2">
            <Send size={20} className="text-blue-500" />
            Campagne Recenti
          </h3>
          <div className="space-y-3">
            {campaigns?.map(campaign => (
              <div key={campaign.id} className="p-4 bg-slate-750 rounded-xl">
                <div className="flex items-center justify-between mb-2">
                  <span className="font-medium text-white">{campaign.name}</span>
                  <span className="text-xs text-slate-400">
                    {new Date(campaign.sentAt).toLocaleDateString()}
                  </span>
                </div>
                <div className="grid grid-cols-3 gap-2 text-center text-sm">
                  <div>
                    <div className="font-bold text-white">{campaign.sent}</div>
                    <div className="text-xs text-slate-400">Inviati</div>
                  </div>
                  <div>
                    <div className="font-bold text-blue-600">{campaign.opened}</div>
                    <div className="text-xs text-slate-400">Aperti</div>
                  </div>
                  <div>
                    <div className="font-bold text-green-600">{campaign.clicked}</div>
                    <div className="text-xs text-slate-400">Click</div>
                  </div>
                </div>
              </div>
            ))}
          </div>
        </div>
      </div>
    </div>
  );
}

// Tab Inbox
function InboxTab({ conversations }) {
  const [selectedConv, setSelectedConv] = useState(null);
  const [message, setMessage] = useState('');

  return (
    <div className="bg-slate-800/30 rounded-2xl shadow-lg overflow-hidden" style={{ height: '70vh' }}>
      <div className="flex h-full">
        {/* Conversations List */}
        <div className="w-1/3 border-r border-slate-700 overflow-y-auto">
          <div className="p-4 border-b border-slate-700">
            <div className="relative">
              <Search className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" size={18} />
              <input
                type="text"
                placeholder="Cerca conversazioni..."
                className="w-full pl-10 pr-4 py-2 border border-slate-700 rounded-lg"
              />
            </div>
          </div>
          <div className="divide-y divide-slate-100">
            {conversations.map(conv => (
              <div
                key={conv.id}
                onClick={() => setSelectedConv(conv)}
                className={`p-4 cursor-pointer hover:bg-slate-700 transition-colors ${
                  selectedConv?.id === conv.id ? 'bg-slate-700' : ''
                }`}
              >
                <div className="flex items-center gap-3 mb-2">
                  <div className="w-10 h-10 bg-gradient-to-br from-blue-400 to-purple-500 rounded-full flex items-center justify-center text-white font-bold">
                    {conv.subscriber.name[0]}
                  </div>
                  <div className="flex-1 min-w-0">
                    <div className="flex items-center justify-between">
                      <span className="font-medium text-white truncate">{conv.subscriber.name}</span>
                      <span className="text-xs text-slate-400">{formatRelativeTime(conv.timestamp)}</span>
                    </div>
                    <p className="text-sm text-slate-400 truncate">{conv.lastMessage}</p>
                  </div>
                  {conv.unread && (
                    <div className="w-2 h-2 bg-slate-7000 rounded-full"></div>
                  )}
                </div>
                <div className="flex gap-1">
                  {conv.tags.map(tag => (
                    <span key={tag} className="text-xs px-2 py-0.5 bg-slate-700 text-slate-400 rounded">
                      {tag}
                    </span>
                  ))}
                </div>
              </div>
            ))}
          </div>
        </div>

        {/* Chat Area */}
        <div className="flex-1 flex flex-col">
          {selectedConv ? (
            <>
              <div className="p-4 border-b border-slate-700">
                <div className="flex items-center justify-between">
                  <div className="flex items-center gap-3">
                    <div className="w-10 h-10 bg-gradient-to-br from-blue-400 to-purple-500 rounded-full flex items-center justify-center text-white font-bold">
                      {selectedConv.subscriber.name[0]}
                    </div>
                    <div>
                      <div className="font-medium text-white">{selectedConv.subscriber.name}</div>
                      <div className="text-xs text-green-600">‚óè Online</div>
                    </div>
                  </div>
                  <button className="p-2 hover:bg-slate-700 rounded-lg">
                    <ExternalLink size={18} className="text-slate-400" />
                  </button>
                </div>
              </div>
              <div className="flex-1 p-4 overflow-y-auto bg-slate-750">
                {/* Messages here */}
                <div className="space-y-4">
                  <div className="flex justify-end">
                    <div className="bg-slate-7000 text-white px-4 py-2 rounded-2xl max-w-xs">
                      Ciao! Come posso aiutarti?
                    </div>
                  </div>
                  <div className="flex justify-start">
                    <div className="bg-slate-800/30 px-4 py-2 rounded-2xl max-w-xs shadow">
                      {selectedConv.lastMessage}
                    </div>
                  </div>
                </div>
              </div>
              <div className="p-4 border-t border-slate-700">
                <div className="flex gap-2">
                  <input
                    type="text"
                    value={message}
                    onChange={(e) => setMessage(e.target.value)}
                    placeholder="Scrivi un messaggio..."
                    className="flex-1 px-4 py-2 border border-slate-700 rounded-lg"
                  />
                  <button className="px-6 py-2 bg-slate-7000 text-white rounded-lg hover:bg-blue-600">
                    <Send size={18} />
                  </button>
                </div>
              </div>
            </>
          ) : (
            <div className="flex-1 flex items-center justify-center text-slate-400">
              Seleziona una conversazione
            </div>
          )}
        </div>
      </div>
    </div>
  );
}

// Tab Subscribers
function SubscribersTab({ subscribers }) {
  const [searchTerm, setSearchTerm] = useState('');

  return (
    <div className="bg-slate-800/30 rounded-2xl shadow-lg p-6">
      <div className="flex items-center justify-between mb-6">
        <h3 className="text-lg font-bold text-white">Subscribers ({subscribers.length})</h3>
        <div className="flex gap-2">
          <button className="px-4 py-2 bg-slate-7000 text-white rounded-lg hover:bg-blue-600 flex items-center gap-2">
            <Plus size={18} />
            Aggiungi
          </button>
          <button className="px-4 py-2 bg-slate-700 text-slate-300 rounded-lg hover:bg-slate-200 flex items-center gap-2">
            <Download size={18} />
            Esporta
          </button>
        </div>
      </div>

      <div className="mb-4">
        <div className="relative">
          <Search className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" size={18} />
          <input
            type="text"
            value={searchTerm}
            onChange={(e) => setSearchTerm(e.target.value)}
            placeholder="Cerca per nome, email o telefono..."
            className="w-full pl-10 pr-4 py-2 border border-slate-700 rounded-lg"
          />
        </div>
      </div>

      <div className="overflow-x-auto">
        <table className="w-full">
          <thead>
            <tr className="border-b border-slate-700">
              <th className="text-left py-3 px-4 text-sm font-semibold text-slate-400">Nome</th>
              <th className="text-left py-3 px-4 text-sm font-semibold text-slate-400">Contatto</th>
              <th className="text-left py-3 px-4 text-sm font-semibold text-slate-400">Tags</th>
              <th className="text-left py-3 px-4 text-sm font-semibold text-slate-400">Ultima Interazione</th>
              <th className="text-left py-3 px-4 text-sm font-semibold text-slate-400">Status</th>
            </tr>
          </thead>
          <tbody className="divide-y divide-slate-100">
            {subscribers.map(sub => (
              <tr key={sub.id} className="hover:bg-slate-700">
                <td className="py-3 px-4">
                  <div className="flex items-center gap-3">
                    <div className="w-8 h-8 bg-gradient-to-br from-blue-400 to-purple-500 rounded-full flex items-center justify-center text-white text-sm font-bold">
                      {sub.name[0]}
                    </div>
                    <span className="font-medium text-white">{sub.name}</span>
                  </div>
                </td>
                <td className="py-3 px-4">
                  <div className="text-sm text-slate-400">
                    <div className="flex items-center gap-2">
                      <Mail size={14} />
                      {sub.email}
                    </div>
                    <div className="flex items-center gap-2 mt-1">
                      <Phone size={14} />
                      {sub.phone}
                    </div>
                  </div>
                </td>
                <td className="py-3 px-4">
                  <div className="flex flex-wrap gap-1">
                    {sub.tags.map(tag => (
                      <span key={tag} className="text-xs px-2 py-1 bg-blue-100 text-blue-700 rounded">
                        {tag}
                      </span>
                    ))}
                  </div>
                </td>
                <td className="py-3 px-4 text-sm text-slate-400">
                  {formatRelativeTime(sub.lastInteraction)}
                </td>
                <td className="py-3 px-4">
                  <span className="text-xs px-2 py-1 bg-green-100 text-green-700 rounded font-medium">
                    {sub.status}
                  </span>
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    </div>
  );
}

// Tab Automations
function AutomationsTab({ flows }) {
  const [editingFlow, setEditingFlow] = useState(null);

  const handleOpenInManyChat = (flowId) => {
    // Apre l'automation in ManyChat
    window.open(`https://manychat.com/fb${flowId}`, '_blank');
  };

  return (
    <div className="bg-slate-800/30 rounded-2xl shadow-lg p-6">
      <div className="flex items-center justify-between mb-6">
        <h3 className="text-lg font-bold text-white">Automazioni ({flows?.length || 0})</h3>
        <a 
          href="https://manychat.com" 
          target="_blank" 
          rel="noopener noreferrer"
          className="px-4 py-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600 flex items-center gap-2"
        >
          <Plus size={18} />
          Crea in ManyChat
        </a>
      </div>

      <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
        {flows.map(flow => (
          <div key={flow.id} className="p-6 border border-slate-700 rounded-xl hover:shadow-lg transition-shadow">
            <div className="flex items-center justify-between mb-4">
              <h4 className="font-bold text-white text-sm">{flow.name}</h4>
              <span className="text-xs px-2 py-1 bg-green-500/20 text-green-400 rounded font-medium">
                {flow.status}
              </span>
            </div>

            {/* Tipo di trigger */}
            <div className="mb-4">
              <span className="text-xs px-2 py-1 bg-blue-500/20 text-blue-400 rounded">
                {flow.type === 'feed_comment_trigger' && 'üí¨ Comment Trigger'}
                {flow.type === 'instagram_story_reply' && 'üì∏ Story Reply'}
                {!flow.type && 'ü§ñ Automation'}
              </span>
            </div>

            <div className="grid grid-cols-2 gap-4 mb-4">
              <div className="text-center p-3 bg-slate-700/50 rounded-lg">
                <div className="text-2xl font-bold text-blue-400">{flow.triggered || 'N/D'}</div>
                <div className="text-xs text-slate-400">Triggered</div>
              </div>
              <div className="text-center p-3 bg-slate-700/50 rounded-lg">
                <div className="text-2xl font-bold text-green-400">{flow.completed || 'N/D'}</div>
                <div className="text-xs text-slate-400">Completati</div>
              </div>
            </div>

            <div className="text-xs text-slate-400 mb-4">
              ID: {flow.id}
            </div>

            <div className="flex gap-2">
              <button 
                onClick={() => handleOpenInManyChat(flow.id)}
                className="flex-1 px-3 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm transition-colors flex items-center justify-center gap-2"
              >
                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                </svg>
                Apri in ManyChat
              </button>
              <button 
                onClick={() => setEditingFlow(flow)}
                className="px-3 py-2 bg-slate-700 text-slate-300 rounded-lg hover:bg-slate-600 text-sm transition-colors"
                title="Info"
              >
                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
              </button>
            </div>
          </div>
        ))}
      </div>

      {/* Modal Info Flow */}
      {editingFlow && (
        <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4">
          <div className="bg-slate-800 rounded-2xl shadow-2xl max-w-lg w-full p-6">
            <div className="flex items-center justify-between mb-6">
              <h3 className="text-xl font-bold text-white">Dettagli Automation</h3>
              <button 
                onClick={() => setEditingFlow(null)}
                className="text-slate-400 hover:text-white transition-colors"
              >
                <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                </svg>
              </button>
            </div>

            <div className="space-y-4">
              <div>
                <label className="block text-sm font-medium text-slate-400 mb-1">Nome</label>
                <div className="text-white font-medium">{editingFlow.name}</div>
              </div>

              <div>
                <label className="block text-sm font-medium text-slate-400 mb-1">Tipo</label>
                <div className="text-white">
                  {editingFlow.type === 'feed_comment_trigger' && 'üí¨ Comment Trigger'}
                  {editingFlow.type === 'instagram_story_reply' && 'üì∏ Story Reply'}
                  {!editingFlow.type && 'ü§ñ Automation'}
                </div>
              </div>

              <div>
                <label className="block text-sm font-medium text-slate-400 mb-1">ID ManyChat</label>
                <div className="text-white font-mono text-sm">{editingFlow.id}</div>
              </div>

              <div>
                <label className="block text-sm font-medium text-slate-400 mb-1">Status</label>
                <span className="inline-block px-3 py-1 bg-green-500/20 text-green-400 rounded-full text-sm font-medium">
                  {editingFlow.status || 'active'}
                </span>
              </div>

              <div className="pt-4 border-t border-slate-700">
                <p className="text-sm text-slate-400 mb-4">
                  Per modificare questa automation, clicca sul pulsante qui sotto per aprirla direttamente in ManyChat.
                </p>
                <button
                  onClick={() => handleOpenInManyChat(editingFlow.id)}
                  className="w-full px-4 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors flex items-center justify-center gap-2 font-medium"
                >
                  <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                  </svg>
                  Modifica in ManyChat
                </button>
              </div>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}

// Tab Broadcast
function BroadcastTab({ campaigns }) {
  const [showNewCampaign, setShowNewCampaign] = useState(false);

  return (
    <div className="bg-slate-800/30 rounded-2xl shadow-lg p-6">
      <div className="flex items-center justify-between mb-6">
        <h3 className="text-lg font-bold text-white">Campagne Broadcast</h3>
        <button 
          onClick={() => setShowNewCampaign(true)}
          className="px-4 py-2 bg-slate-7000 text-white rounded-lg hover:bg-blue-600 flex items-center gap-2"
        >
          <Plus size={18} />
          Nuova Campagna
        </button>
      </div>

      {showNewCampaign ? (
        <div className="p-6 bg-slate-750 rounded-xl mb-6">
          <h4 className="font-bold text-white mb-4">Crea Nuova Campagna</h4>
          <div className="space-y-4">
            <input
              type="text"
              placeholder="Nome campagna"
              className="w-full px-4 py-2 bg-slate-700 border border-slate-600 text-white placeholder-slate-400 rounded-lg focus:ring-2 focus:ring-blue-500"
            />
            <textarea
              placeholder="Messaggio..."
              rows={4}
              className="w-full px-4 py-2 bg-slate-700 border border-slate-600 text-white placeholder-slate-400 rounded-lg focus:ring-2 focus:ring-blue-500"
            />
            <div className="flex gap-2">
              <button className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                Invia Ora
              </button>
              <button className="px-4 py-2 bg-slate-700 text-white rounded-lg hover:bg-slate-600 transition-colors">
                Pianifica
              </button>
              <button 
                onClick={() => setShowNewCampaign(false)}
                className="px-4 py-2 bg-slate-800/30 border border-slate-700 text-slate-300 rounded-lg hover:bg-slate-700"
              >
                Annulla
              </button>
            </div>
          </div>
        </div>
      ) : null}

      <div className="space-y-4">
        {campaigns.map(campaign => (
          <div key={campaign.id} className="p-6 border border-slate-700 rounded-xl">
            <div className="flex items-center justify-between mb-4">
              <div>
                <h4 className="font-bold text-white">{campaign.name}</h4>
                <p className="text-sm text-slate-400">
                  Inviata il {new Date(campaign.sentAt).toLocaleDateString()}
                </p>
              </div>
              <span className="text-xs px-3 py-1 bg-green-100 text-green-700 rounded font-medium">
                {campaign.status}
              </span>
            </div>

            <div className="grid grid-cols-4 gap-4">
              <div className="text-center p-3 bg-slate-750 rounded-lg">
                <div className="text-xl font-bold text-white">{campaign.sent}</div>
                <div className="text-xs text-slate-400">Inviati</div>
              </div>
              <div className="text-center p-3 bg-slate-700 rounded-lg">
                <div className="text-xl font-bold text-blue-600">{campaign.opened}</div>
                <div className="text-xs text-slate-400">Aperti</div>
                <div className="text-xs font-medium text-blue-600">
                  {Math.round((campaign.opened / campaign.sent) * 100)}%
                </div>
              </div>
              <div className="text-center p-3 bg-green-50 rounded-lg">
                <div className="text-xl font-bold text-green-600">{campaign.clicked}</div>
                <div className="text-xs text-slate-400">Click</div>
                <div className="text-xs font-medium text-green-600">
                  {Math.round((campaign.clicked / campaign.opened) * 100)}%
                </div>
              </div>
              <div className="flex items-center justify-center">
                <button className="px-4 py-2 bg-slate-700 text-slate-300 rounded-lg hover:bg-slate-200 text-sm">
                  Dettagli
                </button>
              </div>
            </div>
          </div>
        ))}
      </div>
    </div>
  );
}

// Tab Settings
function SettingsTab({ config, onSave }) {
  const [apiKey, setApiKey] = useState(config?.apiKey || '');
  const [pageId, setPageId] = useState(config?.pageId || '');
  const [syncing, setSyncing] = useState(false);
  const [syncStatus, setSyncStatus] = useState('');

  const handleSyncNow = async () => {
    setSyncing(true);
    setSyncStatus('');
    
    try {
      const { httpsCallable } = await import('firebase/functions');
      const { functions } = await import('../../firebase');
      const { auth } = await import('../../firebase');
      
      // Ottieni il tenant ID dell'utente corrente
      const user = auth.currentUser;
      if (!user) {
        throw new Error('Utente non autenticato');
      }
      
      const userTenantId = user.tenantId || localStorage.getItem('tenantId');
      console.log('üîÑ Sincronizzazione per tenant:', userTenantId);
      
      // Chiama la funzione di sync manualmente
      const syncManyChatData = httpsCallable(functions, 'manualSyncManyChat');
      const result = await syncManyChatData({ tenantId: userTenantId });
      
      console.log('‚úÖ Sync result:', result);
      setSyncStatus('‚úÖ Sincronizzazione completata! Ricarica la pagina per vedere i dati aggiornati.');
      
      // Ricarica la pagina dopo 2 secondi
      setTimeout(() => window.location.reload(), 2000);
    } catch (error) {
      console.error('‚ùå Errore sync:', error);
      setSyncStatus('‚ùå Errore durante la sincronizzazione: ' + error.message);
    } finally {
      setSyncing(false);
    }
  };

  return (
    <div className="bg-slate-800/30 rounded-2xl shadow-lg p-6">
      <h3 className="text-lg font-bold text-white mb-6">Impostazioni ManyChat</h3>
      
      <div className="space-y-4 max-w-xl">
        <div>
          <label className="block text-sm font-medium text-slate-300 mb-2">API Key</label>
          <input
            type="text"
            value={apiKey}
            onChange={(e) => setApiKey(e.target.value)}
            className="w-full px-4 py-2 bg-slate-700 border border-slate-600 text-white placeholder-slate-400 rounded-lg focus:ring-2 focus:ring-blue-500"
          />
        </div>

        <div>
          <label className="block text-sm font-medium text-slate-300 mb-2">Page ID</label>
          <input
            type="text"
            value={pageId}
            onChange={(e) => setPageId(e.target.value)}
            className="w-full px-4 py-2 bg-slate-700 border border-slate-600 text-white placeholder-slate-400 rounded-lg focus:ring-2 focus:ring-blue-500"
          />
        </div>

        <div className="flex gap-3">
          <button
            onClick={() => onSave(apiKey, pageId)}
            className="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"
          >
            Salva Modifiche
          </button>
          
          <button
            onClick={handleSyncNow}
            disabled={syncing}
            className="px-6 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2"
          >
            {syncing ? (
              <>
                <div className="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                Sincronizzazione...
              </>
            ) : (
              <>
                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                </svg>
                Sincronizza Ora
              </>
            )}
          </button>
        </div>
        
        {syncStatus && (
          <div className={`p-3 rounded-lg ${syncStatus.startsWith('‚úÖ') ? 'bg-green-500/20 text-green-400' : 'bg-red-500/20 text-red-400'}`}>
            {syncStatus}
          </div>
        )}
      </div>

      <div className="mt-8 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
        <p className="text-sm text-yellow-800">
          <strong>‚ö†Ô∏è Attenzione:</strong> Modificando le credenziali API potrebbero verificarsi interruzioni nel servizio.
        </p>
      </div>
    </div>
  );
}

// Utility Components
function StatCard({ icon: Icon, label, value, change, color }) {
  const colors = {
    blue: 'from-blue-500 to-blue-600',
    green: 'from-green-500 to-green-600',
    purple: 'from-purple-500 to-purple-600',
    orange: 'from-orange-500 to-orange-600'
  };

  return (
    <motion.div
      initial={{ opacity: 0, y: 20 }}
      animate={{ opacity: 1, y: 0 }}
      className="bg-slate-800/30 rounded-2xl shadow-lg p-6"
    >
      <div className="flex items-center justify-between mb-4">
        <div className={`w-12 h-12 bg-gradient-to-br ${colors[color]} rounded-xl flex items-center justify-center`}>
          <Icon className="text-white" size={24} />
        </div>
      </div>
      <div className="text-3xl font-bold text-white mb-1">{value}</div>
      <div className="text-sm text-slate-400 mb-2">{label}</div>
      <div className="text-xs text-slate-400">{change}</div>
    </motion.div>
  );
}

function QuickAction({ icon: Icon, title, description, color }) {
  const colors = {
    blue: 'from-blue-500 to-blue-600',
    purple: 'from-purple-500 to-purple-600',
    green: 'from-green-500 to-green-600'
  };

  return (
    <button className="bg-slate-800/30 rounded-2xl shadow-lg p-6 hover:shadow-xl transition-all text-left group">
      <div className={`w-12 h-12 bg-gradient-to-br ${colors[color]} rounded-xl flex items-center justify-center mb-4 group-hover:scale-110 transition-transform`}>
        <Icon className="text-white" size={24} />
      </div>
      <h4 className="font-bold text-white mb-1">{title}</h4>
      <p className="text-sm text-slate-400">{description}</p>
    </button>
  );
}

function formatRelativeTime(date) {
  const seconds = Math.floor((new Date() - date) / 1000);
  if (seconds < 60) return 'Ora';
  if (seconds < 3600) return `${Math.floor(seconds / 60)}m fa`;
  if (seconds < 86400) return `${Math.floor(seconds / 3600)}h fa`;
  return `${Math.floor(seconds / 86400)}g fa`;
}
